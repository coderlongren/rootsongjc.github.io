<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes中的服务发现与docker容器间的环境变量传递源码探究 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/exploring-kubernetes-env-with-docker/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-07-19"/>
<meta property="article:modified_time" content="2017-07-19"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes中的服务发现与docker容器间的环境变量传递源码探究 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes中的服务发现与docker容器间的环境变量传递源码探究 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/exploring-kubernetes-env-with-docker/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e4%b8%ad%e7%9a%84%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e4%b8%8edocker%e5%ae%b9%e5%99%a8%e9%97%b4%e7%9a%84%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e4%bc%a0%e9%80%92%e6%ba%90%e7%a0%81%e6%8e%a2%e7%a9%b6-https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f&title=Kubernetes%e4%b8%ad%e7%9a%84%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e4%b8%8edocker%e5%ae%b9%e5%99%a8%e9%97%b4%e7%9a%84%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e4%bc%a0%e9%80%92%e6%ba%90%e7%a0%81%e6%8e%a2%e7%a9%b6&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fexploring-kubernetes-env-with-docker%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes中的服务发现与docker容器间的环境变量传递源码探究</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170713077.jpg" alt="野三坡" /></p>

<p><em>（题图：雷雨@野三坡  Jul 13,2017）</em></p>

<h2 id="前言">前言</h2>

<p>今天创建了两个kubernetes示例应用：</p>

<ul>
<li><p><a href="https://github.com/rootsongjc/k8s-app-monitor-test">k8s-app-monitor-test</a>：启动server用来产生metrics</p></li>

<li><p><a href="https://github.com/rootsongjc/k8s-app-monitor-agent">k8s-app-monitor-agent</a>：获取metrics并绘图，显示在web上</p></li>
</ul>

<p><em>注：相关的kubernetes应用<code>manifest.yaml</code>文件分别见以上两个应用的GitHub 。</em></p>

<p>当我查看Pod中的环境变量信息时，例如kubernetes中的service <code>k8s-app-monitor-test</code>注入的环境变量时，包括了以下变量：</p>

<pre><code class="language-ini">K8S_APP_MONITOR_TEST_PORT_3000_TCP_ADDR=10.254.56.68
K8S_APP_MONITOR_TEST_PORT=tcp://10.254.56.68:3000
K8S_APP_MONITOR_TEST_PORT_3000_TCP_PROTO=tcp
K8S_APP_MONITOR_TEST_SERVICE_PORT_HTTP=3000
K8S_APP_MONITOR_TEST_PORT_3000_TCP_PORT=3000
K8S_APP_MONITOR_TEST_PORT_3000_TCP=tcp://10.254.56.68:3000
K8S_APP_MONITOR_TEST_SERVICE_HOST=10.254.56.68
K8S_APP_MONITOR_TEST_SERVICE_PORT=3000
</code></pre>

<p>我们知道Kubernetes在启动Pod的时候为容器注入环境变量，这些环境变量将在该Pod所在的namespace中共享。但是既然使用这些环境变量就已经可以访问到对应的service，那么获取应用的地址信息，究竟是使用变量呢？还是直接使用DNS解析来发现？下面我们从代码中来寻求答案。</p>

<p>如果不想看下面的文字，可以直接看图。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-service-discovery-with-dns-or-env.png" alt="kubernetes中传递ENV的探索过程" /></p>

<h2 id="探索">探索</h2>

<p>docker的<code>docker/engine-api/types/container/config.go</code>中的<code>Config</code>结构体中有对环境变量的定义：</p>

<pre><code class="language-Go">// Config contains the configuration data about a container.
// It should hold only portable information about the container.
// Here, &quot;portable&quot; means &quot;independent from the host we are running on&quot;.
// Non-portable information *should* appear in HostConfig.
// All fields added to this struct must be marked `omitempty` to keep getting
// predictable hashes from the old `v1Compatibility` configuration.
type Config struct {
	Hostname        string                // Hostname
	Domainname      string                // Domainname
	User            string                // User that will run the command(s) inside the container
...
	Env             []string              // List of environment variable to set in the container
	Cmd             strslice.StrSlice     // Command to run when starting the container
	...
}
</code></pre>

<p>Kubernetes中在<code>pkg/kubelet/container/runtime.go</code>中的<code>RunContainerOptions</code>结构体中定义：</p>

<pre><code class="language-go">// RunContainerOptions specify the options which are necessary for running containers
type RunContainerOptions struct {
	// The environment variables list.
	Envs []EnvVar
  	// The mounts for the containers.
	Mounts []Mount
	// The host devices mapped into the containers.
...
}
</code></pre>

<p>Kubelet向容器中注入环境变量的配置是在<code>pkg/kubelet/kuberuntime/kuberuntime_container.go</code>的如下方法中：</p>

<pre><code class="language-Go">// generateContainerConfig generates container config for kubelet runtime v1.
func (m *kubeGenericRuntimeManager) generateContainerConfig(container *v1.Container, pod *v1.Pod, restartCount int, podIP, imageRef string) (*runtimeapi.ContainerConfig, error) {
    opts, _, err := m.runtimeHelper.GenerateRunContainerOptions(pod, container, podIP)
    ...
	// set environment variables
	envs := make([]*runtimeapi.KeyValue, len(opts.Envs))
	for idx := range opts.Envs {
		e := opts.Envs[idx]
		envs[idx] = &amp;runtimeapi.KeyValue{
			Key:   e.Name,
			Value: e.Value,
		}
	}
	config.Envs = envs

	return config, nil
}
</code></pre>

<p>kubelet的<code>pkg/kubelet/kubelet_pods.go</code>的如下方法中生成了<code>RunContainerOptions</code>：</p>

<pre><code class="language-Go">// GenerateRunContainerOptions generates the RunContainerOptions, which can be used by
// the container runtime to set parameters for launching a container.
func (kl *Kubelet) GenerateRunContainerOptions(pod *v1.Pod, container *v1.Container, podIP string) (*kubecontainer.RunContainerOptions, bool, error) {
	...
	opts := &amp;kubecontainer.RunContainerOptions{CgroupParent: cgroupParent}
	...
	opts.Envs, err = kl.makeEnvironmentVariables(pod, container, podIP)
    return opts, useClusterFirstPolicy, nil
}
</code></pre>

<p>我们再看下<code>makeEnvironmentVariables(pod, container, podIP)</code>方法中又做了什么（该方法也在<code>pkg/kubelet/kubelet_pods.go</code>文件中）。</p>

<pre><code class="language-Go">// Make the environment variables for a pod in the given namespace.
func (kl *Kubelet) makeEnvironmentVariables(pod *v1.Pod, container *v1.Container, podIP string) ([]kubecontainer.EnvVar, error) {
	var result []kubecontainer.EnvVar
	// Note:  These are added to the docker Config, but are not included in the checksum computed
	// by dockertools.BuildDockerName(...).  That way, we can still determine whether an
	// v1.Container is already running by its hash. (We don't want to restart a container just
	// because some service changed.)
	//
	// Note that there is a race between Kubelet seeing the pod and kubelet seeing the service.
	// To avoid this users can: (1) wait between starting a service and starting; or (2) detect
	// missing service env var and exit and be restarted; or (3) use DNS instead of env vars
	// and keep trying to resolve the DNS name of the service (recommended).
	...
}
</code></pre>

<p>该代码段比较长，kubernetes究竟如何将环境变量注入到docker容器中的奥秘就在这里，按图索骥到了这里，从代码注释中已经可以得出结论，使用DNS解析而不要使用环境变量来做服务发现，究竟为何这样做，改天我们再详细解读。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/data-persistence-problem/">Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究</a></li>
                
                <li><a href="/blogs/kubernetes-kubectl-cheatsheat/">Kubernetes kubectl cheat sheat——Kubectl命令参考图</a></li>
                
                <li><a href="/blogs/kubernetes-jenkins-ci-cd/">使用Jenkins进行持续构建与发布应用到kubernetes集群中</a></li>
                
                <li><a href="/blogs/kubernetes-pod-cheetsheet/">Kubernetes Pod Cheat Sheet——Pod数据结构参考图</a></li>
                
                <li><a href="/blogs/kubernetes-client-go-sample/">kubernetes client-go包使用示例</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Jul 19, 2017 </h4>
        <h5 id="wc"> 1300 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/talks/book-kubernetes-management-design-patterns/"><i class="icon-arrow-left"></i> 记一本关于kubernetes management design patterns的书</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/projects/awesome-cloud-native/">Awesome Cloud Native <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1299">
<meta itemprop="datePublished" content="2017-07-19">
<meta itemprop="url" content="https://jimmysong.io/blogs/exploring-kubernetes-env-with-docker/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>
</body>

</html>