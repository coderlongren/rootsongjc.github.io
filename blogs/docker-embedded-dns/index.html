<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="docker, network, dns, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Docker内置DNS : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/docker-embedded-dns/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-02-27"/>
<meta property="article:modified_time" content="2017-02-27"/>



<meta property="article:tag" content="docker">
<meta property="article:tag" content="network">
<meta property="article:tag" content="dns">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Docker内置DNS : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Docker内置DNS - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/docker-embedded-dns/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Docker%e5%86%85%e7%bd%aeDNS-https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f&title=Docker%e5%86%85%e7%bd%aeDNS&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdocker-embedded-dns%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Docker内置DNS</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p>本文主要介绍了<a href="http://lib.csdn.net/base/docker">Docker</a>容器的DNS配置及其注意点，重点对docker 1.10发布的embedded DNS server进行了源码分析，看看embedded DNS server到底是个啥，它是如何工作的。</p>

<h2 id="configure-container-dns">Configure container DNS</h2>

<h3 id="dns-in-default-bridge-network">DNS in default bridge network</h3>

<table>
<thead>
<tr>
<th>Options</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>-h HOSTNAME or –hostname=HOSTNAME</td>
<td>在该容器启动时，将HOSTNAME设置到容器内的/etc/hosts, /etc/hostname, /bin/bash提示中。</td>
</tr>

<tr>
<td>–link=CONTAINER_NAME or ID:ALIAS</td>
<td>在该容器启动时，将ALIAS和CONTAINER_NAME/ID对应的容器IP添加到/etc/hosts. 如果 CONTAINER_NAME/ID有多个IP地址 ？</td>
</tr>

<tr>
<td>–dns=IP_ADDRESS…</td>
<td>在该容器启动时，将<code>nameserver IP_ADDRESS</code>添加到容器内的/etc/resolv.conf中。可以配置多个。</td>
</tr>

<tr>
<td>–dns-search=DOMAIN…</td>
<td>在该容器启动时，将DOMAIN添加到容器内/etc/resolv.conf的dns search列表中。可以配置多个。</td>
</tr>

<tr>
<td>–dns-opt=OPTION…</td>
<td>在该容器启动时，将OPTION添加到容器内/etc/resolv.conf中的options选项中，可以配置多个。</td>
</tr>
</tbody>
</table>

<blockquote>
<p><strong>说明：</strong></p>

<ul>
<li>如果docker run时不含<code>--dns=IP_ADDRESS..., --dns-search=DOMAIN..., or --dns-opt=OPTION...</code>参数，docker daemon会将copy本主机的/etc/resolv.conf，然后对该copy进行处理（将那些/etc/resolv.conf中ping不通的nameserver项给抛弃）,处理完成后留下的部分就作为该容器内部的/etc/resolv.conf。因此，如果你想利用宿主机中的/etc/resolv.conf配置的nameserver进行域名解析，那么你需要宿主机中该dns service配置一个宿主机内容器能ping通的IP。</li>
<li>如果宿主机的/etc/resolv.conf内容发生改变，docker daemon有一个对应的file change notifier会watch到这一变化，然后根据容器状态采取对应的措施：

<ul>
<li>如果容器状态为stopped，则立刻根据宿主机的/etc/resolv.conf内容更新容器内的/etc/resolv.conf.</li>
<li>如果容器状态为running，则容器内的/etc/resolv.conf将不会改变，直到该容器状态变为stopped.</li>
<li>如果容器启动后修改过容器内的/etc/resolv.conf，则不会对该容器进行处理，否则可能会丢失已经完成的修改，无论该容器为什么状态。 
如果容器启动时，用了–dns, –dns-search, or –dns-opt选项，其启动时已经修改了宿主机的/etc/resolv.conf过滤后的内容，因此docker daemon永远不会更新这种容器的/etc/resolv.conf。</li>
<li><strong>注意</strong>: docker daemon监控宿主机/etc/resolv.conf的这个file change notifier的实现是依赖linux内核的inotify特性，而inotfy特性不兼容overlay fs，因此使用overlay fs driver的docker deamon将无法使用该/etc/resolv.conf自动更新的功能。</li>
</ul></li>
</ul>
</blockquote>

<h3 id="embedded-dns-in-user-defined-networks">Embedded DNS in user-defined networks</h3>

<p>在docker 1.10版本中，docker daemon实现了一个叫做<code>embedded DNS server</code>的东西，用来当你创建的容器满足以下条件时：</p>

<ul>
<li>使用自定义网络；</li>
<li>容器创建时候通过<code>--name</code>,<code>--network-alias</code> or <code>--link</code>提供了一个name；</li>
</ul>

<p>docker daemon就会利用embedded DNS server对整个自定义网络中所有容器进行名字解析（你可以理解为一个网络中的一种服务发现）。</p>

<p>因此当你启动容器时候满足以上条件时，该容器的域名解析就不应该去考虑容器内的/etc/hosts, /etc/resolv.conf，应该保持其不变，甚至为空，将需要解析的域名都配置到对应embedded DNS server中。具体配置参数及说明如下：</p>

<table>
<thead>
<tr>
<th>Options</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>–name=CONTAINER-NAME</td>
<td>在该容器启动时，会将CONTAINER-NAME和该容器的IP配置到该容器连接到的自定义网络中的embedded DNS server中，由它提供该自定义网络范围内的域名解析</td>
</tr>

<tr>
<td>–network-alias=ALIAS</td>
<td>将容器的name-ip map配置到容器连接到的其他网络的embedded DNS server中。PS：一个容器可能连接到多个网络中。</td>
</tr>

<tr>
<td>–link=CONTAINER_NAME:ALIAS</td>
<td>在该容器启动时，将ALIAS和CONTAINER_NAME/ID对应的容器IP配置到该容器连接到的自定义网络中的embedded DNS server中，但仅限于配置了该link的容器能解析这条rule。</td>
</tr>

<tr>
<td>–dns=[IP_ADDRESS…]</td>
<td>当embedded DNS server无法解析该容器的某个dns query时，会将请求foward到这些–dns配置的IP_ADDRESS DNS Server，由它们进一步进行域名解析。注意，这些–dns配置到<code>nameserver IP_ADDRESS</code>全部由对应的embedded DNS server管理，并不会更新到容器内的/etc/resolv.conf.</td>
</tr>

<tr>
<td>–dns-search=DOMAIN…</td>
<td>在该容器启动时，会将–dns-search配置的DOMAIN们配置到the embedded DNS server，并不会更新到容器内的/etc/resolv.conf。</td>
</tr>

<tr>
<td>–dns-opt=OPTION…</td>
<td>在该容器启动时，会将–dns-opt配置的OPTION们配置到the embedded DNS server，并不会更新到容器内的/etc/resolv.conf。</td>
</tr>
</tbody>
</table>

<blockquote>
<p><strong>说明：</strong></p>

<ul>
<li>如果docker run时不含<code>--dns=IP_ADDRESS..., --dns-search=DOMAIN..., or --dns-opt=OPTION...</code>参数，docker daemon会将copy本主机的/etc/resolv.conf，然后对该copy进行处理（将那些/etc/resolv.conf中ping不通的nameserver项给抛弃）,处理完成后留下的部分就作为该容器内部的/etc/resolv.conf。因此，如果你想利用宿主机中的/etc/resolv.conf配置的nameserver进行域名解析，那么你需要宿主机中该dns service配置一个宿主机内容器能ping通的IP。</li>
<li>注意容器内/etc/resolv.conf中配置的DNS server，只有当the embedded DNS server无法解析某个name时，才会用到。</li>
</ul>
</blockquote>

<h2 id="embedded-dns-server源码分析">embedded DNS server源码分析</h2>

<p>所有embedded DNS server相关的代码都在libcontainer项目中，几个最主要的文件分别是<code>/libnetwork/resolver.Go</code>,<code>/libnetwork/resolver_unix.go</code>,<code>sandbox_dns_unix.go</code>。</p>

<p>OK, 先来看看embedded DNS server对象在docker中的定义：</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">resolver</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1">// resolver implements the Resolver interface
</span><span class="c1"></span><span class="kd">type</span><span class=""> </span><span class="nx">resolver</span><span class=""> </span><span class="kd">struct</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nx">sb</span><span class="">         </span><span class="o">*</span><span class="nx">sandbox</span><span class="">
</span><span class="">    </span><span class="nx">extDNSList</span><span class=""> </span><span class="p">[</span><span class="nx">maxExtDNS</span><span class="p">]</span><span class="nx">extDNSEntry</span><span class="">
</span><span class="">    </span><span class="nx">server</span><span class="">     </span><span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="">
</span><span class="">    </span><span class="nx">conn</span><span class="">       </span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPConn</span><span class="">
</span><span class="">    </span><span class="nx">tcpServer</span><span class="">  </span><span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="">
</span><span class="">    </span><span class="nx">tcpListen</span><span class="">  </span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPListener</span><span class="">
</span><span class="">    </span><span class="nx">err</span><span class="">        </span><span class="kt">error</span><span class="">
</span><span class="">    </span><span class="nx">count</span><span class="">      </span><span class="kt">int32</span><span class="">
</span><span class="">    </span><span class="nx">tStamp</span><span class="">     </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="">
</span><span class="">    </span><span class="nx">queryLock</span><span class="">  </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1">// Resolver represents the embedded DNS server in Docker. It operates
</span><span class="c1">// by listening on container&#39;s loopback interface for DNS queries.
</span><span class="c1"></span><span class="kd">type</span><span class=""> </span><span class="nx">Resolver</span><span class=""> </span><span class="kd">interface</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="c1">// Start starts the name server for the container
</span><span class="c1"></span><span class="">    </span><span class="nx">Start</span><span class="p">()</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">    </span><span class="c1">// Stop stops the name server for the container. Stopped resolver
</span><span class="c1"></span><span class="">    </span><span class="c1">// can be reused after running the SetupFunc again.
</span><span class="c1"></span><span class="">    </span><span class="nx">Stop</span><span class="p">()</span><span class="">
</span><span class="">    </span><span class="c1">// SetupFunc() provides the setup function that should be run
</span><span class="c1"></span><span class="">    </span><span class="c1">// in the container&#39;s network namespace.
</span><span class="c1"></span><span class="">    </span><span class="nx">SetupFunc</span><span class="p">()</span><span class=""> </span><span class="kd">func</span><span class="p">()</span><span class="">
</span><span class="">    </span><span class="c1">// NameServer() returns the IP of the DNS resolver for the
</span><span class="c1"></span><span class="">    </span><span class="c1">// containers.
</span><span class="c1"></span><span class="">    </span><span class="nx">NameServer</span><span class="p">()</span><span class=""> </span><span class="kt">string</span><span class="">
</span><span class="">    </span><span class="c1">// SetExtServers configures the external nameservers the resolver
</span><span class="c1"></span><span class="">    </span><span class="c1">// should use to forward queries
</span><span class="c1"></span><span class="">    </span><span class="nx">SetExtServers</span><span class="p">([]</span><span class="kt">string</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="c1">// ResolverOptions returns resolv.conf options that should be set
</span><span class="c1"></span><span class="">    </span><span class="nx">ResolverOptions</span><span class="p">()</span><span class=""> </span><span class="p">[]</span><span class="kt">string</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>可见，resolver就是embedded DNS server，每个resolver都bind一个sandbox，并定义了一个对应的dns.Server，还定义了外部DNS对象列表，但embedded DNS server无法解析某个name时，就会forward到那些外部DNS。</p>

<p>Resolver Interface定义了embedded DNS server必须实现的接口，这里会重点关注SetupFunc()和Start()，见下文分析。</p>

<blockquote>
<p>dns.Server的实现，全部交给github.com/miekg/dns，限于篇幅，这里我将不会跟进去分析。</p>
</blockquote>

<p>从整个<a href="http://lib.csdn.net/base/docker">Container</a> create的流程上来看，docker daemon对embedded DNS server的处理是从endpoint Join a sandbox开始的:</p>

<pre><code>libnetwork/endpoint.go


func (ep *endpoint) Join(sbox Sandbox, options ...EndpointOption) error {
    ...

    return ep.sbJoin(sb, options...)
}


func (ep *endpoint) sbJoin(sb *sandbox, options ...EndpointOption) error {
    ...

    if err = sb.populateNetworkResources(ep); err != nil {
        return err
    }

    ...
}
</code></pre>

<p>sandbox join a sandbox的流程中，会调用sandbox. populateNetworkResources做网络资源的设置，这其中就包括了embedded DNS server的启动。</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">sandbox</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">sb</span><span class=""> </span><span class="o">*</span><span class="nx">sandbox</span><span class="p">)</span><span class=""> </span><span class="nx">populateNetworkResources</span><span class="p">(</span><span class="nx">ep</span><span class=""> </span><span class="o">*</span><span class="nx">endpoint</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class="">    </span><span class="k">if</span><span class=""> </span><span class="nx">ep</span><span class="p">.</span><span class="nx">needResolver</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="nx">sb</span><span class="p">.</span><span class="nx">startResolver</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class="">
</span><span class=""></span><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">sandbox_dns_unix</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">sb</span><span class=""> </span><span class="o">*</span><span class="nx">sandbox</span><span class="p">)</span><span class=""> </span><span class="nx">startResolver</span><span class="p">(</span><span class="nx">restore</span><span class=""> </span><span class="kt">bool</span><span class="p">)</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolverOnce</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="kd">var</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">        </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">NewResolver</span><span class="p">(</span><span class="nx">sb</span><span class="p">)</span><span class="">
</span><span class="">        </span><span class="k">defer</span><span class=""> </span><span class="kd">func</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">            </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">                </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class="">            </span><span class="p">}</span><span class="">
</span><span class="">        </span><span class="p">}()</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="c1">// In the case of live restore container is already running with
</span><span class="c1"></span><span class="">        </span><span class="c1">// right resolv.conf contents created before. Just update the
</span><span class="c1"></span><span class="">        </span><span class="c1">// external DNS servers from the restored sandbox for embedded
</span><span class="c1"></span><span class="">        </span><span class="c1">// server to use.
</span><span class="c1"></span><span class="">        </span><span class="k">if</span><span class=""> </span><span class="p">!</span><span class="nx">restore</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">            </span><span class="nx">err</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">sb</span><span class="p">.</span><span class="nx">rebuildDNS</span><span class="p">()</span><span class="">
</span><span class="">            </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&#34;Updating resolv.conf failed for container %s, %q&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">sb</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">(),</span><span class=""> </span><span class="nx">err</span><span class="p">)</span><span class="">
</span><span class="">                </span><span class="k">return</span><span class="">
</span><span class="">            </span><span class="p">}</span><span class="">
</span><span class="">        </span><span class="p">}</span><span class="">
</span><span class="">        </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">SetExtServers</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">extDNS</span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="nx">sb</span><span class="p">.</span><span class="nx">osSbox</span><span class="p">.</span><span class="nx">InvokeFunc</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">SetupFunc</span><span class="p">())</span><span class="">
</span><span class="">        </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Start</span><span class="p">();</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&#34;Resolver Setup/Start failed for container %s, %q&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">sb</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">(),</span><span class=""> </span><span class="nx">err</span><span class="p">)</span><span class="">
</span><span class="">        </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="p">})</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>sandbox.startResolver是流程关键:</p>

<ul>
<li>通过sanbdox.rebuildDNS生成了container内的/etc/resolv.conf</li>
<li>通过resolver.SetExtServers(sb.extDNS)设置embedded DNS server的forward DNS list</li>
<li>通过resolver.SetupFunc()启动两个随机可用端口作为embedded DNS server（127.0.0.11）的TCP和UDP Linstener</li>
<li>通过resolver.Start()对容器内的iptable进行设置(见下)，并通过miekg/dns启动一个nameserver在53端口提供服务。</li>
</ul>

<p>下面我将逐一介绍上面的各个步骤。</p>

<h3 id="sanbdox-rebuilddns">sanbdox.rebuildDNS</h3>

<p>sanbdox.rebuildDNS负责构建容器内的resolv.conf，构建规则就是第一节江参数配置时候提到的：</p>

<ul>
<li>Save the external name servers in resolv.conf in the sandbox</li>
<li>Add only the embedded server’s IP to container’s resolv.conf</li>
<li>If the embedded server needs any resolv.conf options add it to the current list</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">sandbox_dns_unix</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">sb</span><span class=""> </span><span class="o">*</span><span class="nx">sandbox</span><span class="p">)</span><span class=""> </span><span class="nx">rebuildDNS</span><span class="p">()</span><span class=""> </span><span class="kt">error</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nx">currRC</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">GetSpecific</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">resolvConfPath</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="k">return</span><span class=""> </span><span class="nx">err</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="c1">// localhost entries have already been filtered out from the list
</span><span class="c1"></span><span class="">    </span><span class="c1">// retain only the v4 servers in sb for forwarding the DNS queries
</span><span class="c1"></span><span class="">    </span><span class="nx">sb</span><span class="p">.</span><span class="nx">extDNS</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">GetNameservers</span><span class="p">(</span><span class="nx">currRC</span><span class="p">.</span><span class="nx">Content</span><span class="p">,</span><span class=""> </span><span class="nx">types</span><span class="p">.</span><span class="nx">IPv4</span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="kd">var</span><span class=""> </span><span class="p">(</span><span class="">
</span><span class="">        </span><span class="nx">dnsList</span><span class="">        </span><span class="p">=</span><span class=""> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">NameServer</span><span class="p">()}</span><span class="">
</span><span class="">        </span><span class="nx">dnsOptionsList</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">(</span><span class="nx">currRC</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span><span class="">
</span><span class="">        </span><span class="nx">dnsSearchList</span><span class="">  </span><span class="p">=</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">GetSearchDomains</span><span class="p">(</span><span class="nx">currRC</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="nx">dnsList</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nb">append</span><span class="p">(</span><span class="nx">dnsList</span><span class="p">,</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">GetNameservers</span><span class="p">(</span><span class="nx">currRC</span><span class="p">.</span><span class="nx">Content</span><span class="p">,</span><span class=""> </span><span class="nx">types</span><span class="p">.</span><span class="nx">IPv6</span><span class="p">)</span><span class="o">...</span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="nx">resOptions</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">sb</span><span class="p">.</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolverOptions</span><span class="p">()</span><span class="">
</span><span class="">
</span><span class=""></span><span class="nx">dnsOpt</span><span class="p">:</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class="">    </span><span class="nx">dnsOptionsList</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nb">append</span><span class="p">(</span><span class="nx">dnsOptionsList</span><span class="p">,</span><span class=""> </span><span class="nx">resOptions</span><span class="o">...</span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="nx">_</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">resolvconf</span><span class="p">.</span><span class="nx">Build</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">resolvConfPath</span><span class="p">,</span><span class=""> </span><span class="nx">dnsList</span><span class="p">,</span><span class=""> </span><span class="nx">dnsSearchList</span><span class="p">,</span><span class=""> </span><span class="nx">dnsOptionsList</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="k">return</span><span class=""> </span><span class="nx">err</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<h3 id="resolver-setextservers">resolver.SetExtServers</h3>

<p>设置embedded DNS server的forward DNS list, 当embedded DNS server不能解析某name时，就会将请求forward到ExtServers。代码很简单，不多废话。</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">resolver</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">resolver</span><span class="p">)</span><span class=""> </span><span class="nx">SetExtServers</span><span class="p">(</span><span class="nx">dns</span><span class=""> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nx">l</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nb">len</span><span class="p">(</span><span class="nx">dns</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="k">if</span><span class=""> </span><span class="nx">l</span><span class=""> </span><span class="p">&gt;</span><span class=""> </span><span class="nx">maxExtDNS</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="nx">l</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">maxExtDNS</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="k">for</span><span class=""> </span><span class="nx">i</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="mi">0</span><span class="p">;</span><span class=""> </span><span class="nx">i</span><span class=""> </span><span class="p">&lt;</span><span class=""> </span><span class="nx">l</span><span class="p">;</span><span class=""> </span><span class="nx">i</span><span class="o">++</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">extDNSList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ipStr</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">dns</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<h3 id="resolver-setupfunc">resolver.SetupFunc</h3>

<p>启动两个随机可用端口作为embedded DNS server（127.0.0.11）的TCP和UDP Linstener。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">libnetwork</span><span class="o">/</span><span class="nx">resolver</span><span class="p">.</span><span class="k">go</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">resolver</span><span class="p">)</span><span class=""> </span><span class="nx">SetupFunc</span><span class="p">()</span><span class=""> </span><span class="kd">func</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="k">return</span><span class=""> </span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="kd">var</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="c1">// DNS operates primarily on UDP
</span><span class="c1"></span><span class="">        </span><span class="nx">addr</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span><span class="">
</span><span class="">            </span><span class="nx">IP</span><span class="p">:</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">ParseIP</span><span class="p">(</span><span class="nx">resolverIP</span><span class="p">),</span><span class="">
</span><span class="">        </span><span class="p">}</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">ListenUDP</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">addr</span><span class="p">)</span><span class="">
</span><span class="">        </span><span class="o">...</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="c1">// Listen on a TCP as well
</span><span class="c1"></span><span class="">        </span><span class="nx">tcpaddr</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPAddr</span><span class="p">{</span><span class="">
</span><span class="">            </span><span class="nx">IP</span><span class="p">:</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">ParseIP</span><span class="p">(</span><span class="nx">resolverIP</span><span class="p">),</span><span class="">
</span><span class="">        </span><span class="p">}</span><span class="">
</span><span class="">
</span><span class="">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">tcpListen</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">ListenTCP</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">tcpaddr</span><span class="p">)</span><span class="">
</span><span class="">        </span><span class="o">...</span><span class="">
</span><span class="">    </span><span class="p">})</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<h3 id="resolver-start">resolver.Start</h3>

<p>resolver.Start中两个重要步骤，分别是：</p>

<ul>
<li>setupIPTable设置容器内的iptables</li>
<li>启动dns nameserver在53端口开始提供域名解析服务</li>
</ul>

<pre><code>func (r *resolver) Start() error {
    ...
    if err := r.setupIPTable(); err != nil {
        return fmt.Errorf(&quot;setting up IP table rules failed: %v&quot;, err)
    }
    ...
    tcpServer := &amp;dns.Server{Handler: r, Listener: r.tcpListen}
    r.tcpServer = tcpServer
    go func() {
        tcpServer.ActivateAndServe()
    }()
    return nil
}
</code></pre>

<p>先来看看怎么设置容器内的iptables的：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">resolver</span><span class="p">)</span><span class=""> </span><span class="nx">setupIPTable</span><span class="p">()</span><span class=""> </span><span class="kt">error</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class="">    </span><span class="c1">// 获取setupFunc()时的两个本地随机监听端口
</span><span class="c1"></span><span class="">    </span><span class="nx">laddr</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">LocalAddr</span><span class="p">().</span><span class="nx">String</span><span class="p">()</span><span class="">
</span><span class="">    </span><span class="nx">ltcpaddr</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">tcpListen</span><span class="p">.</span><span class="nx">Addr</span><span class="p">().</span><span class="nx">String</span><span class="p">()</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="nx">cmd</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="o">&amp;</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="nx">Path</span><span class="p">:</span><span class="">   </span><span class="nx">reexec</span><span class="p">.</span><span class="nx">Self</span><span class="p">(),</span><span class="">
</span><span class="">        </span><span class="c1">// 将这两个端口传给setup-resolver命令并启动执行
</span><span class="c1"></span><span class="">        </span><span class="nx">Args</span><span class="p">:</span><span class="">   </span><span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;setup-resolver&#34;</span><span class="p">},</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">sb</span><span class="p">.</span><span class="nx">Key</span><span class="p">(),</span><span class=""> </span><span class="nx">laddr</span><span class="p">,</span><span class=""> </span><span class="nx">ltcpaddr</span><span class="p">),</span><span class="">
</span><span class="">        </span><span class="nx">Stdout</span><span class="p">:</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span><span class="">
</span><span class="">        </span><span class="nx">Stderr</span><span class="p">:</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">();</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="k">return</span><span class=""> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&#34;reexec failed: %v&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class="p">)</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="k">return</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1">// init时就注册setup-resolver对应的handler
</span><span class="c1"></span><span class="kd">func</span><span class=""> </span><span class="nx">init</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nx">reexec</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="s">&#34;setup-resolver&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">reexecSetupResolver</span><span class="p">)</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1">// setup-resolver对应的handler定义
</span><span class="c1"></span><span class="kd">func</span><span class=""> </span><span class="nx">reexecSetupResolver</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class="">    </span><span class="c1">// 封装iptables数据
</span><span class="c1"></span><span class="">    </span><span class="nx">_</span><span class="p">,</span><span class=""> </span><span class="nx">ipPort</span><span class="p">,</span><span class=""> </span><span class="nx">_</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="">
</span><span class="">    </span><span class="nx">_</span><span class="p">,</span><span class=""> </span><span class="nx">tcpPort</span><span class="p">,</span><span class=""> </span><span class="nx">_</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="">
</span><span class="">    </span><span class="nx">rules</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="p">[][]</span><span class="kt">string</span><span class="p">{</span><span class="">
</span><span class="">        </span><span class="p">{</span><span class="s">&#34;-t&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;nat&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-I&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">outputChain</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-d&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">resolverIP</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-p&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;udp&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--dport&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">dnsPort</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-j&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;DNAT&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--to-destination&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">]},</span><span class="">
</span><span class="">        </span><span class="p">{</span><span class="s">&#34;-t&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;nat&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-I&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">postroutingchain</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-s&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">resolverIP</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-p&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;udp&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--sport&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">ipPort</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-j&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;SNAT&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--to-source&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;:&#34;</span><span class=""> </span><span class="o">+</span><span class=""> </span><span class="nx">dnsPort</span><span class="p">},</span><span class="">
</span><span class="">        </span><span class="p">{</span><span class="s">&#34;-t&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;nat&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-I&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">outputChain</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-d&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">resolverIP</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-p&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;tcp&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--dport&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">dnsPort</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-j&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;DNAT&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--to-destination&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">]},</span><span class="">
</span><span class="">        </span><span class="p">{</span><span class="s">&#34;-t&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;nat&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-I&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">postroutingchain</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-s&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">resolverIP</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-p&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;tcp&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--sport&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">tcpPort</span><span class="p">,</span><span class=""> </span><span class="s">&#34;-j&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;SNAT&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;--to-source&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;:&#34;</span><span class=""> </span><span class="o">+</span><span class=""> </span><span class="nx">dnsPort</span><span class="p">},</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">    </span><span class="o">...</span><span class="">
</span><span class="">
</span><span class="">    </span><span class="c1">// insert outputChain and postroutingchain
</span><span class="c1"></span><span class="">    </span><span class="o">...</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>在reexecSetupResolver()中清楚的定义了iptables添加outputChain 和postroutingchain，将到容器内的dns query请求重定向到embedded DNS server(127.0.0.11)上的udp/tcp两个随机可用端口，embedded DNS server(127.0.0.11)的返回数据则重定向到容器内的53端口，这样完成了整个dns query请求。</p>

<p>模型图如下： 
<img src="http://img.blog.csdn.net/20170105215440792?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" /></p>

<p>贴一张实例图： 
<img src="http://img.blog.csdn.net/20170105215310369?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" /></p>

<p><img src="http://img.blog.csdn.net/20170105215322635?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" /></p>

<p>到这里，关于embedded DNS server的源码分析就结束了。当然，其中还有很多细节，就留给读者自己走读代码了。</p>

<h2 id="福利">福利</h2>

<p>从该时序图中看看embedded DNS server的操作在整个容器create流程中的位置。
<img src="http://img.blog.csdn.net/20170105215401307?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" /></p>

            </article>
             
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Mon Feb 27, 2017 </h4>
        <h5 id="wc"> 4700 Words </h5>
        <h5 id="readtime"> Read in about 10 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/docker">docker</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/network">network</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/dns">dns</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/docker-service-discovery/"><i class="icon-arrow-left"></i> Docker Service Discovery</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/raft/">Raft一致性算法 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="4659">
<meta itemprop="datePublished" content="2017-02-27">
<meta itemprop="url" content="https://jimmysong.io/blogs/docker-embedded-dns/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
