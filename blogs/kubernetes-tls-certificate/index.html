<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, CA, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes安装之证书验证 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-tls-certificate/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-10"/>
<meta property="article:modified_time" content="2017-04-10"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="CA">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes安装之证书验证 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes安装之证书验证 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-tls-certificate/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8b%e8%af%81%e4%b9%a6%e9%aa%8c%e8%af%81-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f&title=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8b%e8%af%81%e4%b9%a6%e9%aa%8c%e8%af%81&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-tls-certificate%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes安装之证书验证</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2014082502.jpg" alt="颐和园" /></p>

<p><em>（题图：铜牛@颐和园 Aug 25,2014）</em></p>

<h2 id="前言">前言</h2>

<p>昨晚（Apr 9,2017）金山软件的<a href="https://github.com/opsnull">opsnull</a>发布了一个开源项目<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>，下文是结合我<a href="http://rootsongjc.github.io/tags/kubernetes/">之前部署kubernetes的过程</a>打造的kubernetes环境和opsnull的文章<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/01-TLS%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%98%E9%92%A5.md">创建 kubernetes 各组件 TLS 加密通信的证书和秘钥</a>的实践。之前安装过程中一直使用的是非加密方式，一直到后来<a href="http://rootsongjc.github.io/blogs/kubernetes-fluentd-elasticsearch-installation/">使用Fluentd和ElasticSearch收集Kubernetes集群日志</a>时发现有权限验证问题，所以为了深入研究kubernentes。</p>

<h2 id="kubernentes中的身份验证">Kubernentes中的身份验证</h2>

<p><code>kubernetes</code> 系统的各组件需要使用 <code>TLS</code> 证书对通信进行加密，本文档使用 <code>CloudFlare</code> 的 PKI 工具集 <a href="https://github.com/cloudflare/cfssl">cfssl</a> 来生成 Certificate Authority (CA) 和其它证书；</p>

<p><strong>生成的 CA 证书和秘钥文件如下：</strong></p>

<ul>
<li>ca-key.pem</li>
<li>ca.pem</li>
<li>kubernetes-key.pem</li>
<li>kubernetes.pem</li>
<li>kube-proxy.pem</li>
<li>kube-proxy-key.pem</li>
<li>admin.pem</li>
<li>admin-key.pem</li>
</ul>

<p><strong>使用证书的组件如下：</strong></p>

<ul>
<li>etcd：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kube-apiserver：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kubelet：使用 ca.pem；</li>
<li>kube-proxy：使用 ca.pem、kube-proxy-key.pem、kube-proxy.pem；</li>
<li>kubectl：使用 ca.pem、admin-key.pem、admin.pem；</li>
</ul>

<p><code>kube-controller</code>、<code>kube-scheduler</code> 当前需要和 <code>kube-apiserver</code> 部署在同一台机器上且使用非安全端口通信，故不需要证书。</p>

<h2 id="安装-cfssl">安装 <code>CFSSL</code></h2>

<p><strong>方式一：直接使用二进制源码包安装</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
</span><span class="">$ chmod +x cfssl_linux-amd64
</span><span class="">$ sudo mv cfssl_linux-amd64 /root/local/bin/cfssl
</span><span class="">
</span><span class="">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
</span><span class="">$ chmod +x cfssljson_linux-amd64
</span><span class="">$ sudo mv cfssljson_linux-amd64 /root/local/bin/cfssljson
</span><span class="">
</span><span class="">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
</span><span class="">$ chmod +x cfssl-certinfo_linux-amd64
</span><span class="">$ sudo mv cfssl-certinfo_linux-amd64 /root/local/bin/cfssl-certinfo
</span><span class="">
</span><span class="">$ </span><span class="nb">export</span><span class=""> </span><span class="nv">PATH</span><span class=""></span><span class="o">=</span><span class="">/root/local/bin:</span><span class="nv">$PATH</span></code></pre>
</div>
<p><strong>方式二：使用go命令安装</strong></p>

<p>我们的系统中安装了Go1.7.5，使用以下命令安装更快捷：</p>

<pre><code>$go get -u github.com/cloudflare/cfssl/cmd/...
$echo $GOPATH
/usr/local
$ls /usr/local/bin/cfssl*
cfssl cfssl-bundle cfssl-certinfo cfssljson cfssl-newkey cfssl-scan
</code></pre>

<p>在<code>$GOPATH/bin</code>目录下得到以cfssl开头的几个命令。</p>

<h2 id="创建-ca-certificate-authority">创建 CA (Certificate Authority)</h2>

<p><strong>创建 CA 配置文件</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ mkdir /root/ssl
</span><span class="">$ </span><span class="nb">cd</span><span class=""> /root/ssl
</span><span class="">$ cfssl print-defaults config &gt; config.json
</span><span class="">$ cfssl print-defaults csr &gt; csr.json
</span><span class="">$ cat ca-config.json
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;signing&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;default&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;expiry&#34;</span><span class="">: </span><span class="s2">&#34;8760h&#34;</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;profiles&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;kubernetes&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;usages&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">            </span><span class="s2">&#34;signing&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;key encipherment&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;server auth&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;client auth&#34;</span><span class="">
</span><span class="">        </span><span class="o">]</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;expiry&#34;</span><span class="">: </span><span class="s2">&#34;8760h&#34;</span><span class="">
</span><span class="">      </span><span class="o">}</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">}</span></code></pre>
</div>
<p>字段说明</p>

<ul>
<li><code>ca-config.json</code>：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li><code>signing</code>：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 <code>CA=TRUE</code>；</li>
<li><code>server auth</code>：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li><code>client auth</code>：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>

<p><strong>创建 CA 证书签名请求</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cat ca-csr.json
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;CN&#34;</span><span class="">: </span><span class="s2">&#34;kubernetes&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;key&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;algo&#34;</span><span class="">: </span><span class="s2">&#34;rsa&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;size&#34;</span><span class="">: </span><span class="m">2048</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;C&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;ST&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;L&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;O&#34;</span><span class="">: </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;OU&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">
</span><span class="">  </span><span class="o">]</span><span class="">
</span><span class=""></span><span class="o">}</span></code></pre>
</div>
<ul>
<li>&ldquo;CN&rdquo;：<code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>&ldquo;O&rdquo;：<code>Organization</code>，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>

<p><strong>生成 CA 证书和私钥</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl gencert -initca ca-csr.json </span><span class="p">|</span><span class=""> cfssljson -bare ca
</span><span class="">$ ls ca*
</span><span class="">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span></code></pre>
</div>
<h2 id="创建-kubernetes-证书">创建 kubernetes 证书</h2>

<p>创建 kubernetes 证书签名请求</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cat kubernetes-csr.json
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;CN&#34;</span><span class="">: </span><span class="s2">&#34;kubernetes&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;hosts&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">      </span><span class="s2">&#34;127.0.0.1&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;172.20.0.112&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;172.20.0.113&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;172.20.0.114&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;172.20.0.115&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;10.254.0.1&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes.default&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes.default.svc&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes.default.svc.cluster&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes.default.svc.cluster.local&#34;</span><span class="">
</span><span class="">    </span><span class="o">]</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;key&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;algo&#34;</span><span class="">: </span><span class="s2">&#34;rsa&#34;</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;size&#34;</span><span class="">: </span><span class="m">2048</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">        </span><span class="o">{</span><span class="">
</span><span class="">            </span><span class="s2">&#34;C&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;ST&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;L&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;O&#34;</span><span class="">: </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">            </span><span class="s2">&#34;OU&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">
</span><span class="">        </span><span class="o">}</span><span class="">
</span><span class="">    </span><span class="o">]</span><span class="">
</span><span class=""></span><span class="o">}</span></code></pre>
</div>
<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 <strong>IP 或域名列表</strong>，由于该证书后续被 <code>etcd</code> 集群和 <code>kubernetes master</code> 集群使用，所以上面分别指定了 <code>etcd</code> 集群、<code>kubernetes master</code> 集群的主机 IP 和 <strong><code>kubernetes</code> 服务的服务 IP</strong>（一般是 <code>kue-apiserver</code> 指定的 <code>service-cluster-ip-range</code> 网段的第一个IP，如 10.254.0.1。</li>
</ul>

<p><strong>生成 kubernetes 证书和私钥</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl gencert -ca</span><span class="o">=</span><span class="">ca.pem -ca-key</span><span class="o">=</span><span class="">ca-key.pem -config</span><span class="o">=</span><span class="">ca-config.json -profile</span><span class="o">=</span><span class="">kubernetes kubernetes-csr.json </span><span class="p">|</span><span class=""> cfssljson -bare kubernetes
</span><span class="">$ ls kuberntes*
</span><span class="">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</span></code></pre>
</div>
<p>或者直接在命令行上指定相关参数：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="nb">echo</span><span class=""> </span><span class="s1">&#39;{&#34;CN&#34;:&#34;kubernetes&#34;,&#34;hosts&#34;:[&#34;&#34;],&#34;key&#34;:{&#34;algo&#34;:&#34;rsa&#34;,&#34;size&#34;:2048}}&#39;</span><span class=""> </span><span class="p">|</span><span class=""> cfssl gencert -ca</span><span class="o">=</span><span class="">ca.pem -ca-key</span><span class="o">=</span><span class="">ca-key.pem -config</span><span class="o">=</span><span class="">ca-config.json -profile</span><span class="o">=</span><span class="">kubernetes -hostname</span><span class="o">=</span><span class="s2">&#34;127.0.0.1,10.64.3.7,10.254.0.1,kubernetes,kubernetes.default&#34;</span><span class=""> - </span><span class="p">|</span><span class=""> cfssljson -bare kubernetes</span></code></pre>
</div>
<h2 id="创建-admin-证书">创建 admin 证书</h2>

<p>创建 admin 证书签名请求</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cat admin-csr.json
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;CN&#34;</span><span class="">: </span><span class="s2">&#34;admin&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;hosts&#34;</span><span class="">: </span><span class="o">[]</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;key&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;algo&#34;</span><span class="">: </span><span class="s2">&#34;rsa&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;size&#34;</span><span class="">: </span><span class="m">2048</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;C&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;ST&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;L&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;O&#34;</span><span class="">: </span><span class="s2">&#34;system:masters&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;OU&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">
</span><span class="">  </span><span class="o">]</span><span class="">
</span><span class=""></span><span class="o">}</span></code></pre>
</div>
<ul>
<li>后续 <code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权；</li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 的<strong>所有 API</strong>的权限；</li>
<li>OU 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限；</li>
</ul>

<p>生成 admin 证书和私钥</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl gencert -ca</span><span class="o">=</span><span class="">ca.pem -ca-key</span><span class="o">=</span><span class="">ca-key.pem -config</span><span class="o">=</span><span class="">ca-config.json -profile</span><span class="o">=</span><span class="">kubernetes admin-csr.json </span><span class="p">|</span><span class=""> cfssljson -bare admin
</span><span class="">$ ls admin*
</span><span class="">admin.csr  admin-csr.json  admin-key.pem  admin.pem</span></code></pre>
</div>
<h2 id="创建-kube-proxy-证书">创建 kube-proxy 证书</h2>

<p>创建 kube-proxy 证书签名请求</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cat kube-proxy-csr.json
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;CN&#34;</span><span class="">: </span><span class="s2">&#34;system:kube-proxy&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;hosts&#34;</span><span class="">: </span><span class="o">[]</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;key&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;algo&#34;</span><span class="">: </span><span class="s2">&#34;rsa&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;size&#34;</span><span class="">: </span><span class="m">2048</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;C&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;ST&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;L&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;O&#34;</span><span class="">: </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;OU&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">
</span><span class="">  </span><span class="o">]</span><span class="">
</span><span class=""></span><span class="o">}</span></code></pre>
</div>
<ul>
<li>CN 指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li><code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
</ul>

<p>生成 kube-proxy 客户端证书和私钥</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl gencert -ca</span><span class="o">=</span><span class="">ca.pem -ca-key</span><span class="o">=</span><span class="">ca-key.pem -config</span><span class="o">=</span><span class="">ca-config.json -profile</span><span class="o">=</span><span class="">kubernetes  kube-proxy-csr.json </span><span class="p">|</span><span class=""> cfssljson -bare kube-proxy
</span><span class="">$ ls kube-proxy*
</span><span class="">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</span></code></pre>
</div>
<h2 id="校验证书">校验证书</h2>

<p>以 kubernetes 证书为例</p>

<h3 id="使用-opsnssl-命令">使用 <code>opsnssl</code> 命令</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ openssl x509  -noout -text -in  kubernetes.pem
</span><span class="">...
</span><span class="">    Signature Algorithm: sha256WithRSAEncryption
</span><span class="">        Issuer: </span><span class="nv">C</span><span class=""></span><span class="o">=</span><span class="">CN, </span><span class="nv">ST</span><span class=""></span><span class="o">=</span><span class="">BeiJing, </span><span class="nv">L</span><span class=""></span><span class="o">=</span><span class="">BeiJing, </span><span class="nv">O</span><span class=""></span><span class="o">=</span><span class="">k8s, </span><span class="nv">OU</span><span class=""></span><span class="o">=</span><span class="">System, </span><span class="nv">CN</span><span class=""></span><span class="o">=</span><span class="">Kubernetes
</span><span class="">        Validity
</span><span class="">            Not Before: Apr  </span><span class="m">5</span><span class=""> </span><span class="m">05</span><span class="">:36:00 </span><span class="m">2017</span><span class=""> GMT
</span><span class="">            Not After : Apr  </span><span class="m">5</span><span class=""> </span><span class="m">05</span><span class="">:36:00 </span><span class="m">2018</span><span class=""> GMT
</span><span class="">        Subject: </span><span class="nv">C</span><span class=""></span><span class="o">=</span><span class="">CN, </span><span class="nv">ST</span><span class=""></span><span class="o">=</span><span class="">BeiJing, </span><span class="nv">L</span><span class=""></span><span class="o">=</span><span class="">BeiJing, </span><span class="nv">O</span><span class=""></span><span class="o">=</span><span class="">k8s, </span><span class="nv">OU</span><span class=""></span><span class="o">=</span><span class="">System, </span><span class="nv">CN</span><span class=""></span><span class="o">=</span><span class="">kubernetes
</span><span class="">...
</span><span class="">        X509v3 extensions:
</span><span class="">            X509v3 Key Usage: critical
</span><span class="">                Digital Signature, Key Encipherment
</span><span class="">            X509v3 Extended Key Usage:
</span><span class="">                TLS Web Server Authentication, TLS Web Client Authentication
</span><span class="">            X509v3 Basic Constraints: critical
</span><span class="">                CA:FALSE
</span><span class="">            X509v3 Subject Key Identifier:
</span><span class="">                DD:52:04:43:10:13:A9:29:24:17:3A:0E:D7:14:DB:36:F8:6C:E0:E0
</span><span class="">            X509v3 Authority Key Identifier:
</span><span class="">                keyid:44:04:3B:60:BD:69:78:14:68:AF:A0:41:13:F6:17:07:13:63:58:CD
</span><span class="">
</span><span class="">            X509v3 Subject Alternative Name:
</span><span class="">                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:172.20.0.112, IP Address:172.20.0.113, IP Address:172.20.0.114, IP Address:172.20.0.115, IP Address:10.254.0.1
</span><span class="">...</span></code></pre>
</div>
<ul>
<li>确认 <code>Issuer</code> 字段的内容和 <code>ca-csr.json</code> 一致；</li>
<li>确认 <code>Subject</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Subject Alternative Name</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Key Usage、Extended Key Usage</code> 字段的内容和 <code>ca-config.json</code> 中 <code>kubernetes</code> profile 一致；</li>
</ul>

<h3 id="使用-cfssl-certinfo-命令">使用 <code>cfssl-certinfo</code> 命令</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl-certinfo -cert kubernetes.pem
</span><span class="">...
</span><span class=""></span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;subject&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;common_name&#34;</span><span class="">: </span><span class="s2">&#34;kubernetes&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;country&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;organization&#34;</span><span class="">: </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;organizational_unit&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;locality&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;province&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">      </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;System&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;kubernetes&#34;</span><span class="">
</span><span class="">    </span><span class="o">]</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;issuer&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">    </span><span class="s2">&#34;common_name&#34;</span><span class="">: </span><span class="s2">&#34;Kubernetes&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;country&#34;</span><span class="">: </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;organization&#34;</span><span class="">: </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;organizational_unit&#34;</span><span class="">: </span><span class="s2">&#34;System&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;locality&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;province&#34;</span><span class="">: </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;names&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">      </span><span class="s2">&#34;CN&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;BeiJing&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;k8s&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;System&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;Kubernetes&#34;</span><span class="">
</span><span class="">    </span><span class="o">]</span><span class="">
</span><span class="">  </span><span class="o">}</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;serial_number&#34;</span><span class="">: </span><span class="s2">&#34;174360492872423263473151971632292895707129022309&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;sans&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="s2">&#34;kubernetes&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;kubernetes.default&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;kubernetes.default.svc&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;kubernetes.default.svc.cluster&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;kubernetes.default.svc.cluster.local&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;127.0.0.1&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;10.64.3.7&#34;</span><span class="">,
</span><span class="">    </span><span class="s2">&#34;10.254.0.1&#34;</span><span class="">
</span><span class="">  </span><span class="o">]</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;not_before&#34;</span><span class="">: </span><span class="s2">&#34;2017-04-05T05:36:00Z&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;not_after&#34;</span><span class="">: </span><span class="s2">&#34;2018-04-05T05:36:00Z&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;sigalg&#34;</span><span class="">: </span><span class="s2">&#34;SHA256WithRSA&#34;</span><span class="">,
</span><span class="">...</span></code></pre>
</div>
<h2 id="分发证书">分发证书</h2>

<p>将生成的证书和秘钥文件（后缀名为<code>.pem</code>）拷贝到所有机器的 <code>/etc/kubernetes/ssl</code> 目录下备用；</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ sudo mkdir -p /etc/kubernetes/ssl
</span><span class="">$ sudo cp *.pem /etc/kubernetes/ssl</span></code></pre>
</div>
<h2 id="参考">参考</h2>

<ul>
<li><a href="https://coreos.com/os/docs/latest/generate-self-signed-certificates.html">Generate self-signed certificates</a></li>
<li><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-certificate-authority.md">Setting up a Certificate Authority and Creating TLS Certificates</a></li>
<li><a href="https://blogs.msdn.microsoft.com/kaushal/2012/02/17/client-certificates-vs-server-certificates/">Client Certificates V/s Server Certificates</a></li>
<li><a href="http://blog.jobbole.com/104919/">数字证书及 CA 的扫盲介绍</a></li>
</ul>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-fluentd-elasticsearch-installation/">使用Fluentd和ElasticSearch收集Kubernetes集群日志</a></li>
                
                <li><a href="/blogs/kubernetes-configmap-introduction/">Kubernetes的ConfigMap解析</a></li>
                
                <li><a href="/blogs/kubernetes-heapster-installation/">Kubernetes heapster监控插件安装文档</a></li>
                
                <li><a href="/blogs/kubernetes-dashboard-installation/">Kubernetes Dashboard/Web UI安装全记录</a></li>
                
                <li><a href="/blogs/kubernetes-network-config/">Kubernetes基于flannel的网络配置</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Mon Apr 10, 2017 </h4>
        <h5 id="wc"> 2100 Words </h5>
        <h5 id="readtime"> Read in about 5 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/ca">CA</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/fabric8-introduction/"><i class="icon-arrow-left"></i> 开源微服务管理平台fabric8简介</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/cloud-computing-architecture-practice/">《云计算技术架构与实践（第二版）》读后感 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2095">
<meta itemprop="datePublished" content="2017-04-10">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-tls-certificate/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
