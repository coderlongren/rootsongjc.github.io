<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes的边缘节点配置 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-edge-node-configuration/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-09"/>
<meta property="article:modified_time" content="2017-05-09"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes的边缘节点配置 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes的边缘节点配置 - Jimmy Song </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-edge-node-configuration/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e7%9a%84%e8%be%b9%e7%bc%98%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f&title=Kubernetes%e7%9a%84%e8%be%b9%e7%bc%98%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-edge-node-configuration%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes的边缘节点配置</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170506086.jpg" alt="南屏晚钟" /></p>

<p><em>（题图：南屏晚钟@圆明园 May 6,2017）</em></p>

<h2 id="前言">前言</h2>

<p>为了配置kubernetes中的traefik ingress的高可用，对于kubernetes集群以外只暴露一个访问入口，需要使用keepalived排除单点问题。本文参考了<a href="https://github.com/kubernetes/contrib/tree/master/keepalived-vip">kube-keepalived-vip</a>，但并没有使用容器方式安装，而是直接在node节点上安装。</p>

<p>本文已同步到gitbook <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的第2章第5节。</p>

<h2 id="定义">定义</h2>

<p>首先解释下什么叫边缘节点（Edge Node），所谓的边缘节点即集群内部用来向集群外暴露服务能力的节点，集群外部的服务通过该节点来调用集群内部的服务，边缘节点是集群内外交流的一个Endpoint。</p>

<p><strong>边缘节点要考虑两个问题</strong></p>

<ul>
<li>边缘节点的高可用，不能有单点故障，否则整个kubernetes集群将不可用</li>
<li>对外的一致暴露端口，即只能有一个外网访问IP和端口</li>
</ul>

<h2 id="架构">架构</h2>

<p>为了满足边缘节点的以上需求，我们使用<a href="http://www.keepalived.org/">keepalived</a>来实现。</p>

<p>在Kubernetes集群外部配置nginx来访问边缘节点的VIP。</p>

<p>选择Kubernetes的三个node作为边缘节点，并安装keepalived。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/node-edge-arch.jpg" alt="边缘节点架构" /></p>

<h2 id="准备">准备</h2>

<p>复用kubernetes测试集群的三台主机。</p>

<p>172.20.0.113</p>

<p>172.20.0.114</p>

<p>172.20.0.115</p>

<h2 id="安装">安装</h2>

<p>使用keepalived管理VIP，VIP是使用IPVS创建的，<a href="http://www.linux-vs.org">IPVS</a>已经成为linux内核的模块，不需要安装</p>

<p>LVS的工作原理请参考：<a href="http://www.cnblogs.com/codebean/archive/2011/07/25/2116043.html">http://www.cnblogs.com/codebean/archive/2011/07/25/2116043.html</a></p>

<p>不使用镜像方式安装了，直接手动安装，指定三个节点为边缘节点（Edge node）。</p>

<p>因为我们的测试集群一共只有三个node，所有在在三个node上都要安装keepalived和ipvsadmin。</p>

<pre><code class="language-Shell">yum install keepalived ipvsadm
</code></pre>

<h2 id="配置说明">配置说明</h2>

<p>需要对原先的traefik ingress进行改造，从以Deployment方式启动改成DeamonSet。还需要指定一个与node在同一网段的IP地址作为VIP，我们指定成172.20.0.119，配置keepalived前需要先保证这个IP没有被分配。。</p>

<ul>
<li>Traefik以DaemonSet的方式启动</li>
<li>通过nodeSelector选择边缘节点</li>
<li>通过hostPort暴露端口</li>
<li>当前VIP漂移到了172.20.0.115上</li>
<li>Traefik根据访问的host和path配置，将流量转发到相应的service上</li>
</ul>

<h2 id="配置keepalived">配置keepalived</h2>

<p>参考<a href="http://limian.blog.51cto.com/7542175/1301776">基于keepalived 实现VIP转移，lvs，nginx的高可用</a>，配置keepalived。</p>

<p>keepalived的官方配置文档见：<a href="http://keepalived.org/pdf/UserGuide.pdf">http://keepalived.org/pdf/UserGuide.pdf</a></p>

<p>配置文件<code>/etc/keepalived/keepalived.conf</code>文件内容如下：</p>

<pre><code>! Configuration File for keepalived

global_defs {
   notification_email {
     root@localhost
   }
   notification_email_from kaadmin@localhost
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        172.20.0.119
    }
}

virtual_server 172.20.0.119 80{
    delay_loop 6
    lb_algo loadbalance
    lb_kind DR
    nat_mask 255.255.255.0
    persistence_timeout 0
    protocol TCP

    real_server 172.20.0.113 80{
        weight 1
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server 172.20.0.114 80{
        weight 1
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server 172.20.0.115 80{
        weight 1
        TCP_CHECK {
            connect_timeout 3
        }
    }
}
</code></pre>

<p><code>Realserver</code>的IP和端口即traefik供外网访问的IP和端口。</p>

<p>将以上配置分别拷贝到另外两台node的<code>/etc/keepalived</code>目录下。</p>

<p>我们使用转发效率最高的<code>lb_kind DR</code>直接路由方式转发，使用TCP_CHECK来检测real_server的health。</p>

<p><strong>启动keepalived</strong></p>

<pre><code>systemctl start keepalived
</code></pre>

<p>三台node都启动了keepalived后，观察eth0的IP，会在三台node的某一台上发现一个VIP是172.20.0.119。</p>

<pre><code class="language-bash">$ ip addr show eth0
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
    link/ether f4:e9:d4:9f:6b:a0 brd ff:ff:ff:ff:ff:ff
    inet 172.20.0.115/17 brd 172.20.127.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet 172.20.0.119/32 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre>

<p>关掉拥有这个VIP主机上的keepalived，观察VIP是否漂移到了另外两台主机的其中之一上。</p>

<h2 id="改造traefik">改造Traefik</h2>

<p>在这之前我们启动的traefik使用的是deployment，只启动了一个pod，无法保证高可用（即需要将pod固定在某一台主机上，这样才能对外提供一个唯一的访问地址），现在使用了keepalived就可以通过VIP来访问traefik，同时启动多个traefik的pod保证高可用。</p>

<p>配置文件<code>traefik.yaml</code>内容如下：</p>

<pre><code class="language-Yaml">apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: traefik-ingress-lb
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      restartPolicy: Always
      serviceAccountName: ingress
      containers:
      - image: traefik
        name: traefik-ingress-lb
        resources:
          limits:
            cpu: 200m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: admin
          containerPort: 8580
          hostPort: 8580
        args:
        - --web
        - --web.address=:8580
        - --kubernetes
      nodeSelector:
        edgenode: &quot;true&quot;
</code></pre>

<p>注意，我们使用了<code>nodeSelector</code>选择边缘节点来调度traefik-ingress-lb运行在它上面，所有你需要使用：</p>

<pre><code>kubectl label nodes 172.20.0.113 edgenode=true
kubectl label nodes 172.20.0.114 edgenode=true
kubectl label nodes 172.20.0.115 edgenode=true
</code></pre>

<p>给三个node打标签。</p>

<p>查看DaemonSet的启动情况：</p>

<pre><code class="language-Bash">$ kubectl -n kube-system get ds
NAME                 DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE-SELECTOR                              AGE
traefik-ingress-lb   3         3         3         3            3           edgenode=true                              2h
</code></pre>

<p>现在就可以在外网通过172.20.0.119:80来访问到traefik ingress了。</p>

<h2 id="参考">参考</h2>

<p><a href="https://github.com/kubernetes/contrib/tree/master/keepalived-vip">kube-keepalived-vip</a></p>

<p><a href="http://www.keepalived.org/">http://www.keepalived.org/</a></p>

<p><a href="http://outofmemory.cn/wiki/keepalived-configuration">keepalived工作原理与配置说明</a></p>

<p><a href="http://www.cnblogs.com/codebean/archive/2011/07/25/2116043.html">LVS简介及使用</a></p>

<p><a href="http://limian.blog.51cto.com/7542175/1301776">基于keepalived 实现VIP转移，lvs，nginx的高可用</a></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-with-glusterfs/">在kubernetes中使用glusterfs做持久化存储</a></li>
                
                <li><a href="/blogs/kubernetes-performance-test/">Kubernetes网络和集群性能测试</a></li>
                
                <li><a href="/blogs/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试</a></li>
                
                <li><a href="/blogs/ip-and-service-discovry-in-kubernetes/">Kubernetes中的IP和服务发现体系</a></li>
                
                <li><a href="/blogs/kubernetes-rbac-support/">Kubernetes中的RBAC支持</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue May 9, 2017 </h4>
        <h5 id="wc"> 2000 Words </h5>
        <h5 id="readtime"> Read in about 4 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-service-rolling-update/"><i class="icon-arrow-left"></i> Kubernetes中的Rolling Update服务滚动升级</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-with-glusterfs/">在kubernetes中使用glusterfs做持久化存储 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1940">
<meta itemprop="datePublished" content="2017-05-09">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-edge-node-configuration/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>
</body>

</html>