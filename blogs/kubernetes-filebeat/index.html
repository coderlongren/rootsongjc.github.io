<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="使用filebeat收集kubernetes中的应用日志 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-filebeat/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-17"/>
<meta property="article:modified_time" content="2017-05-17"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="使用filebeat收集kubernetes中的应用日志 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> 使用filebeat收集kubernetes中的应用日志 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-filebeat/">

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=%e4%bd%bf%e7%94%a8filebeat%e6%94%b6%e9%9b%86kubernetes%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8%e6%97%a5%e5%bf%97-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f&title=%e4%bd%bf%e7%94%a8filebeat%e6%94%b6%e9%9b%86kubernetes%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8%e6%97%a5%e5%bf%97&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-filebeat%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">使用filebeat收集kubernetes中的应用日志</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170514001.jpg" alt="民生美术馆" /></p>

<p><em>（题图：民生现代美术馆 May 14,2017）</em></p>

<h2 id="前言">前言</h2>

<p>本文已同步更新到Github仓库<a href="http://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中。</p>

<p>昨天写了篇文章<a href="http://rootsongjc.github.io/blogs/kubernetes-logstash/">使用Logstash收集Kubernetes的应用日志</a>，发现logstash十分消耗内存（大约500M），经人提醒改用filebeat（大约消耗10几M内存），因此重写一篇使用filebeat收集kubernetes中的应用日志。</p>

<p>在进行日志收集的过程中，我们首先想到的是使用Logstash，因为它是ELK stack中的重要成员，但是在测试过程中发现，Logstash是基于JDK的，在没有产生日志的情况单纯启动Logstash就大概要消耗<strong>500M</strong>内存，在每个Pod中都启动一个日志收集组件的情况下，使用logstash有点浪费系统资源，经人推荐我们选择使用<strong>Filebeat</strong>替代，经测试单独启动Filebeat容器大约会消耗<strong>12M</strong>内存，比起logstash相当轻量级。</p>

<h2 id="方案选择">方案选择</h2>

<p>Kubernetes官方提供了EFK的日志收集解决方案，但是这种方案并不适合所有的业务场景，它本身就有一些局限性，例如：</p>

<ul>
<li>所有日志都必须是out前台输出，真实业务场景中无法保证所有日志都在前台输出</li>
<li>只能有一个日志输出文件，而真实业务场景中往往有多个日志输出文件</li>
<li>Fluentd并不是常用的日志收集工具，我们更习惯用logstash，现使用filebeat替代</li>
<li>我们已经有自己的ELK集群且有专人维护，没有必要再在kubernetes上做一个日志收集服务</li>
</ul>

<p>基于以上几个原因，我们决定使用自己的ELK集群。</p>

<p><strong>Kubernetes集群中的日志收集解决方案</strong></p>

<table>
<thead>
<tr>
<th><strong>编号</strong></th>
<th><strong>方案</strong></th>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>1</strong></td>
<td>每个app的镜像中都集成日志收集组件</td>
<td>部署方便，kubernetes的yaml文件无须特别配置，可以为每个app自定义日志收集配置</td>
<td>强耦合，不方便应用和日志收集组件升级和维护且会导致镜像过大</td>
</tr>

<tr>
<td><strong>2</strong></td>
<td>单独创建一个日志收集组件跟app的容器一起运行在同一个pod中</td>
<td>低耦合，扩展性强，方便维护和升级</td>
<td>需要对kubernetes的yaml文件进行单独配置，略显繁琐</td>
</tr>

<tr>
<td><strong>3</strong></td>
<td>将所有的Pod的日志都挂载到宿主机上，每台主机上单独起一个日志收集Pod</td>
<td>完全解耦，性能最高，管理起来最方便</td>
<td>需要统一日志收集规则，目录和输出方式</td>
</tr>
</tbody>
</table>

<p>综合以上优缺点，我们选择使用方案二。</p>

<p>该方案在扩展性、个性化、部署和后期维护方面都能做到均衡，因此选择该方案。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/filebeat-log-collector.jpg" alt="logstash日志收集架构图" /></p>

<p>我们创建了自己的logstash镜像。创建过程和使用方式见<a href="https://github.com/rootsongjc/docker-images">https://github.com/rootsongjc/docker-images</a></p>

<p>镜像地址：<code>index.tenxcloud.com/jimmy/filebeat:5.4.0</code></p>

<h2 id="测试">测试</h2>

<p>我们部署一个应用对logstash的日志收集功能进行测试。</p>

<p>创建应用yaml文件<code>fielbeat-test.yaml</code>。</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: filebeat-test
  namespace: default
spec:
  replicas: 3
  template:
    metadata:
      labels:
        k8s-app: filebeat-test
    spec:
      containers:
      - image: sz-pg-oam-docker-hub-001.tendcloud.com/library/filebeat:5.4.0
        name: filebeat
        volumeMounts:
        - name: app-logs
          mountPath: /log
        - name: filebeat-config
          mountPath: /etc/filebeat/
      - image: sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
        name : app
        ports:
        - containerPort: 80
        volumeMounts:
        - name: app-logs
          mountPath: /usr/local/TalkingData/logs
      volumes:
      - name: app-logs
        emptyDir: {}
      - name: filebeat-config
        configMap:
          name: filebeat-config
---
apiVersion: v1
kind: Service
metadata:
  name: filebeat-test
  labels:
    app: filebeat-test
spec:
  ports:
  - port: 80
    protocol: TCP
    name: http
  selector:
    run: filebeat-test
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
data:
  filebeat.yml: |
    filebeat.prospectors:
    - input_type: log
      paths:
        - &quot;/log/*&quot;
        - &quot;/log/usermange/common/*&quot;
    output.elasticsearch:
      hosts: [&quot;172.23.5.255:9200&quot;]
    username: &quot;elastic&quot;
    password: &quot;changeme&quot;
    index: &quot;filebeat-docker-test&quot;
</code></pre>

<p><strong>注意事项</strong></p>

<ul>
<li>将app的<code>/usr/local/TalkingData/logs</code>目录挂载到logstash的<code>/log</code>目录下。</li>
<li>Filebeat容器大概需要10M左右内存。</li>
<li>该文件可以在<code>manifests/test/filebeat-test.yaml</code>找到。</li>
<li>我使用了自己的私有镜像仓库，测试时请换成自己的应用镜像。</li>
<li>filebeat镜像制作请参考<a href="https://github.com/rootsongjc/docker-images">https://github.com/rootsongjc/docker-images</a></li>
</ul>

<p><strong>创建应用</strong></p>

<p>部署Deployment</p>

<pre><code>kubectl create -f filebeat-test.yaml
</code></pre>

<p>查看<code>http://172.23.5.255:9200/_cat/indices</code>将可以看到列表有这样的indices：</p>

<pre><code>green open filebeat-docker-test            7xPEwEbUQRirk8oDX36gAA 5 1   2151     0   1.6mb 841.8kb
</code></pre>

<p>访问Kibana的web页面，查看<code>filebeat-docker-test</code>的索引，可以看到filebeat收集到了app日志。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/filebeat-docker-test.jpg" alt="Kibana页面" /></p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed May 17, 2017 </h4>
          <h5 id="wc"> 200 Words </h5>
          <h5 id="readtime"> Read in about 1 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/kubernetes-logstash/">使用Logstash收集Kubernetes的应用日志 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="178">
<meta itemprop="datePublished" content="2017-05-17">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-filebeat/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

