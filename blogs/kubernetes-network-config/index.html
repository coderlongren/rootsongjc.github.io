<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, cloud computing, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kubernetes network config : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-31"/>
<meta property="article:modified_time" content="2017-03-31"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="cloud computing">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="kubernetes network config : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> kubernetes network config - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
    

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=kubernetes%20network%20config-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f&title=kubernetes%20network%20config&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">kubernetes network config</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/2014100402.jpg" alt="西安鼓楼" /></p>

<p><em>（题图：西安鼓楼 Oct 4,2014）</em></p>

<p>书接上文<a href="http://rootsongjc.github.io/blogs/kubernetes-installation-on-centos/">在CentOS中安装Kubernetes详细指南</a>，这是一个系列文章，作为*学习Kubernetes*的心路历程吧。</p>

<p>本文主要讲解<strong>Kubernetes的网络配置</strong>，👆文中有一个安装<strong>Flannel</strong>的步骤，但是安装好后并没有相应的配置说明。</p>

<h2 id="配置flannel">配置flannel</h2>

<p>我们直接使用的yum安装的flannle，安装好后会生成<code>/usr/lib/systemd/system/flanneld.service</code>配置文件。</p>

<pre><code class="language-ini">[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/flanneld
EnvironmentFile=-/etc/sysconfig/docker-network
ExecStart=/usr/bin/flanneld-start $FLANNEL_OPTIONS
ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure

[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
</code></pre>

<p>可以看到flannel环境变量配置文件在<code>/etc/sysconfig/flanneld</code>。</p>

<pre><code class="language-Ini"># Flanneld configuration options  

# etcd url location.  Point this to the server where etcd runs
FLANNEL_ETCD_ENDPOINTS=&quot;http://sz-pg-oam-docker-test-001.tendcloud.com:2379&quot;

# etcd config key.  This is the configuration key that flannel queries
# For address range assignment
FLANNEL_ETCD_PREFIX=&quot;/kube-centos/network&quot;

# Any additional options that you want to pass
#FLANNEL_OPTIONS=&quot;&quot;
</code></pre>

<ul>
<li><strong>etcd</strong>的地址<code>FLANNEL_ETCD_ENDPOINT</code></li>
<li>etcd查询的目录，包含docker的IP地址段配置。<code>FLANNEL_ETCD_PREFIX</code></li>
</ul>

<p><strong>在etcd中创建网络配置</strong></p>

<p>执行下面的命令为docker分配IP地址段。</p>

<pre><code class="language-shell">etcdctl mkdir /kube-centos/network
etcdctl mk /kube-centos/network/config &quot;{ \&quot;Network\&quot;: \&quot;172.30.0.0/16\&quot;, \&quot;SubnetLen\&quot;: 24, \&quot;Backend\&quot;: { \&quot;Type\&quot;: \&quot;vxlan\&quot; } }&quot;
</code></pre>

<p><strong>配置Docker</strong></p>

<p>Flannel的<a href="https://github.com/coreos/flannel/blob/master/Documentation/running.md">文档</a>中有写<strong>Docker Integration</strong>：</p>

<p>Docker daemon accepts <code>--bip</code> argument to configure the subnet of the docker0 bridge. It also accepts <code>--mtu</code> to set the MTU for docker0 and veth devices that it will be creating. Since flannel writes out the acquired subnet and MTU values into a file, the script starting Docker can source in the values and pass them to Docker daemon:</p>

<pre><code>source /run/flannel/subnet.env
docker daemon --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU} &amp;
</code></pre>

<p>Systemd users can use <code>EnvironmentFile</code> directive in the .service file to pull in <code>/run/flannel/subnet.env</code></p>

<p>下载flannel github release中的tar包，解压后会获得一个<strong>mk-docker-opts.sh</strong>文件。</p>

<p>这个文件是用来<code>Generate Docker daemon options based on flannel env file</code>。</p>

<p>执行<code>./mk-docker-opts.sh -i</code>将会生成如下两个文件环境变量文件。</p>

<p>/run/flannel/subnet.env</p>

<pre><code>FLANNEL_NETWORK=172.30.0.0/16
FLANNEL_SUBNET=172.30.46.1/24
FLANNEL_MTU=1450
FLANNEL_IPMASQ=false
</code></pre>

<p>/run/docker_opts.env</p>

<pre><code>DOCKER_OPT_BIP=&quot;--bip=172.30.46.1/24&quot;
DOCKER_OPT_IPMASQ=&quot;--ip-masq=true&quot;
DOCKER_OPT_MTU=&quot;--mtu=1450&quot;
</code></pre>

<p><strong>设置docker0网桥的IP地址</strong></p>

<pre><code class="language-shell">source /run/flannel/subnet.env
ifconfig docker0 $FLANNEL_SUBNET
</code></pre>

<p>这样docker0和flannel网桥会在同一个子网中，如</p>

<pre><code>6: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN 
    link/ether 02:42:da:bf:83:a2 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.1/24 brd 172.30.38.255 scope global docker0
       valid_lft forever preferred_lft forever
7: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN 
    link/ether 9a:29:46:61:03:44 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
</code></pre>

<p>现在就可以重启docker了。</p>

<p>重启了docker后还要重启kubelet，这时又遇到问题，kubelet启动失败。报错：</p>

<pre><code>Mar 31 16:44:41 sz-pg-oam-docker-test-002.tendcloud.com kubelet[81047]: error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;
</code></pre>

<p>这是kubelet与docker的<strong>cgroup driver</strong>不一致导致的，kubelet启动的时候有个<code>—cgroup-driver</code>参数可以指定为&rdquo;cgroupfs&rdquo;或者“systemd”。</p>

<pre><code>--cgroup-driver string                                    Driver that the kubelet uses to manipulate cgroups on the host.  Possible values: 'cgroupfs', 'systemd' (default &quot;cgroupfs&quot;)
</code></pre>

<p><strong>启动flannel</strong></p>

<pre><code class="language-shell">systemctl daemon-reload
systemctl start flanneld
systemctl status flanneld
</code></pre>

<p>重新登录这三台主机，可以看到每台主机都多了一个IP。</p>

<pre><code class="language-Shell">#启动nginx的pod
kubectl run nginx --replicas=2 --labels=&quot;run=load-balancer-example&quot; --image=sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9  --port=8080
#创建名为example-service的服务
kubectl expose deployment nginx --type=NodePort --name=example-service
#查看状态
kubectl get deployments nginx
kubectl describe deployments nginx
kubectl get replicasets
kubectl describe replicasets
kubectl describe svc example-service
###################################################
Name:			example-service
Namespace:		default
Labels:			run=load-balancer-example
Annotations:		&lt;none&gt;
Selector:		run=load-balancer-example
Type:			NodePort
IP:			10.254.124.145
Port:			&lt;unset&gt;	8080/TCP
NodePort:		&lt;unset&gt;	30554/TCP
Endpoints:		172.30.38.2:8080,172.30.46.2:8080
Session Affinity:	None
Events:			&lt;none&gt;
</code></pre>

<h2 id="虚拟地址">虚拟地址</h2>

<p>Kubernetes中的Service了使用了虚拟地址；该地址无法ping通过，但可以访问其端口。通过下面的命令可以看到，该虚拟地址是若干条iptables的规则。到10.254.124.145:8080端口的请求会被重定向到172.30.38.2或172.30.46.2的8080端口。这些规则是由kube-proxy生成；如果需要某台机器可以访问Service，则需要在该主机启动kube-proxy。</p>

<p><strong>查看service的iptables</strong></p>

<pre><code>$iptables-save|grep example-service
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 30554 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 30554 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SEP-65MX5SGLQRLS77WG -s 172.30.46.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-65MX5SGLQRLS77WG -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.46.2:8080
-A KUBE-SEP-G3W5BQFRHWIMSQQY -s 172.30.38.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-G3W5BQFRHWIMSQQY -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.38.2:8080
-A KUBE-SERVICES -d 10.254.124.145/32 -p tcp -m comment --comment &quot;default/example-service: cluster IP&quot; -m tcp --dport 8080 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-G3W5BQFRHWIMSQQY
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -j KUBE-SEP-65MX5SGLQRLS77WG
</code></pre>

<p><strong>查看clusterIP的iptables</strong></p>

<pre><code>$iptables -t nat -nL|grep 10.254
KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  0.0.0.0/0            10.254.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443
KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.198.44        /* default/example-service: cluster IP */ tcp dpt:8080
</code></pre>

<p>可以看到在PREROUTING环节，k8s设置了一个target: KUBE-SERVICES。而KUBE-SERVICES下面又设置了许多target，一旦destination和dstport匹配，就会沿着chain进行处理。</p>

<p>比如：当我们在pod网络curl 10.254.198.44 8080时，匹配到下面的KUBE-SVC-BR4KARPIGKMRMN3E target：</p>

<pre><code>KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.198.44        /* default/example-service: cluster IP */ tcp dpt:8080
</code></pre>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Mar 31, 2017 </h4>
          <h5 id="wc"> 600 Words </h5>
          <h5 id="readtime"> Read in about 3 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/cloud-computing">cloud computing</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/tensorflow-practice-03/">TensorFlow实战（才云郑泽宇著）读书笔记——第三章TensorFlow入门 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="549">
<meta itemprop="datePublished" content="2017-03-31">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

