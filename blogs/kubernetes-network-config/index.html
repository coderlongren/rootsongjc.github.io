<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, cloud computing, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes基于flannel的网络配置 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-31"/>
<meta property="article:modified_time" content="2017-03-31"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="cloud computing">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes基于flannel的网络配置 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> Kubernetes基于flannel的网络配置 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
    

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e5%9f%ba%e4%ba%8eflannel%e7%9a%84%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f&title=Kubernetes%e5%9f%ba%e4%ba%8eflannel%e7%9a%84%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Kubernetes基于flannel的网络配置</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/2014100402.jpg" alt="西安鼓楼" /></p>

<p><em>（题图：西安鼓楼 Oct 4,2014）</em></p>

<p>书接上文<a href="http://rootsongjc.github.io/blogs/kubernetes-installation-on-centos/">在CentOS中安装Kubernetes详细指南</a>，这是一个系列文章，作为学习Kubernetes的心路历程吧。</p>

<p>本文主要讲解<strong>Kubernetes的网络配置</strong>，👆文中有一个安装<strong>Flannel</strong>的步骤，但是安装好后并没有相应的配置说明。</p>

<h2 id="配置flannel">配置flannel</h2>

<p>我们直接使用的yum安装的flannle，安装好后会生成<code>/usr/lib/systemd/system/flanneld.service</code>配置文件。</p>

<pre><code class="language-ini">[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/flanneld
EnvironmentFile=-/etc/sysconfig/docker-network
ExecStart=/usr/bin/flanneld-start $FLANNEL_OPTIONS
ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure

[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
</code></pre>

<p>可以看到flannel环境变量配置文件在<code>/etc/sysconfig/flanneld</code>。</p>

<pre><code class="language-Ini"># Flanneld configuration options  

# etcd url location.  Point this to the server where etcd runs
FLANNEL_ETCD_ENDPOINTS=&quot;http://sz-pg-oam-docker-test-001.tendcloud.com:2379&quot;

# etcd config key.  This is the configuration key that flannel queries
# For address range assignment
FLANNEL_ETCD_PREFIX=&quot;/kube-centos/network&quot;

# Any additional options that you want to pass
#FLANNEL_OPTIONS=&quot;&quot;
</code></pre>

<ul>
<li>etcd的地址<code>FLANNEL_ETCD_ENDPOINT</code></li>
<li>etcd查询的目录，包含docker的IP地址段配置。<code>FLANNEL_ETCD_PREFIX</code></li>
</ul>

<p><strong>在etcd中创建网络配置</strong></p>

<p>执行下面的命令为docker分配IP地址段。</p>

<pre><code class="language-shell">etcdctl mkdir /kube-centos/network
etcdctl mk /kube-centos/network/config &quot;{ \&quot;Network\&quot;: \&quot;172.30.0.0/16\&quot;, \&quot;SubnetLen\&quot;: 24, \&quot;Backend\&quot;: { \&quot;Type\&quot;: \&quot;vxlan\&quot; } }&quot;
</code></pre>

<p><strong>配置Docker</strong></p>

<p>Flannel的<a href="https://github.com/coreos/flannel/blob/master/Documentation/running.md">文档</a>中有写<strong>Docker Integration</strong>：</p>

<p>Docker daemon accepts <code>--bip</code> argument to configure the subnet of the docker0 bridge. It also accepts <code>--mtu</code> to set the MTU for docker0 and veth devices that it will be creating. Since flannel writes out the acquired subnet and MTU values into a file, the script starting Docker can source in the values and pass them to Docker daemon:</p>

<pre><code>source /run/flannel/subnet.env
docker daemon --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU} &amp;
</code></pre>

<p>Systemd users can use <code>EnvironmentFile</code> directive in the .service file to pull in <code>/run/flannel/subnet.env</code></p>

<p>下载flannel github release中的tar包，解压后会获得一个<strong>mk-docker-opts.sh</strong>文件。</p>

<p>这个文件是用来<code>Generate Docker daemon options based on flannel env file</code>。</p>

<p>执行<code>./mk-docker-opts.sh -i</code>将会生成如下两个文件环境变量文件。</p>

<p>/run/flannel/subnet.env</p>

<pre><code>FLANNEL_NETWORK=172.30.0.0/16
FLANNEL_SUBNET=172.30.46.1/24
FLANNEL_MTU=1450
FLANNEL_IPMASQ=false
</code></pre>

<p>/run/docker_opts.env</p>

<pre><code>DOCKER_OPT_BIP=&quot;--bip=172.30.46.1/24&quot;
DOCKER_OPT_IPMASQ=&quot;--ip-masq=true&quot;
DOCKER_OPT_MTU=&quot;--mtu=1450&quot;
</code></pre>

<p>现在查询etcd中的内容可以看到：</p>

<pre><code>$etcdctl ls /kube-centos/network/subnets
/kube-centos/network/subnets/172.30.14.0-24
/kube-centos/network/subnets/172.30.38.0-24
/kube-centos/network/subnets/172.30.46.0-24
$etcdctl get /kube-centos/network/config
{ &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: { &quot;Type&quot;: &quot;vxlan&quot; } }
$etcdctl get /kube-centos/network/subnets/172.30.14.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.114&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;56:27:7d:1c:08:22&quot;}}
$etcdctl get /kube-centos/network/subnets/172.30.38.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.115&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;12:82:83:59:cf:b8&quot;}}
$etcdctl get /kube-centos/network/subnets/172.30.46.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.113&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;e6:b2:fd:f6:66:96&quot;}}
</code></pre>

<p><strong>设置docker0网桥的IP地址</strong></p>

<pre><code class="language-shell">source /run/flannel/subnet.env
ifconfig docker0 $FLANNEL_SUBNET
</code></pre>

<p>这样docker0和flannel网桥会在同一个子网中，如</p>

<pre><code>6: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN 
    link/ether 02:42:da:bf:83:a2 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.1/24 brd 172.30.38.255 scope global docker0
       valid_lft forever preferred_lft forever
7: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN 
    link/ether 9a:29:46:61:03:44 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
</code></pre>

<p>现在就可以重启docker了。</p>

<p>重启了docker后还要重启kubelet，这时又遇到问题，kubelet启动失败。报错：</p>

<pre><code>Mar 31 16:44:41 sz-pg-oam-docker-test-002.tendcloud.com kubelet[81047]: error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;
</code></pre>

<p>这是kubelet与docker的<strong>cgroup driver</strong>不一致导致的，kubelet启动的时候有个<code>—cgroup-driver</code>参数可以指定为&rdquo;cgroupfs&rdquo;或者“systemd”。</p>

<pre><code>--cgroup-driver string                                    Driver that the kubelet uses to manipulate cgroups on the host.  Possible values: 'cgroupfs', 'systemd' (default &quot;cgroupfs&quot;)
</code></pre>

<p><strong>启动flannel</strong></p>

<pre><code class="language-shell">systemctl daemon-reload
systemctl start flanneld
systemctl status flanneld
</code></pre>

<p>重新登录这三台主机，可以看到每台主机都多了一个IP。</p>

<p>参考Kubernetes官方文档的<a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/">Exposing an External IP Address to Access an Application in a Cluster</a>，官方使用的Hello World测试，我们启动Nginx服务测试。</p>

<pre><code class="language-Shell">#启动nginx的pod
kubectl run nginx --replicas=2 --labels=&quot;run=load-balancer-example&quot; --image=sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9  --port=80
#创建名为example-service的服务
kubectl expose deployment nginx --type=NodePort --name=example-service
#查看状态
kubectl get deployments nginx
kubectl describe deployments nginx
kubectl get replicasets
kubectl describe replicasets
kubectl describe svc example-service
###################################################
Name:			example-service
Namespace:		default
Labels:			run=load-balancer-example
Annotations:		&lt;none&gt;
Selector:		run=load-balancer-example
Type:			NodePort
IP:			10.254.180.209
Port:			&lt;unset&gt;	80/TCP
NodePort:		&lt;unset&gt;	32663/TCP
Endpoints:		172.30.14.2:80,172.30.46.2:80
Session Affinity:	None
Events:			&lt;none&gt;
</code></pre>

<p>我们上面启动的serivce的type是<strong>NodePort</strong>，Kubernetes的service支持三种类型的service，参考<a href="http://www.cnblogs.com/xuxinkun/p/5331728.html">Kubernetes Serivce分析</a>。</p>

<p>现在访问三台物理机的IP:80端口就可以看到nginx的页面了。</p>

<p>稍等一会在访问ClusterIP + Port也可以访问到nginx。</p>

<pre><code>$curl 10.254.180.209:80
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h2 id="虚拟地址">虚拟地址</h2>

<p>Kubernetes中的Service了使用了虚拟地址；该地址无法ping通过，但可以访问其端口。通过下面的命令可以看到，该虚拟地址是若干条iptables的规则。到10.254.124.145:8080端口的请求会被重定向到172.30.38.2或172.30.46.2的8080端口。这些规则是由kube-proxy生成；如果需要某台机器可以访问Service，则需要在该主机启动kube-proxy。</p>

<p><strong>查看service的iptables</strong></p>

<pre><code>$iptables-save|grep example-service
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 32663 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 32663 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SEP-NCPBOLUH5XTTHG3E -s 172.30.46.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-NCPBOLUH5XTTHG3E -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.46.2:80
-A KUBE-SEP-ONEKQBIWICF7RAR3 -s 172.30.14.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-ONEKQBIWICF7RAR3 -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.14.2:80
-A KUBE-SERVICES -d 10.254.180.209/32 -p tcp -m comment --comment &quot;default/example-service: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-ONEKQBIWICF7RAR3
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -j KUBE-SEP-NCPBOLUH5XTTHG3E
</code></pre>

<p><strong>查看clusterIP的iptables</strong></p>

<pre><code>$iptables -t nat -nL|grep 10.254
KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  0.0.0.0/0            10.254.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443
KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.180.209       /* default/example-service: cluster IP */ tcp dpt:80
</code></pre>

<p>可以看到在PREROUTING环节，k8s设置了一个target: KUBE-SERVICES。而KUBE-SERVICES下面又设置了许多target，一旦destination和dstport匹配，就会沿着chain进行处理。</p>

<p>比如：当我们在pod网络curl 10.254.198.44 80时，匹配到下面的KUBE-SVC-BR4KARPIGKMRMN3E target：</p>

<pre><code>KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.180.209       /* default/example-service: cluster IP */ tcp dpt:80
</code></pre>

<p>参考<a href="http://tonybai.com/2017/01/17/understanding-flannel-network-for-kubernetes/">理解Kubernetes网络之Flannel网络</a>，Tony Bai的文章中有对flannel的详细介绍。</p>

<h2 id="遇到的问题">遇到的问题</h2>

<p>在设置网络的过程中遇到了很多问题，记录如下。</p>

<h3 id="问题一">问题一</h3>

<p><strong>问题描述</strong></p>

<p>Kube-proxy开放的<strong>NodePort</strong>端口无法访问。即无法使用NodeIP加NodePort的方式访问service，而且本地telnet也不通，但是端口确确实实在那。</p>

<p><strong>问题状态</strong></p>

<p>已解决</p>

<p><strong>解决方法</strong></p>

<p>其实这不是问题，是因为从上面的操作记录中我们可以看到，<strong>在启动Nginx的Pod</strong>时，指定port为80即可。以ClusterIP + Port的方式访问serivce需要等一段时间。</p>

<p><strong>反思</strong></p>

<p>这个问题困扰了我们差不多两天时间，出现这个问题的根源还是因为<u>思想观念没有从运行docker的命令中解放出来</u>,还把<code>kubelet run —port</code>当成是docker run中的端口映射，这种想法是大错特错的，该端口是image中的应用实际暴露的端口，如nginx的80端口。😔</p>

<h3 id="问题二">问题二</h3>

<p><strong>问题描述</strong></p>

<p>在没有删除service和deploy的情况下就重启kubelet的时候，会遇到kubelet启动失败的情况。</p>

<p><strong>出错信息</strong></p>

<pre><code>Apr 01 14:24:08 sz-pg-oam-docker-test-001.tendcloud.com kubelet[103932]: I0401 14:24:08.359839  103932 kubelet.go:1752] skipping pod synchronization - [Failed to start ContainerManager failed to initialise top level QOS containers: failed to create top level Burstable QOS cgroup : Unit kubepods-burstable.slice already exists.]
</code></pre>

<p><a href="http://www.osbaike.net/article-show-id-229028.html">Kubernetes Resource QoS机制解读</a>，这篇文章详细介绍了QoS的机制。</p>

<p>Kubernetes根据Pod中Containers Resource的<code>request</code>和<code>limit</code>的值来定义Pod的QoS Class。</p>

<p>对于每一种Resource都可以将容器分为3中QoS Classes: Guaranteed, Burstable, and Best-Effort，它们的QoS级别依次递减。</p>

<ul>
<li><strong>Guaranteed</strong>：如果Pod中所有Container的所有Resource的<code>limit</code>和<code>request</code>都相等且不为0，则这个Pod的QoS Class就是Guaranteed。</li>
<li><strong>Burstable</strong>：除了符合Guaranteed和Best-Effort的场景，其他场景的Pod QoS Class都属于Burstable。</li>
<li><strong>Best-Effort</strong>：如果Pod中所有容器的所有Resource的request和limit都没有赋值，则这个Pod的QoS Class就是Best-Effort。</li>
</ul>

<p><strong>解决方法</strong></p>

<p>这个暂时还没找到根本的解决办法，参考Github上的<a href="https://github.com/kubernetes/kubernetes/issues/43856">Failed to start ContainerManager failed to initialize top level QOS containers #43856</a>，重启主机后确实正常了，不过这只是临时解决方法。</p>

<h2 id="后记">后记</h2>

<p>其实昨天就已经安装完毕了，是我们使用的姿势不对，白白耽误这么长时间，身边差个老司机啊，滴～学生卡。</p>

<p>感谢<a href="tonybai.com">Tony Bai</a>、<a href="https://godliness.github.io/">Peter Ma</a>的大力支持。</p>

<p>Apr 1,2017 愚人节，东直门</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Mar 31, 2017 </h4>
          <h5 id="wc"> 800 Words </h5>
          <h5 id="readtime"> Read in about 4 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/cloud-computing">cloud computing</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://rootsongjc.github.io/talks/picture-process/"><i class="icon-arrow-left"></i> 两个图片处理工具——Google Guetzli和基于AI的Deep Photo Style Transfer</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/tensorflow-practice-03/">TensorFlow实战（才云郑泽宇著）读书笔记——第三章TensorFlow入门 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="771">
<meta itemprop="datePublished" content="2017-03-31">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

