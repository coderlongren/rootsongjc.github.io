<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, istio, microservices, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="微服务管理框架istio安装笔记 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/istio-installation/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-01"/>
<meta property="article:modified_time" content="2017-06-01"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="istio">
<meta property="article:tag" content="microservices">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="微服务管理框架istio安装笔记 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> 微服务管理框架istio安装笔记 - Jimmy Song </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/istio-installation/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e5%be%ae%e6%9c%8d%e5%8a%a1%e7%ae%a1%e7%90%86%e6%a1%86%e6%9e%b6istio%e5%ae%89%e8%a3%85%e7%ac%94%e8%ae%b0-https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f&title=%e5%be%ae%e6%9c%8d%e5%8a%a1%e7%ae%a1%e7%90%86%e6%a1%86%e6%9e%b6istio%e5%ae%89%e8%a3%85%e7%ac%94%e8%ae%b0&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fistio-installation%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">微服务管理框架istio安装笔记</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170528033.jpg" alt="威海朱口" /></p>

<p><em>（题图：威海东部海湾 May 28,2017）</em></p>

<h1 id="前言">前言</h1>

<p>本文已上传到<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中的第五章微服务章节，本文仅作归档，更新以<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>为准。</p>

<p>本文根据官网的文档整理而成，步骤包括安装<code>istio 0.1.5</code>并创建一个bookinfo的微服务来测试istio的功能。</p>

<p>文中使用的yaml文件可以在<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的<code>manifests/istio</code>目录中找到，所有的镜像都换成了我的私有镜像仓库地址，请根据官网的镜像自行修改。</p>

<h2 id="安装环境">安装环境</h2>

<ul>
<li>CentOS 7.3.1611</li>
<li>Docker 1.12.6</li>
<li>Kubernetes 1.6.0</li>
</ul>

<h2 id="安装">安装</h2>

<p><strong>1.下载安装包</strong></p>

<p>下载地址：<a href="https://github.com/istio/istio/releases">https://github.com/istio/istio/releases</a></p>

<p>下载Linux版本的当前最新版安装包</p>

<pre><code class="language-Shell">wget https://github.com/istio/istio/releases/download/0.1.5/istio-0.1.5-linux.tar.gz
</code></pre>

<p><strong>2.解压</strong></p>

<p>解压后，得到的目录结构如下：</p>

<pre><code>.
├── bin
│   └── istioctl
├── install
│   └── kubernetes
│       ├── addons
│       │   ├── grafana.yaml
│       │   ├── prometheus.yaml
│       │   ├── servicegraph.yaml
│       │   └── zipkin.yaml
│       ├── istio-auth.yaml
│       ├── istio-rbac-alpha.yaml
│       ├── istio-rbac-beta.yaml
│       ├── istio.yaml
│       ├── README.md
│       └── templates
│           ├── istio-auth
│           │   ├── istio-auth-with-cluster-ca.yaml
│           │   ├── istio-cluster-ca.yaml
│           │   ├── istio-egress-auth.yaml
│           │   ├── istio-ingress-auth.yaml
│           │   └── istio-namespace-ca.yaml
│           ├── istio-egress.yaml
│           ├── istio-ingress.yaml
│           ├── istio-manager.yaml
│           └── istio-mixer.yaml
├── istio.VERSION
├── LICENSE
└── samples
    ├── apps
    │   ├── bookinfo
    │   │   ├── bookinfo.yaml
    │   │   ├── cleanup.sh
    │   │   ├── destination-ratings-test-delay.yaml
    │   │   ├── loadbalancing-policy-reviews.yaml
    │   │   ├── mixer-rule-additional-telemetry.yaml
    │   │   ├── mixer-rule-empty-rule.yaml
    │   │   ├── mixer-rule-ratings-denial.yaml
    │   │   ├── mixer-rule-ratings-ratelimit.yaml
    │   │   ├── README.md
    │   │   ├── route-rule-all-v1.yaml
    │   │   ├── route-rule-delay.yaml
    │   │   ├── route-rule-reviews-50-v3.yaml
    │   │   ├── route-rule-reviews-test-v2.yaml
    │   │   ├── route-rule-reviews-v2-v3.yaml
    │   │   └── route-rule-reviews-v3.yaml
    │   ├── httpbin
    │   │   ├── httpbin.yaml
    │   │   └── README.md
    │   └── sleep
    │       ├── README.md
    │       └── sleep.yaml
    └── README.md

11 directories, 41 files
</code></pre>

<p>从文件里表中可以看到，安装包中包括了kubernetes的yaml文件，示例应用和安装模板。</p>

<p><strong>3.安装istioctl</strong></p>

<p>将<code>./bin/istioctl</code>拷贝到你的<code>$PATH</code>目录下。</p>

<p><strong>4.检查RBAC</strong></p>

<p>因为我们安装的kuberentes版本是1.6.0默认支持RBAC，这一步可以跳过。如果你使用的其他版本的kubernetes，请参考<a href="https://istio.io/docs/tasks/installing-istio.html">官方文档</a>操作。</p>

<p>执行以下命令，正确的输出是这样的：</p>

<pre><code class="language-bash">$ kubectl api-versions | grep rbac
rbac.authorization.k8s.io/v1alpha1
rbac.authorization.k8s.io/v1beta1
</code></pre>

<p><strong>5.创建角色绑定</strong></p>

<pre><code class="language-bash">$ kubectl create -f install/kubernetes/istio-rbac-beta.yaml
clusterrole &quot;istio-manager&quot; created
clusterrole &quot;istio-ca&quot; created
clusterrole &quot;istio-sidecar&quot; created
clusterrolebinding &quot;istio-manager-admin-role-binding&quot; created
clusterrolebinding &quot;istio-ca-role-binding&quot; created
clusterrolebinding &quot;istio-ingress-admin-role-binding&quot; created
clusterrolebinding &quot;istio-sidecar-role-binding&quot; created
</code></pre>

<p><strong>注意：</strong>官网的安装包中的该文件中存在RoleBinding错误，应该是集群级别的<code>clusterrolebinding</code>，而release里的代码只是普通的<code>rolebinding</code>，查看该Issue <a href="https://github.com/istio/istio/issues/327">Istio manager cannot list of create k8s TPR when RBAC enabled #327</a>。</p>

<p><strong>6.安装istio核心组件</strong></p>

<p>用到的镜像有：</p>

<pre><code>docker.io/istio/mixer:0.1.5
docker.io/istio/manager:0.1.5
docker.io/istio/proxy_debug:0.1.5
</code></pre>

<p>我们暂时不开启<a href="https://istio.io/docs/concepts/network-and-auth/auth.html">Istio Auth</a>。</p>

<p><strong>注意：</strong>本文中用到的所有yaml文件中的<code>type: LoadBalancer</code>去掉，使用默认的ClusterIP，然后配置Traefik ingress，就可以在集群外部访问。请参考<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/traefik-ingress-installation.md">安装Traefik ingress</a>。</p>

<pre><code class="language-bash">kubectl apply -f install/kubernetes/istio.yaml
</code></pre>

<p><strong>7.安装监控插件</strong></p>

<p>用到的镜像有：</p>

<pre><code>docker.io/istio/grafana:0.1.5
quay.io/coreos/prometheus:v1.1.1
gcr.io/istio-testing/servicegraph:latest
docker.io/openzipkin/zipkin:latest
</code></pre>

<p>为了方便下载，其中两个镜像我备份到了时速云：</p>

<pre><code>index.tenxcloud.com/jimmy/prometheus:v1.1.1
index.tenxcloud.com/jimmy/servicegraph:latest
</code></pre>

<p>安装插件</p>

<pre><code class="language-bash">kubectl apply -f install/kubernetes/addons/prometheus.yaml
kubectl apply -f install/kubernetes/addons/grafana.yaml
kubectl apply -f install/kubernetes/addons/servicegraph.yaml
kubectl apply -f install/kubernetes/addons/zipkin.yaml
</code></pre>

<p>在traefik ingress中增加增加以上几个服务的配置，同时增加istio-ingress配置。</p>

<pre><code class="language-Yaml">    - host: grafana.istio.io
      http:
        paths:
        - path: /
          backend:
            serviceName: grafana
            servicePort: 3000
    - host: servicegraph.istio.io
      http:
        paths:
        - path: /
          backend:
            serviceName: servicegraph
            servicePort: 8088
    - host: prometheus.istio.io
      http:
        paths:
        - path: /
          backend:
            serviceName: prometheus
            servicePort: 9090
    - host: zipkin.istio.io
      http:
        paths:
        - path: /
          backend:
            serviceName: zipkin
            servicePort: 9411
    - host: ingress.istio.io
      http:
        paths:
        - path: /
          backend:
            serviceName: istio-ingress
            servicePort: 80
</code></pre>

<h2 id="测试">测试</h2>

<p>我们使用Istio提供的测试应用<a href="https://istio.io/docs/samples/bookinfo.html">bookinfo</a>微服务来进行测试。</p>

<p>该微服务用到的镜像有：</p>

<pre><code>istio/examples-bookinfo-details-v1
istio/examples-bookinfo-ratings-v1
istio/examples-bookinfo-reviews-v1
istio/examples-bookinfo-reviews-v2
istio/examples-bookinfo-reviews-v3
istio/examples-bookinfo-productpage-v1
</code></pre>

<p>该应用架构图如下：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/bookinfo-sample-arch.png" alt="BookInfo Sample应用架构图" /></p>

<p><strong>部署应用</strong></p>

<pre><code>kubectl create -f &lt;(istioctl kube-inject -f samples/apps/bookinfo/bookinfo.yaml)
</code></pre>

<p><code>Istio kube-inject</code>命令会在<code>bookinfo.yaml</code>文件中增加Envoy sidecar信息。参考：<a href="https://istio.io/docs/reference/commands/istioctl.html#istioctl-kube-inject">https://istio.io/docs/reference/commands/istioctl.html#istioctl-kube-inject</a></p>

<p>在本机的<code>/etc/hosts</code>下增加VIP节点和<code>ingress.istio.io</code>的对应信息。具体步骤参考：<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">边缘节点配置</a></p>

<p>在浏览器中访问<a href="http://ingress.istio.io/productpage">http://ingress.istio.io/productpage</a></p>

<h2 id="监控">监控</h2>

<p>不断刷新productpage页面，将可以在以下几个监控中看到如下界面。</p>

<p><strong>Grafana页面</strong></p>

<p><a href="http://grafana.istio.io">http://grafana.istio.io</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/istio-bookinfo-grafana.jpg" alt="Istio Grafana界面" /></p>

<p><strong>Prometheus页面</strong></p>

<p><a href="http://prometheus.istio.io">http://prometheus.istio.io</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/istio-bookinfo-prometheus.jpg" alt="Prometheus页面" /></p>

<p><strong>Zipkin页面</strong></p>

<p><a href="http://zipkin.istio.io">http://zipkin.istio.io</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/istio-bookinfo-zipkin.jpg" alt="Zipkin页面" /></p>

<p><strong>ServiceGraph页面</strong></p>

<p><a href="http://servicegraph.istio.io/dotviz">http://servicegraph.istio.io/dotviz</a></p>

<p>可以用来查看服务间的依赖关系。</p>

<p>获得json格式的返回结果，访问<a href="http://servicegraph.istio.io/graph">http://servicegraph.istio.io/graph</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/istio-bookinfo-servicegraph.jpg" alt="ServiceGraph页面" /></p>

<h2 id="更进一步">更进一步</h2>

<p>BookInfo示例中有三个版本的<code>reviews</code>，可以使用istio来配置路由请求，将流量分摊到不同版本的应用上。参考<a href="https://istio.io/docs/tasks/request-routing.html">Configuring Request Routing</a>。</p>

<p>还有一些更高级的功能，我们后续将进一步探索。</p>

<h2 id="参考">参考</h2>

<p><a href="https://istio.io/docs/tasks/installing-istio.html">Installing Istio</a></p>

<p><a href="https://istio.io/docs/samples/bookinfo.html">BookInfo sample</a></p>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Jun 1, 2017 </h4>
        <h5 id="wc"> 1900 Words </h5>
        <h5 id="readtime"> Read in about 4 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/istio">istio</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/microservices">microservices</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/istio-overview/"><i class="icon-arrow-left"></i> 微服务管理框架Istio简介</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-filebeat/">使用filebeat收集kubernetes中的应用日志 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1827">
<meta itemprop="datePublished" content="2017-06-01">
<meta itemprop="url" content="https://jimmysong.io/blogs/istio-installation/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
            Powered by <a href="https://gohugo.io">Hugo</a> </p>
    </div>
</footer>
</body>

</html>

