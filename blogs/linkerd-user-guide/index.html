<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, cloud-native, service-mesh, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Linkerd 使用指南 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/linkerd-user-guide/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-08-01"/>
<meta property="article:modified_time" content="2017-08-01"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="cloud-native">
<meta property="article:tag" content="service-mesh">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Linkerd 使用指南 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Linkerd 使用指南 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/linkerd-user-guide/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Linkerd%20%e4%bd%bf%e7%94%a8%e6%8c%87%e5%8d%97-https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f&title=Linkerd%20%e4%bd%bf%e7%94%a8%e6%8c%87%e5%8d%97&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2flinkerd-user-guide%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Linkerd 使用指南</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<h2 id="前言">前言</h2>

<p>该文章已归档到 <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a> 第五章【领域应用】中，一切内容以 kubernetes-handbook 为准，该文档可能不会及时更新。</p>

<p>以下内容参考：<a href="https://cdn2.hubspot.net/hubfs/2818724/A%20Service%20Mesh%20for%20Kubernetes_Final.pdf">A Service Mesh for Kubernetes</a></p>

<p>Linkerd 作为一款 service mesh 与kubernetes 结合后主要有以下几种用法：</p>

<ol>
<li>作为服务网关，可以监控 kubernetes 中的服务和实例</li>
<li>使用 TLS 加密服务</li>
<li>通过流量转移到持续交付</li>
<li>开发测试环境（Eat your own dog food）、Ingress 和边缘路由</li>
<li>给微服务做 staging</li>
<li>分布式 tracing</li>
<li>作为 Ingress controller</li>
<li>使用 gRPC 更方便</li>
</ol>

<p>以下我们着重讲解在 kubernetes 中如何使用 linkerd 作为 kubernetes 的 Ingress controller，并作为边缘节点代替 <a href="https://traefik.io/">Traefik</a>的功能，详见 <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">边缘节点的配置</a>。</p>

<h2 id="准备">准备</h2>

<p>安装测试时需要用到的镜像有：</p>

<pre><code>buoyantio/helloworld:0.1.4
buoyantio/jenkins-plus:2.60.1
buoyantio/kubectl:v1.4.0
buoyantio/linkerd:1.1.2
buoyantio/namerd:1.1.2
buoyantio/nginx:1.10.2
linkerd/namerctl:0.8.6
openzipkin/zipkin:1.20
tutum/dnsutils:latest

</code></pre>

<p>这些镜像可以直接通过 Docker Hub 获取，我将它们下载下来并上传到了自己的私有镜像仓库 <code>sz-pg-oam-docker-hub-001.tendcloud.com</code> 中，下文中用到的镜像皆来自我的私有镜像仓库，yaml 配置见 <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/manifests/linkerd">linkerd</a> 目录，并在使用时将配置中的镜像地址修改为你自己的。</p>

<h2 id="部署">部署</h2>

<p>首先需要先创建 RBAC，因为使用 namerd 和 ingress 时需要用到。</p>

<pre><code>$ kubectl create -f linkerd-rbac-beta.yml
</code></pre>

<p>Linkerd 提供了 Jenkins 示例，在部署的时候使用以下命令：</p>

<pre><code>$ kubectl create -f jenkins-rbac-beta.yml
$ kubectl create -f jenkins.yml
</code></pre>

<p>访问 <a href="http://jenkins.jimmysong.io/">http://jenkins.jimmysong.io</a></p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-jenkins-pipeline.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-jenkins-pipeline.jpg" alt="Jenkins pipeline" /></a></p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-jenkins.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-jenkins.jpg" alt="Jenkins config" /></a></p>

<p><strong>注意</strong>：要访问 Jenkins 需要在 Ingress 中增加配置，下文会提到。</p>

<p>在 kubernetes 中使用 Jenkins 的时候需要注意 Pipeline 中的配置：</p>

<pre><code>    def currentVersion = getCurrentVersion()
    def newVersion = getNextVersion(currentVersion)
    def frontendIp = kubectl(&quot;get svc l5d -o jsonpath=\&quot;{.status.loadBalancer.ingress[0].*}\&quot;&quot;).trim()
    def originalDst = getDst(getDtab())

</code></pre>

<p><code>frontendIP</code> 的地址要配置成 service 的 Cluster IP ，因为我们没有用到LoadBalancer。</p>

<p>需要安装 namerd，namerd 负责 dtab 信息的存储，当然也可以存储在 etcd、consul中。dtab 保存的是路由规则信息，支持递归解析，详见 <a href="https://linkerd.io/in-depth/dtabs/">dtab</a>。</p>

<p>流量切换主要是通过 <a href="https://linkerd.io/in-depth/dtabs/">dtab</a> 来实现的，通过在 HTTP 请求的 header 中增加 <code>l5d-dtab</code> 和 <code>Host</code> 信息可以对流量分离到 kubernetes 中的不同 service 上。</p>

<p><strong>遇到的问题</strong></p>

<p>Failed with the following error(s) Error signal dtab is already marked as being deployed!</p>

<p>因为该 dtab entry 已经存在，需要删除后再运行。</p>

<p>访问 <a href="http://namerd.jimmysong.io/">http://namerd.jimmysong.io</a></p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/namerd-internal.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/namerd-internal.jpg" alt="namerd" /></a></p>

<p>dtab 保存在 namerd 中，该页面中的更改不会生效，需要使用命令行来操作。</p>

<p>使用 <a href="https://github.com/linkerd/namerctl">namerctl</a> 来操作。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ namerctl --base-url http://namerd-backend.jimmysong.io dtab update internal file</span></code></pre>
</div>
<p><strong>注意</strong>：update 时需要将更新文本先写入文件中。</p>

<h2 id="部署-linkerd">部署 Linkerd</h2>

<p>直接使用 yaml 文件部署，注意修改镜像仓库地址。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建 namerd
</span><span class="c1"></span><span class="">$ kubectl create -f namerd.yaml
</span><span class=""></span><span class="c1"># 创建 ingress
</span><span class="c1"></span><span class="">$ kubectl create -f linkerd-ingress.yml
</span><span class=""></span><span class="c1"># 创建测试服务 hello-world
</span><span class="c1"></span><span class="">$ kubectl create -f hello-world.yml
</span><span class=""></span><span class="c1"># 创建 API 服务
</span><span class="c1"></span><span class="">$ kubectl create -f api.yml
</span><span class=""></span><span class="c1"># 创建测试服务 world-v2
</span><span class="c1"></span><span class="">$ kubectl create -f world-v2.yml</span></code></pre>
</div>
<p>为了在本地调试 linkerd，我们将 linkerd 的 service 加入到 ingress 中，详见 <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/usecases/practice/edge-node-configuration.md">边缘节点配置</a>。</p>

<p>在 Ingress 中增加如下内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="">-</span><span class="w"> </span><span class="">host</span><span class="p">:</span><span class="w"> </span><span class="">linkerd.jimmysong.io</span><span class="w">
</span><span class="w">      </span><span class="">http</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">paths</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">-</span><span class="w"> </span><span class="">path</span><span class="p">:</span><span class="w"> </span><span class="">/</span><span class="w">
</span><span class="w">          </span><span class="">backend</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="">serviceName</span><span class="p">:</span><span class="w"> </span><span class="">l5d</span><span class="w">
</span><span class="w">            </span><span class="">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">9990</span><span class="w">
</span><span class="w">    </span><span class="">-</span><span class="w"> </span><span class="">host</span><span class="p">:</span><span class="w"> </span><span class="">linkerd-viz.jimmysong.io</span><span class="w">
</span><span class="w">      </span><span class="">http</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">paths</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">-</span><span class="w"> </span><span class="">path</span><span class="p">:</span><span class="w"> </span><span class="">/</span><span class="w">
</span><span class="w">          </span><span class="">backend</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="">serviceName</span><span class="p">:</span><span class="w"> </span><span class="">linkerd-viz</span><span class="w">
</span><span class="w">            </span><span class="">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="">-</span><span class="w"> </span><span class="">host</span><span class="p">:</span><span class="w"> </span><span class="">l5d.jimmysong.io</span><span class="w">
</span><span class="w">      </span><span class="">http</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">paths</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">-</span><span class="w"> </span><span class="">path</span><span class="p">:</span><span class="w"> </span><span class="">/</span><span class="w">
</span><span class="w">          </span><span class="">backend</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="">serviceName</span><span class="p">:</span><span class="w"> </span><span class="">l5d</span><span class="w">
</span><span class="w">            </span><span class="">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">4141</span><span class="w">
</span><span class="w">    </span><span class="">-</span><span class="w"> </span><span class="">host</span><span class="p">:</span><span class="w"> </span><span class="">jenkins.jimmysong.io</span><span class="w">
</span><span class="w">      </span><span class="">http</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">paths</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="">-</span><span class="w"> </span><span class="">path</span><span class="p">:</span><span class="w"> </span><span class="">/</span><span class="w">
</span><span class="w">          </span><span class="">backend</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="">serviceName</span><span class="p">:</span><span class="w"> </span><span class="">jenkins</span><span class="w">
</span><span class="w">            </span><span class="">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></code></pre>
</div>
<p>在本地<code>/etc/hosts</code>中添加如下内容：</p>

<pre><code>172.20.0.119 linkerd.jimmysong.io
172.20.0.119 linkerd-viz.jimmysong.io
172.20.0.119 l5d.jimmysong.io

</code></pre>

<p><strong>测试路由功能</strong></p>

<p>使用 curl 简单测试。</p>

<p>单条测试</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ curl -s -H </span><span class="s2">&#34;Host: www.hello.world&#34;</span><span class=""> </span><span class="m">172</span><span class="">.20.0.120:4141
</span><span class="">Hello </span><span class="o">(</span><span class="m">172</span><span class="">.30.60.14</span><span class="o">)</span><span class=""> world </span><span class="o">(</span><span class="m">172</span><span class="">.30.71.19</span><span class="o">)</span><span class="">!!%  </span></code></pre>
</div>
<p>请注意请求返回的结果，表示访问的是 <code>world-v1</code> service。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="k">for</span><span class=""> i in </span><span class="k">$(</span><span class="">seq </span><span class="m">0</span><span class=""> </span><span class="m">10000</span><span class="k">)</span><span class="p">;</span><span class="k">do</span><span class=""> </span><span class="nb">echo</span><span class=""> </span><span class="nv">$i</span><span class="p">;</span><span class="">curl -s -H </span><span class="s2">&#34;Host: www.hello.world&#34;</span><span class=""> </span><span class="m">172</span><span class="">.20.0.120:4141</span><span class="p">;</span><span class="k">done</span><span class=""></span></code></pre>
</div>
<p>使用 ab test。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ab -c </span><span class="m">4</span><span class=""> -n </span><span class="m">10000</span><span class="">  -H </span><span class="s2">&#34;Host: www.hello.world&#34;</span><span class=""> http://172.20.0.120:4141/
</span><span class="">This is ApacheBench, Version </span><span class="m">2</span><span class="">.3 &lt;</span><span class="nv">$Revision</span><span class="">: </span><span class="m">1757674</span><span class=""> $&gt;
</span><span class="">Copyright </span><span class="m">1996</span><span class=""> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class="">Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class="">
</span><span class="">Benchmarking </span><span class="m">172</span><span class="">.20.0.120 </span><span class="o">(</span><span class="">be patient</span><span class="o">)</span><span class="">
</span><span class="">Completed </span><span class="m">1000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">2000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">3000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">4000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">5000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">6000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">7000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">8000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">9000</span><span class=""> requests
</span><span class="">Completed </span><span class="m">10000</span><span class=""> requests
</span><span class="">Finished </span><span class="m">10000</span><span class=""> requests
</span><span class="">
</span><span class="">
</span><span class="">Server Software:        
</span><span class="">Server Hostname:        </span><span class="m">172</span><span class="">.20.0.120
</span><span class="">Server Port:            </span><span class="m">4141</span><span class="">
</span><span class="">
</span><span class="">Document Path:          /
</span><span class="">Document Length:        </span><span class="m">43</span><span class=""> bytes
</span><span class="">
</span><span class="">Concurrency Level:      </span><span class="m">4</span><span class="">
</span><span class="">Time taken </span><span class="k">for</span><span class=""> tests:   </span><span class="m">262</span><span class="">.505 seconds
</span><span class="">Complete requests:      </span><span class="m">10000</span><span class="">
</span><span class="">Failed requests:        </span><span class="m">0</span><span class="">
</span><span class="">Total transferred:      </span><span class="m">2210000</span><span class=""> bytes
</span><span class="">HTML transferred:       </span><span class="m">430000</span><span class=""> bytes
</span><span class="">Requests per second:    </span><span class="m">38</span><span class="">.09 </span><span class="o">[</span><span class="c1">#/sec] (mean)
</span><span class="c1"></span><span class="">Time per request:       </span><span class="m">105</span><span class="">.002 </span><span class="o">[</span><span class="">ms</span><span class="o">]</span><span class=""> </span><span class="o">(</span><span class="">mean</span><span class="o">)</span><span class="">
</span><span class="">Time per request:       </span><span class="m">26</span><span class="">.250 </span><span class="o">[</span><span class="">ms</span><span class="o">]</span><span class=""> </span><span class="o">(</span><span class="">mean, across all concurrent requests</span><span class="o">)</span><span class="">
</span><span class="">Transfer rate:          </span><span class="m">8</span><span class="">.22 </span><span class="o">[</span><span class="">Kbytes/sec</span><span class="o">]</span><span class=""> received
</span><span class="">
</span><span class="">Connection Times </span><span class="o">(</span><span class="">ms</span><span class="o">)</span><span class="">
</span><span class="">              min  mean</span><span class="o">[</span><span class="">+/-sd</span><span class="o">]</span><span class=""> median   max
</span><span class="">Connect:       </span><span class="m">36</span><span class="">   </span><span class="m">51</span><span class="">  </span><span class="m">91</span><span class="">.1     </span><span class="m">39</span><span class="">    </span><span class="m">2122</span><span class="">
</span><span class="">Processing:    </span><span class="m">39</span><span class="">   </span><span class="m">54</span><span class="">  </span><span class="m">29</span><span class="">.3     </span><span class="m">46</span><span class="">     </span><span class="m">585</span><span class="">
</span><span class="">Waiting:       </span><span class="m">39</span><span class="">   </span><span class="m">52</span><span class="">  </span><span class="m">20</span><span class="">.3     </span><span class="m">46</span><span class="">     </span><span class="m">362</span><span class="">
</span><span class="">Total:         </span><span class="m">76</span><span class="">  </span><span class="m">105</span><span class="">  </span><span class="m">96</span><span class="">.3     </span><span class="m">88</span><span class="">    </span><span class="m">2216</span><span class="">
</span><span class="">
</span><span class="">Percentage of the requests served within a certain </span><span class="nb">time</span><span class=""> </span><span class="o">(</span><span class="">ms</span><span class="o">)</span><span class="">
</span><span class="">  </span><span class="m">50</span><span class="">%     </span><span class="m">88</span><span class="">
</span><span class="">  </span><span class="m">66</span><span class="">%     </span><span class="m">93</span><span class="">
</span><span class="">  </span><span class="m">75</span><span class="">%     </span><span class="m">99</span><span class="">
</span><span class="">  </span><span class="m">80</span><span class="">%    </span><span class="m">103</span><span class="">
</span><span class="">  </span><span class="m">90</span><span class="">%    </span><span class="m">119</span><span class="">
</span><span class="">  </span><span class="m">95</span><span class="">%    </span><span class="m">146</span><span class="">
</span><span class="">  </span><span class="m">98</span><span class="">%    </span><span class="m">253</span><span class="">
</span><span class="">  </span><span class="m">99</span><span class="">%    </span><span class="m">397</span><span class="">
</span><span class=""> </span><span class="m">100</span><span class="">%   </span><span class="m">2216</span><span class=""> </span><span class="o">(</span><span class="">longest request</span><span class="o">)</span></code></pre>
</div>
<h2 id="监控-kubernets-中的服务与实例">监控 kubernets 中的服务与实例</h2>

<p>访问 <a href="http://linkerd.jimmysong.io/">http://linkerd.jimmysong.io</a> 查看流量情况</p>

<p>Outcoming</p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-helloworld-outgoing.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-helloworld-outgoing.jpg" alt="linkerd监控" /></a></p>

<p>Incoming</p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-helloworld-incoming.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-helloworld-incoming.jpg" alt="linkerd监控" /></a></p>

<p>访问 <a href="http://linkerd-viz.jimmysong.io/">http://linkerd-viz.jimmysong.io</a> 查看应用 metric 监控</p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-grafana.png"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-grafana.png" alt="linkerd性能监控" /></a></p>

<h2 id="测试路由">测试路由</h2>

<p>测试在 http header 中增加 dtab 规则。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ curl -H </span><span class="s2">&#34;Host: www.hello.world&#34;</span><span class=""> -H </span><span class="s2">&#34;l5d-dtab:/host/world =&gt; /srv/world-v2;&#34;</span><span class=""> </span><span class="m">172</span><span class="">.20.0.120:4141 
</span><span class="">Hello </span><span class="o">(</span><span class="m">172</span><span class="">.30.60.14</span><span class="o">)</span><span class=""> earth </span><span class="o">(</span><span class="m">172</span><span class="">.30.94.40</span><span class="o">)</span><span class="">!!</span></code></pre>
</div>
<p>请注意调用返回的结果，表示调用的是 <code>world-v2</code> 的 service。</p>

<p>另外再对比 ab test 的结果与 <code>linkerd-viz</code> 页面上的结果，可以看到结果一致。</p>

<p>但是我们可能不想把该功能暴露给所有人，所以可以在前端部署一个 nginx 来过滤 header 中的 <code>l5d-dtab</code> 打头的字段，并通过设置 cookie 的方式来替代 header 里的 <code>l5d-dtab</code> 字段。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="nv">http_proxy</span><span class=""></span><span class="o">=</span><span class="">http://172.20.0.120:4141 curl -s http:/hello
</span><span class="">Hello </span><span class="o">(</span><span class="m">172</span><span class="">.30.60.14</span><span class="o">)</span><span class=""> world </span><span class="o">(</span><span class="m">172</span><span class="">.30.71.19</span><span class="o">)</span><span class="">!!</span></code></pre>
</div>
<h2 id="将-linkerd-作为-ingress-controller">将 Linkerd 作为 Ingress controller</h2>

<p>将 Linkerd 作为 kubernetes ingress controller 的方式跟将 Treafik 作为 ingress controller 的过程过程完全一样，可以直接参考 <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">边缘节点配置</a>。</p>

<p>架构如下图所示。</p>

<p><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/images/linkerd-ingress-controller.jpg"><img src="https://github.com/rootsongjc/kubernetes-handbook/raw/master/images/linkerd-ingress-controller.jpg" alt="Linkerd ingress controller" /></a></p>

<p><em>(图片来自 A Service Mesh for Kubernetes - Buoyant.io)</em></p>

<p>当然可以绕过 kubernetes ingress controller 直接使用 linkerd 作为边界路由，通过 dtab 和 linkerd 前面的 nginx 来路由流量。</p>

<h2 id="后记">后记</h2>

<p>看了 Linkerd 的官方示例 <a href="https://github.com/linkerd/linkerd-examples/">linkerd-examples</a> 和 <a href="https://cdn2.hubspot.net/hubfs/2818724/A%20Service%20Mesh%20for%20Kubernetes_Final.pdf">A Service Mesh for Kubernetes</a> 个人感觉两者配合起来讲解的不是很清楚，每个章节不是特别的独立，也不是很有逻辑性。</p>

<p>Linkerd 跟 Istio 一样都是 service mesh，可以在服务间做很多事情，但是 istio 使用起来更加简单灵活，两者的功能基本一样，不过我更倾向于 Istio，因为它更轻量级，不需要在每个节点都部署一个 DaemonSet，并且使用 ingress 也更方便与 kubernetes 集成。</p>

<h2 id="参考">参考</h2>

<p><a href="https://github.com/linkerd/linkerd-examples/">https://github.com/linkerd/linkerd-examples/</a></p>

<p><a href="https://cdn2.hubspot.net/hubfs/2818724/A%20Service%20Mesh%20for%20Kubernetes_Final.pdf">A Service Mesh for Kubernetes</a></p>

<p><a href="https://linkerd.io/in-depth/dtabs/">dtab</a></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/talks/migrating-to-cloud-native-architecture/">迁移到云原生应用架构指南</a></li>
                
                <li><a href="/blogs/deploy-applications-in-kubernetes/">适用于kubernetes的应用开发与部署流程详解</a></li>
                
                <li><a href="/talks/book-kubernetes-management-design-patterns/">记一本关于kubernetes management design patterns的书</a></li>
                
                <li><a href="/blogs/exploring-kubernetes-env-with-docker/">Kubernetes中的服务发现与docker容器间的环境变量传递源码探究</a></li>
                
                <li><a href="/projects/awesome-cloud-native/">Awesome Cloud Native</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Aug 1, 2017 </h4>
        <h5 id="wc"> 1600 Words </h5>
        <h5 id="readtime"> Read in about 4 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/cloud-native">cloud-native</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/service-mesh">service-mesh</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/talks/cloud-native-python/"><i class="icon-arrow-left"></i> Cloud Native Python—使用Python和React构建云原生应用</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/talks/migrating-to-cloud-native-architecture/">迁移到云原生应用架构指南 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1565">
<meta itemprop="datePublished" content="2017-08-01">
<meta itemprop="url" content="https://jimmysong.io/blogs/linkerd-user-guide/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
