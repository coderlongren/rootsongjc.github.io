<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://jimmysong.io/blogs/data-persistence-problem/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-07-11"/>
<meta property="article:modified_time" content="2017-07-11"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="http://jimmysong.io/">
    <title> Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究 - Jimmy Song </title>
    <link rel="canonical" href="http://jimmysong.io/blogs/data-persistence-problem/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e6%8c%81%e4%b9%85%e5%8c%96%e9%97%ae%e9%a2%98%e7%9a%84%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%e8%ae%a8%e8%ae%ba%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e6%8e%a2%e7%a9%b6-http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f&title=Kubernetes%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e6%8c%81%e4%b9%85%e5%8c%96%e9%97%ae%e9%a2%98%e7%9a%84%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%e8%ae%a8%e8%ae%ba%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e6%8e%a2%e7%a9%b6&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdata-persistence-problem%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p>本文已归档到<a href="https://github.com/rootsongjc/kubernetes-handbook/">kubernetes-handbook</a>中的【最佳实践—运维管理】章节中，一切内容以kubernetes-handbook为准。</p>

<h2 id="数据落盘问题的由来">数据落盘问题的由来</h2>

<p>这本质上是数据持久化问题，对于有些应用依赖持久化数据，比如应用自身产生的日志需要持久化存储的情况，需要保证容器里的数据不丢失，在Pod挂掉后，其他应用依然可以访问到这些数据，因此我们需要将数据持久化存储起来。</p>

<h2 id="数据落盘问题解决方案">数据落盘问题解决方案</h2>

<p>下面以一个应用的日志收集为例，该日志需要持久化收集到ElasticSearch集群中，如果不考虑数据丢失的情形，可以直接使用<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中【应用日志收集】一节中的方法，但考虑到Pod挂掉时logstash（或filebeat）并没有收集完该pod内日志的情形，我们想到了如下这种解决方案，示意图如下：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/log-persistence-logstash.png" alt="日志持久化收集解决方案示意图" /></p>

<ol>
<li>首先需要给数据落盘的应用划分node，即这些应用只调用到若干台主机上</li>
<li>给这若干台主机增加label</li>
<li>使用<code>deamonset</code>方式在这若干台主机上启动logstash的Pod（使用nodeSelector来限定在这几台主机上，我们在边缘节点启动的<code>treafik</code>也是这种模式）</li>
<li>将应用的数据通过volume挂载到宿主机上</li>
<li>Logstash（或者filebeat）收集宿主机上的数据，数据持久化不会丢失</li>
</ol>

<h2 id="side-effect">Side-effect</h2>

<ol>
<li>首先kubernetes本身就提供了数据持久化的解决方案statefulset，不过需要用到公有云的存储货其他分布式存储，这一点在我们的私有云环境里被否定了。</li>
<li>需要管理主机的label，增加运维复杂度，但是具体问题具体对待</li>
<li>必须保证应用启动顺序，需要先启动logstash</li>
<li>为主机打label使用nodeSelector的方式限制了资源调度的范围</li>
</ol>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Jul 11, 2017 </h4>
        <h5 id="wc"> 800 Words </h5>
        <h5 id="readtime"> Read in about 2 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://jimmysong.io/blogs/what-is-cloud-native-application-architecture/"><i class="icon-arrow-left"></i> 什么是云原生应用架构</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://jimmysong.io/blogs/kubernetes-kubectl-cheatsheat/">Kubernetes kubectl cheat sheat——Kubectl命令参考图 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="711">
<meta itemprop="datePublished" content="2017-07-11">
<meta itemprop="url" content="http://jimmysong.io/blogs/data-persistence-problem/">
 <footer>
    <div>
        <p>
            <a href="http://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="http://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="http://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="http://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
            Powered by <a href="http://gohugo.io">Hugo</a> </p>
    </div>
</footer>
</body>

</html>
