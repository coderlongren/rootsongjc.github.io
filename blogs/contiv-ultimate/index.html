<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="docker, docker plugin, network, cisco, contiv, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Contiv Ultimate-Docker17.03CE下思科docker网络插件contiv趟坑终极版 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/contiv-ultimate/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-17"/>
<meta property="article:modified_time" content="2017-03-17"/>



<meta property="article:tag" content="docker">
<meta property="article:tag" content="docker plugin">
<meta property="article:tag" content="network">
<meta property="article:tag" content="cisco">
<meta property="article:tag" content="contiv">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Contiv Ultimate-Docker17.03CE下思科docker网络插件contiv趟坑终极版 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Contiv Ultimate-Docker17.03CE下思科docker网络插件contiv趟坑终极版 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/contiv-ultimate/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Contiv%20Ultimate-Docker17.03CE%e4%b8%8b%e6%80%9d%e7%a7%91docker%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6contiv%e8%b6%9f%e5%9d%91%e7%bb%88%e6%9e%81%e7%89%88-https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f&title=Contiv%20Ultimate-Docker17.03CE%e4%b8%8b%e6%80%9d%e7%a7%91docker%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6contiv%e8%b6%9f%e5%9d%91%e7%bb%88%e6%9e%81%e7%89%88&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fcontiv-ultimate%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Contiv Ultimate-Docker17.03CE下思科docker网络插件contiv趟坑终极版</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20140810001.jpg" alt="广州石牌桥" /></p>

<p><em>（题图：广州石牌桥 Aug 10,2014）</em></p>

<p>前几天写的几篇<a href="http://rootsongjc.github.io/tags/contiv/">关于Contiv的文章</a>已经把引入坑了😂</p>

<p>今天这篇文章将带领大家用正确的姿势编译和打包一个<strong>contiv netplugin</strong>。</p>

<blockquote>
<p>请一定要在<strong>Linux</strong>环境中编译。docker中编译也会报错，最好还是搞个虚拟🐔吧，最好还有VPN能翻墙。</p>
</blockquote>

<h2 id="环境准备">环境准备</h2>

<p>我使用的是docker17.03-CE、安装了open vSwitch(这个包redhat的源里没有，需要自己的编译安装)，如果你懒得编译可以用我编译的rpm包，<a href="http://olz1di9xf.bkt.clouddn.com/openvswitch-2.5.0-2.el7.x86_64.rpm">点这里下载</a>。</p>

<h2 id="编译">编译</h2>

<p>这一步是很容易失败的，有人提过<a href="https://github.com/contiv/netplugin/issues/779">issue-779</a></p>

<p><strong>具体步骤</strong></p>

<ul>
<li>创建一个link <strong>/go</strong>链接到你的GOPATH目录，下面编译的时候要用。</li>
<li>将源码的<strong>vender</strong>目录下的文件拷贝到$GOPATH/src目录。</li>
<li>执行编译</li>
</ul>

<p>在netplugin目录下执行以下命令能够编译出二进制文件。</p>

<pre><code>NET_CONTAINER_BUILD=1 make build
</code></pre>

<p>在你的<strong>/$GOPATH/bin</strong>目录下应该会有如下几个文件：</p>

<pre><code>contivk8s  github-release  godep  golint  misspell  modelgen  netcontiv  netctl  netmaster  netplugin
</code></pre>

<p><em>⚠️编译过程中可能会遇到 有些包不存在或者需要翻墙下载。</em></p>

<h2 id="打包">打包</h2>

<p>我们将其打包为docker plugin。</p>

<p>Makefile里用于创建plugin rootfs的命令是：</p>
<div class="highlight"><pre class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="">host-pluginfs-create:
</span><span class="">        @echo dev: creating a docker v2plugin rootfs ...
</span><span class="">        sh scripts/v2plugin_rootfs.sh</span></code></pre>
</div>
<p><strong>v2plugin_rootfs.sh</strong>这个脚本的内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="ch">#!/bin/bash
</span><span class="ch"></span><span class="c1"># Script to create the docker v2 plugin
</span><span class="c1"># run this script from contiv/netplugin directory
</span><span class="c1"></span><span class="">
</span><span class=""></span><span class="nb">echo</span><span class=""> </span><span class="s2">&#34;Creating rootfs for v2plugin &#34;</span><span class="">, </span><span class="si">${</span><span class="nv">CONTIV_V2PLUGIN_NAME</span><span class="si">}</span><span class="">
</span><span class="">cat install/v2plugin/config.template </span><span class="p">|</span><span class=""> grep -v </span><span class="s2">&#34;##&#34;</span><span class=""> &gt; install/v2plugin/config.json
</span><span class="">sed -i </span><span class="s2">&#34;s%PluginName%</span><span class="si">${</span><span class="nv">CONTIV_V2PLUGIN_NAME</span><span class="si">}</span><span class="s2">%&#34;</span><span class=""> install/v2plugin/config.json
</span><span class="">cp bin/netplugin bin/netmaster bin/netctl install/v2plugin
</span><span class="">docker build -t contivrootfs install/v2plugin
</span><span class=""></span><span class="nv">id</span><span class=""></span><span class="o">=</span><span class="k">$(</span><span class="">docker create contivrootfs </span><span class="nb">true</span><span class="k">)</span><span class="">
</span><span class="">mkdir -p install/v2plugin/rootfs
</span><span class="">sudo docker </span><span class="nb">export</span><span class=""> </span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">id</span><span class="si">}</span><span class="s2">&#34;</span><span class=""> </span><span class="p">|</span><span class=""> sudo tar -x -C install/v2plugin/rootfs
</span><span class="">docker rm -vf </span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">id</span><span class="si">}</span><span class="s2">&#34;</span><span class="">
</span><span class="">docker rmi contivrootfs
</span><span class="">rm install/v2plugin/netplugin install/v2plugin/netmaster install/v2plugin/netctl</span></code></pre>
</div>
<p>先把<code>$GOPATH/bin</code>下生成的<code>netplugin</code>、<code>netmaster</code>、<code>netctl</code>、<code>netplugin</code>这几个二进制文件拷贝到netplugin源码的bin目录下。</p>

<p>这里面用语创建contivrootfs镜像的Dockerfile内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class=""># Docker v2plugin container with OVS / netplugin / netmaster 
</span><span class="">
</span><span class="">FROM alpine:3.5
</span><span class="">MAINTAINER Cisco Contiv (http://contiv.github.io/)
</span><span class="">
</span><span class="">RUN mkdir -p /run/docker/plugins /etc/openvswitch /var/run/contiv/log \
</span><span class="">    &amp;&amp; echo &#39;http://dl-cdn.alpinelinux.org/alpine/v3.4/main&#39; &gt;&gt; /etc/apk/repositories \
</span><span class="">    &amp;&amp; apk update &amp;&amp; apk add openvswitch=2.5.0-r0 iptables
</span><span class="">
</span><span class="">COPY netplugin netmaster netctl startcontiv.sh /
</span><span class="">
</span><span class="">ENTRYPOINT [&#34;/startcontiv.sh&#34;]</span></code></pre>
</div>
<p>执行<code>make host-pluginfs-create</code>创建rootfs。</p>

<p>创建出了rootfs后，然后执行</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="">docker plugin create localhost:5000/contiv/netplugin .
</span><span class="">docker push localhost:5000/contiv/netplugin</span></code></pre>
</div>
<blockquote>
<p>注：我们将插件push到docker registry的镜像仓库中，当前<a href="www.github.com/vmware/harbor">Harbor</a>还不支持docker插件的push。</p>
</blockquote>

<p><strong>Install plugin</strong></p>

<p>下面是编译和安装我自己生成v2plugin的过程。</p>

<p>修改<strong>config.json</strong>文件中的<code>plugin_name</code>字段的值为插件的名称。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nv">$docker</span><span class=""> plugin install localhost:5000/contiv/v2plugin 
</span><span class="">Plugin </span><span class="s2">&#34;localhost:5000/contiv/v2plugin&#34;</span><span class=""> is requesting the following privileges:
</span><span class=""> - network: </span><span class="o">[</span><span class="">host</span><span class="o">]</span><span class="">
</span><span class=""> - mount: </span><span class="o">[</span><span class="">/etc/openvswitch</span><span class="o">]</span><span class="">
</span><span class=""> - mount: </span><span class="o">[</span><span class="">/var/log/openvswitch</span><span class="o">]</span><span class="">
</span><span class=""> - mount: </span><span class="o">[</span><span class="">/var/run</span><span class="o">]</span><span class="">
</span><span class=""> - mount: </span><span class="o">[</span><span class="">/lib/modules</span><span class="o">]</span><span class="">
</span><span class=""> - capabilities: </span><span class="o">[</span><span class="">CAP_SYS_ADMIN CAP_NET_ADMIN CAP_SYS_MODULE</span><span class="o">]</span><span class="">
</span><span class="">Do you grant the above permissions? </span><span class="o">[</span><span class="">y/N</span><span class="o">]</span><span class=""> y
</span><span class="">latest: Pulling from contiv/v2plugin
</span><span class="">fd87a71d9090: Download </span><span class="nb">complete</span><span class=""> 
</span><span class="">Digest: sha256:b13ad7930f771c9602acf562c2ae147482466f4d94e708692a215935663215a6
</span><span class="">Status: Downloaded newer image </span><span class="k">for</span><span class=""> localhost:5000/contiv/v2plugin:latest
</span><span class="">Installed plugin localhost:5000/contiv/v2plugin</span></code></pre>
</div>
<p>自己create的插件enable的时候从docker daemon的日志中依然可以看到之前看到找不到socket的错误，实际上也确实是没有生成。如果直接使用<code>docker plugin install store/contiv/v2plugin:1.0.0-beta.3</code>的方式安装插件是没有问题的。</p>

<h2 id="docker17-03-ce中插件机制存在的问题">Docker17.03-CE中插件机制存在的问题</h2>

<p>Docker17.03的插件机制是为了docker公司的商业化策略而实行的，所有的docker插件都运行在自己的namespace和rootfs中，插件接口</p>

<p><strong>Plugin backend接口</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// Backend for Plugin
</span><span class="c1"></span><span class="kd">type</span><span class=""> </span><span class="nx">Backend</span><span class=""> </span><span class="kd">interface</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="nx">Disable</span><span class="p">(</span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">config</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginDisableConfig</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">Enable</span><span class="p">(</span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">config</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginEnableConfig</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">List</span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span><span class=""> </span><span class="p">([]</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">,</span><span class=""> </span><span class="kt">error</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="nx">Inspect</span><span class="p">(</span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">)</span><span class=""> </span><span class="p">(</span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">,</span><span class=""> </span><span class="kt">error</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">config</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginRmConfig</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">Set</span><span class="p">(</span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">args</span><span class=""> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">Privileges</span><span class="p">(</span><span class="nx">ctx</span><span class=""> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class=""> </span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">,</span><span class=""> </span><span class="nx">metaHeaders</span><span class=""> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span><span class=""> </span><span class="nx">authConfig</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">AuthConfig</span><span class="p">)</span><span class=""> </span><span class="p">(</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginPrivileges</span><span class="p">,</span><span class=""> </span><span class="kt">error</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="nx">Pull</span><span class="p">(</span><span class="nx">ctx</span><span class=""> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class=""> </span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">,</span><span class=""> </span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">metaHeaders</span><span class=""> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span><span class=""> </span><span class="nx">authConfig</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">AuthConfig</span><span class="p">,</span><span class=""> </span><span class="nx">privileges</span><span class=""> </span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginPrivileges</span><span class="p">,</span><span class=""> </span><span class="nx">outStream</span><span class=""> </span><span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">Push</span><span class="p">(</span><span class="nx">ctx</span><span class=""> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class=""> </span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">metaHeaders</span><span class=""> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span><span class=""> </span><span class="nx">authConfig</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">AuthConfig</span><span class="p">,</span><span class=""> </span><span class="nx">outStream</span><span class=""> </span><span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">Upgrade</span><span class="p">(</span><span class="nx">ctx</span><span class=""> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class=""> </span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">,</span><span class=""> </span><span class="nx">name</span><span class=""> </span><span class="kt">string</span><span class="p">,</span><span class=""> </span><span class="nx">metaHeaders</span><span class=""> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span><span class=""> </span><span class="nx">authConfig</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">AuthConfig</span><span class="p">,</span><span class=""> </span><span class="nx">privileges</span><span class=""> </span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginPrivileges</span><span class="p">,</span><span class=""> </span><span class="nx">outStream</span><span class=""> </span><span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class="">	</span><span class="nx">CreateFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class=""> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class=""> </span><span class="nx">tarCtx</span><span class=""> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadCloser</span><span class="p">,</span><span class=""> </span><span class="nx">options</span><span class=""> </span><span class="o">*</span><span class="nx">enginetypes</span><span class="p">.</span><span class="nx">PluginCreateOptions</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>从Plugin的后端接口中可以看到，没有像镜像一样的两个常用方法：</p>

<ul>
<li>没有修改plugin名字的方法，因为没有这个方法，就无法push plugin到自己的镜像仓库，另外<strong>Harbor</strong>还是不支持<code>docker plugin push</code> <a href="https://github.com/vmware/harbor/issues/1532">Issue-1532</a>。</li>
<li>没有导出plugin的方法，这样就只能在联网的主机上安装docker plugin了，对于无法联网的主机只好束手无策了。</li>
</ul>

<p>估计docker官方也不会开放这两个接口吧。毕竟这是<strong>Docker EE</strong> 的一个重要卖点：</p>

<blockquote>
<p><strong>Docker EE&rsquo;s Certified Plugins</strong> provide networking and volume plugins and easy to download and install containers to the Docker EE environment.</p>
</blockquote>

<h2 id="疑问">疑问</h2>

<p><strong>为什么一定要使用docker plugin install</strong></p>

<p>因为<code>docker plugin install</code>的时候会申请一些访问权限。</p>

<p>这一块在上面的步骤中可以看到。</p>

<p><strong>为什么docker plugin不能改名字？</strong></p>

<p>我们看下Plugin的结构体（在api/types/plugin.go中定义）：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Plugin A plugin for the Engine API
</span><span class="c1">// swagger:model Plugin
</span><span class="c1"></span><span class="kd">type</span><span class=""> </span><span class="nx">Plugin</span><span class=""> </span><span class="kd">struct</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// config
</span><span class="c1"></span><span class="">	</span><span class="c1">// Required: true
</span><span class="c1"></span><span class="">	</span><span class="nx">Config</span><span class=""> </span><span class="nx">PluginConfig</span><span class=""> </span><span class="s">`json:&#34;Config&#34;`</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// True when the plugin is running. False when the plugin is not running, only installed.
</span><span class="c1"></span><span class="">	</span><span class="c1">// Required: true
</span><span class="c1"></span><span class="">	</span><span class="nx">Enabled</span><span class=""> </span><span class="kt">bool</span><span class=""> </span><span class="s">`json:&#34;Enabled&#34;`</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// Id
</span><span class="c1"></span><span class="">	</span><span class="nx">ID</span><span class=""> </span><span class="kt">string</span><span class=""> </span><span class="s">`json:&#34;Id,omitempty&#34;`</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// name
</span><span class="c1"></span><span class="">	</span><span class="c1">// Required: true
</span><span class="c1"></span><span class="">	</span><span class="nx">Name</span><span class=""> </span><span class="kt">string</span><span class=""> </span><span class="s">`json:&#34;Name&#34;`</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// plugin remote reference used to push/pull the plugin
</span><span class="c1"></span><span class="">	</span><span class="nx">PluginReference</span><span class=""> </span><span class="kt">string</span><span class=""> </span><span class="s">`json:&#34;PluginReference,omitempty&#34;`</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// settings
</span><span class="c1"></span><span class="">	</span><span class="c1">// Required: true
</span><span class="c1"></span><span class="">	</span><span class="nx">Settings</span><span class=""> </span><span class="nx">PluginSettings</span><span class=""> </span><span class="s">`json:&#34;Settings&#34;`</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>注意其中有一个<code>PluginReference</code>结构体，它的方法有：</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="kd">type</span><span class=""> </span><span class="nx">pluginReference</span><span class=""> </span><span class="kd">struct</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="nx">name</span><span class="">     </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="">
</span><span class="">	</span><span class="nx">pluginID</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">References</span><span class="p">(</span><span class="nx">id</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">)</span><span class=""> </span><span class="p">[]</span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">pluginID</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="nx">id</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="k">return</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="p">[]</span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">{</span><span class="nx">r</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">ReferencesByName</span><span class="p">(</span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">)</span><span class=""> </span><span class="p">[]</span><span class="nx">refstore</span><span class="p">.</span><span class="nx">Association</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="p">[]</span><span class="nx">refstore</span><span class="p">.</span><span class="nx">Association</span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="p">{</span><span class="">
</span><span class="">			</span><span class="nx">Ref</span><span class="p">:</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="">
</span><span class="">			</span><span class="nx">ID</span><span class="p">:</span><span class="">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">pluginID</span><span class="p">,</span><span class="">
</span><span class="">		</span><span class="p">},</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">)</span><span class=""> </span><span class="p">(</span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">,</span><span class=""> </span><span class="kt">error</span><span class="p">)</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="nx">ref</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="k">return</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">),</span><span class=""> </span><span class="nx">refstore</span><span class="p">.</span><span class="nx">ErrDoesNotExist</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="nx">r</span><span class="p">.</span><span class="nx">pluginID</span><span class="p">,</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">AddTag</span><span class="p">(</span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">,</span><span class=""> </span><span class="nx">id</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">,</span><span class=""> </span><span class="nx">force</span><span class=""> </span><span class="kt">bool</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="c1">// Read only, ignore
</span><span class="c1"></span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">AddDigest</span><span class="p">(</span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Canonical</span><span class="p">,</span><span class=""> </span><span class="nx">id</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span><span class="nx">Digest</span><span class="p">,</span><span class=""> </span><span class="nx">force</span><span class=""> </span><span class="kt">bool</span><span class="p">)</span><span class=""> </span><span class="kt">error</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="c1">// Read only, ignore
</span><span class="c1"></span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="p">(</span><span class="nx">r</span><span class=""> </span><span class="o">*</span><span class="nx">pluginReference</span><span class="p">)</span><span class=""> </span><span class="nx">Delete</span><span class="p">(</span><span class="nx">ref</span><span class=""> </span><span class="nx">reference</span><span class="p">.</span><span class="nx">Named</span><span class="p">)</span><span class=""> </span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class=""> </span><span class="kt">error</span><span class="p">)</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="c1">// Read only, ignore
</span><span class="c1"></span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="kc">false</span><span class="p">,</span><span class=""> </span><span class="kc">nil</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p>注意其中有三个方法<code>AddTag</code>、<code>AddDigest</code>、<code>Delete</code>方法都是只读的。在<code>migrate/v1/migratev1.go</code>中有引用到了这个。</p>

<p>再看下<strong>Reference</strong>的的定义（vendor/github.com/docker/distribution/reference/reference.go）</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// Package reference provides a general type to represent any way of referencing images within the registry.
</span><span class="c1">// Its main purpose is to abstract tags and digests (content-addressable hash).
</span><span class="c1">//
</span><span class="c1">// Grammar
</span><span class="c1">//
</span><span class="c1">// 	reference                       := name [ &#34;:&#34; tag ] [ &#34;@&#34; digest ]
</span><span class="c1">//	name                            := [domain &#39;/&#39;] path-component [&#39;/&#39; path-component]*
</span><span class="c1">//	domain                          := domain-component [&#39;.&#39; domain-component]* [&#39;:&#39; port-number]
</span><span class="c1">//	domain-component                := /([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])/
</span><span class="c1">//	port-number                     := /[0-9]+/
</span><span class="c1">//	path-component                  := alpha-numeric [separator alpha-numeric]*
</span><span class="c1">// 	alpha-numeric                   := /[a-z0-9]+/
</span><span class="c1">//	separator                       := /[_.]|__|[-]*/
</span><span class="c1">//
</span><span class="c1">//	tag                             := /[\w][\w.-]{0,127}/
</span><span class="c1">//
</span><span class="c1">//	digest                          := digest-algorithm &#34;:&#34; digest-hex
</span><span class="c1">//	digest-algorithm                := digest-algorithm-component [ digest-algorithm-separator digest-algorithm-component ]
</span><span class="c1">//	digest-algorithm-separator      := /[+.-_]/
</span><span class="c1">//	digest-algorithm-component      := /[A-Za-z][A-Za-z0-9]*/
</span><span class="c1">//	digest-hex                      := /[0-9a-fA-F]{32,}/ ; At least 128 bit digest value
</span><span class="c1">//
</span><span class="c1">//	identifier                      := /[a-f0-9]{64}/
</span><span class="c1">//	short-identifier                := /[a-f0-9]{6,64}/
</span><span class="c1">// Reference is an opaque object reference identifier that may include
</span><span class="c1"></span><span class="o">//</span><span class=""> </span><span class="nx">modifiers</span><span class=""> </span><span class="nx">such</span><span class=""> </span><span class="nx">as</span><span class=""> </span><span class="nx">a</span><span class=""> </span><span class="nx">hostname</span><span class="p">,</span><span class=""> </span><span class="nx">name</span><span class="p">,</span><span class=""> </span><span class="nx">tag</span><span class="p">,</span><span class=""> </span><span class="nx">and</span><span class=""> </span><span class="nx">digest</span><span class="p">.</span></code></pre>
</div>
<p>修改plugin的名字的方法是不是还没实现？</p>

<h2 id="解决方法">解决方法</h2>

<p>在代码存在bug的情况下，可以先用下面的方法暂时创建plugin。</p>

<p>虽然docker代码里没有提供<strong>rename plugin</strong>的接口，但是使用<strong>docker install</strong>命令安装的plugin会存储在<code>/var/lib/docker/plugins/${PLUGIN_ID}</code>目录下。</p>

<p>可以在这个目录下使用<strong>docker plugin create</strong>命令创建你自己想要的名称的docker plugin。</p>

<p>使用<code>docker plugin set</code>命令修改plugin中的属性:</p>

<ul>
<li>cluster_store</li>
<li>plugin_role</li>
<li>plugin_name</li>
</ul>

<p><strong>插件调试</strong></p>

<p>日志地址<code>/run/contiv/log/</code>。</p>

<p>从非master节点的netplugin启动日志<code>netplugin_bootup.log</code>中可以看到：</p>

<pre><code>V2 Plugin logs
Loading OVS
Starting OVS
Starting Netplugin 
/netplugin -debug -plugin-mode docker -vlan-if  -cluster-store etcd://172.20.0.113:2379  
Not starting netmaster as plugin role is none
</code></pre>

<p>Netplugin启动的时候是正确的解析了<strong>etcd</strong>的配置了。</p>

<p>但是我们再看一下<code>netplugin.log</code>的日志后就会发现，启动还是失败了。</p>

<pre><code>time=&quot;Mar 21 03:20:37.537954358&quot; level=debug msg=&quot;Got link list(16): [0xc4203fe200 0xc4203fe300 0xc4203fe400 0xc4203fe500 0xc420420000 0xc420420090 0xc420420120 0xc4204201b0 0xc420420240 0xc4204202d0 0xc420420360 0xc4204203f0 0xc420420480 0xc420420510 0xc4203feb80 0xc4203fec80]&quot;
time=&quot;Mar 21 03:20:37.538576647&quot; level=error msg=&quot;Failed to connect to etcd. Err: client: etcd cluster is unavailable or misconfigured&quot;
time=&quot;Mar 21 03:20:37.538599827&quot; level=error msg=&quot;Error creating client etcd to url 127.0.0.1:2379. Err: client: etcd cluster is unavailable or misconfigured&quot;
time=&quot;Mar 21 03:20:37.538612813&quot; level=fatal msg=&quot;Error initializing cluster. Err: client: etcd cluster is unavailable or misconfigured&quot;
</code></pre>

<p><code>netplugin</code>没有正确的解析etcd的地址。这到底是为什么呢？bootup的日志里不是写的解析到了吗？这个问题还得研究下源码，也许是一个bug。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/contiv-v2plugin/">Contiv入坑指南-v2plugin</a></li>
                
                <li><a href="/blogs/contiv-tryout/">Contiv入坑指南-试用全记录</a></li>
                
                <li><a href="/blogs/contiv-guide/">思科开源docker网络插件Contiv简介</a></li>
                
                <li><a href="/blogs/docker-plugin-develop/">Docker17.03-CE插件开发案例</a></li>
                
                <li><a href="/blogs/docker-create-plugin/">Docker 17.03-CE create plugin源码解析</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Fri Mar 17, 2017 </h4>
        <h5 id="wc"> 2600 Words </h5>
        <h5 id="readtime"> Read in about 6 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/docker">docker</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/docker-plugin">docker plugin</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/network">network</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/cisco">cisco</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/contiv">contiv</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/talks/building-github-pages-with-hugo/"><i class="icon-arrow-left"></i> 零基础使用Hugo和GitHub Pages创建自己的博客</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/docker-plugin-develop/">Docker17.03-CE插件开发案例 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2527">
<meta itemprop="datePublished" content="2017-03-17">
<meta itemprop="url" content="https://jimmysong.io/blogs/contiv-ultimate/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
