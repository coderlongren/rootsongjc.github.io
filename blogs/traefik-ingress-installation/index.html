<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, traefik, ingress, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes traefik ingress安装试用 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/traefik-ingress-installation/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-20"/>
<meta property="article:modified_time" content="2017-04-20"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="traefik">
<meta property="article:tag" content="ingress">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes traefik ingress安装试用 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> Kubernetes traefik ingress安装试用 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/traefik-ingress-installation/">

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>
    hljs.initHighlightingOnLoad();
</script>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function() {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden; '>
    <img src='http://olz1di9xf.bkt.clouddn.com/jimmy.jpg' />
</div>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%20traefik%20ingress%e5%ae%89%e8%a3%85%e8%af%95%e7%94%a8-http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f&title=Kubernetes%20traefik%20ingress%e5%ae%89%e8%a3%85%e8%af%95%e7%94%a8&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2ftraefik-ingress-installation%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Kubernetes traefik ingress安装试用</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/20160915046.jpg" alt="fish" /></p>

<p><em>（题图：🐟@鱼缸 Sep 15,2016）</em></p>

<h2 id="前言">前言</h2>

<p>昨天翻了下<a href="http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/">Ingress解析</a>，然后安装试用了下<a href="https://traefik.io">traefik</a>，过程已同步到<a href="https://www.gitbook.com/book/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>上，Github地址<a href="https://github.com/rootsongjc/kubernetes-handbook">https://github.com/rootsongjc/kubernetes-handbook</a></p>

<h2 id="ingress简介">Ingress简介</h2>

<p>如果你还不了解，ingress是什么，可以先看下我翻译的Kubernetes官网上ingress的介绍<a href="http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/">Kubernetes Ingress解析</a>。</p>

<p><strong>理解Ingress</strong></p>

<p>简单的说，ingress就是从kubernetes集群外访问集群的入口，将用户的URL请求转发到不同的service上。Ingress相当于nginx、apache等负载均衡方向代理服务器，其中还包括规则定义，即URL的路由信息，路由信息得的刷新由<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-controllers">Ingress controller</a>来提供。</p>

<p><strong>理解Ingress Controller</strong></p>

<p>Ingress Controller 实质上可以理解为是个监视器，Ingress Controller 通过不断地跟 kubernetes API 打交道，实时的感知后端 service、pod 等变化，比如新增和减少 pod，service 增加与减少等；当得到这些变化信息后，Ingress Controller 再结合下文的 Ingress 生成配置，然后更新反向代理负载均衡器，并刷新其配置，达到服务发现的作用。</p>

<h2 id="部署traefik">部署Traefik</h2>

<p><strong>介绍traefik</strong></p>

<p><a href="https://traefik.io/">Traefik</a>是一款开源的反向代理与负载均衡工具。它最大的优点是能够与常见的微服务系统直接整合，可以实现自动化动态配置。目前支持Docker, Swarm, Mesos/Marathon, Mesos, Kubernetes, Consul, Etcd, Zookeeper, BoltDB, Rest API等等后端模型。</p>

<p>以下配置文件可以在<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>GitHub仓库中的<a href="manifests/traefik-ingress/">manifests/traefik-ingress/</a>目录下找到。</p>

<p><strong>创建ingress-rbac.yaml</strong></p>

<p>将用于service account验证。</p>

<pre><code class="language-Yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress
  namespace: kube-system

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: ingress
subjects:
  - kind: ServiceAccount
    name: ingress
    namespace: kube-system
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
</code></pre>

<p><strong>创建名为<code>traefik-ingress</code>的ingress</strong>，文件名traefik.yaml</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-ingress
spec:
  rules:
  - host: traefik.nginx.io
    http:
      paths:
      - path: /
        backend:
          serviceName: my-nginx
          servicePort: 80
  - host: traefik.frontend.io
    http:
      paths:
      - path: /
        backend:
          serviceName: frontend
          servicePort: 80
</code></pre>

<p>这其中的<code>backend</code>中要配置default namespace中启动的service名字。<code>path</code>就是URL地址后的路径，如traefik.frontend.io/path，service将会接受path这个路径，host最好使用service-name.filed1.filed2.domain-name这种类似主机名称的命名方式，方便区分服务。</p>

<p>根据你自己环境中部署的service的名字和端口自行修改，有新service增加时，修改该文件后可以使用<code>kubectl replace -f traefik.yaml</code>来更新。</p>

<p>我们现在集群中已经有两个service了，一个是nginx，另一个是官方的<code>guestbook</code>例子。</p>

<p><strong>创建Depeloyment</strong></p>

<pre><code class="language-Yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: traefik-ingress-lb
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      restartPolicy: Always
      serviceAccountName: ingress
      containers:
      - image: traefik
        name: traefik-ingress-lb
        resources:
          limits:
            cpu: 200m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: admin
          containerPort: 8580
          hostPort: 8580
        args:
        - --web
        - --web.address=:8580
        - --kubernetes
</code></pre>

<p>注意我们这里用的是Deploy类型，没有限定该pod运行在哪个主机上。Traefik的端口是8580。</p>

<p><strong>Traefik UI</strong></p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
  - name: web
    port: 80
    targetPort: 8580
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  rules:
  - host: traefik-ui.local
    http:
      paths:
      - path: /
        backend:
          serviceName: traefik-web-ui
          servicePort: web
</code></pre>

<p>配置完成后就可以启动treafik ingress了。</p>

<pre><code>kubectl create -f .
</code></pre>

<p>我查看到traefik的pod在<code>172.20.0.115</code>这台节点上启动了。</p>

<p>访问该地址<code>http://172.20.0.115:8580/</code>将可以看到dashboard。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/traefik-dashboard.jpg" alt="kubernetes-dashboard" /></p>

<p>左侧黄色部分部分列出的是所有的rule，右侧绿色部分是所有的backend。</p>

<h2 id="测试">测试</h2>

<p>在集群的任意一个节点上执行。假如现在我要访问nginx的&rdquo;/&ldquo;路径。</p>

<pre><code class="language-bash">$ curl -H Host:traefik.nginx.io http://172.20.0.115/
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>如果你需要在kubernetes集群以外访问就需要设置DNS，或者修改本机的hosts文件。</p>

<p>在其中加入：</p>

<pre><code>172.20.0.115 traefik.nginx.io
172.20.0.115 traefik.frontend.io
</code></pre>

<p>所有访问这些地址的流量都会发送给172.20.0.115这台主机，就是我们启动traefik的主机。</p>

<p>Traefik会解析http请求header里的Host参数将流量转发给Ingress配置里的相应service。</p>

<p>修改hosts后就就可以在kubernetes集群外访问以上两个service，如下图：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/traefik-nginx.jpg" alt="traefik-nginx" /></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/traefik-guestbook.jpg" alt="traefik-guestbook" /></p>

<h2 id="参考">参考</h2>

<p><a href="http://www.colabug.com/thread-1703745-1-1.html">Traefik-kubernetes 初试</a></p>

<p><a href="http://www.tuicool.com/articles/ZnuEfay">Traefik简介</a></p>

<p><a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook">Guestbook example</a></p>

        </article>
  </div>
</section>



<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Apr 20, 2017 </h4>
        <h5 id="wc"> 400 Words </h5>
        <h5 id="readtime"> Read in about 2 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/traefik">traefik</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/ingress">ingress</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/kubernetes-rbac-support/"><i class="icon-arrow-left"></i> Kubernetes中的RBAC支持</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/">Kubernetes ingress解析 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He also likes coding and writing. He can't live without music
            and movies. Most of his career is about big data and cloud native ecosystem. If you not see him on front of computer, he must being taking photoes in the outside, looking at his amazing photos at <a href=https://tuchong.com/1425795/>Jimmy's
            tuchong homepage</a>. He has recently been keen on microservices, DevOps, kubernetes, and cloud native application architectures.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="339">
<meta itemprop="datePublished" content="2017-04-20">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/traefik-ingress-installation/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

