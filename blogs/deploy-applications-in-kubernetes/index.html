<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="适用于kubernetes的应用开发与部署流程详解 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/deploy-applications-in-kubernetes/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-07-20"/>
<meta property="article:modified_time" content="2017-07-20"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="适用于kubernetes的应用开发与部署流程详解 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> 适用于kubernetes的应用开发与部署流程详解 - Jimmy Song </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/deploy-applications-in-kubernetes/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e9%80%82%e7%94%a8%e4%ba%8ekubernetes%e7%9a%84%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91%e4%b8%8e%e9%83%a8%e7%bd%b2%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3-https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f&title=%e9%80%82%e7%94%a8%e4%ba%8ekubernetes%e7%9a%84%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91%e4%b8%8e%e9%83%a8%e7%bd%b2%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fdeploy-applications-in-kubernetes%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">适用于kubernetes的应用开发与部署流程详解</h1>
        <div>
            <article itemprop="articleBody" id="content">
                <p><img src="http://olz1di9xf.bkt.clouddn.com/20170714048.jpg" alt="野三坡" /></p>

<p><em>（题图：风和日丽@野三坡 Jul 14,2017）</em></p>

<p>本文已归档在<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中的第3章【用户指南】中，一切更新以kubernetes-handbook中为准。</p>

<p>为了详细说明，我特意写了两个示例程序放在GitHub中，模拟应用开发流程：</p>

<ul>
<li><a href="https://github.com/rootsongjc/k8s-app-monitor-test">k8s-app-monitor-test</a>：生成模拟的监控数据，发送http请求，获取json返回值</li>
<li><a href="https://github.com/rootsongjc/k8s-app-monitor-agent">K8s-app-monitor-agent</a>：获取监控数据并绘图，访问浏览器获取图表</li>
</ul>

<p>API文档见<a href="https://github.com/rootsongjc/k8s-app-monitor-test">k8s-app-monitor-test</a>中的<code>api.html</code>文件，该文档在API blueprint中定义，使用<a href="https://github.com/danielgtaylor/aglio">aglio</a>生成，打开后如图所示：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/k8s-app-monitor-test-api-doc.jpg" alt="API文档" /></p>

<p><strong>关于服务发现</strong></p>

<p><code>K8s-app-monitor-agent</code>服务需要访问<code>k8s-app-monitor-test</code>服务，这就涉及到服务发现的问题，我们在代码中直接写死了要访问的服务的内网DNS地址（kubedns中的地址，即<code>k8s-app-monitor-test.default.svc.cluster.local</code>）。</p>

<p>我们知道Kubernetes在启动Pod的时候为容器注入环境变量，这些环境变量在所有的 namespace 中共享（环境变量是不断追加的，新启动的Pod中将拥有老的Pod中所有的环境变量，而老的Pod中的环境变量不变）。但是既然使用这些环境变量就已经可以访问到对应的service，那么获取应用的地址信息，究竟是使用变量呢？还是直接使用DNS解析来发现？</p>

<p>答案是使用DNS，详细说明见<a href="http://rootsongjc.github.io/blogs/exploring-kubernetes-env-with-docker/">Kubernetes中的服务发现与Docker容器间的环境变量传递源码探究</a>。</p>

<p><strong>打包镜像</strong></p>

<p>因为我使用wercker自动构建，构建完成后自动打包成docker镜像并上传到docker hub中（需要现在docker hub中创建repo）。</p>

<p>构建流程见：<a href="https://app.wercker.com/jimmysong/k8s-app-monitor-agent/">https://app.wercker.com/jimmysong/k8s-app-monitor-agent/</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/k8s-app-monitor-agent-wercker.jpg" alt="wercker" /></p>

<p>生成了如下两个docker镜像：</p>

<ul>
<li>jimmysong/k8s-app-monitor-test:latest</li>
<li>jimmysong/k8s-app-monitor-agent:latest</li>
</ul>

<p><strong>启动服务</strong></p>

<p>所有的kubernetes应用启动所用的yaml配置文件都保存在那两个GitHub仓库的<code>manifest.yaml</code>文件中。</p>

<p>分别在两个GitHub目录下执行<code>kubectl create -f manifest.yaml</code>即可启动服务。</p>

<p><strong>外部访问</strong></p>

<p>服务启动后需要更新ingress配置，在<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/manifests/traefik-ingress/ingress.yaml">ingress.yaml</a>文件中增加以下几行：</p>

<pre><code class="language-Yaml">  - host: k8s-app-monitor-agent.jimmysong.io
    http:
      paths:
      - path: /
        backend:
          serviceName: k8s-app-monitor-agent
          servicePort: 8080
</code></pre>

<p>保存后，然后执行<code>kubectl replace -f ingress.yaml</code>即可刷新ingress。</p>

<p>修改本机的<code>/etc/hosts</code>文件，在其中加入以下一行：</p>

<pre><code>172.20.0.119 k8s-app-monitor-agent.jimmysong.io
</code></pre>

<p>当然你也可以加入到DNS中，为了简单起见我使用hosts。</p>

<p>详见<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">边缘节点配置</a>。</p>

<p>在浏览器中访问<a href="http://k8s-app-monitor-agent.jimmysong.io">http://k8s-app-monitor-agent.jimmysong.io</a></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/k8s-app-monitor-agent.jpg" alt="图表" /></p>

<p>刷新页面将获得新的图表。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/talks/book-kubernetes-management-design-patterns/">记一本关于kubernetes management design patterns的书</a></li>
                
                <li><a href="/blogs/exploring-kubernetes-env-with-docker/">Kubernetes中的服务发现与docker容器间的环境变量传递源码探究</a></li>
                
                <li><a href="/blogs/data-persistence-problem/">Kubernetes中的数据持久化问题的一个案例讨论与解决方案探究</a></li>
                
                <li><a href="/blogs/kubernetes-kubectl-cheatsheat/">Kubernetes kubectl cheat sheat——Kubectl命令参考图</a></li>
                
                <li><a href="/blogs/kubernetes-jenkins-ci-cd/">使用Jenkins进行持续构建与发布应用到kubernetes集群中</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Jul 20, 2017 </h4>
        <h5 id="wc"> 1200 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/talks/migrating-to-cloud-native-architecture/"><i class="icon-arrow-left"></i> 迁移到云原生应用架构指南</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/talks/book-kubernetes-management-design-patterns/">记一本关于kubernetes management design patterns的书 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1143">
<meta itemprop="datePublished" content="2017-07-20">
<meta itemprop="url" content="https://jimmysong.io/blogs/deploy-applications-in-kubernetes/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>
</body>

</html>