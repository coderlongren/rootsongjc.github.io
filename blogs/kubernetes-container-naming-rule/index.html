<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kubernetes管理的容器命名规则解析 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-container-naming-rule/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-15"/>
<meta property="article:modified_time" content="2017-06-15"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="kubernetes管理的容器命名规则解析 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> kubernetes管理的容器命名规则解析 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-container-naming-rule/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=kubernetes%e7%ae%a1%e7%90%86%e7%9a%84%e5%ae%b9%e5%99%a8%e5%91%bd%e5%90%8d%e8%a7%84%e5%88%99%e8%a7%a3%e6%9e%90-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f&title=kubernetes%e7%ae%a1%e7%90%86%e7%9a%84%e5%ae%b9%e5%99%a8%e5%91%bd%e5%90%8d%e8%a7%84%e5%88%99%e8%a7%a3%e6%9e%90&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-container-naming-rule%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">kubernetes管理的容器命名规则解析</h1>
        <div>
            <article itemprop="articleBody" id="content">
                <p>本文将归档到<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的【运维管理-监控】章节中，最终版本以kubernetes-handbook中为准。</p>

<p>当我们通过cAdvisor获取到了容器的信息后，例如访问<code>${NODE_IP}:4194/api/v1.3/docker</code>获取的json结果中的某个容器包含如下字段：</p>

<pre><code class="language-json">&quot;labels&quot;: {
&quot;annotation.io.kubernetes.container.hash&quot;: &quot;f47f0602&quot;, 
&quot;annotation.io.kubernetes.container.ports&quot;: &quot;[{\&quot;containerPort\&quot;:80,\&quot;protocol\&quot;:\&quot;TCP\&quot;}]&quot;, 
&quot;annotation.io.kubernetes.container.restartCount&quot;: &quot;0&quot;, 
&quot;annotation.io.kubernetes.container.terminationMessagePath&quot;: &quot;/dev/termination-log&quot;, 
&quot;annotation.io.kubernetes.container.terminationMessagePolicy&quot;: &quot;File&quot;, 
&quot;annotation.io.kubernetes.pod.terminationGracePeriod&quot;: &quot;30&quot;, 
&quot;io.kubernetes.container.logpath&quot;: &quot;/var/log/pods/d8a2e995-3617-11e7-a4b0-ecf4bbe5d414/php-redis_0.log&quot;, 
&quot;io.kubernetes.container.name&quot;: &quot;php-redis&quot;, 
&quot;io.kubernetes.docker.type&quot;: &quot;container&quot;, 
&quot;io.kubernetes.pod.name&quot;: &quot;frontend-2337258262-771lz&quot;, 
&quot;io.kubernetes.pod.namespace&quot;: &quot;default&quot;, 
&quot;io.kubernetes.pod.uid&quot;: &quot;d8a2e995-3617-11e7-a4b0-ecf4bbe5d414&quot;, 
&quot;io.kubernetes.sandbox.id&quot;: &quot;843a0f018c0cef2a5451434713ea3f409f0debc2101d2264227e814ca0745677&quot;
},
</code></pre>

<p>这些信息其实都是kubernetes创建容器时给docker container打的<code>Labels</code>。</p>

<p>你是否想过这些label跟容器的名字有什么关系？当你在node节点上执行<code>docker ps</code>看到的容器名字又对应哪个应用的Pod呢？</p>

<p>在kubernetes代码中pkg/kubelet/dockertools/docker.go中的BuildDockerName方法定义了容器的名称规范。</p>

<p>这段容器名称定义代码如下：</p>

<pre><code class="language-go">// Creates a name which can be reversed to identify both full pod name and container name.
// This function returns stable name, unique name and a unique id.
// Although rand.Uint32() is not really unique, but it's enough for us because error will
// only occur when instances of the same container in the same pod have the same UID. The
// chance is really slim.
func BuildDockerName(dockerName KubeletContainerName, container *v1.Container) (string, string, string) {
	containerName := dockerName.ContainerName + &quot;.&quot; + strconv.FormatUint(kubecontainer.HashContainerLegacy(container), 16)
	stableName := fmt.Sprintf(&quot;%s_%s_%s_%s&quot;,
		containerNamePrefix,
		containerName,
		dockerName.PodFullName,
		dockerName.PodUID)
	UID := fmt.Sprintf(&quot;%08x&quot;, rand.Uint32())
	return stableName, fmt.Sprintf(&quot;%s_%s&quot;, stableName, UID), UID
}

// Unpacks a container name, returning the pod full name and container name we would have used to
// construct the docker name. If we are unable to parse the name, an error is returned.
func ParseDockerName(name string) (dockerName *KubeletContainerName, hash uint64, err error) {
	// For some reason docker appears to be appending '/' to names.
	// If it's there, strip it.
	name = strings.TrimPrefix(name, &quot;/&quot;)
	parts := strings.Split(name, &quot;_&quot;)
	if len(parts) == 0 || parts[0] != containerNamePrefix {
		err = fmt.Errorf(&quot;failed to parse Docker container name %q into parts&quot;, name)
		return nil, 0, err
	}
	if len(parts) &lt; 6 {
		// We have at least 5 fields.  We may have more in the future.
		// Anything with less fields than this is not something we can
		// manage.
		glog.Warningf(&quot;found a container with the %q prefix, but too few fields (%d): %q&quot;, containerNamePrefix, len(parts), name)
		err = fmt.Errorf(&quot;Docker container name %q has less parts than expected %v&quot;, name, parts)
		return nil, 0, err
	}

	nameParts := strings.Split(parts[1], &quot;.&quot;)
	containerName := nameParts[0]
	if len(nameParts) &gt; 1 {
		hash, err = strconv.ParseUint(nameParts[1], 16, 32)
		if err != nil {
			glog.Warningf(&quot;invalid container hash %q in container %q&quot;, nameParts[1], name)
		}
	}

	podFullName := parts[2] + &quot;_&quot; + parts[3]
	podUID := types.UID(parts[4])

	return &amp;KubeletContainerName{podFullName, podUID, containerName}, hash, nil
}
</code></pre>

<p>我们可以看到容器名称中包含如下几个字段，中间用下划线隔开，至少有6个字段，未来可能添加更多字段。</p>

<p>下面的是四个基本字段。</p>

<pre><code>containerNamePrefix_containerName_PodFullName_PodUID
</code></pre>

<p>所有kubernetes启动的容器的containerNamePrefix都是k8s。</p>

<p>Kubernetes启动的docker容器的容器名称规范，下面以官方示例guestbook为例，Deployment 名为 frontend中启动的名为php-redis的docker容器的副本书为3。</p>

<p>Deployment frontend的配置如下：</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: frontend
spec:
  template:
    metadata:
      labels:
        app: guestbook
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: bj-xg-oam-docker-hub-001.tendcloud.com/library/gb-frontend:v4
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        env:
        - name: GET_HOSTS_FROM
          value: dns
        ports:
        - containerPort: 80
</code></pre>

<p>我们选取三个实例中的一个运行php-redis的docker容器。</p>

<pre><code>k8s_php-redis_frontend-2337258262-154p7_default_d8a2e2dd-3617-11e7-a4b0-ecf4bbe5d414_0
</code></pre>

<ul>
<li>containerNamePrefix：k8s</li>
<li>containerName：php-redis</li>
<li>podFullName：frontend-2337258262-154p7</li>
<li>computeHash：154p7</li>
<li>deploymentName：frontend</li>
<li>replicaSetName：frontend-2337258262</li>
<li>namespace：default</li>
<li>podUID：d8a2e2dd-3617-11e7-a4b0-ecf4bbe5d414</li>
<li>restartCount：0</li>
</ul>

<p>kubernetes容器命名规则解析，见下图所示。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-container-naming-rule.jpg" alt="kubernetes的容器命名规则示意图" /></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/configuration-best-practice/">Kubernetes配置最佳实践</a></li>
                
                <li><a href="/blogs/istio-overview/">微服务管理框架Istio简介</a></li>
                
                <li><a href="/blogs/istio-installation/">微服务管理框架istio安装笔记</a></li>
                
                <li><a href="/blogs/kubernetes-filebeat/">使用filebeat收集kubernetes中的应用日志</a></li>
                
                <li><a href="/blogs/kubernetes-logstash/">使用Logstash收集Kubernetes的应用日志</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Jun 15, 2017 </h4>
        <h5 id="wc"> 1200 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-client-go-sample/"><i class="icon-arrow-left"></i> kubernetes client-go包使用示例</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/configuration-best-practice/">Kubernetes配置最佳实践 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1164">
<meta itemprop="datePublished" content="2017-06-15">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-container-naming-rule/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            id: '页面 ID', 
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    