<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="在开启TLS的Kubernetes1.6集群上安装EFK : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-efk-installation-with-tls/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-13"/>
<meta property="article:modified_time" content="2017-04-13"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="在开启TLS的Kubernetes1.6集群上安装EFK : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> 在开启TLS的Kubernetes1.6集群上安装EFK - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-efk-installation-with-tls/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85EFK-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f&title=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85EFK&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-efk-installation-with-tls%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">在开启TLS的Kubernetes1.6集群上安装EFK</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016061706.jpg" alt="簋街" /></p>

<p><em>（题图：簋街 Jun 17,2016）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目(fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>)中的一篇文章，下文是结合我<a href="https://jimmysong.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，在开启了TLS验证的集群中部署EFK日志收集监控插件。</p>

<h1 id="配置和安装-efk">配置和安装 EFK</h1>

<p>官方文件目录：<code>cluster/addons/fluentd-elasticsearch</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ls *.yaml
</span><span class="">es-controller.yaml  es-service.yaml  fluentd-es-ds.yaml  kibana-controller.yaml  kibana-service.yaml efk-rbac.yaml</span></code></pre>
</div>
<p>同样EFK服务也需要一个<code>efk-rbac.yaml</code>文件，配置serviceaccount为<code>efk</code>。</p>

<p>已经修改好的 yaml 文件见：<a href="./manifests/EFK">EFK</a></p>

<h2 id="配置-es-controller-yaml">配置 es-controller.yaml</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ diff es-controller.yaml.orig es-controller.yaml
</span><span class="">24c24
</span><span class="">&lt;       - image: gcr.io/google_containers/elasticsearch:v2.4.1-2
</span><span class="">---
</span><span class="">&gt;       - image: sz-pg-oam-docker-hub-001.tendcloud.com/library/elasticsearch:v2.4.1-2</span></code></pre>
</div>
<h2 id="配置-es-service-yaml">配置 es-service.yaml</h2>

<p>无需配置；</p>

<h2 id="配置-fluentd-es-ds-yaml">配置 fluentd-es-ds.yaml</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ diff fluentd-es-ds.yaml.orig fluentd-es-ds.yaml
</span><span class="">26c26
</span><span class="">&lt;         image: gcr.io/google_containers/fluentd-elasticsearch:1.22
</span><span class="">---
</span><span class="">&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/fluentd-elasticsearch:1.22</span></code></pre>
</div>
<h2 id="配置-kibana-controller-yaml">配置 kibana-controller.yaml</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ diff kibana-controller.yaml.orig kibana-controller.yaml
</span><span class="">22c22
</span><span class="">&lt;         image: gcr.io/google_containers/kibana:v4.6.1-1
</span><span class="">---
</span><span class="">&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/kibana:v4.6.1-1</span></code></pre>
</div>
<h2 id="给-node-设置标签">给 Node 设置标签</h2>

<p>定义 DaemonSet <code>fluentd-es-v1.22</code> 时设置了 nodeSelector <code>beta.kubernetes.io/fluentd-ds-ready=true</code> ，所以需要在期望运行 fluentd 的 Node 上设置该标签；</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl get nodes
</span><span class="">NAME        STATUS    AGE       VERSION
</span><span class=""></span><span class="m">172</span><span class="">.20.0.113   Ready     1d        v1.6.0
</span><span class="">
</span><span class="">$ kubectl label nodes </span><span class="m">172</span><span class="">.20.0.113 beta.kubernetes.io/fluentd-ds-ready</span><span class="o">=</span><span class="nb">true</span><span class="">
</span><span class="">node </span><span class="s2">&#34;172.20.0.113&#34;</span><span class=""> labeled</span></code></pre>
</div>
<p>给其他两台node打上同样的标签。</p>

<h2 id="执行定义文件">执行定义文件</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl create -f .
</span><span class="">serviceaccount </span><span class="s2">&#34;efk&#34;</span><span class=""> created
</span><span class="">clusterrolebinding </span><span class="s2">&#34;efk&#34;</span><span class=""> created
</span><span class="">replicationcontroller </span><span class="s2">&#34;elasticsearch-logging-v1&#34;</span><span class=""> created
</span><span class="">service </span><span class="s2">&#34;elasticsearch-logging&#34;</span><span class=""> created
</span><span class="">daemonset </span><span class="s2">&#34;fluentd-es-v1.22&#34;</span><span class=""> created
</span><span class="">deployment </span><span class="s2">&#34;kibana-logging&#34;</span><span class=""> created
</span><span class="">service </span><span class="s2">&#34;kibana-logging&#34;</span><span class=""> created</span></code></pre>
</div>
<h2 id="检查执行结果">检查执行结果</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl get deployment -n kube-system</span><span class="p">|</span><span class="">grep kibana
</span><span class="">kibana-logging         </span><span class="m">1</span><span class="">         </span><span class="m">1</span><span class="">         </span><span class="m">1</span><span class="">            </span><span class="m">1</span><span class="">           2m
</span><span class="">
</span><span class="">$ kubectl get pods -n kube-system</span><span class="p">|</span><span class="">grep -E </span><span class="s1">&#39;elasticsearch|fluentd|kibana&#39;</span><span class="">
</span><span class="">elasticsearch-logging-v1-mlstp          </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">elasticsearch-logging-v1-nfbbf          </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">fluentd-es-v1.22-31sm0                  </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">fluentd-es-v1.22-bpgqs                  </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">fluentd-es-v1.22-qmn7h                  </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">kibana-logging-1432287342-0gdng         </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">
</span><span class="">$ kubectl get service  -n kube-system</span><span class="p">|</span><span class="">grep -E </span><span class="s1">&#39;elasticsearch|kibana&#39;</span><span class="">
</span><span class="">elasticsearch-logging   </span><span class="m">10</span><span class="">.254.77.62    &lt;none&gt;        </span><span class="m">9200</span><span class="">/TCP                        2m
</span><span class="">kibana-logging          </span><span class="m">10</span><span class="">.254.8.113    &lt;none&gt;        </span><span class="m">5601</span><span class="">/TCP                        2m</span></code></pre>
</div>
<p>kibana Pod 第一次启动时会用<strong>较长时间(10-20分钟)</strong>来优化和 Cache 状态页面，可以 tailf 该 Pod 的日志观察进度：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl logs kibana-logging-1432287342-0gdng -n kube-system -f
</span><span class=""></span><span class="nv">ELASTICSEARCH_URL</span><span class=""></span><span class="o">=</span><span class="">http://elasticsearch-logging:9200
</span><span class="">server.basePath: /api/v1/proxy/namespaces/kube-system/services/kibana-logging
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:08:06Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;info&#34;</span><span class="">,</span><span class="s2">&#34;optimize&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Optimizing and caching bundles for kibana and statusPage. This may take a few minutes&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:17Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;info&#34;</span><span class="">,</span><span class="s2">&#34;optimize&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Optimization of bundles for kibana and statusPage complete in 610.40 seconds&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:17Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:kibana@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:18Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:elasticsearch@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;yellow&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to yellow - Waiting for Elasticsearch&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:kbn_vislib_vis_types@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:markdown_vis@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:metric_vis@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:spyModes@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:statusPage@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:table_vis@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from uninitialized to green - Ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;uninitialized&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:19Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;listening&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Server running at http://0.0.0.0:5601&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:24Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:elasticsearch@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;yellow&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from yellow to yellow - No existing Kibana index found&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;yellow&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;Waiting for Elasticsearch&#34;</span><span class="o">}</span><span class="">
</span><span class=""></span><span class="o">{</span><span class="s2">&#34;type&#34;</span><span class="">:</span><span class="s2">&#34;log&#34;</span><span class="">,</span><span class="s2">&#34;@timestamp&#34;</span><span class="">:</span><span class="s2">&#34;2017-04-12T13:18:29Z&#34;</span><span class="">,</span><span class="s2">&#34;tags&#34;</span><span class="">:</span><span class="o">[</span><span class="s2">&#34;status&#34;</span><span class="">,</span><span class="s2">&#34;plugin:elasticsearch@1.0.0&#34;</span><span class="">,</span><span class="s2">&#34;info&#34;</span><span class="o">]</span><span class="">,</span><span class="s2">&#34;pid&#34;</span><span class="">:7,</span><span class="s2">&#34;state&#34;</span><span class="">:</span><span class="s2">&#34;green&#34;</span><span class="">,</span><span class="s2">&#34;message&#34;</span><span class="">:</span><span class="s2">&#34;Status changed from yellow to green - Kibana index ready&#34;</span><span class="">,</span><span class="s2">&#34;prevState&#34;</span><span class="">:</span><span class="s2">&#34;yellow&#34;</span><span class="">,</span><span class="s2">&#34;prevMsg&#34;</span><span class="">:</span><span class="s2">&#34;No existing Kibana index found&#34;</span><span class="o">}</span></code></pre>
</div>
<h2 id="访问-kibana">访问 kibana</h2>

<ol>
<li>通过 kube-apiserver 访问：</li>
</ol>

<p>获取 monitoring-grafana 服务 URL</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">   $ kubectl cluster-info
</span><span class="">   Kubernetes master is running at https://172.20.0.113:6443
</span><span class="">   Elasticsearch is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/elasticsearch-logging
</span><span class="">   Heapster is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/heapster
</span><span class="">   Kibana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kibana-logging
</span><span class="">   KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
</span><span class="">   kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
</span><span class="">   monitoring-grafana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
</span><span class="">   monitoring-influxdb is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb</span></code></pre>
</div>
<p>浏览器访问 URL： <code>https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kibana-logging/app/kibana</code></p>

<ol>
<li>通过 kubectl proxy 访问：</li>
</ol>

<p>创建代理</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">   $ kubectl proxy --address</span><span class="o">=</span><span class="s1">&#39;172.20.0.113&#39;</span><span class=""> --port</span><span class="o">=</span><span class="m">8086</span><span class=""> --accept-hosts</span><span class="o">=</span><span class="s1">&#39;^*$&#39;</span><span class="">
</span><span class="">   Starting to serve on </span><span class="m">172</span><span class="">.20.0.113:8086</span></code></pre>
</div>
<p>浏览器访问 URL：<code>http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/kibana-logging</code></p>

<p>在 Settings -&gt; Indices 页面创建一个 index（相当于 mysql 中的一个 database），选中 <code>Index contains time-based events</code>，使用默认的 <code>logstash-*</code> pattern，点击 <code>Create</code> ;</p>

<p><strong>可能遇到的问题</strong></p>

<p>如果你在这里发现Create按钮是灰色的无法点击，且Time-filed name中没有选项，fluentd要读取<code>/var/log/containers/</code>目录下的log日志，这些日志是从<code>/var/lib/docker/containers/${CONTAINER_ID}/${CONTAINER_ID}-json.log</code>链接过来的，查看你的docker配置，<code>—log-dirver</code>需要设置为<strong>json-file</strong>格式，默认的可能是<strong>journald</strong>，参考<a href="https://docs.docker.com/engine/admin/logging/overview/#examples">docker logging</a>。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-es-setting.png" alt="es-setting" /></p>

<p>创建Index后，可以在 <code>Discover</code> 下看到 ElasticSearch logging 中汇聚的日志；</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-efk-kibana.jpg" alt="es-home" /></p>

<p>至此Kubernetes的所有环境都安装完成。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-heapster-installation-with-tls/">在开启TLS的Kubernetes1.6集群上安装heapster</a></li>
                
                <li><a href="/blogs/kubernetes-dashboard-installation-with-tls/">在开启TLS的Kubernetes1.6集群上安装dashboard</a></li>
                
                <li><a href="/blogs/kubernetes-kubedns-installation/">Kubernetes安装之kubedns配置</a></li>
                
                <li><a href="/blogs/kubernetes-ha-master-installation/">Kubernetes高可用master节点安装</a></li>
                
                <li><a href="/blogs/kubernetes-etcd-ha-config/">Kubernetes安装之etcd高可用配置</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Apr 13, 2017 </h4>
        <h5 id="wc"> 1200 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/projects/kubernetes-installation-document/"><i class="icon-arrow-left"></i> Kubernetes1.6集群部署完全指南 ——二进制文件部署开启TLS基于CentOS7发布</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-heapster-installation-with-tls/">在开启TLS的Kubernetes1.6集群上安装heapster <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1110">
<meta itemprop="datePublished" content="2017-04-13">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-efk-installation-with-tls/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
