<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="vagrant, tools, hashicorp, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Vagrant介绍-从使用到放弃完全指南 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/vagrant-intro/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-08"/>
<meta property="article:modified_time" content="2017-03-08"/>



<meta property="article:tag" content="vagrant">
<meta property="article:tag" content="tools">
<meta property="article:tag" content="hashicorp">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Vagrant介绍-从使用到放弃完全指南 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">


    <base href="http://rootsongjc.github.io/">
    <title> Vagrant介绍-从使用到放弃完全指南 - rootsongjc.github.io </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/vagrant-intro/">
    

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Vagrant%e4%bb%8b%e7%bb%8d-%e4%bb%8e%e4%bd%bf%e7%94%a8%e5%88%b0%e6%94%be%e5%bc%83%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97-http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f&title=Vagrant%e4%bb%8b%e7%bb%8d-%e4%bb%8e%e4%bd%bf%e7%94%a8%e5%88%b0%e6%94%be%e5%bc%83%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fvagrant-intro%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Vagrant介绍-从使用到放弃完全指南</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/2017030513.jpg" alt="光熙家园夜景" /></p>

<p><em>（题图：北京地铁13号线光熙家园夜景）</em></p>

<h2 id="起源">起源</h2>

<p>久闻<strong>Vagrant</strong>大名，之前经常看到有开源项目使用它作为分布式开发的环境配置。</p>

<p>因为今天在看<a href="https://github.com/contiv/netplugin">contiv</a>正好里面使用vagrant搭建的开发测试环境，所以顺便了解下。它的<a href="https://github.com/contiv/netplugin/blob/master/Vagrantfile">Vagrantfile</a>文件中定义了三台主机。并安装了很多依赖软件，如consul、etcd、docker、go等，整的比较复杂。</p>

<pre><code>➜  netplugin git:(master) ✗ vagrant status
Current machine states:

netplugin-node1           running (virtualbox)
netplugin-node2           running (virtualbox)
netplugin-node3           running (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
</code></pre>

<p>Vagrant是<a href="https://www.hashicorp.com/">hashicorp</a>这家公司的产品，这家公司主要做数据中心PAAS和虚拟化，其名下大名鼎鼎的产品有<code>Consul</code>、<code>Vault</code>、<code>Nomad</code>、<code>Terraform</code>。他们的产品都是基于<strong>Open Source</strong>的<a href="https://github.com/hashicorp">Github地址</a>。</p>

<h2 id="用途">用途</h2>

<p>Vagrant是用来管理虚拟机的，如VirtualBox、VMware、AWS等，主要好处是可以提供一个可配置、可移植和复用的软件环境，可以使用shell、chef、puppet等工具部署。所以vagrant不能单独使用，如果你用它来管理自己的开发环境的话，必须在自己的电脑里安装了虚拟机软件，我使用的是<strong>virtualbox</strong>。</p>

<p>Vagrant提供一个命令行工具<code>vagrant</code>，通过这个命令行工具可以直接启动一个虚拟机，当然你需要提前定义一个Vagrantfile文件，这有点类似Dockerfile之于docker了。</p>

<p>跟docker类比这来看vagrant就比较好理解了，vagrant也是用来提供一致性环境的，vagrant本身也提供一个镜像源，使用<code>vagrant init hashicorp/precise64</code>就可以初始化一个Ubuntu 12.04的镜像。</p>

<h2 id="用法">用法</h2>

<p>你可以下载安装文件来安装vagrant，也可以使用RubyGem安装，它是用Ruby开发的。</p>

<p><strong>Vagrantfile</strong></p>

<p>Vagrantfile是用来定义vagrant project的，使用ruby语法，不过你不必了解ruby就可以写一个Vagrantfile。</p>

<p>看个例子，选自<a href="https://github.com/fenbox/Vagrantfile">https://github.com/fenbox/Vagrantfile</a></p>

<pre><code class="language-Ruby"># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure(&quot;2&quot;) do |config|
  # The most common configuration options are documented and commented below.
  # For a complete reference, please see the online documentation at
  # https://docs.vagrantup.com.

  # Every Vagrant development environment requires a box. You can search for
  # boxes at https://atlas.hashicorp.com/search.
  config.vm.box = &quot;ubuntu/trusty64&quot;

  # Disable automatic box update checking. If you disable this, then
  # boxes will only be checked for updates when the user runs
  # `vagrant box outdated`. This is not recommended.
  # config.vm.box_check_update = false

  # Create a forwarded port mapping which allows access to a specific port
  # within the machine from a port on the host machine. In the example below,
  # accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.
  # config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080

  # Create a private network, which allows host-only access to the machine
  # using a specific IP.
  config.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;

  # Create a public network, which generally matched to bridged network.
  # Bridged networks make the machine appear as another physical device on
  # your network.
  # config.vm.network &quot;public_network&quot;

  # Share an additional folder to the guest VM. The first argument is
  # the path on the host to the actual folder. The second argument is
  # the path on the guest to mount the folder. And the optional third
  # argument is a set of non-required options.
  # config.vm.synced_folder &quot;../data&quot;, &quot;/vagrant_data&quot;

  # Provider-specific configuration so you can fine-tune various
  # backing providers for Vagrant. These expose provider-specific options.
  # Example for VirtualBox:
  #
  # config.vm.provider &quot;virtualbox&quot; do |vb|
  #   # Display the VirtualBox GUI when booting the machine
  #   vb.gui = true
  #
  #   # Customize the amount of memory on the VM:
  #   vb.memory = &quot;1024&quot;
  # end
  #
  # View the documentation for the provider you are using for more
  # information on available options.

  # Define a Vagrant Push strategy for pushing to Atlas. Other push strategies
  # such as FTP and Heroku are also available. See the documentation at
  # https://docs.vagrantup.com/v2/push/atlas.html for more information.
  # config.push.define &quot;atlas&quot; do |push|
  #   push.app = &quot;YOUR_ATLAS_USERNAME/YOUR_APPLICATION_NAME&quot;
  # end

  # Enable provisioning with a shell script. Additional provisioners such as
  # Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the
  # documentation for more information about their specific syntax and use.
  # config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
  #   apt-get update
  #   apt-get install -y apache2
  # SHELL
  config.vm.provision :shell, path: &quot;bootstrap.sh&quot;
end
</code></pre>

<p><strong>Boxes</strong></p>

<p>Vagrant的基础镜像，相当于docker images。可以在这些基础镜像的基础上制作自己的虚拟机镜像。</p>

<p>添加一个box</p>

<pre><code class="language-shell">$ vagrant box add hashicorp/precise64
</code></pre>

<p>在Vagrantfile中指定box</p>

<pre><code class="language-Ruby">Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;hashicorp/precise64&quot;
  config.vm.box_version = &quot;1.1.0&quot;
end
</code></pre>

<p><strong>使用ssh进入vagrant</strong></p>

<p><code>vagrant up</code>后就可以用<code>vagrant ssh $name</code>进入虚拟机内，如果主机上就一个vagrant可以不指定名字。默认进入的用户是vagrant。</p>

<p><strong>文件同步</strong></p>

<p><code>vagrant up</code>后在虚拟机中会有一个<code>/vagrant</code>目录，这跟你定义<code>Vagrantfile</code>是同一级目录。</p>

<p>这个目录跟你宿主机上的目录文件是同步的。</p>

<p><strong>软件安装</strong></p>

<p>在Vagrantfile中定义要安装的软件和操作。</p>

<p>例如安装apache</p>

<p>在与Vagrantfile同级的目录下创建一个<code>bootstrap.sh</code>文件。</p>

<pre><code class="language-shell">#!/usr/bin/env bash

apt-get update
apt-get install -y apache2
if ! [ -L /var/www ]; then
  rm -rf /var/www
  ln -fs /vagrant /var/www
fi
</code></pre>

<p>然后在Vagrantfile中使用它。</p>

<pre><code class="language-Ruby">Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;hashicorp/precise64&quot;
  config.vm.box_version = &quot;1.1.0&quot;
end
</code></pre>

<p><strong>网络</strong></p>

<p>端口转发</p>

<pre><code class="language-ruby">Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;hashicorp/precise64&quot;
  config.vm.provision :shell, path: &quot;bootstrap.sh&quot;
  config.vm.network :forwarded_port, guest: 80, host: 4567
end
</code></pre>

<p>执行<code>vagrant reload</code>或者<code>vagrant up</code>可以生效。</p>

<p><strong>分享</strong></p>

<p>你自己做的vagrant是可以分享给别人的用的，只要你有一个hashicorp账号，<code>vagrant login</code>后就可以执行<code>vagrant share</code>分享，会生成一个URL，其它人也可以访问到你的vagrant里的服务。</p>

<p><strong>中止</strong></p>

<ul>
<li>vagrant suspend</li>
<li>Vagrant halt</li>
<li>Vagrant destroy</li>
</ul>

<p><strong>重构</strong></p>

<p>再次执行<code>vagrant up</code>即可。</p>

<h2 id="分布式环境">分布式环境</h2>

<p>开发分布式环境下的应用时往往需要多个虚拟机用于测试，这时候才是vagrant显威力的时候。</p>

<p><strong>定义多个主机</strong></p>

<pre><code class="language-ruby">Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.provision &quot;shell&quot;, inline: &quot;echo Hello&quot;

  config.vm.define &quot;web&quot; do |web|
    web.vm.box = &quot;apache&quot;
  end

  config.vm.define &quot;db&quot; do |db|
    db.vm.box = &quot;mysql&quot;
  end
end
</code></pre>

<p>这个比较复杂，详见<a href="https://www.vagrantup.com/docs/multi-machine/">https://www.vagrantup.com/docs/multi-machine/</a></p>

<p>还有一些其它功能，如push、plugins、providers按下不表。</p>

<h2 id="总结">总结</h2>

<p>总的来说说Vagrant没有Docker好用，但是对于协同开发，用它来定义分布式开发环境还可以，ruby的语法看着有点不习惯，好在也不复杂，如果是团队几个人开发，弄几个虚拟机大家互相拷贝一下也没那么复杂吧？</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed Mar 8, 2017 </h4>
          <h5 id="wc"> 700 Words </h5>
          <h5 id="readtime"> Read in about 4 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/vagrant">vagrant</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/tools">tools</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/hashicorp">hashicorp</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/packer-intro/"><i class="icon-arrow-left"></i> Packer Intro</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/projects/docker_tech_selection/">docker技术选型 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            Jimmy Song is a software engineer living in Beijing, he usually likes to explore open source software projects, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took the photo particularly sticky, this is  his tuchong personal page: <a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>
            He has recently been keen on micro-service, DevOps and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="646">
<meta itemprop="datePublished" content="2017-03-08">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/vagrant-intro/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7131036-1', 'rootsongj.github.io');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
</body>
</html>

