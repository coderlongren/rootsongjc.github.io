<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="在kubernetes中使用glusterfs做持久化存储 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-with-glusterfs/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-04"/>
<meta property="article:modified_time" content="2017-05-04"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="在kubernetes中使用glusterfs做持久化存储 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> 在kubernetes中使用glusterfs做持久化存储 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-with-glusterfs/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e5%9c%a8kubernetes%e4%b8%ad%e4%bd%bf%e7%94%a8glusterfs%e5%81%9a%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f&title=%e5%9c%a8kubernetes%e4%b8%ad%e4%bd%bf%e7%94%a8glusterfs%e5%81%9a%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-with-glusterfs%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">在kubernetes中使用glusterfs做持久化存储</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170501005.jpg" alt="森林公园" /></p>

<p><em>（题图：无题@北京奥林匹克森林公园 May 1,2017）</em></p>

<h2 id="前言">前言</h2>

<p>本文章已同步到<a href="https://www.gitbook.com/book/rootsongjc/kubernetes-handbook/details">kubernetes-handbook</a> 7.1章节。</p>

<p>Kubernetes集群沿用<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">跟我一起部署kubernetes1.6集群</a>中的三台机器。</p>

<p>我们复用kubernetes集群的这三台主机做<a href="https://github.com/gluster/glusterfs">glusterfs</a>存储。</p>

<p>以下步骤参考自：<a href="https://www.xf80.com/2017/04/21/kubernetes-glusterfs/">https://www.xf80.com/2017/04/21/kubernetes-glusterfs/</a></p>

<h2 id="安装glusterfs">安装glusterfs</h2>

<p>我们直接在物理机上使用yum安装，如果你选择在kubernetes上安装，请参考：<a href="https://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md">https://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 先安装 gluster 源
</span><span class="c1"></span><span class="">$ yum install centos-release-gluster -y
</span><span class="">
</span><span class=""></span><span class="c1"># 安装 glusterfs 组件
</span><span class="c1"></span><span class="">$ yum install -y glusterfs glusterfs-server glusterfs-fuse glusterfs-rdma glusterfs-geo-replication glusterfs-devel
</span><span class="">
</span><span class=""></span><span class="c1">## 创建 glusterfs 目录
</span><span class="c1"></span><span class="">$ mkdir /opt/glusterd
</span><span class="">
</span><span class=""></span><span class="c1">## 修改 glusterd 目录
</span><span class="c1"></span><span class="">$ sed -i </span><span class="s1">&#39;s/var\/lib/opt/g&#39;</span><span class=""> /etc/glusterfs/glusterd.vol
</span><span class="">
</span><span class=""></span><span class="c1"># 启动 glusterfs
</span><span class="c1"></span><span class="">$ systemctl start glusterd.service
</span><span class="">
</span><span class=""></span><span class="c1"># 设置开机启动
</span><span class="c1"></span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> glusterd.service
</span><span class="">
</span><span class=""></span><span class="c1">#查看状态
</span><span class="c1"></span><span class="">$ systemctl status glusterd.service</span></code></pre>
</div>
<h2 id="配置-glusterfs">配置 glusterfs</h2>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="c1"># 配置 hosts
</span><span class="c1"></span><span class="">
</span><span class="">$ vi /etc/hosts
</span><span class=""></span><span class="m">172</span><span class="">.20.0.113   sz-pg-oam-docker-test-001.tendcloud.com 
</span><span class=""></span><span class="m">172</span><span class="">.20.0.114   sz-pg-oam-docker-test-002.tendcloud.com 
</span><span class=""></span><span class="m">172</span><span class="">.20.0.115   sz-pg-oam-docker-test-003.tendcloud.com </span></code></pre>
</div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 开放端口
</span><span class="c1"></span><span class="">$ iptables -I INPUT -p tcp --dport </span><span class="m">24007</span><span class=""> -j ACCEPT
</span><span class="">
</span><span class=""></span><span class="c1"># 创建存储目录
</span><span class="c1"></span><span class="">$ mkdir /opt/gfs_data</span></code></pre>
</div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 添加节点到 集群
</span><span class="c1"># 执行操作的本机不需要probe 本机
</span><span class="c1"></span><span class="o">[</span><span class="">root@sz-pg-oam-docker-test-001 ~</span><span class="o">]</span><span class="c1">#
</span><span class="c1"></span><span class="">gluster peer probe sz-pg-oam-docker-test-002.tendcloud.com
</span><span class="">gluster peer probe sz-pg-oam-docker-test-003.tendcloud.com
</span><span class="">
</span><span class=""></span><span class="c1"># 查看集群状态
</span><span class="c1"></span><span class="">$ gluster peer status
</span><span class="">Number of Peers: </span><span class="m">2</span><span class="">
</span><span class="">
</span><span class="">Hostname: sz-pg-oam-docker-test-002.tendcloud.com
</span><span class="">Uuid: f25546cc-2011-457d-ba24-342554b51317
</span><span class="">State: Peer in Cluster </span><span class="o">(</span><span class="">Connected</span><span class="o">)</span><span class="">
</span><span class="">
</span><span class="">Hostname: sz-pg-oam-docker-test-003.tendcloud.com
</span><span class="">Uuid: 42b6cad1-aa01-46d0-bbba-f7ec6821d66d
</span><span class="">State: Peer in Cluster </span><span class="o">(</span><span class="">Connected</span><span class="o">)</span></code></pre>
</div>
<h2 id="配置-volume">配置 volume</h2>

<p>GlusterFS中的volume的模式有很多中，包括以下几种：</p>

<ul>
<li><strong>分布卷（默认模式）</strong>：即DHT, 也叫 分布卷: 将文件已hash算法随机分布到 一台服务器节点中存储。</li>
<li><strong>复制模式</strong>：即AFR, 创建volume 时带 replica x 数量: 将文件复制到 replica x 个节点中。</li>
<li><strong>条带模式</strong>：即Striped, 创建volume 时带 stripe x 数量： 将文件切割成数据块，分别存储到 stripe x 个节点中 ( 类似raid 0 )。</li>
<li><strong>分布式条带模式</strong>：最少需要4台服务器才能创建。 创建volume 时 stripe 2 server = 4 个节点： 是DHT 与 Striped 的组合型。</li>
<li><strong>分布式复制模式</strong>：最少需要4台服务器才能创建。 创建volume 时 replica 2 server = 4 个节点：是DHT 与 AFR 的组合型。</li>
<li><strong>条带复制卷模式</strong>：最少需要4台服务器才能创建。 创建volume 时 stripe 2 replica 2 server = 4 个节点： 是 Striped 与 AFR 的组合型。</li>
<li><strong>三种模式混合</strong>： 至少需要8台 服务器才能创建。 stripe 2 replica 2 , 每4个节点 组成一个 组。</li>
</ul>

<p>这几种模式的示例图参考：<a href="http://www.cnblogs.com/jicki/p/5801712.html">CentOS7安装GlusterFS</a>。</p>

<p>因为我们只有三台主机，在此我们使用默认的<strong>分布卷模式</strong>。<strong>请勿在生产环境上使用该模式，容易导致数据丢失。</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建分布卷
</span><span class="c1"></span><span class="">$ gluster volume create k8s-volume transport tcp sz-pg-oam-docker-test-001.tendcloud.com:/opt/gfs_data sz-pg-oam-docker-test-002.tendcloud.com:/opt/gfs_data sz-pg-oam-docker-test-003.tendcloud.com:/opt/gfs_data force
</span><span class="">
</span><span class=""></span><span class="c1"># 查看volume状态
</span><span class="c1"></span><span class="">$ gluster volume info
</span><span class="">Volume Name: k8s-volume
</span><span class="">Type: Distribute
</span><span class="">Volume ID: 9a3b0710-4565-4eb7-abae-1d5c8ed625ac
</span><span class="">Status: Created
</span><span class="">Snapshot Count: </span><span class="m">0</span><span class="">
</span><span class="">Number of Bricks: </span><span class="m">3</span><span class="">
</span><span class="">Transport-type: tcp
</span><span class="">Bricks:
</span><span class="">Brick1: sz-pg-oam-docker-test-001.tendcloud.com:/opt/gfs_data
</span><span class="">Brick2: sz-pg-oam-docker-test-002.tendcloud.com:/opt/gfs_data
</span><span class="">Brick3: sz-pg-oam-docker-test-003.tendcloud.com:/opt/gfs_data
</span><span class="">Options Reconfigured:
</span><span class="">transport.address-family: inet
</span><span class="">nfs.disable: on
</span><span class="">
</span><span class=""></span><span class="c1"># 启动 分布卷
</span><span class="c1"></span><span class="">$ gluster volume start k8s-volume</span></code></pre>
</div>
<h2 id="glusterfs调优">Glusterfs调优</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 开启 指定 volume 的配额
</span><span class="c1"></span><span class="">$ gluster volume quota k8s-volume </span><span class="nb">enable</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 限制 指定 volume 的配额
</span><span class="c1"></span><span class="">$ gluster volume quota k8s-volume limit-usage / 1TB
</span><span class="">
</span><span class=""></span><span class="c1"># 设置 cache 大小, 默认32MB
</span><span class="c1"></span><span class="">$ gluster volume </span><span class="nb">set</span><span class=""> k8s-volume performance.cache-size 4GB
</span><span class="">
</span><span class=""></span><span class="c1"># 设置 io 线程, 太大会导致进程崩溃
</span><span class="c1"></span><span class="">$ gluster volume </span><span class="nb">set</span><span class=""> k8s-volume performance.io-thread-count </span><span class="m">16</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 设置 网络检测时间, 默认42s
</span><span class="c1"></span><span class="">$ gluster volume </span><span class="nb">set</span><span class=""> k8s-volume network.ping-timeout </span><span class="m">10</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 设置 写缓冲区的大小, 默认1M
</span><span class="c1"></span><span class="">$ gluster volume </span><span class="nb">set</span><span class=""> k8s-volume performance.write-behind-window-size 1024MB</span></code></pre>
</div>
<h2 id="kubernetes中配置glusterfs">Kubernetes中配置glusterfs</h2>

<p>官方的文档见：<a href="https://github.com/kubernetes/kubernetes/tree/master/examples/volumes/glusterfs">https://github.com/kubernetes/kubernetes/tree/master/examples/volumes/glusterfs</a></p>

<p>以下用到的所有yaml和json配置文件可以在<a href="manifests/glusterfs">glusterfs</a>中找到。注意替换其中私有镜像地址为你自己的镜像地址。</p>

<h2 id="kubernetes安装客户端">kubernetes安装客户端</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 在所有 k8s node 中安装 glusterfs 客户端
</span><span class="c1"></span><span class="">
</span><span class="">$ yum install -y glusterfs glusterfs-fuse
</span><span class="">
</span><span class=""></span><span class="c1"># 配置 hosts
</span><span class="c1"></span><span class="">
</span><span class="">$ vi /etc/hosts
</span><span class="">
</span><span class=""></span><span class="m">172</span><span class="">.20.0.113   sz-pg-oam-docker-test-001.tendcloud.com
</span><span class=""></span><span class="m">172</span><span class="">.20.0.114   sz-pg-oam-docker-test-002.tendcloud.com
</span><span class=""></span><span class="m">172</span><span class="">.20.0.115   sz-pg-oam-docker-test-003.tendcloud.com</span></code></pre>
</div>
<p>因为我们glusterfs跟kubernetes集群复用主机，因为此这一步可以省去。</p>

<h2 id="配置-endpoints">配置 endpoints</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ curl -O https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-endpoints.json
</span><span class="">
</span><span class=""></span><span class="c1"># 修改 endpoints.json ，配置 glusters 集群节点ip
</span><span class="c1"># 每一个 addresses 为一个 ip 组
</span><span class="c1"></span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;addresses&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">        </span><span class="o">{</span><span class="">
</span><span class="">          </span><span class="s2">&#34;ip&#34;</span><span class="">: </span><span class="s2">&#34;172.22.0.113&#34;</span><span class="">
</span><span class="">        </span><span class="o">}</span><span class="">
</span><span class="">      </span><span class="o">]</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;ports&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">        </span><span class="o">{</span><span class="">
</span><span class="">          </span><span class="s2">&#34;port&#34;</span><span class="">: </span><span class="m">1990</span><span class="">
</span><span class="">        </span><span class="o">}</span><span class="">
</span><span class="">      </span><span class="o">]</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">
</span><span class=""></span><span class="c1"># 导入 glusterfs-endpoints.json
</span><span class="c1"></span><span class="">
</span><span class="">$ kubectl apply -f glusterfs-endpoints.json
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 endpoints 信息
</span><span class="c1"></span><span class="">$ kubectl get ep</span></code></pre>
</div>
<h2 id="配置-service">配置 service</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ curl -O https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-service.json
</span><span class="">
</span><span class=""></span><span class="c1"># service.json 里面查找的是 enpointes 的名称与端口，端口默认配置为 1，我改成了1990
</span><span class="c1"></span><span class="">
</span><span class=""></span><span class="c1"># 导入 glusterfs-service.json
</span><span class="c1"></span><span class="">$ kubectl apply -f glusterfs-service.json
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 service 信息
</span><span class="c1"></span><span class="">$ kubectl get svc</span></code></pre>
</div>
<h2 id="创建测试-pod">创建测试 pod</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ curl -O https://raw.githubusercontent.com/kubernetes/kubernetes/master/examples/volumes/glusterfs/glusterfs-pod.json
</span><span class="">
</span><span class=""></span><span class="c1"># 编辑 glusterfs-pod.json
</span><span class="c1"># 修改 volumes  下的 path 为上面创建的 volume 名称
</span><span class="c1"></span><span class="">
</span><span class=""></span><span class="s2">&#34;path&#34;</span><span class="">: </span><span class="s2">&#34;k8s-volume&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 导入 glusterfs-pod.json
</span><span class="c1"></span><span class="">$ kubectl apply -f glusterfs-pod.json
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 pods 状态
</span><span class="c1"></span><span class="">$ kubectl get pods               
</span><span class="">NAME                             READY     STATUS    RESTARTS   AGE
</span><span class="">glusterfs                        </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          1m
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 pods 所在 node
</span><span class="c1"></span><span class="">$ kubectl describe pods/glusterfs
</span><span class="">
</span><span class=""></span><span class="c1"># 登陆 node 物理机，使用 df 可查看挂载目录
</span><span class="c1"></span><span class="">$ df -h
</span><span class=""></span><span class="m">172</span><span class="">.20.0.113:k8s-volume </span><span class="m">1073741824</span><span class="">        </span><span class="m">0</span><span class=""> </span><span class="m">1073741824</span><span class="">   </span><span class="m">0</span><span class="">% </span><span class="m">172</span><span class="">.20.0.113:k8s-volume  </span><span class="m">1</span><span class="">.0T     </span><span class="m">0</span><span class="">  </span><span class="m">1</span><span class="">.0T   </span><span class="m">0</span><span class="">% /var/lib/kubelet/pods/3de9fc69-30b7-11e7-bfbd-8af1e3a7c5bd/volumes/kubernetes.io~glusterfs/glusterfsvol</span></code></pre>
</div>
<h2 id="配置persistentvolume">配置PersistentVolume</h2>

<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PersistentVolume</a>（PV）和 PersistentVolumeClaim（PVC）是kubernetes提供的两种API资源，用于抽象存储细节。管理员关注于如何通过pv提供存储功能而无需关注用户如何使用，同样的用户只需要挂载PVC到容器中而不需要关注存储卷采用何种技术实现。</p>

<p>PVC和PV的关系跟pod和node关系类似，前者消耗后者的资源。PVC可以向PV申请指定大小的存储资源并设置访问模式。</p>

<p><strong>PV属性</strong></p>

<ul>
<li>storage容量</li>
<li>读写属性：分别为ReadWriteOnce：单个节点读写； ReadOnlyMany：多节点只读 ； ReadWriteMany：多节点读写</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cat glusterfs-pv.yaml
</span><span class="">apiVersion: v1
</span><span class="">kind: PersistentVolume
</span><span class="">metadata:
</span><span class="">  name: gluster-dev-volume
</span><span class="">spec:
</span><span class="">  capacity:
</span><span class="">    storage: 8Gi
</span><span class="">  accessModes:
</span><span class="">    - ReadWriteMany
</span><span class="">  glusterfs:
</span><span class="">    endpoints: </span><span class="s2">&#34;glusterfs-cluster&#34;</span><span class="">
</span><span class="">    path: </span><span class="s2">&#34;k8s-volume&#34;</span><span class="">
</span><span class="">    readOnly: </span><span class="nb">false</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 导入PV
</span><span class="c1"></span><span class="">$ kubectl apply -f glusterfs-pv.yaml
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 pv
</span><span class="c1"></span><span class="">$ kubectl get pv
</span><span class="">NAME                 CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
</span><span class="">gluster-dev-volume   8Gi        RWX           Retain          Available                                      3s</span></code></pre>
</div>
<p>PVC属性</p>

<ul>
<li>访问属性与PV相同</li>
<li>容量：向PV申请的容量 &lt;= PV总容量</li>
</ul>

<h2 id="配置pvc">配置PVC</h2>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="">$ cat glusterfs-pvc.yaml
</span><span class="">kind: PersistentVolumeClaim
</span><span class="">apiVersion: v1
</span><span class="">metadata:
</span><span class="">  name: glusterfs-nginx
</span><span class="">spec:
</span><span class="">  accessModes:
</span><span class="">    - ReadWriteMany
</span><span class="">  resources:
</span><span class="">    requests:
</span><span class="">      storage: 8Gi
</span><span class="">
</span><span class=""></span><span class="c1"># 导入 pvc
</span><span class="c1"></span><span class="">$ kubectl apply -f glusterfs-pvc.yaml
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 pvc
</span><span class="c1"></span><span class="">
</span><span class="">$ kubectl get pv
</span><span class="">NAME              STATUS    VOLUME               CAPACITY   ACCESSMODES   STORAGECLASS   AGE
</span><span class="">glusterfs-nginx   Bound     gluster-dev-volume   8Gi        RWX                          4s</span></code></pre>
</div>
<h2 id="创建-nginx-deployment-挂载-volume">创建 nginx deployment 挂载 volume</h2>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="">$ vi nginx-deployment.yaml
</span><span class="">apiVersion: extensions/v1beta1 
</span><span class="">kind: Deployment 
</span><span class="">metadata: 
</span><span class="">  name: nginx-dm
</span><span class="">spec: 
</span><span class="">  replicas: </span><span class="m">2</span><span class="">
</span><span class="">  template: 
</span><span class="">    metadata: 
</span><span class="">      labels: 
</span><span class="">        name: nginx 
</span><span class="">    spec: 
</span><span class="">      containers: 
</span><span class="">        - name: nginx 
</span><span class="">          image: nginx:alpine 
</span><span class="">          imagePullPolicy: IfNotPresent
</span><span class="">          ports: 
</span><span class="">            - containerPort: </span><span class="m">80</span><span class="">
</span><span class="">          volumeMounts:
</span><span class="">            - name: gluster-dev-volume
</span><span class="">              mountPath: </span><span class="s2">&#34;/usr/share/nginx/html&#34;</span><span class="">
</span><span class="">      volumes:
</span><span class="">      - name: gluster-dev-volume
</span><span class="">        persistentVolumeClaim:
</span><span class="">          claimName: glusterfs-nginx
</span><span class="">
</span><span class=""></span><span class="c1"># 导入 deployment
</span><span class="c1"></span><span class="">$ kubectl apply -f nginx-deployment.yaml 
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 deployment
</span><span class="c1"></span><span class="">$ kubectl get pods </span><span class="p">|</span><span class="">grep nginx-dm
</span><span class="">nginx-dm-3698525684-g0mvt       </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          6s
</span><span class="">nginx-dm-3698525684-hbzq1       </span><span class="m">1</span><span class="">/1       Running   </span><span class="m">0</span><span class="">          6s
</span><span class="">
</span><span class=""></span><span class="c1"># 查看 挂载
</span><span class="c1"></span><span class="">$ kubectl </span><span class="nb">exec</span><span class=""> -it nginx-dm-3698525684-g0mvt -- df -h</span><span class="p">|</span><span class="">grep k8s-volume
</span><span class=""></span><span class="m">172</span><span class="">.20.0.113:k8s-volume         </span><span class="m">1</span><span class="">.0T     </span><span class="m">0</span><span class="">  </span><span class="m">1</span><span class="">.0T   </span><span class="m">0</span><span class="">% /usr/share/nginx/html
</span><span class="">
</span><span class=""></span><span class="c1"># 创建文件 测试
</span><span class="c1"></span><span class="">$ kubectl </span><span class="nb">exec</span><span class=""> -it nginx-dm-3698525684-g0mvt -- touch /usr/share/nginx/html/index.html
</span><span class="">
</span><span class="">$ kubectl </span><span class="nb">exec</span><span class=""> -it nginx-dm-3698525684-g0mvt -- ls -lt /usr/share/nginx/html/index.html
</span><span class="">-rw-r--r-- </span><span class="m">1</span><span class=""> root root </span><span class="m">0</span><span class=""> May  </span><span class="m">4</span><span class=""> </span><span class="m">11</span><span class="">:36 /usr/share/nginx/html/index.html
</span><span class="">
</span><span class=""></span><span class="c1"># 验证 glusterfs
</span><span class="c1"># 因为我们使用分布卷，所以可以看到某个节点中有文件
</span><span class="c1"></span><span class="o">[</span><span class="">root@sz-pg-oam-docker-test-001 ~</span><span class="o">]</span><span class=""> ls /opt/gfs_data/
</span><span class=""></span><span class="o">[</span><span class="">root@sz-pg-oam-docker-test-002 ~</span><span class="o">]</span><span class=""> ls /opt/gfs_data/
</span><span class="">index.html
</span><span class=""></span><span class="o">[</span><span class="">root@sz-pg-oam-docker-test-003 ~</span><span class="o">]</span><span class=""> ls /opt/gfs_data/</span></code></pre>
</div>
<h2 id="参考">参考</h2>

<p><a href="https://www.xf80.com/2017/04/21/kubernetes-glusterfs/?utm_source=tuicool&amp;utm_medium=referral#kubernetes-glusterfs">在kubernetes中安装glusterfs</a></p>

<p><a href="http://www.cnblogs.com/jicki/p/5801712.html">CentOS 7 安装 GlusterFS</a></p>

<p><a href="https://github.com/kubernetes/kubernetes/tree/master/examples/volumes/glusterfs">GlusterFS with kubernetes</a></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-performance-test/">Kubernetes网络和集群性能测试</a></li>
                
                <li><a href="/blogs/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试</a></li>
                
                <li><a href="/blogs/ip-and-service-discovry-in-kubernetes/">Kubernetes中的IP和服务发现体系</a></li>
                
                <li><a href="/blogs/kubernetes-rbac-support/">Kubernetes中的RBAC支持</a></li>
                
                <li><a href="/blogs/traefik-ingress-installation/">Kubernetes traefik ingress安装试用</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu May 4, 2017 </h4>
        <h5 id="wc"> 2300 Words </h5>
        <h5 id="readtime"> Read in about 5 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-edge-node-configuration/"><i class="icon-arrow-left"></i> Kubernetes的边缘节点配置</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-performance-test/">Kubernetes网络和集群性能测试 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2220">
<meta itemprop="datePublished" content="2017-05-04">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-with-glusterfs/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
