<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes配置最佳实践 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/configuration-best-practice/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-14"/>
<meta property="article:modified_time" content="2017-06-14"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes配置最佳实践 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="http://rootsongjc.github.io/">
    <title> Kubernetes配置最佳实践 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/configuration-best-practice/"> 
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>
    hljs.initHighlightingOnLoad();
</script>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function() {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden; '>
    <img src='http://olz1di9xf.bkt.clouddn.com/jimmy.jpg' />
</div>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e9%85%8d%e7%bd%ae%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f&title=Kubernetes%e9%85%8d%e7%bd%ae%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fconfiguration-best-practice%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes配置最佳实践</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170526034.jpg" alt="青岛" /></p>

<p><em>（题图：青岛 May 26,2017）</em></p>

<h2 id="前言">前言</h2>

<p>本文档旨在汇总和强调用户指南、快速开始文档和示例中的最佳实践。该文档会很很活跃并持续更新中。如果你觉得很有用的最佳实践但是本文档中没有包含，欢迎给我们提Pull Request。</p>

<p>本文已上传到<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>中的第四章最佳实践章节，本文仅作归档，更新以<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>为准。</p>

<h2 id="通用配置建议">通用配置建议</h2>

<ul>
<li>定义配置文件的时候，指定最新的稳定API版本（目前是V1）。</li>
<li>在配置文件push到集群之前应该保存在版本控制系统中。这样当需要的时候能够快速回滚，必要的时候也可以快速的创建集群。</li>
<li>使用YAML格式而不是JSON格式的配置文件。在大多数场景下它们都可以作为数据交换格式，但是YAML格式比起JSON更易读和配置。</li>
<li>尽量将相关的对象放在同一个配置文件里。这样比分成多个文件更容易管理。参考<a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook/all-in-one/guestbook-all-in-one.yaml">guestbook-all-in-one.yaml</a>文件中的配置（注意，尽管你可以在使用<code>kubectl</code>命令时指定配置文件目录，你也可以在配置文件目录下执行<code>kubectl create</code>——查看下面的详细信息）。</li>
<li>为了简化和最小化配置，也为了防止错误发生，不要指定不必要的默认配置。例如，省略掉<code>ReplicationController</code>的selector和label，如果你希望它们跟<code>podTemplate</code>中的label一样的话，因为那些配置默认是<code>podTemplate</code>的label产生的。更多信息请查看 <a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook/">guestbook app</a> 的yaml文件和 <a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook/frontend-deployment.yaml">examples</a> 。</li>
<li>将资源对象的描述放在一个annotation中可以更好的内省。</li>
</ul>

<h2 id="裸奔的pods-vs-replication-controllers和-jobs">裸奔的Pods vs Replication Controllers和 Jobs</h2>

<ul>
<li>如果有其他方式替代“裸奔的pod”（如没有绑定到<a href="https://kubernetes.io/docs/user-guide/replication-controller">replication controller </a>上的pod），那么就使用其他选择。在node节点出现故障时，裸奔的pod不会被重新调度。Replication Controller总是会重新创建pod，除了明确指定了<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy"><code>restartPolicy: Never</code></a> 的场景。<a href="https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/">Job</a> 也许是比较合适的选择。</li>
</ul>

<h2 id="services">Services</h2>

<ul>
<li>通常最好在创建相关的<a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/">replication controllers</a>之前先创建<a href="https://kubernetes.io/docs/concepts/services-networking/service/">service</a>（没有这个必要吧？）你也可以在创建Replication Controller的时候不指定replica数量（默认是1），创建service后，在通过Replication Controller来扩容。这样可以在扩容很多个replica之前先确认pod是正常的。</li>
<li>除非时分必要的情况下（如运行一个node daemon），不要使用<code>hostPort</code>（用来指定暴露在主机上的端口号）。当你给Pod绑定了一个<code>hostPort</code>，该pod可被调度到的主机的受限了，因为端口冲突。如果是为了调试目的来通过端口访问的话，你可以使用 <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/http-proxy-access-api/">kubectl proxy and apiserver proxy</a> 或者 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/">kubectl port-forward</a>。你可使用 Service 来对外暴露服务。如果你确实需要将pod的端口暴露到主机上，考虑使用 <a href="https://kubernetes.io/docs/user-guide/services/#type-nodeport">NodePort</a> service。</li>
<li>跟<code>hostPort</code>一样的原因，避免使用 <code>hostNetwork</code>。</li>
<li>如果你不需要kube-proxy的负载均衡的话，可以考虑使用使用<a href="https://kubernetes.io/docs/user-guide/services/#headless-services">headless services</a>。</li>
</ul>

<h2 id="使用label">使用Label</h2>

<ul>
<li>定义 <a href="https://kubernetes.io/docs/user-guide/labels/">labels</a> 来指定应用或Deployment的 <strong>semantic attributes</strong> 。例如，不是将label附加到一组pod来显式表示某些服务（例如，<code>service:myservice</code>），或者显式地表示管理pod的replication controller（例如，<code>controller:mycontroller</code>），附加label应该是标示语义属性的标签， 例如<code>{app:myapp,tier:frontend,phase:test,deployment:v3}</code>。 这将允许您选择适合上下文的对象组——例如，所有的”tier:frontend“pod的服务或app是“myapp”的所有“测试”阶段组件。 有关此方法的示例，请参阅<a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook/">guestbook</a>应用程序。</li>
</ul>

<p>可以通过简单地从其service的选择器中省略特定于发行版本的标签，而不是更新服务的选择器来完全匹配replication controller的选择器，来实现跨越多个部署的服务，例如滚动更新。</p>

<ul>
<li>为了滚动升级的方便，在Replication Controller的名字中包含版本信息，例如作为名字的后缀。设置一个<code>version</code>标签页是很有用的。滚动更新创建一个新的controller而不是修改现有的controller。因此，version含混不清的controller名字就可能带来问题。查看<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">Rolling Update Replication Controller</a>文档获取更多关于滚动升级命令的信息。</li>
</ul>

<p>注意 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a> 对象不需要再管理 replication controller 的版本名。Deployment 中描述了对象的期望状态，如果对spec的更改被应用了话，Deployment controller 会以控制的速率来更改实际状态到期望状态。（Deployment目前是 <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/#api-groups"><code>extensions</code> API Group</a>的一部分）。</p>

<ul>
<li>利用label做调试。因为Kubernetes replication controller和service使用label来匹配pods，这允许你通过移除pod中的label的方式将其从一个controller或者service中移除，原来的controller会创建一个新的pod来取代移除的pod。这是一个很有用的方式，帮你在一个隔离的环境中调试之前的“活着的” pod。查看 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/"><code>kubectl label</code></a> 命令。</li>
</ul>

<h2 id="容器镜像">容器镜像</h2>

<ul>
<li><a href="https://kubernetes.io/docs/concepts/containers/images/">默认容器镜像拉取策略</a> 是 <code>IfNotPresent</code>, 当本地已存在该镜像的时候 <a href="https://kubernetes.io/docs/admin/kubelet/">Kubelet</a> 不会再从镜像仓库拉取。如果你希望总是从镜像仓库中拉取镜像的话，在yaml文件中指定镜像拉取策略为<code>Always</code>（ <code>imagePullPolicy: Always</code>）或者指定镜像的tag为 <code>:latest</code> 。</li>
</ul>

<p>如果你没有将镜像标签指定为<code>:latest</code>，例如指定为<code>myimage:v1</code>，当该标签的镜像进行了更新，kubelet也不会拉取该镜像。你可以在每次镜像更新后都生成一个新的tag（例如<code>myimage:v2</code>），在配置文件中明确指定该版本。</p>

<p><strong>注意：</strong> 在生产环境下部署容器应该尽量避免使用<code>:latest</code>标签，因为这样很难追溯到底运行的是哪个版本的容器和回滚。</p>

<h2 id="使用kubectl">使用kubectl</h2>

<ul>
<li>尽量使用 <code>kubectl create -f &lt;directory&gt;</code>  。kubeclt会自动查找该目录下的所有后缀名为<code>.yaml</code>、<code>.yml</code>和<code>.json</code>文件并将它们传递给<code>create</code>命令。</li>
<li>使用 <code>kubectl delete</code> 而不是 <code>stop</code>. <code>Delete</code> 是 <code>stop</code>的超集，<code>stop</code> 已经被弃用。</li>
<li>使用 kubectl bulk 操作（通过文件或者label）来get和delete。查看<a href="https://kubernetes.io/docs/user-guide/labels/#label-selectors">label selectors </a>和 <a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#using-labels-effectively">using labels effectively</a>。</li>
<li>使用 <code>kubectl run</code> 和 <code>expose</code> 命令快速创建直有耽搁容器的Deployment。查看 <a href="https://kubernetes.io/docs/user-guide/quick-start/">quick start guide</a>中的示例。</li>
</ul>

<h2 id="参考">参考</h2>

<p><a href="https://kubernetes.io/docs/concepts/configuration/overview/">Configuration Best Practices</a></p>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Jun 14, 2017 </h4>
        <h5 id="wc"> 2700 Words </h5>
        <h5 id="readtime"> Read in about 6 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/kubernetes-container-naming-rule/"><i class="icon-arrow-left"></i> kubernetes管理的容器命名规则解析</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://rootsongjc.github.io/talks/cloud-native-go/">Cloud Native Go - 基于Go和React的web云服务构建指南 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="2626">
<meta itemprop="datePublished" content="2017-06-14">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/configuration-best-practice/">
 <footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

