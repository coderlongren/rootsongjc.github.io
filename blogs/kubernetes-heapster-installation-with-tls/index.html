<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="在开启TLS的Kubernetes1.6集群上安装heapster : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-heapster-installation-with-tls/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-12"/>
<meta property="article:modified_time" content="2017-04-12"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="在开启TLS的Kubernetes1.6集群上安装heapster : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> 在开启TLS的Kubernetes1.6集群上安装heapster - Jimmy Song </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-heapster-installation-with-tls/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85heapster-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f&title=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85heapster&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-heapster-installation-with-tls%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">在开启TLS的Kubernetes1.6集群上安装heapster</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016080801.jpg" alt="大喵" /></p>

<p><em>（题图：大喵 Aug 8,2016）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目(fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>)中的一篇文章，下文是结合我<a href="http://rootsongjc.github.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，在开启了TLS验证的集群中部署heapster，包括influxdb、grafana等组件。</p>

<h2 id="配置和安装heapster">配置和安装Heapster</h2>

<p>到 <a href="https://github.com/kubernetes/heapster/releases">heapster release 页面</a> 下载最新版本的 heapster。</p>

<pre><code class="language-bash">$ wget https://github.com/kubernetes/heapster/archive/v1.3.0.zip
$ unzip v1.3.0.zip
$ mv v1.3.0.zip heapster-1.3.0
</code></pre>

<p>文件目录： <code>heapster-1.3.0/deploy/kube-config/influxdb</code></p>

<pre><code class="language-bash">$ cd heapster-1.3.0/deploy/kube-config/influxdb
$ ls *.yaml
grafana-deployment.yaml  grafana-service.yaml  heapster-deployment.yaml  heapster-service.yaml  influxdb-deployment.yaml  influxdb-service.yaml heapster-rbac.yaml
</code></pre>

<p>我们自己创建了heapster的rbac配置<code>heapster-rbac.yaml</code>。</p>

<p>已经修改好的 yaml 文件见：<a href="./manifests/heapster">heapster</a></p>

<h2 id="配置-grafana-deployment">配置 grafana-deployment</h2>

<pre><code class="language-bash">$ diff grafana-deployment.yaml.orig grafana-deployment.yaml
16c16
&lt;         image: gcr.io/google_containers/heapster-grafana-amd64:v4.0.2
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-grafana-amd64:v4.0.2
40,41c40,41
&lt;           # value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/
&lt;           value: /
---
&gt;           value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/
&gt;           #value: /
</code></pre>

<p>如果后续使用 kube-apiserver 或者 kubectl proxy 访问 grafana dashboard，则必须将 <code>GF_SERVER_ROOT_URL</code> 设置为 <code>/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/</code>，否则后续访问grafana时访问时提示找不到<code>http://10.64.3.7:8086/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/api/dashboards/home</code> 页面；</p>

<h2 id="配置-heapster-deployment">配置 heapster-deployment</h2>

<pre><code class="language-bash">$ diff heapster-deployment.yaml.orig heapster-deployment.yaml
16c16
&lt;         image: gcr.io/google_containers/heapster-amd64:v1.3.0-beta.1
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-amd64:v1.3.0-beta.1
</code></pre>

<h2 id="配置-influxdb-deployment">配置 influxdb-deployment</h2>

<p>influxdb 官方建议使用命令行或 HTTP API 接口来查询数据库，从 v1.1.0 版本开始默认关闭 admin UI，将在后续版本中移除 admin UI 插件。</p>

<p>开启镜像中 admin UI的办法如下：先导出镜像中的 influxdb 配置文件，开启 admin 插件后，再将配置文件内容写入 ConfigMap，最后挂载到镜像中，达到覆盖原始配置的目的：</p>

<p>注意：manifests 目录已经提供了 <a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/manifests/heapster/influxdb-cm.yaml">修改后的 ConfigMap 定义文件</a></p>

<pre><code class="language-bash">$ # 导出镜像中的 influxdb 配置文件
$ docker run --rm --entrypoint 'cat'  -ti lvanneo/heapster-influxdb-amd64:v1.1.1 /etc/config.toml &gt;config.toml.orig
$ cp config.toml.orig config.toml
$ # 修改：启用 admin 接口
$ vim config.toml
$ diff config.toml.orig config.toml
35c35
&lt;   enabled = false
---
&gt;   enabled = true
$ # 将修改后的配置写入到 ConfigMap 对象中
$ kubectl create configmap influxdb-config --from-file=config.toml  -n kube-system
configmap &quot;influxdb-config&quot; created
$ # 将 ConfigMap 中的配置文件挂载到 Pod 中，达到覆盖原始配置的目的
$ diff influxdb-deployment.yaml.orig influxdb-deployment.yaml
16c16
&lt;         image: grc.io/google_containers/heapster-influxdb-amd64:v1.1.1
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-influxdb-amd64:v1.1.1
19a20,21
&gt;         - mountPath: /etc/
&gt;           name: influxdb-config
22a25,27
&gt;       - name: influxdb-config
&gt;         configMap:
&gt;           name: influxdb-config
</code></pre>

<h2 id="配置-monitoring-influxdb-service">配置 monitoring-influxdb Service</h2>

<pre><code>$ diff influxdb-service.yaml.orig influxdb-service.yaml
12a13
&gt;   type: NodePort
15a17,20
&gt;     name: http
&gt;   - port: 8083
&gt;     targetPort: 8083
&gt;     name: admin
</code></pre>

<ul>
<li>定义端口类型为 NodePort，额外增加了 admin 端口映射，用于后续浏览器访问 influxdb 的 admin UI 界面；</li>
</ul>

<h2 id="执行所有定义文件">执行所有定义文件</h2>

<pre><code class="language-bash">$ pwd
/root/heapster-1.3.0/deploy/kube-config/influxdb
$ ls *.yaml
grafana-service.yaml      heapster-rbac.yaml     influxdb-cm.yaml          influxdb-service.yaml
grafana-deployment.yaml  heapster-deployment.yaml  heapster-service.yaml  influxdb-deployment.yaml
$ kubectl create -f  .
deployment &quot;monitoring-grafana&quot; created
service &quot;monitoring-grafana&quot; created
deployment &quot;heapster&quot; created
serviceaccount &quot;heapster&quot; created
clusterrolebinding &quot;heapster&quot; created
service &quot;heapster&quot; created
configmap &quot;influxdb-config&quot; created
deployment &quot;monitoring-influxdb&quot; created
service &quot;monitoring-influxdb&quot; created
</code></pre>

<h2 id="检查执行结果">检查执行结果</h2>

<p>检查 Deployment</p>

<pre><code class="language-bash">$ kubectl get deployments -n kube-system | grep -E 'heapster|monitoring'
heapster               1         1         1            1           2m
monitoring-grafana     1         1         1            1           2m
monitoring-influxdb    1         1         1            1           2m
</code></pre>

<p>检查 Pods</p>

<pre><code class="language-bash">$ kubectl get pods -n kube-system | grep -E 'heapster|monitoring'
heapster-110704576-gpg8v                1/1       Running   0          2m
monitoring-grafana-2861879979-9z89f     1/1       Running   0          2m
monitoring-influxdb-1411048194-lzrpc    1/1       Running   0          2m
</code></pre>

<p>检查 kubernets dashboard 界面，看是显示各 Nodes、Pods 的 CPU、内存、负载等利用率曲线图；</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-dashboard-with-heapster.jpg" alt="dashboard-heapster" /></p>

<h2 id="访问-grafana">访问 grafana</h2>

<ol>
<li>通过 kube-apiserver 访问：</li>
</ol>

<p>获取 monitoring-grafana 服务 URL</p>

<pre><code class="language-bash">   $ kubectl cluster-info
   Kubernetes master is running at https://172.20.0.113:6443
   Heapster is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/heapster
   KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
   kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
   monitoring-grafana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
   monitoring-influxdb is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb

   To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</code></pre>

<p>浏览器访问 URL： <code>http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana</code></p>

<ol>
<li>通过 kubectl proxy 访问：</li>
</ol>

<p>创建代理</p>

<pre><code class="language-bash">   $ kubectl proxy --address='172.20.0.113' --port=8086 --accept-hosts='^*$'
   Starting to serve on 172.20.0.113:8086
</code></pre>

<p>浏览器访问 URL：<code>http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana</code></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-heapster-grafana.jpg" alt="grafana" /></p>

<h2 id="访问-influxdb-admin-ui">访问 influxdb admin UI</h2>

<p>获取 influxdb http 8086 映射的 NodePort</p>

<pre><code>$ kubectl get svc -n kube-system|grep influxdb
monitoring-influxdb    10.254.22.46    &lt;nodes&gt;       8086:32299/TCP,8083:30269/TCP   9m
</code></pre>

<p>通过 kube-apiserver 的<strong>非安全端口</strong>访问 influxdb 的 admin UI 界面： <code>http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb:8083/</code></p>

<p>在页面的 “Connection Settings” 的 Host 中输入 node IP， Port 中输入 8086 映射的 nodePort 如上面的 32299，点击 “Save” 即可（我的集群中的地址是172.20.0.113:32299）：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-influxdb-heapster.jpg" alt="kubernetes-influxdb-heapster" /></p>

<p>到此Heapster已经部署完成。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-dashboard-installation-with-tls/">在开启TLS的Kubernetes1.6集群上安装dashboard</a></li>
                
                <li><a href="/blogs/kubernetes-kubedns-installation/">Kubernetes安装之kubedns配置</a></li>
                
                <li><a href="/blogs/kubernetes-ha-master-installation/">Kubernetes高可用master节点安装</a></li>
                
                <li><a href="/blogs/kubernetes-etcd-ha-config/">Kubernetes安装之etcd高可用配置</a></li>
                
                <li><a href="/blogs/kubernetes-create-kubeconfig/">Kubernetes安装之创建kubeconfig文件</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Apr 12, 2017 </h4>
        <h5 id="wc"> 1400 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-efk-installation-with-tls/"><i class="icon-arrow-left"></i> 在开启TLS的Kubernetes1.6集群上安装EFK</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-dashboard-installation-with-tls/">在开启TLS的Kubernetes1.6集群上安装dashboard <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1331">
<meta itemprop="datePublished" content="2017-04-12">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-heapster-installation-with-tls/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>
</body>

</html>