<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="wercker, docker, ci, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="使用Wercker进行持续构建与发布 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/continuous-integration-with-wercker/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-22"/>
<meta property="article:modified_time" content="2017-06-22"/>



<meta property="article:tag" content="wercker">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="ci">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="使用Wercker进行持续构建与发布 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> 使用Wercker进行持续构建与发布 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/continuous-integration-with-wercker/">

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>
    hljs.initHighlightingOnLoad();
</script>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function() {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden; '>
    <img src='http://olz1di9xf.bkt.clouddn.com/jimmy.jpg' />
</div>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=%e4%bd%bf%e7%94%a8Wercker%e8%bf%9b%e8%a1%8c%e6%8c%81%e7%bb%ad%e6%9e%84%e5%bb%ba%e4%b8%8e%e5%8f%91%e5%b8%83-http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f&title=%e4%bd%bf%e7%94%a8Wercker%e8%bf%9b%e8%a1%8c%e6%8c%81%e7%bb%ad%e6%9e%84%e5%bb%ba%e4%b8%8e%e5%8f%91%e5%b8%83&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fcontinuous-integration-with-wercker%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">使用Wercker进行持续构建与发布</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p>本文介绍了wercker和它的基本用法，并用我GitHub上的<a href="https://github.com/rootsongjc/magpie">magpie</a>应用作为示例，讲解如何给GitHub项目增加wercker构建流程，并将生成的镜像自动上传到Docker Hub上。</p>

<p>注：本文参考了<a href="http://rootsongjc.github.io/cloud-native-go">Cloud Native Go</a>书中的”持续交付“章节。</p>

<h2 id="ci工具">CI工具</h2>

<p>开源项目的构建离不开CI工具，你可能经常会在很多GitHub的开源项目首页上看到这样的东西：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-budget.jpg" alt="wercker status badge" /></p>

<p>这些图标都是CI工具提供的，可以直观的看到当前的构建状态，例如wercker中可以在<code>Application</code>-<code>magpie</code>-<code>options</code>中看到：</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-status-budge-setting.jpg" alt="wercker status badge设置" /></p>

<p>将文本框中的代码复制到你的项目的<code>README</code>文件中，就可以在项目主页上看到这样的标志了。</p>

<p>现在市面上有很多流行的CI/CD工具和DevOps工具有很多，这些工具提高了软件开发的效率，增加了开发人员的幸福感。这些工具有：</p>

<p>适用于GitHub上的开源项目，可以直接使用GitHub账户登陆，对于公开项目可以直接使用：<a href="https://travis-ci.org">Travis-ci</a>、<a href="https://circleci.com">CircleCI</a>、<a href="http://www.wercker.com/">Wercker</a>。从目前GitHub上开源项目的使用情况来看，Travis-ci的使用率更高一些。</p>

<p>适用于企业级的：<a href="https://jenkins.io/">Jenkins</a></p>

<p>不仅包括CI/CD功能的DevOps平台：<a href="https://www.jfrog.com/">JFrog</a>、<a href="https://spinnaker.io">Spinnaker</a>、<a href="https://fabric8.io">Fabric8</a></p>

<h2 id="wercker简介">Wercker简介</h2>

<p>Wercker是一家为现代云服务提供容器化应用及微服务的快速开发、部署工具的初创企业，成立于2012年，总部位于荷兰阿姆斯特丹。其以容器为中心的平台可以对微服务和应用的开发进行自动化。开发者通过利用其命令行工具能够生成容器到桌面，然后自动生成应用并部署到各种云平台上面。其支持的平台包括Heroku、AWS以及Rackspace等。</p>

<p>Wercker于2016年获得450万美元A轮融资，此轮融资由Inkef Capital领投，Notion Capital跟投，融资所得将用于商业版产品的开发。此轮融资过后其总融资额为750万美元。</p>

<p>Wercker于2017年4月被Oracle甲骨文于收购。</p>

<h2 id="为什么使用wercker">为什么使用Wercker</h2>

<p>所有的CI工具都可以在市面上获取，但为何要建议使用Wercker呢？依据云之道的准则评估了所有工具，发现Wercker正是我们需要的。</p>

<p>首先，无须在工作站中安装Wecker，仅安装一个命令行客户端即可，构建过程全部在云端进行。</p>

<p>其次，不用通过信用卡就可使用Wercker。当我们迫切希望简化流程时，这是一件令人赞叹的事。付款承诺这一条件大大增加了开发者的压力，这通常是不必要的。</p>

<p>最后，Wercker使用起来非常简单。它非常容易配置，不需要经过高级培训或拥有持续集成的博士学位，也不用制定专门的流程。</p>

<p>通过Wercker搭建CI环境只需经过三个基本步骤。</p>

<p>1．在Wercker网站中创建一个应用程序。</p>

<p>2．将wercker.yml添加到应用程序的代码库中。</p>

<p>3．选择打包和部署构建的位置。</p>

<h2 id="如何使用">如何使用</h2>

<p>可以使用GitHub帐号直接登录<a href="http://www.wercker.com">Wercker</a>，整个创建应用CI的流程一共3步。</p>

<p>一旦拥有了账户，那么只需简单地点击位于顶部的<strong>应用程序</strong>菜单，然后选择<strong>创建</strong>选项即可。如果系统提示是否要创建组织或应用程序，请选择<strong>应用程序</strong>。Wercker组织允许多个Wercker用户之间进行协作，而无须提供信用卡。下图为设置新应用程序的向导页面。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-create-application.jpg" alt="向导页面" /></p>

<p>选择了GitHub中的repo之后，第二步配置访问权限，最后一步Wercker会尝试生成一个wercker.yml文件（后面会讨论）。不过至少对于Go应用程序来说，这个配置很少会满足要求，所以我们总是需要创建自己的Wercker配置文件。</p>

<h2 id="安装wercker命令行程序">安装Wercker命令行程序</h2>

<p>这一步是可选的，如果你希望在本地进行wercker构建的话才需要在本地安装命令行程序。本地构建和云端构建都依赖于Docker的使用。基本上，代码会被置于所选择的docker镜像中（在wercker.yml中定义），然后再选择执行的内容和方法。</p>

<p>要在本地运行Wercker构建，需要使用Wercker CLI。有关如何安装和测试CLI的内容，请查看<a href="http://devcenter.wercker.com/docs/cli。Wercker更新文档的频率要比本书更高，所以请在本书中做个标记，然后根据Wercker网站的文档安装Wercker">http://devcenter.wercker.com/docs/cli。Wercker更新文档的频率要比本书更高，所以请在本书中做个标记，然后根据Wercker网站的文档安装Wercker</a> CLI。</p>

<p>如果已经正确安装了CLI，应该可以查询到CLI的版本，代码如下所示。</p>

<pre><code>Version: 1.0.882
Compiled at: 2017-06-02 06:49:39 +0800 CST
Git commit: da8bc056ed99e27b4b7a1b608078ddaf025a9dc4
No new version available
</code></pre>

<p>本地构建只要在项目的根目录下输入<code>wercker build</code>命令即可，wercker会自动下载依赖的docker镜像在本地运行所有构建流程。</p>

<h2 id="创建wercker配置文件wercker-yml">创建Wercker配置文件wercker.yml</h2>

<p>Wercker配置文件是一个YAML文件，该文件必须在GitHub repo的最顶层目录，该文件主要包含三个部分，对应可用的三个主要管道。</p>

<p> <strong>Dev</strong>：定义了开发管道的步骤列表。与所有管道一样，可以选定一个<strong>box</strong>用于构建，也可以全局指定一个box应用于所有管道。box可以是Wercker内置的预制Docker镜像之一，也可以是Docker Hub托管的任何Docker镜像。</p>

<p> <strong>Build</strong>：定义了在Wercker构建期间要执行的步骤和脚本的列表。与许多其他服务（如Jenkins和TeamCity）不同，构建步骤位于代码库的配置文件中，而不是隐藏在服务配置里。</p>

<p> <strong>Deploy</strong>：在这里可以定义构建的部署方式和位置。</p>

<p>Wercker中还有<strong>工作流</strong>的概念，通过使用分支、条件构建、多个部署目标和其他高级功能扩展了管道的功能，这些高级功能读着可以自己在wercker的网站中探索。</p>

<h2 id="示例">示例</h2>

<p>我们以我用Go语言开发的管理yarn on docker集群的命令行工具<a href="https://github.com/rootsongjc/magpie">magpie</a>为例，讲解如何使用wercker自动构建，并产生docker镜像发布到Docker Hub中。</p>

<p>下面是magpie这个项目中使用的<code>wercker.yml</code>文件。</p>

<pre><code class="language-Yaml">box: golang
build:
  steps:
    # Sets the go workspace and places you package
    # at the right place in the workspace tree
    - setup-go-workspace

    # Gets the dependencies
    - script:
        name: go get
        code: |
          go get github.com/rootsongjc/magpie
    # Build the project
    - script:
        name: go build
        code: |
          go build -o magpie main.go
    # Test the project
    - script:
        name: go test
        code: |
          go test ./...
    - script:
        name: copy files to wercker output 
        code: |
          cp -R ./ ${WERCKER_OUTPUT_DIR}
deploy: 
  steps:
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD 
        cmd: /pipeline/source/magpie
        tag: latest
        repository: jimmysong/magpie
</code></pre>

<p>此文件包含两个管道：build和deploy。在开发流程中，我们使用Wercker和Docker创建一个干净的Docker镜像，然后将它push到Docker Hub中。Wercker包含一个叫做<code>Internal/docker-push</code>的deploy plugin，可以将构建好的docker镜像push到镜像仓库中，默认是Docker Hub，也可以配置成私有镜像仓库。</p>

<p>box键的值是golang。这意味着我们使用的是一个基础的Docker镜像，它已经安装了Go环境。这一点至关重要，因为执行Wercker构建的基准Docker镜像需要包含应用程序所需的构建工具。</p>

<p>这部分存在一些难以理解的概念。当使用Wercker进行构建时，其实并没有使用本地工作站的资源（即使在技术层面上，构建也是在本地执行的），相反，使用的是Docker镜像中的可用资源。因此，如果要使用Wercker编译Go应用程序，需要首先运行包含Go的Docker镜像。如果想要构建唯一的工件，无论它是在本地还是在Wercker的云端运行，使用Docker镜像都是完全合理的。</p>

<p>本次构建中运行的第一个脚本是go get。这一步可以go get可能需要的、但不包含在基础镜像中的任何东西。无论为脚本设置什么名称，构建输出都会有所显示，如下图所示。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-pipline-output.jpg" alt="构建流程输出" /></p>

<p>在build管道中，接下来的两个脚本执行的构建和测试流程，最后一个脚本是将构建后的文件拷贝到wercker的输出目录中，我们将使用该目录构建docker镜像。</p>

<p>我们注意到deploy中有两个变量：<code>$USERNAME</code>、<code>$PASSWORD</code>，这是我们自定义的变量，当你不希望将隐私内容直接写在代码中的时候，可以在wercker中自定义变量，变量可以只作用于单个pipeline，也可以是所有pipeline共享的。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-enviroment.jpg" alt="在wercker中设置环境变量" /></p>

<p>可以将变量设置成<strong>Protected</strong>模式，这样只有设置者本人才知道该变量的值是什么，其他人即使有共享访问权限，也看不到该变量的值，但可以重新设置来覆盖原值。</p>

<p>Deploy管道中配置的docker镜像的repo、tag和cmd命令，其他容器配置都在代码顶层目录的<code>Dockerfile</code>中定义。当整个构建流程完成后，就可以在docker镜像仓库中看到刚构建的镜像<code>jimmysong/magpie:latest</code>了。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/wercker-docker-magpie.jpg" alt="使用wercker自动构建的docker镜像magpie" /></p>

<h2 id="总结">总结</h2>

<p>当然以上只是一个很简单的示例，还有很多可以优化的流程，比如我们在示例使用<code>latest</code>作为docker镜像的tag，wercker本身提供了很多内置和构建时<a href="http://devcenter.wercker.com/docs/environment-variables/available-env-vars">环境变量</a>，我们可以在<code>wercker.yml</code>文件里获取这些变量作为命令中的值。</p>

<p>当比于其他CI工具，wercker配置简单，更易于使用，同时在wercker的registry中还可以看到很多别人构建的pipline可供参考，还有十分友好的<a href="http://devcenter.wercker.com/docs/workflows">workflows</a>可用于编排构建流程和依赖。</p>

<p>当然CI工具的功能不止这些，利用它可以实现很多自动化流程，节约我们的时间，解放生产力，更多玩法就要大家自己去探索了。</p>

<h2 id="参考">参考</h2>

<p><a href="http://36kr.com/p/5042850.html">容器化应用开发部署平台Wercker获450万美元A轮融资</a></p>

<p><a href="[http://www.admin5.com/article/20170418/737167.shtml">甲骨文收购创业公司Wercker 为开发人员自动化代码测试部署</a></p>

<p><a href="http://devcenter.wercker.com/docs/home">Wercker docs</a></p>

<p><a href="http://devcenter.wercker.com/docs/workflows">Wercker workflow</a></p>

<p><a href="https://github.com/rootsongjc/magpie">magpie</a></p>

        </article>
  </div>
</section>



<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Jun 22, 2017 </h4>
        <h5 id="wc"> 200 Words </h5>
        <h5 id="readtime"> Read in about 1 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://rootsongjc.github.io//tags/wercker">wercker</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/docker">docker</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/ci">ci</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/creating-api-document-with-api-blueprint/"><i class="icon-arrow-left"></i> 使用API blueprint创建API文档</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/kubernetes-client-go-sample/">kubernetes client-go包使用示例 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He also likes coding and writing. He can't live without music
            and movies. Most of his career is about big data and cloud native ecosystem. If you not see him on front of computer, he must being taking photoes in the outside, looking at his amazing photos at <a href=https://tuchong.com/1425795/>Jimmy's
            tuchong homepage</a>. He has recently been keen on microservices, DevOps, kubernetes, and cloud native application architectures.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="194">
<meta itemprop="datePublished" content="2017-06-22">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/continuous-integration-with-wercker/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

