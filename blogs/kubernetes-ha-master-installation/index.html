<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes高可用master节点安装 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-ha-master-installation/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-11"/>
<meta property="article:modified_time" content="2017-04-11"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes高可用master节点安装 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes高可用master节点安装 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-ha-master-installation/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e9%ab%98%e5%8f%af%e7%94%a8master%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f&title=Kubernetes%e9%ab%98%e5%8f%af%e7%94%a8master%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-ha-master-installation%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes高可用master节点安装</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2015091402.jpg" alt="北京西山" /></p>

<p><em>（题图：鬼见愁@北京西山 Sep 14,2015）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目((fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>))中的一篇文章，下文是结合我<a href="https://jimmysong.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，部署master节点的<code>kube-apiserver</code>、<code>kube-controller-manager</code>和<code>kube-scheduler</code>的过程。</p>

<h2 id="高可用kubernetes-master节点安装">高可用kubernetes master节点安装</h2>

<p>kubernetes master 节点包含的组件：</p>

<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>

<p>目前这三个组件需要部署在同一台机器上。</p>

<ul>
<li><code>kube-scheduler</code>、<code>kube-controller-manager</code> 和 <code>kube-apiserver</code> 三者的功能紧密相关；</li>
<li>同时只能有一个 <code>kube-scheduler</code>、<code>kube-controller-manager</code> 进程处于工作状态，如果运行多个，则需要通过选举产生一个 leader；</li>
</ul>

<p>本文档记录部署一个三个节点的高可用 kubernetes master 集群步骤。（后续创建一个 load balancer 来代理访问 kube-apiserver 的请求）</p>

<h2 id="tls-证书文件">TLS 证书文件</h2>

<p>pem和token.csv证书文件我们在<a href="./01-TLS证书和秘钥.md">TLS证书和秘钥</a>这一步中已经创建过了。我们再检查一下。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ls /etc/kubernetes/ssl
</span><span class="">admin-key.pem  admin.pem  ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  kubernetes-key.pem  kubernetes.pem</span></code></pre>
</div>
<h2 id="下载最新版本的二进制文件">下载最新版本的二进制文件</h2>

<p>有两种下载方式</p>

<p><strong>方式一</strong></p>

<p>从 <a href="https://github.com/kubernetes/kubernetes/releases">github release 页面</a> 下载发布版 tarball，解压后再执行下载脚本</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="">$ wget https://github.com/kubernetes/kubernetes/releases/download/v1.6.0/kubernetes.tar.gz
</span><span class="">$ tar -xzvf kubernetes.tar.gz
</span><span class="">...
</span><span class="">$ </span><span class="nb">cd</span><span class=""> kubernetes
</span><span class="">$ ./cluster/get-kube-binaries.sh
</span><span class="">...</span></code></pre>
</div>
<p><strong>方式二</strong></p>

<p>从 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md"><code>CHANGELOG</code>页面</a> 下载 <code>client</code> 或 <code>server</code> tarball 文件</p>

<p><code>server</code> 的 tarball <code>kubernetes-server-linux-amd64.tar.gz</code> 已经包含了 <code>client</code>(<code>kubectl</code>) 二进制文件，所以不用单独下载<code>kubernetes-client-linux-amd64.tar.gz</code>文件；</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="">$ </span><span class="c1"># wget https://dl.k8s.io/v1.6.0/kubernetes-client-linux-amd64.tar.gz
</span><span class="c1"></span><span class="">$ wget https://dl.k8s.io/v1.6.0/kubernetes-server-linux-amd64.tar.gz
</span><span class="">$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
</span><span class="">...
</span><span class="">$ </span><span class="nb">cd</span><span class=""> kubernetes
</span><span class="">$ tar -xzvf  kubernetes-src.tar.gz</span></code></pre>
</div>
<p>将二进制文件拷贝到指定路径</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cp -r server/bin/</span><span class="o">{</span><span class="">kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet</span><span class="o">}</span><span class=""> /root/local/bin/</span></code></pre>
</div>
<h2 id="配置和启动-kube-apiserver">配置和启动 kube-apiserver</h2>

<p><strong>创建 kube-apiserver的service配置文件</strong></p>

<p>serivce配置文件<code>/usr/lib/systemd/system/kube-apiserver.service</code>内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Unit]</span><span class="">
</span><span class=""></span><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Kubernetes API Service</span><span class="">
</span><span class=""></span><span class="na">Documentation</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">https://github.com/GoogleCloudPlatform/kubernetes</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">network.target</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">etcd.service</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/config</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/apiserver</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/kube-apiserver \
</span><span class="s">	    $KUBE_LOGTOSTDERR \
</span><span class="s">	    $KUBE_LOG_LEVEL \
</span><span class="s">	    $KUBE_ETCD_SERVERS \
</span><span class="s">	    $KUBE_API_ADDRESS \
</span><span class="s">	    $KUBE_API_PORT \
</span><span class="s">	    $KUBELET_PORT \
</span><span class="s">	    $KUBE_ALLOW_PRIV \
</span><span class="s">	    $KUBE_SERVICE_ADDRESSES \
</span><span class="s">	    $KUBE_ADMISSION_CONTROL \
</span><span class="s">	    $KUBE_API_ARGS</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class=""></span><span class="na">Type</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">notify</span><span class="">
</span><span class=""></span><span class="na">LimitNOFILE</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">65536</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span></code></pre>
</div>
<p><code>/etc/kubernetes/config</code>文件的内容为：</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1">###</span><span class="">
</span><span class=""></span><span class="c1"># kubernetes system config</span><span class="">
</span><span class=""></span><span class="c1">#</span><span class="">
</span><span class=""></span><span class="c1"># The following values are used to configure various aspects of all</span><span class="">
</span><span class=""></span><span class="c1"># kubernetes services, including</span><span class="">
</span><span class=""></span><span class="c1">#</span><span class="">
</span><span class=""></span><span class="c1">#   kube-apiserver.service</span><span class="">
</span><span class=""></span><span class="c1">#   kube-controller-manager.service</span><span class="">
</span><span class=""></span><span class="c1">#   kube-scheduler.service</span><span class="">
</span><span class=""></span><span class="c1">#   kubelet.service</span><span class="">
</span><span class=""></span><span class="c1">#   kube-proxy.service</span><span class="">
</span><span class=""></span><span class="c1"># logging to stderr means we get it in the systemd journal</span><span class="">
</span><span class=""></span><span class="na">KUBE_LOGTOSTDERR</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;--logtostderr=true&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># journal message level, 0 is debug</span><span class="">
</span><span class=""></span><span class="na">KUBE_LOG_LEVEL</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;--v=0&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># Should this cluster be allowed to run privileged docker containers</span><span class="">
</span><span class=""></span><span class="na">KUBE_ALLOW_PRIV</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;--allow-privileged=true&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># How the controller-manager, scheduler, and proxy find the apiserver</span><span class="">
</span><span class=""></span><span class="c1">#KUBE_MASTER=&#34;--master=http://sz-pg-oam-docker-test-001.tendcloud.com:8080&#34;</span><span class="">
</span><span class=""></span><span class="na">KUBE_MASTER</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;--master=http://172.20.0.113:8080&#34;</span></code></pre>
</div>
<p>该配置文件同时被kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy使用。</p>

<p>apiserver配置文件<code>/etc/kubernetes/apiserver</code>内容为：</p>
<div class="highlight"><pre class="chroma"><code class="language-Ini" data-lang="Ini"><span class="">###
</span><span class="">## kubernetes system config
</span><span class="">##
</span><span class="">## The following values are used to configure the kube-apiserver
</span><span class="">##
</span><span class="">#
</span><span class="">## The address on the local server to listen to.
</span><span class="">#KUBE_API_ADDRESS=&#34;--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com&#34;
</span><span class="">KUBE_API_ADDRESS=&#34;--advertise-address=172.20.0.113 --bind-address=172.20.0.113 --insecure-bind-address=172.20.0.113&#34;
</span><span class="">#
</span><span class="">## The port on the local server to listen on.
</span><span class="">#KUBE_API_PORT=&#34;--port=8080&#34;
</span><span class="">#
</span><span class="">## Port minions listen on
</span><span class="">#KUBELET_PORT=&#34;--kubelet-port=10250&#34;
</span><span class="">#
</span><span class="">## Comma separated list of nodes in the etcd cluster
</span><span class="">KUBE_ETCD_SERVERS=&#34;--etcd-servers=https://172.20.0.113:2379,172.20.0.114:2379,172.20.0.115:2379&#34;
</span><span class="">#
</span><span class="">## Address range to use for services
</span><span class="">KUBE_SERVICE_ADDRESSES=&#34;--service-cluster-ip-range=10.254.0.0/16&#34;
</span><span class="">#
</span><span class="">## default admission control policies
</span><span class="">KUBE_ADMISSION_CONTROL=&#34;--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota&#34;
</span><span class="">#
</span><span class="">## Add your own!
</span><span class="">KUBE_API_ARGS=&#34;--authorization-mode=RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/etc/kubernetes/ssl/ca.pem --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h&#34;</span></code></pre>
</div>
<ul>
<li><code>--authorization-mode=RBAC</code> 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求；</li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用<strong>非安全端口</strong>和 kube-apiserver通信;</li>
<li>kubelet、kube-proxy、kubectl 部署在其它 Node 节点上，如果通过<strong>安全端口</strong>访问 kube-apiserver，则必须先通过 TLS 证书认证，再通过 RBAC 授权；</li>
<li>kube-proxy、kubectl 通过在使用的证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的；</li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定 <code>--kubelet-certificate-authority</code>、<code>--kubelet-client-certificate</code> 和 <code>--kubelet-client-key</code> 选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误；</li>
<li><code>--admission-control</code> 值必须包含 <code>ServiceAccount</code>；</li>
<li><code>--bind-address</code> 不能为 <code>127.0.0.1</code>；</li>
<li><code>runtime-config</code>配置为<code>rbac.authorization.k8s.io/v1beta1</code>，表示运行时的apiVersion；</li>
<li><code>--service-cluster-ip-range</code> 指定 Service Cluster IP 地址段，该地址段不能路由可达；</li>
<li>缺省情况下 kubernetes 对象保存在 etcd <code>/registry</code> 路径下，可以通过 <code>--etcd-prefix</code> 参数进行调整；</li>
</ul>

<p>完整 unit 见 <a href="./systemd/kube-apiserver.service">kube-apiserver.service</a></p>

<p><strong>启动kube-apiserver</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ systemctl daemon-reload
</span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> kube-apiserver
</span><span class="">$ systemctl start kube-apiserver
</span><span class="">$ systemctl status kube-apiserver</span></code></pre>
</div>
<h2 id="配置和启动-kube-controller-manager">配置和启动 kube-controller-manager</h2>

<p><strong>创建 kube-controller-manager的serivce配置文件</strong></p>

<p>文件路径<code>/usr/lib/systemd/system/kube-controller-manager.service</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Kubernetes Controller Manager</span><span class="">
</span><span class=""></span><span class="na">Documentation</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">https://github.com/GoogleCloudPlatform/kubernetes</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/config</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/controller-manager</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/kube-controller-manager \
</span><span class="s">	    $KUBE_LOGTOSTDERR \
</span><span class="s">	    $KUBE_LOG_LEVEL \
</span><span class="s">	    $KUBE_MASTER \
</span><span class="s">	    $KUBE_CONTROLLER_MANAGER_ARGS</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class=""></span><span class="na">LimitNOFILE</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">65536</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span></code></pre>
</div>
<p>配置文件<code>/etc/kubernetes/controller-manager</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1">###</span><span class="">
</span><span class=""></span><span class="c1"># The following values are used to configure the kubernetes controller-manager</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># defaults from config and apiserver should be adequate</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># Add your own!</span><span class="">
</span><span class=""></span><span class="na">KUBE_CONTROLLER_MANAGER_ARGS</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem --leader-elect=true&#34;</span></code></pre>
</div>
<ul>
<li><p><code>--service-cluster-ip-range</code> 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致；</p></li>

<li><p><code>--cluster-signing-*</code> 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥；</p></li>

<li><p><code>--root-ca-file</code> 用来对 kube-apiserver 证书进行校验，<strong>指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件</strong>；</p></li>

<li><p><code>--address</code> 值必须为 <code>127.0.0.1</code>，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器，否则：</p></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">  $ kubectl get componentstatuses
</span><span class="">  NAME                 STATUS      MESSAGE                                                                                        ERROR
</span><span class="">  scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp </span><span class="m">127</span><span class="">.0.0.1:10251: getsockopt: connection refused   
</span><span class="">  controller-manager   Healthy     ok                                                                                             
</span><span class="">  etcd-2               Unhealthy   Get http://172.20.0.113:2379/health: malformed HTTP response </span><span class="s2">&#34;\x15\x03\x01\x00\x02\x02&#34;</span><span class="">        
</span><span class="">  etcd-0               Healthy     </span><span class="o">{</span><span class="s2">&#34;health&#34;</span><span class="">: </span><span class="s2">&#34;true&#34;</span><span class="o">}</span><span class="">                                                                             
</span><span class="">  etcd-1               Healthy     </span><span class="o">{</span><span class="s2">&#34;health&#34;</span><span class="">: </span><span class="s2">&#34;true&#34;</span><span class="o">}</span><span class="">  </span></code></pre>
</div>
<p>参考：<a href="https://github.com/kubernetes-incubator/bootkube/issues/64">https://github.com/kubernetes-incubator/bootkube/issues/64</a></p>

<p>完整 unit 见 <a href="./systemd/kube-controller-manager.service">kube-controller-manager.service</a></p>

<h3 id="启动-kube-controller-manager">启动 kube-controller-manager</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ systemctl daemon-reload
</span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> kube-controller-manager
</span><span class="">$ systemctl start kube-controller-manager</span></code></pre>
</div>
<h2 id="配置和启动-kube-scheduler">配置和启动 kube-scheduler</h2>

<p><strong>创建 kube-scheduler的serivce配置文件</strong></p>

<p>文件路径<code>/usr/lib/systemd/system/kube-scheduler.serivce</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Unit]</span><span class="">
</span><span class=""></span><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Kubernetes Scheduler Plugin</span><span class="">
</span><span class=""></span><span class="na">Documentation</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">https://github.com/GoogleCloudPlatform/kubernetes</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/config</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/scheduler</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/kube-scheduler \
</span><span class="s">            $KUBE_LOGTOSTDERR \
</span><span class="s">            $KUBE_LOG_LEVEL \
</span><span class="s">            $KUBE_MASTER \
</span><span class="s">            $KUBE_SCHEDULER_ARGS</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class=""></span><span class="na">LimitNOFILE</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">65536</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span></code></pre>
</div>
<p>配置文件<code>/etc/kubernetes/scheduler</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-Ini" data-lang="Ini"><span class="">###
</span><span class=""># kubernetes scheduler config
</span><span class="">
</span><span class=""># default config should be adequate
</span><span class="">
</span><span class=""># Add your own!
</span><span class="">KUBE_SCHEDULER_ARGS=&#34;--leader-elect=true --address=127.0.0.1&#34;</span></code></pre>
</div>
<ul>
<li><code>--address</code> 值必须为 <code>127.0.0.1</code>，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器；</li>
</ul>

<p>完整 unit 见 <a href="./systemd/kube-scheduler.service">kube-scheduler.service</a></p>

<h3 id="启动-kube-scheduler">启动 kube-scheduler</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ systemctl daemon-reload
</span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> kube-scheduler
</span><span class="">$ systemctl start kube-scheduler</span></code></pre>
</div>
<h2 id="验证-master-节点功能">验证 master 节点功能</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl get componentstatuses
</span><span class="">NAME                 STATUS    MESSAGE              ERROR
</span><span class="">scheduler            Healthy   ok                   
</span><span class="">controller-manager   Healthy   ok                   
</span><span class="">etcd-0               Healthy   </span><span class="o">{</span><span class="s2">&#34;health&#34;</span><span class="">: </span><span class="s2">&#34;true&#34;</span><span class="o">}</span><span class="">   
</span><span class="">etcd-1               Healthy   </span><span class="o">{</span><span class="s2">&#34;health&#34;</span><span class="">: </span><span class="s2">&#34;true&#34;</span><span class="o">}</span><span class="">   
</span><span class="">etcd-2               Healthy   </span><span class="o">{</span><span class="s2">&#34;health&#34;</span><span class="">: </span><span class="s2">&#34;true&#34;</span><span class="o">}</span><span class="">   </span></code></pre>
</div>
<h2 id="后记">后记</h2>

<p>当时在配置过程中遇到了问题<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/4">TLS认证相关的问题</a>，其实就是因为配置apiserver时候etcd的协议写成了http导致的，应该是用https。</p>

<p><a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">Opsnull</a>写的kubernetes高可用master集群部署过程中似乎并没有包括<strong>高可用的配置</strong>，才云科技的唐继元分享过<a href="https://segmentfault.com/a/1190000005832319">Kubernetes Master High Availability 高级实践</a>。</p>

<p>究竟如何实现kubernetes master的高可用还需要继续探索。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-etcd-ha-config/">Kubernetes安装之etcd高可用配置</a></li>
                
                <li><a href="/blogs/kubernetes-create-kubeconfig/">Kubernetes安装之创建kubeconfig文件</a></li>
                
                <li><a href="/blogs/kubernetes-tls-certificate/">Kubernetes安装之证书验证</a></li>
                
                <li><a href="/blogs/kubernetes-fluentd-elasticsearch-installation/">使用Fluentd和ElasticSearch收集Kubernetes集群日志</a></li>
                
                <li><a href="/blogs/kubernetes-configmap-introduction/">Kubernetes的ConfigMap解析</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Apr 11, 2017 </h4>
        <h5 id="wc"> 2400 Words </h5>
        <h5 id="readtime"> Read in about 5 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-node-installation/"><i class="icon-arrow-left"></i> Kubernetes node节点安装</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-etcd-ha-config/">Kubernetes安装之etcd高可用配置 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2371">
<meta itemprop="datePublished" content="2017-04-11">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-ha-master-installation/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
