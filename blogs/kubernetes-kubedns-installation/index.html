<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes安装之kubedns配置 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://jimmysong.io/blogs/kubernetes-kubedns-installation/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-12"/>
<meta property="article:modified_time" content="2017-04-12"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes安装之kubedns配置 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="http://jimmysong.io/">
    <title> Kubernetes安装之kubedns配置 - Jimmy Song </title>
    <link rel="canonical" href="http://jimmysong.io/blogs/kubernetes-kubedns-installation/"> <link rel="stylesheet" href="./static/css/style.css">


<link href="./static/css/prism.css" rel="stylesheet" />
<script src="./static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8bkubedns%e9%85%8d%e7%bd%ae-http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f&title=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8bkubedns%e9%85%8d%e7%bd%ae&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-kubedns-installation%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes安装之kubedns配置</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016082701.jpg" alt="东三环" /></p>

<p><em>（题图：雨过天晴@北京定福庄 Aug 27,2016）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目(fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>)中的一篇文章，下文是结合我<a href="http://rootsongjc.github.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，使用yaml文件部署<strong>kubedns</strong>。</p>

<p><strong>安装环境配置信息</strong></p>

<ul>
<li>CentOS 7.2.1511</li>
<li>Docker 1.12.5</li>
<li>Flannel 0.7</li>
<li>Kubernetes 1.6.0</li>
</ul>

<h2 id="安装和配置-kubedns-插件">安装和配置 kubedns 插件</h2>

<p>官方的yaml文件目录：<code>kubernetes/cluster/addons/dns</code>。</p>

<p>该插件直接使用kubernetes部署，官方的配置文件中包含以下镜像：</p>

<pre><code>gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.1
gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.1
gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.1
</code></pre>

<p>我clone了上述镜像，上传到我的私有镜像仓库：</p>

<pre><code>sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-dnsmasq-nanny-amd64:1.14.1
sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-kube-dns-amd64:1.14.1
sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-sidecar-amd64:1.14.1
</code></pre>

<p>同时上传了一份到时速云备份：</p>

<pre><code>index.tenxcloud.com/jimmy/k8s-dns-dnsmasq-nanny-amd64:1.14.1
index.tenxcloud.com/jimmy/k8s-dns-kube-dns-amd64:1.14.1
index.tenxcloud.com/jimmy/k8s-dns-sidecar-amd64:1.14.1
</code></pre>

<p>以下yaml配置文件中使用的是私有镜像仓库中的镜像。</p>

<pre><code class="language-bash">kubedns-cm.yaml  
kubedns-sa.yaml  
kubedns-controller.yaml  
kubedns-svc.yaml
</code></pre>

<p>已经修改好的 yaml 文件见：<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">github项目中的manifest/kubedns/目录</a>。</p>

<h2 id="系统预定义的-rolebinding">系统预定义的 RoleBinding</h2>

<p>预定义的 RoleBinding <code>system:kube-dns</code> 将 kube-system 命名空间的 <code>kube-dns</code> ServiceAccount 与 <code>system:kube-dns</code> Role 绑定， 该 Role 具有访问 kube-apiserver DNS 相关 API 的权限；</p>

<pre><code class="language-Bash">$ kubectl get clusterrolebindings system:kube-dns -o yaml
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  creationTimestamp: 2017-04-11T11:20:42Z
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-dns
  resourceVersion: &quot;58&quot;
  selfLink: /apis/rbac.authorization.k8s.io/v1beta1/clusterrolebindingssystem%3Akube-dns
  uid: e61f4d92-1ea8-11e7-8cd7-f4e9d49f8ed0
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-dns
subjects:
- kind: ServiceAccount
  name: kube-dns
  namespace: kube-system
</code></pre>

<p><code>kubedns-controller.yaml</code> 中定义的 Pods 时使用了 <code>kubedns-sa.yaml</code> 文件定义的 <code>kube-dns</code> ServiceAccount，所以具有访问 kube-apiserver DNS 相关 API 的权限。</p>

<h2 id="配置-kube-dns-serviceaccount">配置 kube-dns ServiceAccount</h2>

<p>无需修改。</p>

<h2 id="配置-kube-dns-服务">配置 <code>kube-dns</code> 服务</h2>

<pre><code class="language-bash">$ diff kubedns-svc.yaml.base kubedns-svc.yaml
30c30
&lt;   clusterIP: __PILLAR__DNS__SERVER__
---
&gt;   clusterIP: 10.254.0.2
</code></pre>

<ul>
<li>spec.clusterIP = 10.254.0.2，即明确指定了 kube-dns Service IP，这个 IP 需要和 kubelet 的 <code>--cluster-dns</code> 参数值一致；</li>
</ul>

<h2 id="配置-kube-dns-deployment">配置 <code>kube-dns</code> Deployment</h2>

<pre><code class="language-bash">$ diff kubedns-controller.yaml.base kubedns-controller.yaml
58c58
&lt;         image: gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.1
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-kube-dns-amd64:v1.14.1
88c88
&lt;         - --domain=__PILLAR__DNS__DOMAIN__.
---
&gt;         - --domain=cluster.local.
92c92
&lt;         __PILLAR__FEDERATIONS__DOMAIN__MAP__
---
&gt;         #__PILLAR__FEDERATIONS__DOMAIN__MAP__
110c110
&lt;         image: gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.1
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-dnsmasq-nanny-amd64:v1.14.1
129c129
&lt;         - --server=/__PILLAR__DNS__DOMAIN__/127.0.0.1#10053
---
&gt;         - --server=/cluster.local./127.0.0.1#10053
148c148
&lt;         image: gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.1
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-sidecar-amd64:v1.14.1
161,162c161,162
&lt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,A
&lt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,A
---
&gt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local.,5,A
&gt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local.,5,A
</code></pre>

<ul>
<li>使用系统已经做了 RoleBinding 的 <code>kube-dns</code> ServiceAccount，该账户具有访问 kube-apiserver DNS 相关 API 的权限；</li>
</ul>

<h2 id="执行所有定义文件">执行所有定义文件</h2>

<pre><code class="language-bash">$ pwd
/root/kubedns
$ ls *.yaml
kubedns-cm.yaml  kubedns-controller.yaml  kubedns-sa.yaml  kubedns-svc.yaml
$ kubectl create -f .
</code></pre>

<h2 id="检查-kubedns-功能">检查 kubedns 功能</h2>

<p>新建一个 Deployment</p>

<pre><code class="language-bash">$ cat  my-nginx.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-nginx
spec:
  replicas: 2
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
      - name: my-nginx
        image: sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9
        ports:
        - containerPort: 80
$ kubectl create -f my-nginx.yaml
</code></pre>

<p>Export 该 Deployment, 生成 <code>my-nginx</code> 服务</p>

<pre><code class="language-bash">$ kubectl expose deploy my-nginx
$ kubectl get services --all-namespaces |grep my-nginx
default       my-nginx     10.254.179.239   &lt;none&gt;        80/TCP          42m
</code></pre>

<p>创建另一个 Pod，查看 <code>/etc/resolv.conf</code> 是否包含 <code>kubelet</code> 配置的 <code>--cluster-dns</code> 和 <code>--cluster-domain</code>，是否能够将服务 <code>my-nginx</code> 解析到 Cluster IP <code>10.254.179.239</code>。</p>

<pre><code class="language-bash">$ kubectl create -f nginx-pod.yaml
$ kubectl exec  nginx -i -t -- /bin/bash
root@nginx:/# cat /etc/resolv.conf
nameserver 10.254.0.2
search default.svc.cluster.local. svc.cluster.local. cluster.local. tendcloud.com
options ndots:5

root@nginx:/# ping my-nginx
PING my-nginx.default.svc.cluster.local (10.254.179.239): 56 data bytes
76 bytes from 119.147.223.109: Destination Net Unreachable
^C--- my-nginx.default.svc.cluster.local ping statistics ---

root@nginx:/# ping kubernetes
PING kubernetes.default.svc.cluster.local (10.254.0.1): 56 data bytes
^C--- kubernetes.default.svc.cluster.local ping statistics ---
11 packets transmitted, 0 packets received, 100% packet loss

root@nginx:/# ping kube-dns.kube-system.svc.cluster.local
PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 56 data bytes
^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---
6 packets transmitted, 0 packets received, 100% packet loss
</code></pre>

<p>从结果来看，service名称可以正常解析。</p>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Apr 12, 2017 </h4>
        <h5 id="wc"> 900 Words </h5>
        <h5 id="readtime"> Read in about 2 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://jimmysong.io/blogs/kubernetes-dashboard-installation-with-tls/"><i class="icon-arrow-left"></i> 在开启TLS的Kubernetes1.6集群上安装dashboard</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://jimmysong.io/blogs/kubernetes-node-installation/">Kubernetes node节点安装 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="871">
<meta itemprop="datePublished" content="2017-04-12">
<meta itemprop="url" content="http://jimmysong.io/blogs/kubernetes-kubedns-installation/">
 <footer>
    <div>
        <p>
            <a href="http://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="http://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="http://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="http://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
            Powered by <a href="http://gohugo.io">Hugo</a> </p>
    </div>
</footer>
</body>

</html>
