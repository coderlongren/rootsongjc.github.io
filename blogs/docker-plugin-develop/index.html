<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="docker, docker plugin, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Docker插件开发-sshfs示例 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/docker-plugin-develop/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-10"/>
<meta property="article:modified_time" content="2017-03-10"/>



<meta property="article:tag" content="docker">
<meta property="article:tag" content="docker plugin">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Docker插件开发-sshfs示例 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> Docker插件开发-sshfs示例 - rootsongjc.github.io </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/docker-plugin-develop/">
    

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Docker%e6%8f%92%e4%bb%b6%e5%bc%80%e5%8f%91-sshfs%e7%a4%ba%e4%be%8b-http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f&title=Docker%e6%8f%92%e4%bb%b6%e5%bc%80%e5%8f%91-sshfs%e7%a4%ba%e4%be%8b&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Docker插件开发-sshfs示例</h1>
  <div>
        <article itemprop="articleBody" id="content">
           <p><img src="http://olz1di9xf.bkt.clouddn.com/20161016022.jpg" alt="杭州吴山" /></p>

<p><em>（题图：杭州吴山步道旁的墙壁 Oct 16,2016）</em></p>

<p><a href="https://github.com/docker/docker/blob/17.03.x/docs/extend/index.md#developing-a-plugin">官方示例文档</a></p>

<p>官方以开发一个<strong>sshfs</strong>的volume plugin为例。</p>

<pre><code>$ git clone https://github.com/vieux/docker-volume-sshfs
$ cd docker-volume-sshfs
$ go get github.com/docker/go-plugins-helpers/volume
$ go build -o docker-volume-sshfs main.go  
$ docker build -t rootfsimage .
$ id=$(docker create rootfsimage true) # id was cd851ce43a403 when the image was created
$ sudo mkdir -p myplugin/rootfs
$ sudo docker export &quot;$id&quot; | sudo tar -x -C myplugin/rootfs
$ docker rm -vf &quot;$id&quot;
$ docker rmi rootfsimage
</code></pre>

<p>我们可以看到<strong>sshfs</strong>的Dockerfile是这样的：</p>

<pre><code class="language-Dockerfile">FROM alpine

RUN apk update &amp;&amp; apk add sshfs

RUN mkdir -p /run/docker/plugins /mnt/state /mnt/volumes

COPY docker-volume-sshfs docker-volume-sshfs

CMD [&quot;docker-volume-sshfs&quot;]
</code></pre>

<p>实际上是讲编译好的可执行文件复制到alpine linux容器中运行。</p>

<p>编译rootfsimage镜像的过程。</p>

<pre><code>docker build -t rootfsimage .
Sending build context to Docker daemon 11.71 MB
Step 1/5 : FROM alpine
 ---&gt; 4a415e366388
Step 2/5 : RUN apk update &amp;&amp; apk add sshfs
 ---&gt; Running in 1551ecc1c847
fetch http://dl-cdn.alpinelinux.org/alpine/v3.5/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.5/community/x86_64/APKINDEX.tar.gz
v3.5.2-2-ge626ce8c3c [http://dl-cdn.alpinelinux.org/alpine/v3.5/main]
v3.5.1-71-gc7bb9a04f0 [http://dl-cdn.alpinelinux.org/alpine/v3.5/community]
OK: 7959 distinct packages available
(1/10) Installing openssh-client (7.4_p1-r0)
(2/10) Installing fuse (2.9.7-r0)
(3/10) Installing libffi (3.2.1-r2)
(4/10) Installing libintl (0.19.8.1-r0)
(5/10) Installing libuuid (2.28.2-r1)
(6/10) Installing libblkid (2.28.2-r1)
(7/10) Installing libmount (2.28.2-r1)
(8/10) Installing pcre (8.39-r0)
(9/10) Installing glib (2.50.2-r0)
(10/10) Installing sshfs (2.8-r0)
Executing busybox-1.25.1-r0.trigger
Executing glib-2.50.2-r0.trigger
OK: 11 MiB in 21 packages
 ---&gt; 1a73c501f431
Removing intermediate container 1551ecc1c847
Step 3/5 : RUN mkdir -p /run/docker/plugins /mnt/state /mnt/volumes
 ---&gt; Running in 032af3b2595a
 ---&gt; 30c7e8463e96
Removing intermediate container 032af3b2595a
Step 4/5 : COPY docker-volume-sshfs docker-volume-sshfs
 ---&gt; a924c6fcc1e4
Removing intermediate container ffc5e3c97707
Step 5/5 : CMD docker-volume-sshfs
 ---&gt; Running in 0dc938fe4f4e
 ---&gt; 0fd2e3d94860
Removing intermediate container 0dc938fe4f4e
Successfully built 0fd2e3d94860
</code></pre>

<p>编写<code>config.json</code>文档</p>

<pre><code class="language-Json">{
    &quot;description&quot;: &quot;sshFS plugin for Docker&quot;,
    &quot;documentation&quot;: &quot;https://docs.docker.com/engine/extend/plugins/&quot;,
    &quot;entrypoint&quot;: [&quot;/go/bin/docker-volume-sshfs&quot;],
    &quot;network&quot;: {
           &quot;type&quot;: &quot;host&quot;
           },
    &quot;interface&quot; : {
           &quot;types&quot;: [&quot;docker.volumedriver/1.0&quot;],
           &quot;socket&quot;: &quot;sshfs.sock&quot;
    },
    &quot;linux&quot;: {
        &quot;capabilities&quot;: [&quot;CAP_SYS_ADMIN&quot;]
    }
}
</code></pre>

<p>该插件使用host网络类型，使用/run/docker/plugins/sshfs.sock接口与docker engine通信。</p>

<p><strong>创建plugin</strong></p>

<p>使用<code>docker plugin create &lt;plugin_name&gt; /path/to/plugin/data/</code>命令创建插件。</p>

<p>具体到sshfs插件，在myplugin目录下使用如下命令创建插件：</p>

<pre><code class="language-shell">docker plugin create jimmysong/sshfs:latest .
</code></pre>

<p>现在就可以看到刚创建的插件了</p>

<pre><code>docker plugin ls
ID                  NAME                 DESCRIPTION               ENABLED
8aa1f6098fca        vieux/sshfs:latest   sshFS plugin for Docker   true
</code></pre>

<p><strong>push plugin</strong></p>

<p>先登录你的docker hub账户，然后使用<code>docker plugin push jimmysong/sshfs:latest</code>即可以推送docker plugin到docker hub中。</p>

<p>目前推送到<strong>harbor</strong>镜像仓库有问题，报错信息：</p>

<pre><code>c08c951b53b7: Preparing 
denied: requested access to the resource is denied
</code></pre>

<p>已给harbor提<a href="https://github.com/vmware/harbor/issues/1532">issue-1532</a></p>

<p><strong>plugin的使用</strong></p>

<p>有发现了个问题<a href="https://github.com/docker/docker/issues/31723">docker issue-31723</a>，使用plugin创建volume的时候居然找不到<code>sshfs.sock</code>文件！😢刚开始手动创建plugin的时候测试了下是正常的，不知道为啥弄到这台测试机器上出问题了。</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Mar 10, 2017 </h4>
          <h5 id="wc"> 400 Words </h5>
          <h5 id="readtime"> Read in about 2 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/docker">docker</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/docker-plugin">docker plugin</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/docker-vs-kubernetes-part1/"><i class="icon-arrow-left"></i> Docker v.s Kubernetes part1</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/contiv-v2plugin/">Contiv入坑指南-v2plugin <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            Jimmy Song is a software engineer living in Beijing, he usually likes to explore open source software projects, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took the photo particularly sticky, this is  his tuchong personal page: <a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>
            He has recently been keen on micro-service, DevOps and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="327">
<meta itemprop="datePublished" content="2017-03-10">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/docker-plugin-develop/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7131036-1', 'rootsongj.github.io');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
</body>
</html>

