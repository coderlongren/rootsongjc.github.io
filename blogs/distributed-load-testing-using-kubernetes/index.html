<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="运用kubernetes进行分布式负载测试 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://jimmysong.io/blogs/distributed-load-testing-using-kubernetes/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-24"/>
<meta property="article:modified_time" content="2017-04-24"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="运用kubernetes进行分布式负载测试 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="http://jimmysong.io/">
    <title> 运用kubernetes进行分布式负载测试 - Jimmy Song </title>
    <link rel="canonical" href="http://jimmysong.io/blogs/distributed-load-testing-using-kubernetes/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=%e8%bf%90%e7%94%a8kubernetes%e8%bf%9b%e8%a1%8c%e5%88%86%e5%b8%83%e5%bc%8f%e8%b4%9f%e8%bd%bd%e6%b5%8b%e8%af%95-http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f&title=%e8%bf%90%e7%94%a8kubernetes%e8%bf%9b%e8%a1%8c%e5%88%86%e5%b8%83%e5%bc%8f%e8%b4%9f%e8%bd%bd%e6%b5%8b%e8%af%95&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2fjimmysong.io%2fblogs%2fdistributed-load-testing-using-kubernetes%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">运用kubernetes进行分布式负载测试</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20160325002.jpg" alt="kubrick" /></p>

<p><em>（题图：Kubrick Book Store  Mar 25,2016）</em></p>

<h2 id="前言">前言</h2>

<p>Github地址<a href="https://github.com/rootsongjc/distributed-load-testing-using-kubernetes">https://github.com/rootsongjc/distributed-load-testing-using-kubernetes</a></p>

<p>该教程描述如何在<a href="http://kubernetes.io">Kubernetes</a>中进行分布式负载均衡测试，包括一个web应用、docker镜像和Kubernetes controllers/services。更多资料请查看<a href="http://cloud.google.com/solutions/distributed-load-testing-using-kubernetes">Distributed Load Testing Using Kubernetes</a> 。</p>

<p><strong>注意：该测试是在我自己本地搭建的kubernetes集群上测试的，不需要使用Google Cloud Platform。</strong></p>

<h2 id="准备">准备</h2>

<p><strong>不需要GCE及其他组件，你只需要有一个kubernetes集群即可。</strong></p>

<p>如果你还没有kubernetes集群，可以参考<a href="https://www.gitbook.com/book/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>部署一个。</p>

<h2 id="部署web应用">部署Web应用</h2>

<p><code>sample-webapp</code> 目录下包含一个简单的web测试应用。我们将其构建为docker镜像，在kubernetes中运行。你可以自己构建，也可以直接用这个我构建好的镜像<code>index.tenxcloud.com/jimmy/k8s-sample-webapp:latest</code>。</p>

<p>在kubernetes上部署sample-webapp。</p>

<pre><code class="language-bash">$ cd kubernetes-config
$ kubectl create -f sample-webapp-controller.yaml
$ kubectl create -f kubectl create -f sample-webapp-service.yaml
</code></pre>

<h2 id="部署locust的controller和service">部署Locust的Controller和Service</h2>

<p><code>locust-master</code>和<code>locust-work</code>使用同样的docker镜像，修改cotnroller中<code>spec.template.spec.containers.env</code>字段中的value为你<code>sample-webapp</code> service的名字。</p>

<pre><code>- name: TARGET_HOST
  value: http://sample-webapp:8000
</code></pre>

<h3 id="创建controller-docker镜像-可选">创建Controller Docker镜像（可选）</h3>

<p><code>locust-master</code>和<code>locust-work</code> controller使用的都是<code>locust-tasks</code> docker镜像。你可以直接下载<code>gcr.io/cloud-solutions-http://olz1di9xf.bkt.clouddn.com/locust-tasks</code>，也可以自己编译。自己编译大概要花几分钟时间，镜像大小为820M。</p>

<pre><code>$ docker build -t index.tenxcloud.com/jimmy/locust-tasks:latest .
$ docker push index.tenxcloud.com/jimmy/locust-tasks:latest
</code></pre>

<p><strong>注意</strong>：我使用的是时速云的镜像仓库。</p>

<p>每个controller的yaml的<code>spec.template.spec.containers.image</code> 字段指定的是我的镜像：</p>

<pre><code>image: index.tenxcloud.com/jimmy/locust-tasks:latest
</code></pre>

<h3 id="部署locust-master">部署locust-master</h3>

<pre><code class="language-bash">$ kubectl create -f locust-master-controller.yaml
$ kubectl create -f locust-master-service.yaml
</code></pre>

<h3 id="部署locust-worker">部署locust-worker</h3>

<p>Now deploy <code>locust-worker-controller</code>:</p>

<pre><code class="language-bash">$ kubectl create -f locust-worker-controller.yaml
</code></pre>

<p>你可以很轻易的给work扩容，通过命令行方式：</p>

<pre><code class="language-bash">$ kubectl scale --replicas=20 replicationcontrollers locust-worker
</code></pre>

<p>当然你也可以通过WebUI：Dashboard - Workloads - Replication Controllers - <strong>ServiceName</strong> - Scale来扩容。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/dashbaord-scale.jpg" alt="dashboard-scale" /></p>

<h3 id="配置traefik">配置Traefik</h3>

<p>参考<a href="http://rootsongjc.github.io/blogs/traefik-ingress-installation/">kubernetes的traefik ingress安装</a>，在<code>ingress.yaml</code>中加入如下配置：</p>

<pre><code class="language-Yaml">  - host: traefik.locust.io
    http:
      paths:
      - path: /
        backend:
          serviceName: locust-master
          servicePort: 8089
</code></pre>

<p>然后执行<code>kubectl replace -f ingress.yaml</code>即可更新traefik。</p>

<p>通过Traefik的dashboard就可以看到刚增加的<code>traefik.locust.io</code>节点。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/traefik-dashboard-locust.jpg" alt="traefik-dashboard-locust" /></p>

<h2 id="执行测试">执行测试</h2>

<p>打开<code>http://traefik.locust.io</code>页面，点击<code>Edit</code>输入伪造的用户数和用户每秒发送的请求个数，点击<code>Start Swarming</code>就可以开始测试了。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/locust-start-swarming.jpg" alt="locust-start-swarming" /></p>

<p>在测试过程中调整<code>sample-webapp</code>的pod个数（默认设置了1个pod），观察pod的负载变化情况。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/sample-webapp-rc.jpg" alt="sample-webapp-rc" /></p>

<p>从一段时间的观察中可以看到负载被平均分配给了3个pod。</p>

<p>在locust的页面中可以实时观察也可以下载测试结果。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/locust-dashboard.jpg" alt="locust-dashboard" /></p>

<h2 id="参考">参考</h2>

<p><a href="https://cloud.google.com/solutions/distributed-load-testing-using-kubernetes">Distributed Load Testing Using Kubernetes</a></p>

<p><a href="http://www.csdn.net/article/2015-07-07/2825155">运用Kubernetes进行分布式负载测试</a></p>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Mon Apr 24, 2017 </h4>
        <h5 id="wc"> 1500 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://jimmysong.io/blogs/kubernetes-performance-test/"><i class="icon-arrow-left"></i> Kubernetes网络和集群性能测试</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://jimmysong.io/blogs/ip-and-service-discovry-in-kubernetes/">Kubernetes中的IP和服务发现体系 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1419">
<meta itemprop="datePublished" content="2017-04-24">
<meta itemprop="url" content="http://jimmysong.io/blogs/distributed-load-testing-using-kubernetes/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
            Powered by <a href="https://gohugo.io">Hugo</a> </p>
    </div>
</footer>
</body>

</html>

