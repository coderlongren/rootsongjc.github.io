<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes网络和集群性能测试 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-performance-test/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-25"/>
<meta property="article:modified_time" content="2017-04-25"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes网络和集群性能测试 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes网络和集群性能测试 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-performance-test/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e7%bd%91%e7%bb%9c%e5%92%8c%e9%9b%86%e7%be%a4%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f&title=Kubernetes%e7%bd%91%e7%bb%9c%e5%92%8c%e9%9b%86%e7%be%a4%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-performance-test%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes网络和集群性能测试</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20160618045.jpg" alt="Img" /></p>

<p><em>（题图：无题@安贞门 Jun 18,2016）</em></p>

<h2 id="前言">前言</h2>

<p>该测试是为了测试在不同的场景下，访问kubernetes的延迟以及kubernetes的性能。进行以下测试前，你需要有一个部署好的kubernetes集群，关于如何部署kuberentes1.6集群，请参考<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>。</p>

<h2 id="准备">准备</h2>

<p><strong>测试环境</strong></p>

<p>在以下几种环境下进行测试：</p>

<ul>
<li>Kubernetes集群node节点上通过Cluster IP方式访问</li>
<li>Kubernetes集群内部通过service访问</li>
<li>Kubernetes集群外部通过traefik ingress暴露的地址访问</li>
</ul>

<p><strong>测试地址</strong></p>

<p>Cluster IP: 10.254.149.31</p>

<p>Service Port：8000</p>

<p>Ingress Host：traefik.sample-webapp.io</p>

<p><strong>测试工具</strong></p>

<ul>
<li><a href="http://locust.io">Locust</a>：一个简单易用的用户负载测试工具，用来测试web或其他系统能够同时处理的并发用户数。</li>
<li>curl</li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/test/e2e">kubemark</a></li>
<li>测试程序：sample-webapp，源码见Github <a href="https://github.com/rootsongjc/distributed-load-testing-using-kubernetes">kubernetes的分布式负载测试</a></li>
</ul>

<p><strong>测试说明</strong></p>

<p>通过向<code>sample-webapp</code>发送curl请求获取响应时间，直接curl后的结果为：</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="">$ curl </span><span class="s2">&#34;http://10.254.149.31:8000/&#34;</span><span class="">
</span><span class="">Welcome to the </span><span class="s2">&#34;Distributed Load Testing Using Kubernetes&#34;</span><span class=""> sample web app</span></code></pre>
</div>
<h2 id="网络延迟测试">网络延迟测试</h2>

<h3 id="场景一-kubernetes集群node节点上通过cluster-ip访问">场景一、 Kubernetes集群node节点上通过Cluster IP访问</h3>

<p><strong>测试命令</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="">curl -o /dev/null -s -w </span><span class="s1">&#39;%{time_connect} %{time_starttransfer} %{time_total}&#39;</span><span class=""> </span><span class="s2">&#34;http://10.254.149.31:8000/&#34;</span></code></pre>
</div>
<p><strong>10组测试结果</strong></p>

<table>
<thead>
<tr>
<th>No</th>
<th>time_connect</th>
<th>time_starttransfer</th>
<th>time_total</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>0.000</td>
<td>0.003</td>
<td>0.003</td>
</tr>

<tr>
<td>2</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>3</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>4</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>5</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>6</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>7</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>8</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>9</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>

<tr>
<td>10</td>
<td>0.000</td>
<td>0.002</td>
<td>0.002</td>
</tr>
</tbody>
</table>

<p><strong>平均响应时间：2ms</strong></p>

<p><strong>时间指标说明</strong></p>

<p>单位：秒</p>

<p>time_connect：建立到服务器的 TCP 连接所用的时间</p>

<p>time_starttransfer：在发出请求之后，Web 服务器返回数据的第一个字节所用的时间</p>

<p>time_total：完成请求所用的时间</p>

<h3 id="场景二-kubernetes集群内部通过service访问">场景二、Kubernetes集群内部通过service访问</h3>

<p><strong>测试命令</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="">curl -o /dev/null -s -w &#39;%{time_connect} %{time_starttransfer} %{time_total}&#39; &#34;http://sample-webapp:8000/&#34;</span></code></pre>
</div>
<p><strong>10组测试结果</strong></p>

<table>
<thead>
<tr>
<th>No</th>
<th>time_connect</th>
<th>time_starttransfer</th>
<th>time_total</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>2</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>3</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>4</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>5</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>6</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>7</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>8</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>9</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>

<tr>
<td>10</td>
<td>0.004</td>
<td>0.006</td>
<td>0.006</td>
</tr>
</tbody>
</table>

<p><strong>平均响应时间：6ms</strong></p>

<h3 id="场景三-在公网上通过traefik-ingress访问">场景三、在公网上通过traefik ingress访问</h3>

<p><strong>测试命令</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="">curl -o /dev/null -s -w &#39;%{time_connect} %{time_starttransfer} %{time_total}&#39; &#34;http://traefik.sample-webapp.io&#34; &gt;&gt;result</span></code></pre>
</div>
<p><strong>10组测试结果</strong></p>

<table>
<thead>
<tr>
<th>No</th>
<th>time_connect</th>
<th>time_starttransfer</th>
<th>time_total</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>0.043</td>
<td>0.085</td>
<td>0.085</td>
</tr>

<tr>
<td>2</td>
<td>0.052</td>
<td>0.093</td>
<td>0.093</td>
</tr>

<tr>
<td>3</td>
<td>0.043</td>
<td>0.082</td>
<td>0.082</td>
</tr>

<tr>
<td>4</td>
<td>0.051</td>
<td>0.093</td>
<td>0.093</td>
</tr>

<tr>
<td>5</td>
<td>0.068</td>
<td>0.188</td>
<td>0.188</td>
</tr>

<tr>
<td>6</td>
<td>0.049</td>
<td>0.089</td>
<td>0.089</td>
</tr>

<tr>
<td>7</td>
<td>0.051</td>
<td>0.113</td>
<td>0.113</td>
</tr>

<tr>
<td>8</td>
<td>0.055</td>
<td>0.120</td>
<td>0.120</td>
</tr>

<tr>
<td>9</td>
<td>0.065</td>
<td>0.126</td>
<td>0.127</td>
</tr>

<tr>
<td>10</td>
<td>0.050</td>
<td>0.111</td>
<td>0.111</td>
</tr>
</tbody>
</table>

<p><strong>平均响应时间：110ms</strong></p>

<h3 id="测试结果">测试结果</h3>

<p>在这三种场景下的响应时间测试结果如下：</p>

<ul>
<li>Kubernetes集群node节点上通过Cluster IP方式访问：2ms</li>
<li>Kubernetes集群内部通过service访问：6ms</li>
<li>Kubernetes集群外部通过traefik ingress暴露的地址访问：110ms</li>
</ul>

<p><em>注意：执行测试的node节点/Pod与serivce所在的pod的距离（是否在同一台主机上），对前两个场景可以能会有一定影响。</em></p>

<h2 id="网络性能测试">网络性能测试</h2>

<p>网络使用flannel的vxlan模式。</p>

<p>使用iperf进行测试。</p>

<p>服务端命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="">iperf -s -p </span><span class="m">12345</span><span class=""> -i </span><span class="m">1</span><span class=""> -M</span></code></pre>
</div>
<p>客户端命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="">iperf -c </span><span class="si">${</span><span class="nv">server</span><span class="p">-ip</span><span class="si">}</span><span class=""> -p </span><span class="m">12345</span><span class=""> -i </span><span class="m">1</span><span class=""> -t </span><span class="m">10</span><span class=""> -w 20K</span></code></pre>
</div>
<h3 id="场景一-主机之间">场景一、主机之间</h3>

<pre><code>[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 1.0 sec   598 MBytes  5.02 Gbits/sec
[  3]  1.0- 2.0 sec   637 MBytes  5.35 Gbits/sec
[  3]  2.0- 3.0 sec   664 MBytes  5.57 Gbits/sec
[  3]  3.0- 4.0 sec   657 MBytes  5.51 Gbits/sec
[  3]  4.0- 5.0 sec   641 MBytes  5.38 Gbits/sec
[  3]  5.0- 6.0 sec   639 MBytes  5.36 Gbits/sec
[  3]  6.0- 7.0 sec   628 MBytes  5.26 Gbits/sec
[  3]  7.0- 8.0 sec   649 MBytes  5.44 Gbits/sec
[  3]  8.0- 9.0 sec   638 MBytes  5.35 Gbits/sec
[  3]  9.0-10.0 sec   652 MBytes  5.47 Gbits/sec
[  3]  0.0-10.0 sec  6.25 GBytes  5.37 Gbits/sec
</code></pre>

<h3 id="场景二-不同主机的pod之间-使用flannel的vxlan模式">场景二、不同主机的Pod之间(使用flannel的vxlan模式)</h3>

<pre><code>[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 1.0 sec   372 MBytes  3.12 Gbits/sec
[  3]  1.0- 2.0 sec   345 MBytes  2.89 Gbits/sec
[  3]  2.0- 3.0 sec   361 MBytes  3.03 Gbits/sec
[  3]  3.0- 4.0 sec   397 MBytes  3.33 Gbits/sec
[  3]  4.0- 5.0 sec   405 MBytes  3.40 Gbits/sec
[  3]  5.0- 6.0 sec   410 MBytes  3.44 Gbits/sec
[  3]  6.0- 7.0 sec   404 MBytes  3.39 Gbits/sec
[  3]  7.0- 8.0 sec   408 MBytes  3.42 Gbits/sec
[  3]  8.0- 9.0 sec   451 MBytes  3.78 Gbits/sec
[  3]  9.0-10.0 sec   387 MBytes  3.25 Gbits/sec
[  3]  0.0-10.0 sec  3.85 GBytes  3.30 Gbits/sec
</code></pre>

<h3 id="场景三-node与非同主机的pod之间-使用flannel的vxlan模式">场景三、Node与非同主机的Pod之间（使用flannel的vxlan模式）</h3>

<pre><code>[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 1.0 sec   372 MBytes  3.12 Gbits/sec
[  3]  1.0- 2.0 sec   420 MBytes  3.53 Gbits/sec
[  3]  2.0- 3.0 sec   434 MBytes  3.64 Gbits/sec
[  3]  3.0- 4.0 sec   409 MBytes  3.43 Gbits/sec
[  3]  4.0- 5.0 sec   382 MBytes  3.21 Gbits/sec
[  3]  5.0- 6.0 sec   408 MBytes  3.42 Gbits/sec
[  3]  6.0- 7.0 sec   403 MBytes  3.38 Gbits/sec
[  3]  7.0- 8.0 sec   423 MBytes  3.55 Gbits/sec
[  3]  8.0- 9.0 sec   376 MBytes  3.15 Gbits/sec
[  3]  9.0-10.0 sec   451 MBytes  3.78 Gbits/sec
[  3]  0.0-10.0 sec  3.98 GBytes  3.42 Gbits/sec
</code></pre>

<h3 id="场景四-不同主机的pod之间-使用flannel的host-gw模式">场景四、不同主机的Pod之间（使用flannel的host-gw模式）</h3>

<pre><code>[ ID] Interval       Transfer     Bandwidth
[  5]  0.0- 1.0 sec   530 MBytes  4.45 Gbits/sec
[  5]  1.0- 2.0 sec   576 MBytes  4.84 Gbits/sec
[  5]  2.0- 3.0 sec   631 MBytes  5.29 Gbits/sec
[  5]  3.0- 4.0 sec   580 MBytes  4.87 Gbits/sec
[  5]  4.0- 5.0 sec   627 MBytes  5.26 Gbits/sec
[  5]  5.0- 6.0 sec   578 MBytes  4.85 Gbits/sec
[  5]  6.0- 7.0 sec   584 MBytes  4.90 Gbits/sec
[  5]  7.0- 8.0 sec   571 MBytes  4.79 Gbits/sec
[  5]  8.0- 9.0 sec   564 MBytes  4.73 Gbits/sec
[  5]  9.0-10.0 sec   572 MBytes  4.80 Gbits/sec
[  5]  0.0-10.0 sec  5.68 GBytes  4.88 Gbits/sec
</code></pre>

<h3 id="场景五-node与非同主机的pod之间-使用flannel的host-gw模式">场景五、Node与非同主机的Pod之间（使用flannel的host-gw模式）</h3>

<pre><code>[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 1.0 sec   570 MBytes  4.78 Gbits/sec
[  3]  1.0- 2.0 sec   552 MBytes  4.63 Gbits/sec
[  3]  2.0- 3.0 sec   598 MBytes  5.02 Gbits/sec
[  3]  3.0- 4.0 sec   580 MBytes  4.87 Gbits/sec
[  3]  4.0- 5.0 sec   590 MBytes  4.95 Gbits/sec
[  3]  5.0- 6.0 sec   594 MBytes  4.98 Gbits/sec
[  3]  6.0- 7.0 sec   598 MBytes  5.02 Gbits/sec
[  3]  7.0- 8.0 sec   606 MBytes  5.08 Gbits/sec
[  3]  8.0- 9.0 sec   596 MBytes  5.00 Gbits/sec
[  3]  9.0-10.0 sec   604 MBytes  5.07 Gbits/sec
[  3]  0.0-10.0 sec  5.75 GBytes  4.94 Gbits/sec
</code></pre>

<h3 id="网络性能对比综述">网络性能对比综述</h3>

<p>使用Flannel的<strong>vxlan</strong>模式实现每个pod一个IP的方式，会比宿主机直接互联的网络性能损耗30%～40%，符合网上流传的测试结论。而flannel的host-gw模式比起宿主机互连的网络性能损耗大约是10%。</p>

<h2 id="kubernete的性能测试">Kubernete的性能测试</h2>

<p>参考<a href="https://supereagle.github.io/2017/03/09/kubemark/">Kubernetes集群性能测试</a>中的步骤，对kubernetes的性能进行测试。</p>

<p>我的集群版本是Kubernetes1.6.0，首先克隆代码，将kubernetes目录复制到<code>$GOPATH/src/k8s.io/</code>下然后执行：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ./hack/generate-bindata.sh
</span><span class="">/usr/local/src/k8s.io/kubernetes /usr/local/src/k8s.io/kubernetes
</span><span class="">Generated bindata file : test/e2e/generated/bindata.go has </span><span class="m">13498</span><span class=""> test/e2e/generated/bindata.go lines of lovely automated artifacts
</span><span class="">No changes in generated bindata file: pkg/generated/bindata.go
</span><span class="">/usr/local/src/k8s.io/kubernetes
</span><span class="">$ make </span><span class="nv">WHAT</span><span class=""></span><span class="o">=</span><span class="s2">&#34;test/e2e/e2e.test&#34;</span><span class="">
</span><span class="">...
</span><span class="">+++ </span><span class="o">[</span><span class="m">0425</span><span class=""> </span><span class="m">17</span><span class="">:01:34</span><span class="o">]</span><span class=""> Generating bindata:
</span><span class="">    test/e2e/generated/gobindata_util.go
</span><span class="">/usr/local/src/k8s.io/kubernetes /usr/local/src/k8s.io/kubernetes/test/e2e/generated
</span><span class="">/usr/local/src/k8s.io/kubernetes/test/e2e/generated
</span><span class="">+++ </span><span class="o">[</span><span class="m">0425</span><span class=""> </span><span class="m">17</span><span class="">:01:34</span><span class="o">]</span><span class=""> Building go targets </span><span class="k">for</span><span class=""> linux/amd64:
</span><span class="">    test/e2e/e2e.test
</span><span class="">$ make ginkgo
</span><span class="">+++ </span><span class="o">[</span><span class="m">0425</span><span class=""> </span><span class="m">17</span><span class="">:05:57</span><span class="o">]</span><span class=""> Building the toolchain targets:
</span><span class="">    k8s.io/kubernetes/hack/cmd/teststale
</span><span class="">    k8s.io/kubernetes/vendor/github.com/jteeuwen/go-bindata/go-bindata
</span><span class="">+++ </span><span class="o">[</span><span class="m">0425</span><span class=""> </span><span class="m">17</span><span class="">:05:57</span><span class="o">]</span><span class=""> Generating bindata:
</span><span class="">    test/e2e/generated/gobindata_util.go
</span><span class="">/usr/local/src/k8s.io/kubernetes /usr/local/src/k8s.io/kubernetes/test/e2e/generated
</span><span class="">/usr/local/src/k8s.io/kubernetes/test/e2e/generated
</span><span class="">+++ </span><span class="o">[</span><span class="m">0425</span><span class=""> </span><span class="m">17</span><span class="">:05:58</span><span class="o">]</span><span class=""> Building go targets </span><span class="k">for</span><span class=""> linux/amd64:
</span><span class="">    vendor/github.com/onsi/ginkgo/ginkgo
</span><span class="">
</span><span class="">$ </span><span class="nb">export</span><span class=""> </span><span class="nv">KUBERNETES_PROVIDER</span><span class=""></span><span class="o">=</span><span class="nb">local</span><span class="">
</span><span class="">$ </span><span class="nb">export</span><span class=""> </span><span class="nv">KUBECTL_PATH</span><span class=""></span><span class="o">=</span><span class="">/usr/bin/kubectl
</span><span class="">$ go run hack/e2e.go -v -test  --test_args</span><span class="o">=</span><span class="s2">&#34;--host=http://172.20.0.113:8080 --ginkgo.focus=\[Feature:Performance\]&#34;</span><span class=""> &gt;&gt;log.txt</span></code></pre>
</div>
<p><strong>测试结果</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">Apr </span><span class="m">25</span><span class=""> </span><span class="m">18</span><span class="">:27:31.461: INFO: API calls latencies: </span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;apicalls&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;resource&#34;</span><span class="">: </span><span class="s2">&#34;pods&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;verb&#34;</span><span class="">: </span><span class="s2">&#34;POST&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;latency&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;Perc50&#34;</span><span class="">: </span><span class="m">2148000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc90&#34;</span><span class="">: </span><span class="m">13772000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc99&#34;</span><span class="">: </span><span class="m">14436000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc100&#34;</span><span class="">: </span><span class="m">0</span><span class="">
</span><span class="">      </span><span class="o">}</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;resource&#34;</span><span class="">: </span><span class="s2">&#34;services&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;verb&#34;</span><span class="">: </span><span class="s2">&#34;DELETE&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;latency&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;Perc50&#34;</span><span class="">: </span><span class="m">9843000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc90&#34;</span><span class="">: </span><span class="m">11226000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc99&#34;</span><span class="">: </span><span class="m">12391000</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Perc100&#34;</span><span class="">: </span><span class="m">0</span><span class="">
</span><span class="">      </span><span class="o">}</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">    ...
</span><span class="">Apr </span><span class="m">25</span><span class=""> </span><span class="m">18</span><span class="">:27:31.461: INFO: </span><span class="o">[</span><span class="">Result:Performance</span><span class="o">]</span><span class=""> </span><span class="o">{</span><span class="">
</span><span class="">  </span><span class="s2">&#34;version&#34;</span><span class="">: </span><span class="s2">&#34;v1&#34;</span><span class="">,
</span><span class="">  </span><span class="s2">&#34;dataItems&#34;</span><span class="">: </span><span class="o">[</span><span class="">
</span><span class="">    </span><span class="o">{</span><span class="">
</span><span class="">      </span><span class="s2">&#34;data&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;Perc50&#34;</span><span class="">: </span><span class="m">2</span><span class="">.148,
</span><span class="">        </span><span class="s2">&#34;Perc90&#34;</span><span class="">: </span><span class="m">13</span><span class="">.772,
</span><span class="">        </span><span class="s2">&#34;Perc99&#34;</span><span class="">: </span><span class="m">14</span><span class="">.436
</span><span class="">      </span><span class="o">}</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;unit&#34;</span><span class="">: </span><span class="s2">&#34;ms&#34;</span><span class="">,
</span><span class="">      </span><span class="s2">&#34;labels&#34;</span><span class="">: </span><span class="o">{</span><span class="">
</span><span class="">        </span><span class="s2">&#34;Resource&#34;</span><span class="">: </span><span class="s2">&#34;pods&#34;</span><span class="">,
</span><span class="">        </span><span class="s2">&#34;Verb&#34;</span><span class="">: </span><span class="s2">&#34;POST&#34;</span><span class="">
</span><span class="">      </span><span class="o">}</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">,
</span><span class="">...
</span><span class=""></span><span class="m">2</span><span class="">.857: INFO: Running AfterSuite actions on all node
</span><span class="">Apr </span><span class="m">26</span><span class=""> </span><span class="m">10</span><span class="">:35:32.857: INFO: Running AfterSuite actions on node </span><span class="m">1</span><span class="">
</span><span class="">
</span><span class="">Ran </span><span class="m">2</span><span class=""> of </span><span class="m">606</span><span class=""> Specs in </span><span class="m">268</span><span class="">.371 seconds
</span><span class="">SUCCESS! -- </span><span class="m">2</span><span class=""> Passed </span><span class="p">|</span><span class=""> </span><span class="m">0</span><span class=""> Failed </span><span class="p">|</span><span class=""> </span><span class="m">0</span><span class=""> Pending </span><span class="p">|</span><span class=""> </span><span class="m">604</span><span class=""> Skipped PASS
</span><span class="">
</span><span class="">Ginkgo ran </span><span class="m">1</span><span class=""> suite in 4m28.667870101s
</span><span class="">Test Suite Passed</span></code></pre>
</div>
<p>从kubemark输出的日志中可以看到<strong>API calls latencies</strong>和<strong>Performance</strong>。</p>

<p><strong>日志里显示，创建90个pod用时40秒以内，平均创建每个pod耗时0.44秒。</strong></p>

<h3 id="不同type的资源类型api请求耗时分布">不同type的资源类型API请求耗时分布</h3>

<table>
<thead>
<tr>
<th>Resource</th>
<th>Verb</th>
<th>50%</th>
<th>90%</th>
<th>99%</th>
</tr>
</thead>

<tbody>
<tr>
<td>services</td>
<td>DELETE</td>
<td>8.472ms</td>
<td>9.841ms</td>
<td>38.226ms</td>
</tr>

<tr>
<td>endpoints</td>
<td>PUT</td>
<td>1.641ms</td>
<td>3.161ms</td>
<td>30.715ms</td>
</tr>

<tr>
<td>endpoints</td>
<td>GET</td>
<td>931µs</td>
<td>10.412ms</td>
<td>27.97ms</td>
</tr>

<tr>
<td>nodes</td>
<td>PATCH</td>
<td>4.245ms</td>
<td>11.117ms</td>
<td>18.63ms</td>
</tr>

<tr>
<td>pods</td>
<td>PUT</td>
<td>2.193ms</td>
<td>2.619ms</td>
<td>17.285ms</td>
</tr>
</tbody>
</table>

<p>从<code>log.txt</code>日志中还可以看到更多详细请求的测试指标。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubenetes-e2e-test.jpg" alt="kubernetes-dashboard" /></p>

<h3 id="注意事项">注意事项</h3>

<p>测试过程中需要用到docker镜像存储在GCE中，需要翻墙下载，我没看到哪里配置这个镜像的地址。该镜像副本已上传时速云：</p>

<p>用到的镜像有如下两个：</p>

<ul>
<li>gcr.io/google_containers/pause-amd64:3.0</li>
<li>gcr.io/google_containers/serve_hostname:v1.4</li>
</ul>

<p>时速云镜像地址：</p>

<ul>
<li>index.tenxcloud.com/jimmy/pause-amd64:3.0</li>
<li>index.tenxcloud.com/jimmy/serve_hostname:v1.4</li>
</ul>

<p>将镜像pull到本地后重新打tag。</p>

<h2 id="locust测试">Locust测试</h2>

<p>请求统计</p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Name</th>
<th># requests</th>
<th># failures</th>
<th>Median response time</th>
<th>Average response time</th>
<th>Min response time</th>
<th>Max response time</th>
<th>Average Content Size</th>
<th>Requests/s</th>
</tr>
</thead>

<tbody>
<tr>
<td>POST</td>
<td>/login</td>
<td>5070</td>
<td>78</td>
<td>59000</td>
<td>80551</td>
<td>11218</td>
<td>202140</td>
<td>54</td>
<td>1.17</td>
</tr>

<tr>
<td>POST</td>
<td>/metrics</td>
<td>5114232</td>
<td>85879</td>
<td>63000</td>
<td>82280</td>
<td>29518</td>
<td>331330</td>
<td>94</td>
<td>1178.77</td>
</tr>

<tr>
<td>None</td>
<td>Total</td>
<td>5119302</td>
<td>85957</td>
<td>63000</td>
<td>82279</td>
<td>11218</td>
<td>331330</td>
<td>94</td>
<td>1179.94</td>
</tr>
</tbody>
</table>

<p>响应时间分布</p>

<table>
<thead>
<tr>
<th>Name</th>
<th># requests</th>
<th>50%</th>
<th>66%</th>
<th>75%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>98%</th>
<th>99%</th>
<th>100%</th>
</tr>
</thead>

<tbody>
<tr>
<td>POST /login</td>
<td>5070</td>
<td>59000</td>
<td>125000</td>
<td>140000</td>
<td>148000</td>
<td>160000</td>
<td>166000</td>
<td>174000</td>
<td>176000</td>
<td>202140</td>
</tr>

<tr>
<td>POST /metrics</td>
<td>5114993</td>
<td>63000</td>
<td>127000</td>
<td>142000</td>
<td>149000</td>
<td>160000</td>
<td>166000</td>
<td>172000</td>
<td>176000</td>
<td>331330</td>
</tr>

<tr>
<td>None Total</td>
<td>5120063</td>
<td>63000</td>
<td>127000</td>
<td>142000</td>
<td>149000</td>
<td>160000</td>
<td>166000</td>
<td>172000</td>
<td>176000</td>
<td>331330</td>
</tr>
</tbody>
</table>

<p>以上两个表格都是瞬时值。请求失败率在2%左右。</p>

<p>Sample-webapp起了48个pod。</p>

<p>Locust模拟10万用户，每秒增长100个。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-locust-test.jpg" alt="locust-test" /></p>

<h2 id="参考">参考</h2>

<p><a href="https://testerhome.com/topics/4839">基于 Python 的性能测试工具 locust (与 LR 的简单对比)</a></p>

<p><a href="http://docs.locust.io/en/latest/what-is-locust.html">Locust docs</a></p>

<p><a href="http://timd.cn/2015/09/17/locust/">python用户负载测试工具：locust</a></p>

<p><a href="https://supereagle.github.io/2017/03/09/kubemark/">Kubernetes集群性能测试</a></p>

<p><a href="http://dockone.io/article/1050">CoreOS是如何将Kubernetes的性能提高10倍的</a></p>

<p><a href="http://blog.fleeto.us/translation/updates-performance-and-scalability-kubernetes-13-2000-node-60000-pod-clusters">Kubernetes 1.3 的性能和弹性 —— 2000 节点，60,0000 Pod 的集群</a></p>

<p><a href="http://www.csdn.net/article/2015-07-07/2825155">运用Kubernetes进行分布式负载测试</a></p>

<p><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/kubemark-guide.md">Kubemark User Guide</a></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试</a></li>
                
                <li><a href="/blogs/ip-and-service-discovry-in-kubernetes/">Kubernetes中的IP和服务发现体系</a></li>
                
                <li><a href="/blogs/kubernetes-rbac-support/">Kubernetes中的RBAC支持</a></li>
                
                <li><a href="/blogs/traefik-ingress-installation/">Kubernetes traefik ingress安装试用</a></li>
                
                <li><a href="/blogs/kubernetes-ingress-resource/">Kubernetes ingress解析</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Apr 25, 2017 </h4>
        <h5 id="wc"> 2800 Words </h5>
        <h5 id="readtime"> Read in about 6 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-with-glusterfs/"><i class="icon-arrow-left"></i> 在kubernetes中使用glusterfs做持久化存储</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2749">
<meta itemprop="datePublished" content="2017-04-25">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-performance-test/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
