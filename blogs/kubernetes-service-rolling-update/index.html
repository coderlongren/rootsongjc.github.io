<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes中的Rolling Update服务滚动升级 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-service-rolling-update/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-10"/>
<meta property="article:modified_time" content="2017-05-10"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes中的Rolling Update服务滚动升级 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes中的Rolling Update服务滚动升级 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-service-rolling-update/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e4%b8%ad%e7%9a%84Rolling%20Update%e6%9c%8d%e5%8a%a1%e6%bb%9a%e5%8a%a8%e5%8d%87%e7%ba%a7-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f&title=Kubernetes%e4%b8%ad%e7%9a%84Rolling%20Update%e6%9c%8d%e5%8a%a1%e6%bb%9a%e5%8a%a8%e5%8d%87%e7%ba%a7&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes中的Rolling Update服务滚动升级</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170430014.jpg" alt="后海夜色" /></p>

<p><em>（题图：后海夜色 Apr 30,2017）</em></p>

<h2 id="前言">前言</h2>

<p>本文已同步到gitbook <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的第8章第1节。</p>

<p>本文说明在Kubernetes1.6中服务如何滚动升级，并对其进行测试。</p>

<p>当有镜像发布新版本，新版本服务上线时如何实现服务的滚动和平滑升级？</p>

<p>如果你使用<strong>ReplicationController</strong>创建的pod可以使用<code>kubectl rollingupdate</code>命令滚动升级，如果使用的是<strong>Deployment</strong>创建的Pod可以直接修改yaml文件后执行<code>kubectl apply</code>即可。</p>

<p>Deployment已经内置了RollingUpdate strategy，因此不用再调用<code>kubectl rollingupdate</code>命令，升级的过程是先创建新版的pod将流量导入到新pod上后销毁原来的旧的pod。</p>

<p>Rolling Update适用于<code>Deployment</code>、<code>Replication Controller</code>，官方推荐使用Deployment而不再使用Replication Controller。</p>

<p>使用ReplicationController时的滚动升级请参考官网说明：<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</a></p>

<h2 id="replicationcontroller与deployment的关系">ReplicationController与Deployment的关系</h2>

<p>ReplicationController和Deployment的RollingUpdate命令有些不同，但是实现的机制是一样的，关于这两个kind的关系我引用了<a href="https://segmentfault.com/a/1190000008232770">ReplicationController与Deployment的区别</a>中的部分内容如下，详细区别请查看原文。</p>

<h3 id="replicationcontroller">ReplicationController</h3>

<p>Replication Controller为Kubernetes的一个核心内容，应用托管到Kubernetes之后，需要保证应用能够持续的运行，Replication Controller就是这个保证的key，主要的功能如下：</p>

<ul>
<li>确保pod数量：它会确保Kubernetes中有指定数量的Pod在运行。如果少于指定数量的pod，Replication Controller会创建新的，反之则会删除掉多余的以保证Pod数量不变。</li>
<li>确保pod健康：当pod不健康，运行出错或者无法提供服务时，Replication Controller也会杀死不健康的pod，重新创建新的。</li>
<li>弹性伸缩 ：在业务高峰或者低峰期的时候，可以通过Replication Controller动态的调整pod的数量来提高资源的利用率。同时，配置相应的监控功能（Hroizontal Pod Autoscaler），会定时自动从监控平台获取Replication Controller关联pod的整体资源使用情况，做到自动伸缩。</li>
<li>滚动升级：滚动升级为一种平滑的升级方式，通过逐步替换的策略，保证整体系统的稳定，在初始化升级的时候就可以及时发现和解决问题，避免问题不断扩大。</li>
</ul>

<h3 id="deployment">Deployment</h3>

<p>Deployment同样为Kubernetes的一个核心内容，主要职责同样是为了保证pod的数量和健康，90%的功能与Replication Controller完全一样，可以看做新一代的Replication Controller。但是，它又具备了Replication Controller之外的新特性：</p>

<ul>
<li>Replication Controller全部功能：Deployment继承了上面描述的Replication Controller全部功能。</li>
<li>事件和状态查看：可以查看Deployment的升级详细进度和状态。</li>
<li>回滚：当升级pod镜像或者相关参数的时候发现问题，可以使用回滚操作回滚到上一个稳定的版本或者指定的版本。</li>
<li>版本记录: 每一次对Deployment的操作，都能保存下来，给予后续可能的回滚使用。</li>
<li>暂停和启动：对于每一次升级，都能够随时暂停和启动。</li>
<li>多种升级方案：Recreate：删除所有已存在的pod,重新创建新的; RollingUpdate：滚动升级，逐步替换的策略，同时滚动升级时，支持更多的附加参数，例如设置最大不可用pod数量，最小升级间隔时间等等。</li>
</ul>

<h2 id="创建测试镜像">创建测试镜像</h2>

<p>我们来创建一个特别简单的web服务，当你访问网页时，将输出一句版本信息。通过区分这句版本信息输出我们就可以断定升级是否完成。</p>

<p>所有配置和代码见Github上的<a href="https://github.com/rootsongjc/kubernetes-handbook/tree/master/manifests/test/rolling-update-test">manifests/test/rolling-update-test</a>目录。</p>

<p><strong>Web服务的代码main.go</strong></p>

<pre><code class="language-Go">package main

import (
	&quot;fmt&quot;
	&quot;log&quot;
	&quot;net/http&quot;
)

func sayhello(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, &quot;This is version 1.&quot;) //这个写入到w的是输出到客户端的
}

func main() {
	http.HandleFunc(&quot;/&quot;, sayhello) //设置访问的路由
	log.Println(&quot;This is version 1.&quot;)
	err := http.ListenAndServe(&quot;:9090&quot;, nil) //设置监听的端口
	if err != nil {
		log.Fatal(&quot;ListenAndServe: &quot;, err)
	}
}
</code></pre>

<p><strong>创建Dockerfile</strong></p>

<pre><code class="language-Dockerfile">FROM alpine:3.5
MAINTAINER Jimmy Song&lt;rootsongjc@gmail.com&gt;
ADD hellov2 /
ENTRYPOINT [&quot;/hellov2&quot;]
</code></pre>

<p>注意修改添加的文件的名称。</p>

<p><strong>创建Makefile</strong></p>

<p>修改镜像仓库的地址为你自己的私有镜像仓库地址。</p>

<p>修改<code>Makefile</code>中的<code>TAG</code>为新的版本号。</p>

<pre><code class="language-cmake">all: build push clean
.PHONY: build push clean

TAG = v1

# Build for linux amd64
build:
	GOOS=linux GOARCH=amd64 go build -o hello${TAG} main.go
	docker build -t sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG} .

# Push to tenxcloud
push:
	docker push sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG}

# Clean 
clean:
	rm -f hello${TAG}
</code></pre>

<p><strong>编译</strong></p>

<pre><code class="language-Shell">make all
</code></pre>

<p>分别修改main.go中的输出语句、Dockerfile中的文件名称和Makefile中的TAG，创建两个版本的镜像。</p>

<h2 id="测试">测试</h2>

<p>我们使用Deployment部署服务来测试。</p>

<p>配置文件<code>rolling-update-test.yaml</code>：</p>

<pre><code class="language-Yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
    name: rolling-update-test
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: rolling-update-test
    spec:
      containers:
      - name: rolling-update-test
        image: sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:v1
        ports:
        - containerPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: rolling-update-test
  labels:
    app: rolling-update-test
spec:
  ports:
  - port: 9090
    protocol: TCP
    name: http
  selector:
    app: rolling-update-test
</code></pre>

<p><strong>部署service</strong></p>

<pre><code class="language-shell">kubectl create -f rolling-update-test.yaml
</code></pre>

<p><strong>修改traefik ingress配置</strong></p>

<p>在<code>ingress.yaml</code>文件中增加新service的配置。</p>

<pre><code class="language-Yaml">  - host: rolling-update-test.traefik.io
    http:
      paths:
      - path: /
        backend:
          serviceName: rolling-update-test
          servicePort: 9090
</code></pre>

<p>修改本地的host配置，增加一条配置：</p>

<pre><code>172.20.0.119 rolling-update-test.traefik.io
</code></pre>

<p>注意：172.20.0.119是我们之前使用keepalived创建的VIP。</p>

<p>打开浏览器访问<a href="http://rolling-update-test.traefik.io将会看到以下输出：">http://rolling-update-test.traefik.io将会看到以下输出：</a></p>

<pre><code>This is version 1.
</code></pre>

<p><strong>滚动升级</strong></p>

<p>只需要将<code>rolling-update-test.yaml</code>文件中的<code>image</code>改成新版本的镜像名，然后执行：</p>

<pre><code class="language-shell">kubectl apply -f rolling-update-test.yaml
</code></pre>

<p>也可以参考<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Concept</a>中的方法，直接设置新的镜像。</p>

<pre><code>kubectl set image deployment/rolling-update-test rolling-update-test=sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:v2
</code></pre>

<p>或者使用<code>kubectl edit deployment/rolling-update-test</code>修改镜像名称后保存。</p>

<p>使用以下命令查看升级进度：</p>

<pre><code>kubectl rollout status deployment/rolling-update-test
</code></pre>

<p>升级完成后在浏览器中刷新<a href="http://rolling-update-test.traefik.io将会看到以下输出：">http://rolling-update-test.traefik.io将会看到以下输出：</a></p>

<pre><code>This is version 2.
</code></pre>

<p>说明滚动升级成功。</p>

<h2 id="使用replicationcontroller创建的pod如何rollingupdate">使用ReplicationController创建的Pod如何RollingUpdate</h2>

<p>以上讲解使用<strong>Deployment</strong>创建的Pod的RollingUpdate方式，那么如果使用传统的<strong>ReplicationController</strong>创建的Pod如何Update呢？</p>

<p>举个例子：</p>

<pre><code class="language-bash">$ kubectl -n spark-cluster rolling-update zeppelin-controller --image sz-pg-oam-docker-hub-001.tendcloud.com/library/zeppelin:0.7.1
Created zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b
Scaling up zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b from 0 to 1, scaling down zeppelin-controller from 1 to 0 (keep 1 pods available, don't exceed 2 pods)
Scaling zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b up to 1
Scaling zeppelin-controller down to 0
Update succeeded. Deleting old controller: zeppelin-controller
Renaming zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b to zeppelin-controller
replicationcontroller &quot;zeppelin-controller&quot; rolling updated
</code></pre>

<p>只需要指定新的镜像即可，当然你可以配置RollingUpdate的策略。</p>

<h2 id="参考">参考</h2>

<p><a href="http://dockone.io/article/328">Rolling update机制解析</a></p>

<p><a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">Running a Stateless Application Using a Deployment</a></p>

<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/simple-rolling-update.md">Simple Rolling Update</a></p>

<p><a href="https://segmentfault.com/a/1190000008232770">使用kubernetes的deployment进行RollingUpdate</a></p>

<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Concept</a></p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-edge-node-configuration/">Kubernetes的边缘节点配置</a></li>
                
                <li><a href="/blogs/kubernetes-with-glusterfs/">在kubernetes中使用glusterfs做持久化存储</a></li>
                
                <li><a href="/blogs/kubernetes-performance-test/">Kubernetes网络和集群性能测试</a></li>
                
                <li><a href="/blogs/distributed-load-testing-using-kubernetes/">运用kubernetes进行分布式负载测试</a></li>
                
                <li><a href="/blogs/ip-and-service-discovry-in-kubernetes/">Kubernetes中的IP和服务发现体系</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed May 10, 2017 </h4>
        <h5 id="wc"> 3000 Words </h5>
        <h5 id="readtime"> Read in about 6 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-concept-deployment/"><i class="icon-arrow-left"></i> Kubernete概念解析之Deployment</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-edge-node-configuration/">Kubernetes的边缘节点配置 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="2905">
<meta itemprop="datePublished" content="2017-05-10">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-service-rolling-update/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>
</body>

</html>