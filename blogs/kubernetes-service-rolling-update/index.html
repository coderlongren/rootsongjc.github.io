<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes中的Rolling Update服务滚动升级 : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-service-rolling-update/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-10"/>
<meta property="article:modified_time" content="2017-05-10"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes中的Rolling Update服务滚动升级 : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> Kubernetes中的Rolling Update服务滚动升级 - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-service-rolling-update/">

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e4%b8%ad%e7%9a%84Rolling%20Update%e6%9c%8d%e5%8a%a1%e6%bb%9a%e5%8a%a8%e5%8d%87%e7%ba%a7-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f&title=Kubernetes%e4%b8%ad%e7%9a%84Rolling%20Update%e6%9c%8d%e5%8a%a1%e6%bb%9a%e5%8a%a8%e5%8d%87%e7%ba%a7&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-service-rolling-update%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Kubernetes中的Rolling Update服务滚动升级</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170430014.jpg" alt="后海夜色" /></p>

<p><em>（题图：后海夜色 Apr 30,2017）</em></p>

<h2 id="前言">前言</h2>

<p>本文已同步到gitbook <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的第8章第1节。</p>

<p>本文说明在Kubernetes1.6中服务如何滚动升级，并对其进行测试。</p>

<p>当有镜像发布新版本，新版本服务上线时如何实现服务的滚动和平滑升级？</p>

<p>如果你使用<strong>ReplicationController</strong>创建的pod可以使用<code>kubectl rollingupdate</code>命令滚动升级，如果使用的是<strong>Deployment</strong>创建的Pod可以直接修改yaml文件后执行<code>kubectl apply</code>即可。</p>

<p>Deployment已经内置了RollingUpdate strategy，因此不用再调用<code>kubectl rollingupdate</code>命令，升级的过程是先创建新版的pod将流量导入到新pod上后销毁原来的旧的pod。</p>

<p>Rolling Update适用于<code>Deployment</code>、<code>Replication Controller</code>，官方推荐使用Deployment而不再使用Replication Controller。</p>

<p>使用ReplicationController时的滚动升级请参考官网说明：<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</a></p>

<h2 id="创建测试镜像">创建测试镜像</h2>

<p>我们来创建一个特别简单的web服务，当你访问网页时，将输出一句版本信息。通过区分这句版本信息输出我们就可以断定升级是否完成。</p>

<p>所有配置和代码见Github上的<a href="https://github.com/rootsongjc/kubernetes-handbook/tree/master/manifests/test/rolling-update-test">manifests/test/rolling-update-test</a>目录。</p>

<p><strong>Web服务的代码main.go</strong></p>

<pre><code class="language-Go">package main

import (
	&quot;fmt&quot;
	&quot;log&quot;
	&quot;net/http&quot;
)

func sayhello(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, &quot;This is version 1.&quot;) //这个写入到w的是输出到客户端的
}

func main() {
	http.HandleFunc(&quot;/&quot;, sayhello) //设置访问的路由
	log.Println(&quot;This is version 1.&quot;)
	err := http.ListenAndServe(&quot;:9090&quot;, nil) //设置监听的端口
	if err != nil {
		log.Fatal(&quot;ListenAndServe: &quot;, err)
	}
}
</code></pre>

<p><strong>创建Dockerfile</strong></p>

<pre><code class="language-Dockerfile">FROM alpine:3.5
MAINTAINER Jimmy Song&lt;rootsongjc@gmail.com&gt;
ADD hellov2 /
ENTRYPOINT [&quot;/hellov2&quot;]
</code></pre>

<p>注意修改添加的文件的名称。</p>

<p><strong>创建Makefile</strong></p>

<p>修改镜像仓库的地址为你自己的私有镜像仓库地址。</p>

<p>修改<code>Makefile</code>中的<code>TAG</code>为新的版本号。</p>

<pre><code class="language-cmake">all: build push clean
.PHONY: build push clean

TAG = v1

# Build for linux amd64
build:
	GOOS=linux GOARCH=amd64 go build -o hello${TAG} main.go
	docker build -t sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG} .

# Push to tenxcloud
push:
	docker push sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG}

# Clean 
clean:
	rm -f hello${TAG}
</code></pre>

<p><strong>编译</strong></p>

<pre><code class="language-Shell">make all
</code></pre>

<p>分别修改main.go中的输出语句、Dockerfile中的文件名称和Makefile中的TAG，创建两个版本的镜像。</p>

<h2 id="测试">测试</h2>

<p>我们使用Deployment部署服务来测试。</p>

<p>配置文件<code>rolling-update-test.yaml</code>：</p>

<pre><code class="language-Yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
    name: rolling-update-test
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: rolling-update-test
    spec:
      containers:
      - name: rolling-update-test
        image: sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:v1
        ports:
        - containerPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: rolling-update-test
  labels:
    app: rolling-update-test
spec:
  ports:
  - port: 9090
    protocol: TCP
    name: http
  selector:
    app: rolling-update-test
</code></pre>

<p><strong>部署service</strong></p>

<pre><code class="language-shell">kubectl create -f rolling-update-test.yaml
</code></pre>

<p><strong>修改traefik ingress配置</strong></p>

<p>在<code>ingress.yaml</code>文件中增加新service的配置。</p>

<pre><code class="language-Yaml">  - host: rolling-update-test.traefik.io
    http:
      paths:
      - path: /
        backend:
          serviceName: rolling-update-test
          servicePort: 9090
</code></pre>

<p>修改本地的host配置，增加一条配置：</p>

<pre><code>172.20.0.119 rolling-update-test.traefik.io
</code></pre>

<p>注意：172.20.0.119是我们之前使用keepalived创建的VIP。</p>

<p>打开浏览器访问<a href="http://rolling-update-test.traefik.io将会看到以下输出：">http://rolling-update-test.traefik.io将会看到以下输出：</a></p>

<pre><code>This is version 1.
</code></pre>

<p><strong>滚动升级</strong></p>

<p>只需要将<code>rolling-update-test.yaml</code>文件中的<code>image</code>改成新版本的镜像名，然后执行：</p>

<pre><code class="language-shell">kubectl apply -f rolling-update-test.yaml
</code></pre>

<p>在浏览器中刷新<a href="http://rolling-update-test.traefik.io将会看到以下输出：">http://rolling-update-test.traefik.io将会看到以下输出：</a></p>

<pre><code>This is version 2.
</code></pre>

<p>说明滚动升级成功。</p>

<h2 id="参考">参考</h2>

<p><a href="http://dockone.io/article/328">Rolling update机制解析</a></p>

<p><a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">Running a Stateless Application Using a Deployment</a></p>

<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/simple-rolling-update.md">Simple Rolling Update</a></p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed May 10, 2017 </h4>
          <h5 id="wc"> 300 Words </h5>
          <h5 id="readtime"> Read in about 2 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/kubernetes-edge-node-configuration/">Kubernetes的边缘节点配置 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="238">
<meta itemprop="datePublished" content="2017-05-10">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-service-rolling-update/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

