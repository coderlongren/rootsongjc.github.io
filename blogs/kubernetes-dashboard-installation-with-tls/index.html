<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="在开启TLS的Kubernetes1.6集群上安装dashboard : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation-with-tls/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-12"/>
<meta property="article:modified_time" content="2017-04-12"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="在开启TLS的Kubernetes1.6集群上安装dashboard : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> 在开启TLS的Kubernetes1.6集群上安装dashboard - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation-with-tls/">

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85dashboard-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f&title=%e5%9c%a8%e5%bc%80%e5%90%afTLS%e7%9a%84Kubernetes1.6%e9%9b%86%e7%be%a4%e4%b8%8a%e5%ae%89%e8%a3%85dashboard&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-dashboard-installation-with-tls%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">在开启TLS的Kubernetes1.6集群上安装dashboard</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016082001.jpg" alt="东直门" /></p>

<p><em>（题图：东直门桥 Aug 20,2016）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目(fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>)中的一篇文章，下文是结合我<a href="http://rootsongjc.github.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，在开启了TLS验证的集群中部署dashboard。</p>

<p>感谢<a href="github.com/opsnull">opsnull</a>和<a href="github.com/ipchy">ipchy</a>的细心解答。</p>

<p><strong>安装环境配置信息</strong></p>

<ul>
<li>CentOS 7.2.1511</li>
<li>Docker 1.12.5</li>
<li>Flannel 0.7</li>
<li>Kubernetes 1.6.0</li>
</ul>

<h2 id="配置和安装-dashboard">配置和安装 dashboard</h2>

<p>官方文件目录：<code>kubernetes/cluster/addons/dashboard</code></p>

<p>我们使用的文件</p>

<pre><code class="language-bash">$ ls *.yaml
dashboard-controller.yaml  dashboard-service.yaml dashboard-rbac.yaml
</code></pre>

<p>已经修改好的 yaml 文件见：<a href="./manifests/dashboard">dashboard</a></p>

<p>由于 <code>kube-apiserver</code> 启用了 <code>RBAC</code> 授权，而官方源码目录的 <code>dashboard-controller.yaml</code> 没有定义授权的 ServiceAccount，所以后续访问 <code>kube-apiserver</code> 的 API 时会被拒绝，web中提示：</p>

<pre><code>Forbidden (403)

User &quot;system:serviceaccount:kube-system:default&quot; cannot list jobs.batch in the namespace &quot;default&quot;. (get jobs.batch)
</code></pre>

<p>增加了一个<code>dashboard-rbac.yaml</code>文件，定义一个名为 dashboard 的 ServiceAccount，然后将它和 Cluster Role view 绑定。</p>

<h2 id="配置dashboard-service">配置dashboard-service</h2>

<pre><code class="language-bash">$ diff dashboard-service.yaml.orig dashboard-service.yaml
10a11
&gt;   type: NodePort
</code></pre>

<ul>
<li>指定端口类型为 NodePort，这样外界可以通过地址 nodeIP:nodePort 访问 dashboard；</li>
</ul>

<h2 id="配置dashboard-controller">配置dashboard-controller</h2>

<pre><code class="language-bash">$ diff dashboard-controller.yaml.orig dashboard-controller.yaml
23c23
&lt;         image: gcr.io/google_containers/kubernetes-dashboard-amd64:v1.6.0
---
&gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/kubernetes-dashboard-amd64:v1.6.0
</code></pre>

<h2 id="执行所有定义文件">执行所有定义文件</h2>

<pre><code class="language-bash">$ pwd
/root/kubernetes/cluster/addons/dashboard
$ ls *.yaml
dashboard-controller.yaml  dashboard-service.yaml
$ kubectl create -f  .
service &quot;kubernetes-dashboard&quot; created
deployment &quot;kubernetes-dashboard&quot; created
</code></pre>

<h2 id="检查执行结果">检查执行结果</h2>

<p>查看分配的 NodePort</p>

<pre><code class="language-bash">$ kubectl get services kubernetes-dashboard -n kube-system
NAME                   CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
kubernetes-dashboard   10.254.224.130   &lt;nodes&gt;       80:30312/TCP   25s
</code></pre>

<ul>
<li>NodePort 30312映射到 dashboard pod 80端口；</li>
</ul>

<p>检查 controller</p>

<pre><code class="language-bash">$ kubectl get deployment kubernetes-dashboard  -n kube-system
NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubernetes-dashboard   1         1         1            1           3m
$ kubectl get pods  -n kube-system | grep dashboard
kubernetes-dashboard-1339745653-pmn6z   1/1       Running   0          4m
</code></pre>

<h2 id="访问dashboard">访问dashboard</h2>

<p>有以下三种方式：</p>

<ul>
<li>kubernetes-dashboard 服务暴露了 NodePort，可以使用 <code>http://NodeIP:nodePort</code> 地址访问 dashboard；</li>
<li>通过 kube-apiserver 访问 dashboard（https 6443端口和http 8080端口方式）；</li>
<li>通过 kubectl proxy 访问 dashboard：</li>
</ul>

<h3 id="通过-kubectl-proxy-访问-dashboard">通过 kubectl proxy 访问 dashboard</h3>

<p>启动代理</p>

<pre><code class="language-bash">$ kubectl proxy --address='172.20.0.113' --port=8086 --accept-hosts='^*$'
Starting to serve on 172.20.0.113:8086
</code></pre>

<ul>
<li>需要指定 <code>--accept-hosts</code> 选项，否则浏览器访问 dashboard 页面时提示 “Unauthorized”；</li>
</ul>

<p>浏览器访问 URL：<code>http://172.20.0.113:8086/ui</code>
自动跳转到：<code>http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/workload?namespace=default</code></p>

<h3 id="通过-kube-apiserver-访问dashboard">通过 kube-apiserver 访问dashboard</h3>

<p>获取集群服务地址列表</p>

<pre><code class="language-bash">$ kubectl cluster-info
Kubernetes master is running at https://172.20.0.113:6443
KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
</code></pre>

<p>浏览器访问 URL：<code>https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard</code>（浏览器会提示证书验证，因为通过加密通道，以改方式访问的话，需要提前导入证书到你的计算机中）。这是我当时在这遇到的坑：<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/5">通过 kube-apiserver 访问dashboard，提示User &ldquo;system:anonymous&rdquo; cannot proxy services in the namespace &ldquo;kube-system&rdquo;. #5</a>，已经解决。</p>

<p><strong>导入证书</strong></p>

<p>将生成的admin.pem证书转换格式</p>

<pre><code>openssl pkcs12 -export -in admin.pem  -out admin.p12 -inkey admin-key.pem
</code></pre>

<p>将生成的<code>admin.p12</code>证书导入的你的电脑，导出的时候记住你设置的密码，导入的时候还要用到。</p>

<p>如果你不想使用<strong>https</strong>的话，可以直接访问insecure port 8080端口:<code>http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard</code></p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-dashboard-raw.jpg" alt="kubernetes-dashboard" /></p>

<p>由于缺少 Heapster 插件，当前 dashboard 不能展示 Pod、Nodes 的 CPU、内存等 metric 图形。</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Wed Apr 12, 2017 </h4>
          <h5 id="wc"> 300 Words </h5>
          <h5 id="readtime"> Read in about 2 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/kubernetes-heapster-installation-with-tls/"><i class="icon-arrow-left"></i> 在开启TLS的Kubernetes1.6集群上安装heapster</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/kubernetes-kubedns-installation/">Kubernetes安装之kubedns配置 <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="274">
<meta itemprop="datePublished" content="2017-04-12">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation-with-tls/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

