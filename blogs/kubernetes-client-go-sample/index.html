<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, go, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kubernetes client-go包使用示例 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-client-go-sample/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-21"/>
<meta property="article:modified_time" content="2017-06-21"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="go">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="kubernetes client-go包使用示例 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> kubernetes client-go包使用示例 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-client-go-sample/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=kubernetes%20client-go%e5%8c%85%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f&title=kubernetes%20client-go%e5%8c%85%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">kubernetes client-go包使用示例</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170526017.jpg" alt="青岛栈桥" /></p>

<p><em>(题图：青岛栈桥 May 26,2017)</em></p>

<h2 id="前言">前言</h2>

<p>本文将归档到<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的【开发指南—client-go示例】章节中，最终版本以kubernetes-handbook中为准。</p>

<p>本文中的代码见：<a href="https://github.com/rootsongjc/kubernetes-client-go-sample">https://github.com/rootsongjc/kubernetes-client-go-sample</a></p>

<h2 id="client-go示例">client-go示例</h2>

<p>访问kubernetes集群有几下几种方式：</p>

<table>
<thead>
<tr>
<th>方式</th>
<th>特点</th>
<th>支持者</th>
</tr>
</thead>

<tbody>
<tr>
<td>Kubernetes dashboard</td>
<td>直接通过Web UI进行操作，简单直接，可定制化程度低</td>
<td>官方支持</td>
</tr>

<tr>
<td>kubectl</td>
<td>命令行操作，功能最全，但是比较复杂，适合对其进行进一步的分装，定制功能，版本适配最好</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/kubernetes/client-go">client-go</a></td>
<td>从kubernetes的代码中抽离出来的客户端包，简单易用，但需要小心区分kubernetes的API版本</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/kubernetes-incubator/client-python">client-python</a></td>
<td>python客户端，kubernetes-incubator</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/fabric8io/kubernetes-client">Java client</a></td>
<td>fabric8中的一部分，kubernetes的java客户端</td>
<td>redhat</td>
</tr>
</tbody>
</table>

<p>下面，我们基于<a href="https://github.com/kubernetes/client-go">client-go</a>，对Deployment升级镜像的步骤进行了定制，通过命令行传递一个Deployment的名字、应用容器名和新image名字的方式来升级。代码和使用方式见 <a href="https://github.com/rootsongjc/kubernetes-client-go-sample">https://github.com/rootsongjc/kubernetes-client-go-sample</a> 。</p>

<h2 id="kubernetes-client-go-sample">kubernetes-client-go-sample</h2>

<p>代码如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="kn">package</span><span class=""> </span><span class="nx">main</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kn">import</span><span class=""> </span><span class="p">(</span><span class="">
</span><span class="">	</span><span class="s">&#34;flag&#34;</span><span class="">
</span><span class="">	</span><span class="s">&#34;fmt&#34;</span><span class="">
</span><span class="">	</span><span class="s">&#34;os&#34;</span><span class="">
</span><span class="">	</span><span class="s">&#34;path/filepath&#34;</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="s">&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span><span class="">
</span><span class="">	</span><span class="nx">metav1</span><span class=""> </span><span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span><span class="">
</span><span class="">	</span><span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span><span class="">
</span><span class="">	</span><span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span><span class="">
</span><span class=""></span><span class="p">)</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="nx">main</span><span class="p">()</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="kd">var</span><span class=""> </span><span class="nx">kubeconfig</span><span class=""> </span><span class="o">*</span><span class="kt">string</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">home</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">homeDir</span><span class="p">();</span><span class=""> </span><span class="nx">home</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="s">&#34;&#34;</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">kubeconfig</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">home</span><span class="p">,</span><span class=""> </span><span class="s">&#34;.kube&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;config&#34;</span><span class="p">),</span><span class=""> </span><span class="s">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class=""> </span><span class="k">else</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">kubeconfig</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;absolute path to the kubeconfig file&#34;</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="nx">deploymentName</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&#34;deployment&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;deployment name&#34;</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="nx">imageName</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&#34;image&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;new image name&#34;</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="nx">appName</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;app&#34;</span><span class="p">,</span><span class=""> </span><span class="s">&#34;application name&#34;</span><span class="p">)</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="o">*</span><span class="nx">deploymentName</span><span class=""> </span><span class="o">==</span><span class=""> </span><span class="s">&#34;&#34;</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;You must specify the deployment name.&#34;</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="o">*</span><span class="nx">imageName</span><span class=""> </span><span class="o">==</span><span class=""> </span><span class="s">&#34;&#34;</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;You must specify the new image name.&#34;</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="c1">// use the current context in kubeconfig
</span><span class="c1"></span><span class="">	</span><span class="nx">config</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">clientcmd</span><span class="p">.</span><span class="nx">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class=""> </span><span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">
</span><span class="">	</span><span class="c1">// create the clientset
</span><span class="c1"></span><span class="">	</span><span class="nx">clientset</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="nx">deployment</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">clientset</span><span class="p">.</span><span class="nx">AppsV1beta1</span><span class="p">().</span><span class="nx">Deployments</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">).</span><span class="nx">Get</span><span class="p">(</span><span class="o">*</span><span class="nx">deploymentName</span><span class="p">,</span><span class=""> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Deployment not found\n&#34;</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class=""> </span><span class="k">else</span><span class=""> </span><span class="k">if</span><span class=""> </span><span class="nx">statusError</span><span class="p">,</span><span class=""> </span><span class="nx">isStatus</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">errors</span><span class="p">.</span><span class="nx">StatusError</span><span class="p">);</span><span class=""> </span><span class="nx">isStatus</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Error getting deployment%v\n&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">statusError</span><span class="p">.</span><span class="nx">ErrStatus</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class=""> </span><span class="k">else</span><span class=""> </span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class=""> </span><span class="k">else</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Found deployment\n&#34;</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="nx">name</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">deployment</span><span class="p">.</span><span class="nx">GetName</span><span class="p">()</span><span class="">
</span><span class="">		</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;name -&gt;&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">name</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="nx">containers</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="o">&amp;</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="">
</span><span class="">		</span><span class="nx">found</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="kc">false</span><span class="">
</span><span class="">		</span><span class="k">for</span><span class=""> </span><span class="nx">i</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="k">range</span><span class=""> </span><span class="o">*</span><span class="nx">containers</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">			</span><span class="nx">c</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="o">*</span><span class="nx">containers</span><span class="">
</span><span class="">			</span><span class="k">if</span><span class=""> </span><span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Name</span><span class=""> </span><span class="o">==</span><span class=""> </span><span class="o">*</span><span class="nx">appName</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">				</span><span class="nx">found</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="kc">true</span><span class="">
</span><span class="">				</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;Old image -&gt;&#34;</span><span class="p">,</span><span class=""> </span><span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Image</span><span class="p">)</span><span class="">
</span><span class="">				</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;New image -&gt;&#34;</span><span class="p">,</span><span class=""> </span><span class="o">*</span><span class="nx">imageName</span><span class="p">)</span><span class="">
</span><span class="">				</span><span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Image</span><span class=""> </span><span class="p">=</span><span class=""> </span><span class="o">*</span><span class="nx">imageName</span><span class="">
</span><span class="">			</span><span class="p">}</span><span class="">
</span><span class="">		</span><span class="p">}</span><span class="">
</span><span class="">		</span><span class="k">if</span><span class=""> </span><span class="nx">found</span><span class=""> </span><span class="o">==</span><span class=""> </span><span class="kc">false</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">			</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&#34;The application container not exist in the deployment pods.&#34;</span><span class="p">)</span><span class="">
</span><span class="">			</span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="p">}</span><span class="">
</span><span class="">		</span><span class="nx">_</span><span class="p">,</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">clientset</span><span class="p">.</span><span class="nx">AppsV1beta1</span><span class="p">().</span><span class="nx">Deployments</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">).</span><span class="nx">Update</span><span class="p">(</span><span class="nx">deployment</span><span class="p">)</span><span class="">
</span><span class="">		</span><span class="k">if</span><span class=""> </span><span class="nx">err</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="kc">nil</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">			</span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span><span class="">
</span><span class="">		</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class=""></span><span class="p">}</span><span class="">
</span><span class="">
</span><span class=""></span><span class="kd">func</span><span class=""> </span><span class="nx">homeDir</span><span class="p">()</span><span class=""> </span><span class="kt">string</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">	</span><span class="k">if</span><span class=""> </span><span class="nx">h</span><span class=""> </span><span class="o">:=</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&#34;HOME&#34;</span><span class="p">);</span><span class=""> </span><span class="nx">h</span><span class=""> </span><span class="o">!=</span><span class=""> </span><span class="s">&#34;&#34;</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">		</span><span class="k">return</span><span class=""> </span><span class="nx">h</span><span class="">
</span><span class="">	</span><span class="p">}</span><span class="">
</span><span class="">	</span><span class="k">return</span><span class=""> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&#34;USERPROFILE&#34;</span><span class="p">)</span><span class=""> </span><span class="c1">// windows
</span><span class="c1"></span><span class="p">}</span></code></pre>
</div>
<p>我们使用<code>kubeconfig</code>文件认证连接kubernetes集群，该文件默认的位置是<code>$HOME/.kube/config</code>。</p>

<p>该代码编译后可以直接在kubernetes集群之外，任何一个可以连接到API server的机器上运行。</p>

<p><strong>编译运行</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ go get github.com/rootsongjc/kubernetes-client-go-sample
</span><span class="">$ </span><span class="nb">cd</span><span class=""> </span><span class="nv">$GOPATH</span><span class="">/src/github.com/rootsongjc/kubernetes-client-go-sample
</span><span class="">$ make
</span><span class="">$ ./update-deployment-image -h
</span><span class="">Usage of ./update-deployment-image:
</span><span class="">  -alsologtostderr
</span><span class="">    	log to standard error as well as files
</span><span class="">  -app string
</span><span class="">    	application name </span><span class="o">(</span><span class="">default </span><span class="s2">&#34;app&#34;</span><span class="o">)</span><span class="">
</span><span class="">  -deployment string
</span><span class="">    	deployment name
</span><span class="">  -image string
</span><span class="">    	new image name
</span><span class="">  -kubeconfig string
</span><span class="">    	</span><span class="o">(</span><span class="">optional</span><span class="o">)</span><span class=""> absolute path to the kubeconfig file </span><span class="o">(</span><span class="">default </span><span class="s2">&#34;/Users/jimmy/.kube/config&#34;</span><span class="o">)</span><span class="">
</span><span class="">  -log_backtrace_at value
</span><span class="">    	when logging hits line file:N, emit a stack trace
</span><span class="">  -log_dir string
</span><span class="">    	If non-empty, write log files in this directory
</span><span class="">  -logtostderr
</span><span class="">    	log to standard error instead of files
</span><span class="">  -stderrthreshold value
</span><span class="">    	logs at or above this threshold go to stderr
</span><span class="">  -v value
</span><span class="">    	log level </span><span class="k">for</span><span class=""> V logs
</span><span class="">  -vmodule value
</span><span class="">    	comma-separated list of </span><span class="nv">pattern</span><span class=""></span><span class="o">=</span><span class="">N settings </span><span class="k">for</span><span class=""> file-filtered logging</span></code></pre>
</div>
<p><strong>使用不存在的image更新</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class=""> $ ./update-deployment-image -deployment filebeat-test -image sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9 
</span><span class="">Found deployment
</span><span class="">name -&gt; filebeat-test
</span><span class="">Old image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
</span><span class="">New image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9</span></code></pre>
</div>
<p>查看Deployment的event。</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="">$ kubectl describe deployment filebeat-test   
</span><span class="">Name:			filebeat-test
</span><span class="">Namespace:		default
</span><span class="">CreationTimestamp:	Fri, </span><span class="m">19</span><span class=""> May </span><span class="m">2017</span><span class=""> </span><span class="m">15</span><span class="">:12:28 +0800
</span><span class="">Labels:			k8s-app</span><span class="o">=</span><span class="">filebeat-test
</span><span class="">Selector:		k8s-app</span><span class="o">=</span><span class="">filebeat-test
</span><span class="">Replicas:		</span><span class="m">2</span><span class=""> updated </span><span class="p">|</span><span class=""> </span><span class="m">3</span><span class=""> total </span><span class="p">|</span><span class=""> </span><span class="m">2</span><span class=""> available </span><span class="p">|</span><span class=""> </span><span class="m">2</span><span class=""> unavailable
</span><span class="">StrategyType:		RollingUpdate
</span><span class="">MinReadySeconds:	</span><span class="m">0</span><span class="">
</span><span class="">RollingUpdateStrategy:	</span><span class="m">1</span><span class=""> max unavailable, </span><span class="m">1</span><span class=""> max surge
</span><span class="">Conditions:
</span><span class="">  Type		Status	Reason
</span><span class="">  ----		------	------
</span><span class="">  Available 	True	MinimumReplicasAvailable
</span><span class="">  Progressing 	True	ReplicaSetUpdated
</span><span class="">OldReplicaSets:	filebeat-test-2365467882 </span><span class="o">(</span><span class="m">2</span><span class="">/2 replicas created</span><span class="o">)</span><span class="">
</span><span class="">NewReplicaSet:	filebeat-test-2470325483 </span><span class="o">(</span><span class="m">2</span><span class="">/2 replicas created</span><span class="o">)</span><span class="">
</span><span class="">Events:
</span><span class="">  FirstSeen	LastSeen	Count	From				SubObjectPath	Type		ReasoMessage
</span><span class="">  ---------	--------	-----	----				-------------	--------	------------
</span><span class="">  2h		1m		</span><span class="m">3</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled down replica </span><span class="nb">set</span><span class=""> filebeat-test-2365467882 to </span><span class="m">2</span><span class="">
</span><span class="">  1m		1m		</span><span class="m">1</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled up replica </span><span class="nb">set</span><span class=""> filebeat-test-2470325483 to </span><span class="m">1</span><span class="">
</span><span class="">  1m		1m		</span><span class="m">1</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled up replica </span><span class="nb">set</span><span class=""> filebeat-test-2470325483 to </span><span class="m">2</span></code></pre>
</div>
<p>可以看到老的ReplicaSet从3个replica减少到了2个，有2个使用新配置的replica不可用，目前可用的replica是2个。</p>

<p>这是因为我们指定的镜像不存在，查看Deployment的pod的状态。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl get pods -l k8s-app</span><span class="o">=</span><span class="">filebeat-test
</span><span class="">NAME                             READY     STATUS             RESTARTS   AGE
</span><span class="">filebeat-test-2365467882-4zwx8   </span><span class="m">2</span><span class="">/2       Running            </span><span class="m">0</span><span class="">          33d
</span><span class="">filebeat-test-2365467882-rqskl   </span><span class="m">2</span><span class="">/2       Running            </span><span class="m">0</span><span class="">          33d
</span><span class="">filebeat-test-2470325483-6vjbw   </span><span class="m">1</span><span class="">/2       ImagePullBackOff   </span><span class="m">0</span><span class="">          4m
</span><span class="">filebeat-test-2470325483-gc14k   </span><span class="m">1</span><span class="">/2       ImagePullBackOff   </span><span class="m">0</span><span class="">          4m</span></code></pre>
</div>
<p>我们可以看到有两个pod正在拉取image。</p>

<p><strong>还原为原先的镜像</strong></p>

<p>将image设置为原来的镜像。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ./update-deployment-image -deployment filebeat-test -image sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
</span><span class="">Found deployment
</span><span class="">name -&gt; filebeat-test
</span><span class="">Old image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9
</span><span class="">New image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8</span></code></pre>
</div>
<p>现在再查看Deployment的状态。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl describe deployment filebeat-test   
</span><span class="">Name:			filebeat-test
</span><span class="">Namespace:		default
</span><span class="">CreationTimestamp:	Fri, </span><span class="m">19</span><span class=""> May </span><span class="m">2017</span><span class=""> </span><span class="m">15</span><span class="">:12:28 +0800
</span><span class="">Labels:			k8s-app</span><span class="o">=</span><span class="">filebeat-test
</span><span class="">Selector:		k8s-app</span><span class="o">=</span><span class="">filebeat-test
</span><span class="">Replicas:		</span><span class="m">3</span><span class=""> updated </span><span class="p">|</span><span class=""> </span><span class="m">3</span><span class=""> total </span><span class="p">|</span><span class=""> </span><span class="m">3</span><span class=""> available </span><span class="p">|</span><span class=""> </span><span class="m">0</span><span class=""> unavailable
</span><span class="">StrategyType:		RollingUpdate
</span><span class="">MinReadySeconds:	</span><span class="m">0</span><span class="">
</span><span class="">RollingUpdateStrategy:	</span><span class="m">1</span><span class=""> max unavailable, </span><span class="m">1</span><span class=""> max surge
</span><span class="">Conditions:
</span><span class="">  Type		Status	Reason
</span><span class="">  ----		------	------
</span><span class="">  Available 	True	MinimumReplicasAvailable
</span><span class="">  Progressing 	True	NewReplicaSetAvailable
</span><span class="">OldReplicaSets:	&lt;none&gt;
</span><span class="">NewReplicaSet:	filebeat-test-2365467882 </span><span class="o">(</span><span class="m">3</span><span class="">/3 replicas created</span><span class="o">)</span><span class="">
</span><span class="">Events:
</span><span class="">  FirstSeen	LastSeen	Count	From				SubObjectPath	Type		ReasoMessage
</span><span class="">  ---------	--------	-----	----				-------------	--------	------------
</span><span class="">  2h		8m		</span><span class="m">3</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled down replica </span><span class="nb">set</span><span class=""> filebeat-test-2365467882 to </span><span class="m">2</span><span class="">
</span><span class="">  8m		8m		</span><span class="m">1</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled up replica </span><span class="nb">set</span><span class=""> filebeat-test-2470325483 to </span><span class="m">1</span><span class="">
</span><span class="">  8m		8m		</span><span class="m">1</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled up replica </span><span class="nb">set</span><span class=""> filebeat-test-2470325483 to </span><span class="m">2</span><span class="">
</span><span class="">  2h		1m		</span><span class="m">3</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled up replica </span><span class="nb">set</span><span class=""> filebeat-test-2365467882 to </span><span class="m">3</span><span class="">
</span><span class="">  1m		1m		</span><span class="m">1</span><span class="">	</span><span class="o">{</span><span class="">deployment-controller </span><span class="o">}</span><span class="">			Normal		ScalingReplicaSet	Scaled down replica </span><span class="nb">set</span><span class=""> filebeat-test-2470325483 to </span><span class="m">0</span></code></pre>
</div>
<p>可以看到available的replica个数恢复成3了。</p>

<p>其实在使用该命令的过程中，通过kubernetes dashboard的页面上查看Deployment的状态更直观，更加方便故障排查。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-client-go-sample-update.jpg" alt="使用kubernetes dashboard进行故障排查" /></p>

<p>这也是dashboard最大的优势，简单、直接、高效。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-container-naming-rule/">kubernetes管理的容器命名规则解析</a></li>
                
                <li><a href="/blogs/configuration-best-practice/">Kubernetes配置最佳实践</a></li>
                
                <li><a href="/talks/cloud-native-go/">Cloud Native Go - 基于Go和React的web云服务构建指南</a></li>
                
                <li><a href="/blogs/istio-overview/">微服务管理框架Istio简介</a></li>
                
                <li><a href="/blogs/istio-installation/">微服务管理框架istio安装笔记</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Jun 21, 2017 </h4>
        <h5 id="wc"> 1400 Words </h5>
        <h5 id="readtime"> Read in about 3 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/go">go</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/continuous-integration-with-wercker/"><i class="icon-arrow-left"></i> 使用Wercker进行持续构建与发布</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-container-naming-rule/">kubernetes管理的容器命名规则解析 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1358">
<meta itemprop="datePublished" content="2017-06-21">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-client-go-sample/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
