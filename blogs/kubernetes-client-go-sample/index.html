<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, go, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kubernetes client-go包使用示例 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-client-go-sample/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-06-21"/>
<meta property="article:modified_time" content="2017-06-21"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="go">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="kubernetes client-go包使用示例 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> kubernetes client-go包使用示例 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-client-go-sample/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=kubernetes%20client-go%e5%8c%85%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f&title=kubernetes%20client-go%e5%8c%85%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-client-go-sample%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">kubernetes client-go包使用示例</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20170526017.jpg" alt="青岛栈桥" /></p>

<p><em>(题图：青岛栈桥 May 26,2017)</em></p>

<h2 id="前言">前言</h2>

<p>本文将归档到<a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>的【开发指南—client-go示例】章节中，最终版本以kubernetes-handbook中为准。</p>

<p>本文中的代码见：<a href="https://github.com/rootsongjc/kubernetes-client-go-sample">https://github.com/rootsongjc/kubernetes-client-go-sample</a></p>

<h2 id="client-go示例">client-go示例</h2>

<p>访问kubernetes集群有几下几种方式：</p>

<table>
<thead>
<tr>
<th>方式</th>
<th>特点</th>
<th>支持者</th>
</tr>
</thead>

<tbody>
<tr>
<td>Kubernetes dashboard</td>
<td>直接通过Web UI进行操作，简单直接，可定制化程度低</td>
<td>官方支持</td>
</tr>

<tr>
<td>kubectl</td>
<td>命令行操作，功能最全，但是比较复杂，适合对其进行进一步的分装，定制功能，版本适配最好</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/kubernetes/client-go">client-go</a></td>
<td>从kubernetes的代码中抽离出来的客户端包，简单易用，但需要小心区分kubernetes的API版本</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/kubernetes-incubator/client-python">client-python</a></td>
<td>python客户端，kubernetes-incubator</td>
<td>官方支持</td>
</tr>

<tr>
<td><a href="https://github.com/fabric8io/kubernetes-client">Java client</a></td>
<td>fabric8中的一部分，kubernetes的java客户端</td>
<td>redhat</td>
</tr>
</tbody>
</table>

<p>下面，我们基于<a href="https://github.com/kubernetes/client-go">client-go</a>，对Deployment升级镜像的步骤进行了定制，通过命令行传递一个Deployment的名字、应用容器名和新image名字的方式来升级。代码和使用方式见 <a href="https://github.com/rootsongjc/kubernetes-client-go-sample">https://github.com/rootsongjc/kubernetes-client-go-sample</a> 。</p>

<h2 id="kubernetes-client-go-sample">kubernetes-client-go-sample</h2>

<p>代码如下：</p>

<pre><code class="language-Go">package main

import (
	&quot;flag&quot;
	&quot;fmt&quot;
	&quot;os&quot;
	&quot;path/filepath&quot;

	&quot;k8s.io/apimachinery/pkg/api/errors&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
	&quot;k8s.io/client-go/kubernetes&quot;
	&quot;k8s.io/client-go/tools/clientcmd&quot;
)

func main() {
	var kubeconfig *string
	if home := homeDir(); home != &quot;&quot; {
		kubeconfig = flag.String(&quot;kubeconfig&quot;, filepath.Join(home, &quot;.kube&quot;, &quot;config&quot;), &quot;(optional) absolute path to the kubeconfig file&quot;)
	} else {
		kubeconfig = flag.String(&quot;kubeconfig&quot;, &quot;&quot;, &quot;absolute path to the kubeconfig file&quot;)
	}
	deploymentName := flag.String(&quot;deployment&quot;, &quot;&quot;, &quot;deployment name&quot;)
	imageName := flag.String(&quot;image&quot;, &quot;&quot;, &quot;new image name&quot;)
	appName := flag.String(&quot;app&quot;, &quot;app&quot;, &quot;application name&quot;)

	flag.Parse()
	if *deploymentName == &quot;&quot; {
		fmt.Println(&quot;You must specify the deployment name.&quot;)
		os.Exit(0)
	}
	if *imageName == &quot;&quot; {
		fmt.Println(&quot;You must specify the new image name.&quot;)
		os.Exit(0)
	}
	// use the current context in kubeconfig
	config, err := clientcmd.BuildConfigFromFlags(&quot;&quot;, *kubeconfig)
	if err != nil {
		panic(err.Error())
	}

	// create the clientset
	clientset, err := kubernetes.NewForConfig(config)
	if err != nil {
		panic(err.Error())
	}
	deployment, err := clientset.AppsV1beta1().Deployments(&quot;default&quot;).Get(*deploymentName, metav1.GetOptions{})
	if err != nil {
		panic(err.Error())
	}
	if errors.IsNotFound(err) {
		fmt.Printf(&quot;Deployment not found\n&quot;)
	} else if statusError, isStatus := err.(*errors.StatusError); isStatus {
		fmt.Printf(&quot;Error getting deployment%v\n&quot;, statusError.ErrStatus.Message)
	} else if err != nil {
		panic(err.Error())
	} else {
		fmt.Printf(&quot;Found deployment\n&quot;)
		name := deployment.GetName()
		fmt.Println(&quot;name -&gt;&quot;, name)
		containers := &amp;deployment.Spec.Template.Spec.Containers
		found := false
		for i := range *containers {
			c := *containers
			if c[i].Name == *appName {
				found = true
				fmt.Println(&quot;Old image -&gt;&quot;, c[i].Image)
				fmt.Println(&quot;New image -&gt;&quot;, *imageName)
				c[i].Image = *imageName
			}
		}
		if found == false {
			fmt.Println(&quot;The application container not exist in the deployment pods.&quot;)
			os.Exit(0)
		}
		_, err := clientset.AppsV1beta1().Deployments(&quot;default&quot;).Update(deployment)
		if err != nil {
			panic(err.Error())
		}
	}
}

func homeDir() string {
	if h := os.Getenv(&quot;HOME&quot;); h != &quot;&quot; {
		return h
	}
	return os.Getenv(&quot;USERPROFILE&quot;) // windows
}
</code></pre>

<p>我们使用<code>kubeconfig</code>文件认证连接kubernetes集群，该文件默认的位置是<code>$HOME/.kube/config</code>。</p>

<p>该代码编译后可以直接在kubernetes集群之外，任何一个可以连接到API server的机器上运行。</p>

<p><strong>编译运行</strong></p>

<pre><code class="language-bash">$ go get github.com/rootsongjc/kubernetes-client-go-sample
$ cd $GOPATH/src/github.com/rootsongjc/kubernetes-client-go-sample
$ make
$ ./update-deployment-image -h
Usage of ./update-deployment-image:
  -alsologtostderr
    	log to standard error as well as files
  -app string
    	application name (default &quot;app&quot;)
  -deployment string
    	deployment name
  -image string
    	new image name
  -kubeconfig string
    	(optional) absolute path to the kubeconfig file (default &quot;/Users/jimmy/.kube/config&quot;)
  -log_backtrace_at value
    	when logging hits line file:N, emit a stack trace
  -log_dir string
    	If non-empty, write log files in this directory
  -logtostderr
    	log to standard error instead of files
  -stderrthreshold value
    	logs at or above this threshold go to stderr
  -v value
    	log level for V logs
  -vmodule value
    	comma-separated list of pattern=N settings for file-filtered logging
</code></pre>

<p><strong>使用不存在的image更新</strong></p>

<pre><code class="language-bash"> $ ./update-deployment-image -deployment filebeat-test -image sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9 
Found deployment
name -&gt; filebeat-test
Old image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
New image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9
</code></pre>

<p>查看Deployment的event。</p>

<pre><code class="language-Bash">$ kubectl describe deployment filebeat-test   
Name:			filebeat-test
Namespace:		default
CreationTimestamp:	Fri, 19 May 2017 15:12:28 +0800
Labels:			k8s-app=filebeat-test
Selector:		k8s-app=filebeat-test
Replicas:		2 updated | 3 total | 2 available | 2 unavailable
StrategyType:		RollingUpdate
MinReadySeconds:	0
RollingUpdateStrategy:	1 max unavailable, 1 max surge
Conditions:
  Type		Status	Reason
  ----		------	------
  Available 	True	MinimumReplicasAvailable
  Progressing 	True	ReplicaSetUpdated
OldReplicaSets:	filebeat-test-2365467882 (2/2 replicas created)
NewReplicaSet:	filebeat-test-2470325483 (2/2 replicas created)
Events:
  FirstSeen	LastSeen	Count	From				SubObjectPath	Type		ReasoMessage
  ---------	--------	-----	----				-------------	--------	------------
  2h		1m		3	{deployment-controller }			Normal		ScalingReplicaSet	Scaled down replica set filebeat-test-2365467882 to 2
  1m		1m		1	{deployment-controller }			Normal		ScalingReplicaSet	Scaled up replica set filebeat-test-2470325483 to 1
  1m		1m		1	{deployment-controller }			Normal		ScalingReplicaSet	Scaled up replica set filebeat-test-2470325483 to 2
</code></pre>

<p>可以看到老的ReplicaSet从3个replica减少到了2个，有2个使用新配置的replica不可用，目前可用的replica是2个。</p>

<p>这是因为我们指定的镜像不存在，查看Deployment的pod的状态。</p>

<pre><code class="language-bash">$ kubectl get pods -l k8s-app=filebeat-test
NAME                             READY     STATUS             RESTARTS   AGE
filebeat-test-2365467882-4zwx8   2/2       Running            0          33d
filebeat-test-2365467882-rqskl   2/2       Running            0          33d
filebeat-test-2470325483-6vjbw   1/2       ImagePullBackOff   0          4m
filebeat-test-2470325483-gc14k   1/2       ImagePullBackOff   0          4m
</code></pre>

<p>我们可以看到有两个pod正在拉取image。</p>

<p><strong>还原为原先的镜像</strong></p>

<p>将image设置为原来的镜像。</p>

<pre><code class="language-bash">$ ./update-deployment-image -deployment filebeat-test -image sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
Found deployment
name -&gt; filebeat-test
Old image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_9
New image -&gt; sz-pg-oam-docker-hub-001.tendcloud.com/library/analytics-docker-test:Build_8
</code></pre>

<p>现在再查看Deployment的状态。</p>

<pre><code class="language-bash">$ kubectl describe deployment filebeat-test   
Name:			filebeat-test
Namespace:		default
CreationTimestamp:	Fri, 19 May 2017 15:12:28 +0800
Labels:			k8s-app=filebeat-test
Selector:		k8s-app=filebeat-test
Replicas:		3 updated | 3 total | 3 available | 0 unavailable
StrategyType:		RollingUpdate
MinReadySeconds:	0
RollingUpdateStrategy:	1 max unavailable, 1 max surge
Conditions:
  Type		Status	Reason
  ----		------	------
  Available 	True	MinimumReplicasAvailable
  Progressing 	True	NewReplicaSetAvailable
OldReplicaSets:	&lt;none&gt;
NewReplicaSet:	filebeat-test-2365467882 (3/3 replicas created)
Events:
  FirstSeen	LastSeen	Count	From				SubObjectPath	Type		ReasoMessage
  ---------	--------	-----	----				-------------	--------	------------
  2h		8m		3	{deployment-controller }			Normal		ScalingReplicaSet	Scaled down replica set filebeat-test-2365467882 to 2
  8m		8m		1	{deployment-controller }			Normal		ScalingReplicaSet	Scaled up replica set filebeat-test-2470325483 to 1
  8m		8m		1	{deployment-controller }			Normal		ScalingReplicaSet	Scaled up replica set filebeat-test-2470325483 to 2
  2h		1m		3	{deployment-controller }			Normal		ScalingReplicaSet	Scaled up replica set filebeat-test-2365467882 to 3
  1m		1m		1	{deployment-controller }			Normal		ScalingReplicaSet	Scaled down replica set filebeat-test-2470325483 to 0
</code></pre>

<p>可以看到available的replica个数恢复成3了。</p>

<p>其实在使用该命令的过程中，通过kubernetes dashboard的页面上查看Deployment的状态更直观，更加方便故障排查。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-client-go-sample-update.jpg" alt="使用kubernetes dashboard进行故障排查" /></p>

<p>这也是dashboard最大的优势，简单、直接、高效。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-container-naming-rule/">kubernetes管理的容器命名规则解析</a></li>
                
                <li><a href="/blogs/configuration-best-practice/">Kubernetes配置最佳实践</a></li>
                
                <li><a href="/talks/cloud-native-go/">Cloud Native Go - 基于Go和React的web云服务构建指南</a></li>
                
                <li><a href="/blogs/istio-overview/">微服务管理框架Istio简介</a></li>
                
                <li><a href="/blogs/istio-installation/">微服务管理框架istio安装笔记</a></li>
                
            </ul>
            
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Jun 21, 2017 </h4>
        <h5 id="wc"> 1700 Words </h5>
        <h5 id="readtime"> Read in about 4 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
        <li> <a href="https://jimmysong.io//tags/go">go</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/continuous-integration-with-wercker/"><i class="icon-arrow-left"></i> 使用Wercker进行持续构建与发布</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-container-naming-rule/">kubernetes管理的容器命名规则解析 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="1638">
<meta itemprop="datePublished" content="2017-06-21">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-client-go-sample/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>


</body>

</html>
