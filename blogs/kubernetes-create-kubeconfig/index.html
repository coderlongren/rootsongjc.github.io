<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes安装之创建kubeconfig文件 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-create-kubeconfig/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-11"/>
<meta property="article:modified_time" content="2017-04-11"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes安装之创建kubeconfig文件 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes安装之创建kubeconfig文件 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-create-kubeconfig/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8b%e5%88%9b%e5%bb%bakubeconfig%e6%96%87%e4%bb%b6-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f&title=Kubernetes%e5%ae%89%e8%a3%85%e4%b9%8b%e5%88%9b%e5%bb%bakubeconfig%e6%96%87%e4%bb%b6&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-create-kubeconfig%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes安装之创建kubeconfig文件</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016050801.jpg" alt="北海公园" /></p>

<p><em>(题图：北海公园 May 8,2016)</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目((fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>))中的一篇文章，下文是结合我<a href="http://rootsongjc.github.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，生成<strong>kubeconfig</strong>文件的过程。
<code>kubelet</code>、<code>kube-proxy</code> 等 Node 机器上的进程与 Master 机器的 <code>kube-apiserver</code> 进程通信时需要认证和授权；
kubernetes 1.4 开始支持由 <code>kube-apiserver</code> 为客户端生成 TLS 证书的 <a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/">TLS Bootstrapping</a> 功能，这样就不需要为每个客户端生成证书了；该功能<strong>当前仅支持为 <code>kubelet</code></strong> 生成证书。</p>

<h2 id="创建-tls-bootstrapping-token">创建 TLS Bootstrapping Token</h2>

<p><strong>Token auth file</strong></p>

<p>Token可以是任意的包涵128 bit的字符串，可以使用安全的随机数发生器生成。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span><span class=""> </span><span class="nv">BOOTSTRAP_TOKEN</span><span class=""></span><span class="o">=</span><span class="k">$(</span><span class="">head -c </span><span class="m">16</span><span class=""> /dev/urandom </span><span class="p">|</span><span class=""> od -An -t x </span><span class="p">|</span><span class=""> tr -d </span><span class="s1">&#39; &#39;</span><span class="k">)</span><span class="">
</span><span class="">cat &gt; token.csv </span><span class="s">&lt;&lt;EOF
</span><span class="s">${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,&#34;system:kubelet-bootstrap&#34;
</span><span class="s">EOF</span></code></pre>
</div>
<blockquote>
<p>后三行是一句，直接复制上面的脚本运行即可。</p>
</blockquote>

<p>将token.csv发到所有机器（Master 和 Node）的 <code>/etc/kubernetes/</code> 目录。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">$cp</span><span class=""> token.csv /etc/kubernetes/</span></code></pre>
</div>
<h2 id="创建-kubelet-bootstrapping-kubeconfig-文件">创建 kubelet bootstrapping kubeconfig 文件</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="nb">cd</span><span class=""> /etc/kubernetes
</span><span class="">$ </span><span class="nb">export</span><span class=""> </span><span class="nv">KUBE_APISERVER</span><span class=""></span><span class="o">=</span><span class="s2">&#34;https://172.20.0.113:6443&#34;</span><span class="">
</span><span class="">$ </span><span class="c1"># 设置集群参数
</span><span class="c1"></span><span class="">$ kubectl config set-cluster kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">  --certificate-authority</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/ca.pem </span><span class="se">\
</span><span class="se"></span><span class="">  --embed-certs</span><span class="o">=</span><span class="nb">true</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --server</span><span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">bootstrap.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置客户端认证参数
</span><span class="c1"></span><span class="">$ kubectl config set-credentials kubelet-bootstrap </span><span class="se">\
</span><span class="se"></span><span class="">  --token</span><span class="o">=</span><span class="si">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="si">}</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">bootstrap.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置上下文参数
</span><span class="c1"></span><span class="">$ kubectl config set-context default </span><span class="se">\
</span><span class="se"></span><span class="">  --cluster</span><span class="o">=</span><span class="">kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">  --user</span><span class="o">=</span><span class="">kubelet-bootstrap </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">bootstrap.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置默认上下文
</span><span class="c1"></span><span class="">$ kubectl config use-context default --kubeconfig</span><span class="o">=</span><span class="">bootstrap.kubeconfig</span></code></pre>
</div>
<ul>
<li><code>--embed-certs</code> 为 <code>true</code> 时表示将 <code>certificate-authority</code> 证书写入到生成的 <code>bootstrap.kubeconfig</code> 文件中；</li>
<li>设置客户端认证参数时<strong>没有</strong>指定秘钥和证书，后续由 <code>kube-apiserver</code> 自动生成；</li>
</ul>

<h2 id="创建-kube-proxy-kubeconfig-文件">创建 kube-proxy kubeconfig 文件</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="nb">export</span><span class=""> </span><span class="nv">KUBE_APISERVER</span><span class=""></span><span class="o">=</span><span class="s2">&#34;https://172.20.0.113:6443&#34;</span><span class="">
</span><span class="">$ </span><span class="c1"># 设置集群参数
</span><span class="c1"></span><span class="">$ kubectl config set-cluster kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">  --certificate-authority</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/ca.pem </span><span class="se">\
</span><span class="se"></span><span class="">  --embed-certs</span><span class="o">=</span><span class="nb">true</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --server</span><span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">kube-proxy.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置客户端认证参数
</span><span class="c1"></span><span class="">$ kubectl config set-credentials kube-proxy </span><span class="se">\
</span><span class="se"></span><span class="">  --client-certificate</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/kube-proxy.pem </span><span class="se">\
</span><span class="se"></span><span class="">  --client-key</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/kube-proxy-key.pem </span><span class="se">\
</span><span class="se"></span><span class="">  --embed-certs</span><span class="o">=</span><span class="nb">true</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">kube-proxy.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置上下文参数
</span><span class="c1"></span><span class="">$ kubectl config set-context default </span><span class="se">\
</span><span class="se"></span><span class="">  --cluster</span><span class="o">=</span><span class="">kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">  --user</span><span class="o">=</span><span class="">kube-proxy </span><span class="se">\
</span><span class="se"></span><span class="">  --kubeconfig</span><span class="o">=</span><span class="">kube-proxy.kubeconfig
</span><span class="">$ </span><span class="c1"># 设置默认上下文
</span><span class="c1"></span><span class="">$ kubectl config use-context default --kubeconfig</span><span class="o">=</span><span class="">kube-proxy.kubeconfig</span></code></pre>
</div>
<ul>
<li>设置集群参数和客户端认证参数时 <code>--embed-certs</code> 都为 <code>true</code>，这会将 <code>certificate-authority</code>、<code>client-certificate</code> 和 <code>client-key</code> 指向的证书文件内容写入到生成的 <code>kube-proxy.kubeconfig</code> 文件中；</li>
<li><code>kube-proxy.pem</code> 证书中 CN 为 <code>system:kube-proxy</code>，<code>kube-apiserver</code> 预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
</ul>

<h2 id="分发-kubeconfig-文件">分发 kubeconfig 文件</h2>

<p>将两个 kubeconfig 文件分发到所有 Node 机器的 <code>/etc/kubernetes/</code> 目录</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cp bootstrap.kubeconfig kube-proxy.kubeconfig /etc/kubernetes/</span></code></pre>
</div>
            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/kubernetes-tls-certificate/">Kubernetes安装之证书验证</a></li>
                
                <li><a href="/blogs/kubernetes-fluentd-elasticsearch-installation/">使用Fluentd和ElasticSearch收集Kubernetes集群日志</a></li>
                
                <li><a href="/blogs/kubernetes-configmap-introduction/">Kubernetes的ConfigMap解析</a></li>
                
                <li><a href="/blogs/kubernetes-heapster-installation/">Kubernetes heapster监控插件安装文档</a></li>
                
                <li><a href="/blogs/kubernetes-dashboard-installation/">Kubernetes Dashboard/Web UI安装全记录</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Apr 11, 2017 </h4>
        <h5 id="wc"> 700 Words </h5>
        <h5 id="readtime"> Read in about 2 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-etcd-ha-config/"><i class="icon-arrow-left"></i> Kubernetes安装之etcd高可用配置</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/fabric8-introduction/">开源微服务管理平台fabric8简介 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="697">
<meta itemprop="datePublished" content="2017-04-11">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-create-kubeconfig/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
