<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Kubernetes node节点安装 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubernetes-node-installation/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-04-11"/>
<meta property="article:modified_time" content="2017-04-11"/>





<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Kubernetes node节点安装 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Kubernetes node节点安装 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubernetes-node-installation/"> <link rel="stylesheet" href="/static/css/style.css">






<link rel="stylesheet" href="/static/css/syntax.css">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%20node%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85-https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f&title=Kubernetes%20node%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubernetes-node-installation%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 
    <section id="main">
        <h1 itemprop="name" id="title">Kubernetes node节点安装</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/2016121101.jpg" alt="东三环" /></p>

<p><em>（题图：太阳宫桥@北京东北三环 Dec 11,2016）</em></p>

<h2 id="前言">前言</h2>

<p>这是<a href="https://github.com/rootsongjc/follow-me-install-kubernetes-cluster">和我一步步部署kubernetes集群</a>项目(fork自<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster">opsnull</a>)中的一篇文章，下文是结合我<a href="https://jimmysong.io/tags/kubernetes/">之前部署kubernetes的过程</a>产生的kuberentes环境，部署node节点上的<code>kube-proxy</code>和<code>kubelet</code>，同时对之前部署的flannel改造。</p>

<p><strong>安装环境配置信息</strong></p>

<ul>
<li>CentOS7.2.1511</li>
<li>Docker 1.12.5</li>
<li>Flannel 0.7</li>
<li>Kubernetes 1.6.0</li>
</ul>

<h2 id="部署kubernetes-node节点">部署kubernetes node节点</h2>

<p>kubernetes node 节点包含如下组件：</p>

<ul>
<li>Flanneld：参考我之前写的文章<a href="https://jimmysong.io/blogs/kubernetes-network-config/">Kubernetes基于Flannel的网络配置</a>，之前没有配置TLS，现在需要在serivce配置文件中增加TLS配置。</li>
<li>Docker1.12.5：docker的安装很简单，这里也不说了。</li>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>

<p>下面着重讲<code>kubelet</code>和<code>kube-proxy</code>的安装，同时还要将之前安装的flannel集成TLS验证。</p>

<h2 id="目录和文件">目录和文件</h2>

<p>我们再检查一下三个节点上，经过前几步操作生成的配置文件。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ls /etc/kubernetes/ssl
</span><span class="">admin-key.pem  admin.pem  ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  kubernetes-key.pem  kubernetes.pem
</span><span class="">$ ls /etc/kubernetes/
</span><span class="">apiserver  bootstrap.kubeconfig  config  controller-manager  kubelet  kube-proxy.kubeconfig  proxy  scheduler  ssl  token.csv</span></code></pre>
</div>
<h2 id="配置flanneld">配置Flanneld</h2>

<p>参考我之前写的文章<a href="https://jimmysong.io/blogs/kubernetes-network-config/">Kubernetes基于Flannel的网络配置</a>，之前没有配置TLS，现在需要在serivce配置文件中增加TLS配置。</p>

<p>service配置文件<code>/usr/lib/systemd/system/flanneld.service</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Unit]</span><span class="">
</span><span class=""></span><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Flanneld overlay address etcd agent</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">network.target</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">network-online.target</span><span class="">
</span><span class=""></span><span class="na">Wants</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">network-online.target</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">etcd.service</span><span class="">
</span><span class=""></span><span class="na">Before</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">docker.service</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">Type</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">notify</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/etc/sysconfig/flanneld</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/sysconfig/docker-network</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/flanneld-start $FLANNEL_OPTIONS</span><span class="">
</span><span class=""></span><span class="na">ExecStartPost</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span><span class="">
</span><span class=""></span><span class="na">RequiredBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">docker.service</span></code></pre>
</div>
<p><code>/etc/sysconfig/flanneld</code>配置文件。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># Flanneld configuration options  </span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># etcd url location.  Point this to the server where etcd runs</span><span class="">
</span><span class=""></span><span class="na">FLANNEL_ETCD_ENDPOINTS</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;https://172.20.0.113:2379,https://172.20.0.114:2379,https://172.20.0.115:2379&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># etcd config key.  This is the configuration key that flannel queries</span><span class="">
</span><span class=""></span><span class="c1"># For address range assignment</span><span class="">
</span><span class=""></span><span class="na">FLANNEL_ETCD_PREFIX</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;/kube-centos/network&#34;</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># Any additional options that you want to pass</span><span class="">
</span><span class=""></span><span class="na">FLANNEL_OPTIONS</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">&#34;-etcd-cafile=/etc/kubernetes/ssl/ca.pem -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem&#34;</span></code></pre>
</div>
<p>在FLANNEL_OPTIONS中增加TLS的配置。</p>

<h2 id="安装和配置-kubelet">安装和配置 kubelet</h2>

<p>kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper cluster 角色(role)，
然后 kubelet 才能有权限创建认证请求(certificate signing requests)：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ </span><span class="nb">cd</span><span class=""> /etc/kubernetes
</span><span class="">$ kubectl create clusterrolebinding kubelet-bootstrap </span><span class="se">\
</span><span class="se"></span><span class="">  --clusterrole</span><span class="o">=</span><span class="">system:node-bootstrapper </span><span class="se">\
</span><span class="se"></span><span class="">  --user</span><span class="o">=</span><span class="">kubelet-bootstrap</span></code></pre>
</div>
<ul>
<li><code>--user=kubelet-bootstrap</code> 是在 <code>/etc/kubernetes/token.csv</code> 文件中指定的用户名，同时也写入了 <code>/etc/kubernetes/bootstrap.kubeconfig</code> 文件；</li>
</ul>

<h3 id="下载最新的-kubelet-和-kube-proxy-二进制文件">下载最新的 kubelet 和 kube-proxy 二进制文件</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ wget https://dl.k8s.io/v1.6.0/kubernetes-server-linux-amd64.tar.gz
</span><span class="">$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
</span><span class="">$ </span><span class="nb">cd</span><span class=""> kubernetes
</span><span class="">$ tar -xzvf  kubernetes-src.tar.gz
</span><span class="">$ cp -r ./server/bin/</span><span class="o">{</span><span class="">kube-proxy,kubelet</span><span class="o">}</span><span class=""> /usr/bin/</span></code></pre>
</div>
<h3 id="创建-kubelet-的service配置文件">创建 kubelet 的service配置文件</h3>

<p>文件位置<code>/usr/lib/systemd/system/kubelet.serivce</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Unit]</span><span class="">
</span><span class=""></span><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Kubernetes Kubelet Server</span><span class="">
</span><span class=""></span><span class="na">Documentation</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">https://github.com/GoogleCloudPlatform/kubernetes</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">docker.service</span><span class="">
</span><span class=""></span><span class="na">Requires</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">docker.service</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">WorkingDirectory</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/var/lib/kubelet</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/config</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/kubelet</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/kubelet \
</span><span class="s">            $KUBE_LOGTOSTDERR \
</span><span class="s">            $KUBE_LOG_LEVEL \
</span><span class="s">            $KUBELET_API_SERVER \
</span><span class="s">            $KUBELET_ADDRESS \
</span><span class="s">            $KUBELET_PORT \
</span><span class="s">            $KUBELET_HOSTNAME \
</span><span class="s">            $KUBE_ALLOW_PRIV \
</span><span class="s">            $KUBELET_POD_INFRA_CONTAINER \
</span><span class="s">            $KUBELET_ARGS</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span></code></pre>
</div>
<p>kubelet的配置文件<code>/etc/kubernetes/kubelet</code>。其中的IP地址更改为你的每台node节点的IP地址。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">###
</span><span class="c1">## kubernetes kubelet (minion) config
</span><span class="c1">#
</span><span class="c1">## The address for the info server to serve on (set to 0.0.0.0 or &#34;&#34; for all interfaces)
</span><span class="c1"></span><span class="nv">KUBELET_ADDRESS</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--address=172.20.0.113&#34;</span><span class="">
</span><span class=""></span><span class="c1">#
</span><span class="c1">## The port for the info server to serve on
</span><span class="c1">#KUBELET_PORT=&#34;--port=10250&#34;
</span><span class="c1">#
</span><span class="c1">## You may leave this blank to use the actual hostname
</span><span class="c1"></span><span class="nv">KUBELET_HOSTNAME</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--hostname-override=172.20.0.113&#34;</span><span class="">
</span><span class=""></span><span class="c1">#
</span><span class="c1">## location of the api-server
</span><span class="c1"></span><span class="nv">KUBELET_API_SERVER</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--api-servers=http://172.20.0.113:8080&#34;</span><span class="">
</span><span class=""></span><span class="c1">#
</span><span class="c1">## pod infrastructure container
</span><span class="c1"></span><span class="nv">KUBELET_POD_INFRA_CONTAINER</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--pod-infra-container-image=sz-pg-oam-docker-hub-001.tendcloud.com/library/pod-infrastructure:rhel7&#34;</span><span class="">
</span><span class=""></span><span class="c1">#
</span><span class="c1">## Add your own!
</span><span class="c1"></span><span class="nv">KUBELET_ARGS</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--cgroup-driver=systemd --cluster_dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --require-kubeconfig --cert-dir=/etc/kubernetes/ssl --cluster_domain=cluster.local. --hairpin-mode promiscuous-bridge --serialize-image-pulls=false&#34;</span></code></pre>
</div>
<ul>
<li><code>--address</code> 不能设置为 <code>127.0.0.1</code>，否则后续 Pods 访问 kubelet 的 API 接口时会失败，因为 Pods 访问的 <code>127.0.0.1</code> 指向自己而不是 kubelet；</li>
<li>如果设置了 <code>--hostname-override</code> 选项，则 <code>kube-proxy</code> 也需要设置该选项，否则会出现找不到 Node 的情况；</li>
<li><code>--experimental-bootstrap-kubeconfig</code> 指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求；</li>
<li>管理员通过了 CSR 请求后，kubelet 自动在 <code>--cert-dir</code> 目录创建证书和私钥文件(<code>kubelet-client.crt</code> 和 <code>kubelet-client.key</code>)，然后写入 <code>--kubeconfig</code> 文件；</li>
<li>建议在 <code>--kubeconfig</code> 配置文件中指定 <code>kube-apiserver</code> 地址，如果未指定 <code>--api-servers</code> 选项，则必须指定 <code>--require-kubeconfig</code> 选项后才从配置文件中读取 kube-apiserver 的地址，否则 kubelet 启动后将找不到 kube-apiserver (日志中提示未找到 API Server），<code>kubectl get nodes</code> 不会返回对应的 Node 信息;</li>
<li><code>--cluster_dns</code> 指定 kubedns 的 Service IP(可以先分配，后续创建 kubedns 服务时指定该 IP)，<code>--cluster_domain</code> 指定域名后缀，这两个参数同时指定后才会生效；</li>
</ul>

<p>完整 unit 见 <a href="./systemd/kubelet.service">kubelet.service</a></p>

<h3 id="启动kublet">启动kublet</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ systemctl daemon-reload
</span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> kubelet
</span><span class="">$ systemctl start kubelet
</span><span class="">$ systemctl status kubelet</span></code></pre>
</div>
<h3 id="通过-kublet-的-tls-证书请求">通过 kublet 的 TLS 证书请求</h3>

<p>kubelet 首次启动时向 kube-apiserver 发送证书签名请求，必须通过后 kubernetes 系统才会将该 Node 加入到集群。</p>

<p>查看未授权的 CSR 请求</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl get csr
</span><span class="">NAME        AGE       REQUESTOR           CONDITION
</span><span class="">csr-2b308   4m        kubelet-bootstrap   Pending
</span><span class="">$ kubectl get nodes
</span><span class="">No resources found.</span></code></pre>
</div>
<p>通过 CSR 请求</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl certificate approve csr-2b308
</span><span class="">certificatesigningrequest </span><span class="s2">&#34;csr-2b308&#34;</span><span class=""> approved
</span><span class="">$ kubectl get nodes
</span><span class="">NAME        STATUS    AGE       VERSION
</span><span class=""></span><span class="m">10</span><span class="">.64.3.7   Ready     49m       v1.6.1</span></code></pre>
</div>
<p>自动生成了 kubelet kubeconfig 文件和公私钥</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ ls -l /etc/kubernetes/kubelet.kubeconfig
</span><span class="">-rw------- </span><span class="m">1</span><span class=""> root root </span><span class="m">2284</span><span class=""> Apr  </span><span class="m">7</span><span class=""> </span><span class="m">02</span><span class="">:07 /etc/kubernetes/kubelet.kubeconfig
</span><span class="">$ ls -l /etc/kubernetes/ssl/kubelet*
</span><span class="">-rw-r--r-- </span><span class="m">1</span><span class=""> root root </span><span class="m">1046</span><span class=""> Apr  </span><span class="m">7</span><span class=""> </span><span class="m">02</span><span class="">:07 /etc/kubernetes/ssl/kubelet-client.crt
</span><span class="">-rw------- </span><span class="m">1</span><span class=""> root root  </span><span class="m">227</span><span class=""> Apr  </span><span class="m">7</span><span class=""> </span><span class="m">02</span><span class="">:04 /etc/kubernetes/ssl/kubelet-client.key
</span><span class="">-rw-r--r-- </span><span class="m">1</span><span class=""> root root </span><span class="m">1103</span><span class=""> Apr  </span><span class="m">7</span><span class=""> </span><span class="m">02</span><span class="">:07 /etc/kubernetes/ssl/kubelet.crt
</span><span class="">-rw------- </span><span class="m">1</span><span class=""> root root </span><span class="m">1675</span><span class=""> Apr  </span><span class="m">7</span><span class=""> </span><span class="m">02</span><span class="">:07 /etc/kubernetes/ssl/kubelet.key</span></code></pre>
</div>
<h2 id="配置-kube-proxy">配置 kube-proxy</h2>

<p><strong>创建 kube-proxy 的service配置文件</strong></p>

<p>文件路径<code>/usr/lib/systemd/system/kube-proxy.service</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Unit]</span><span class="">
</span><span class=""></span><span class="na">Description</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">Kubernetes Kube-Proxy Server</span><span class="">
</span><span class=""></span><span class="na">Documentation</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">https://github.com/GoogleCloudPlatform/kubernetes</span><span class="">
</span><span class=""></span><span class="na">After</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">network.target</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Service]</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/config</span><span class="">
</span><span class=""></span><span class="na">EnvironmentFile</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">-/etc/kubernetes/proxy</span><span class="">
</span><span class=""></span><span class="na">ExecStart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">/usr/bin/kube-proxy \
</span><span class="s">	    $KUBE_LOGTOSTDERR \
</span><span class="s">	    $KUBE_LOG_LEVEL \
</span><span class="s">	    $KUBE_MASTER \
</span><span class="s">	    $KUBE_PROXY_ARGS</span><span class="">
</span><span class=""></span><span class="na">Restart</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">on-failure</span><span class="">
</span><span class=""></span><span class="na">LimitNOFILE</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">65536</span><span class="">
</span><span class="">
</span><span class=""></span><span class="k">[Install]</span><span class="">
</span><span class=""></span><span class="na">WantedBy</span><span class=""></span><span class="o">=</span><span class=""></span><span class="s">multi-user.target</span></code></pre>
</div>
<p>kube-proxy配置文件<code>/etc/kubernetes/proxy</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">###
</span><span class="c1"># kubernetes proxy config
</span><span class="c1"></span><span class="">
</span><span class=""></span><span class="c1"># default config should be adequate
</span><span class="c1"></span><span class="">
</span><span class=""></span><span class="c1"># Add your own!
</span><span class="c1"></span><span class="nv">KUBE_PROXY_ARGS</span><span class=""></span><span class="o">=</span><span class="s2">&#34;--bind-address=172.20.0.113 --hostname-override=172.20.0.113 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16&#34;</span></code></pre>
</div>
<ul>
<li><code>--hostname-override</code> 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则；</li>
<li>kube-proxy 根据 <code>--cluster-cidr</code> 判断集群内部和外部流量，指定 <code>--cluster-cidr</code> 或 <code>--masquerade-all</code> 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT；</li>
<li><code>--kubeconfig</code> 指定的配置文件嵌入了 kube-apiserver 的地址、用户名、证书、秘钥等请求和认证信息；</li>
<li>预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
</ul>

<p>完整 unit 见 <a href="./systemd/kube-proxy.service">kube-proxy.service</a></p>

<h3 id="启动-kube-proxy">启动 kube-proxy</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ systemctl daemon-reload
</span><span class="">$ systemctl </span><span class="nb">enable</span><span class=""> kube-proxy
</span><span class="">$ systemctl start kube-proxy
</span><span class="">$ systemctl status kube-proxy</span></code></pre>
</div>
<h2 id="验证测试">验证测试</h2>

<p>我们创建一个niginx的service试一下集群是否可用。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ kubectl run nginx --replicas</span><span class="o">=</span><span class="m">2</span><span class=""> --labels</span><span class="o">=</span><span class="s2">&#34;run=load-balancer-example&#34;</span><span class=""> --image</span><span class="o">=</span><span class="">sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9  --port</span><span class="o">=</span><span class="m">80</span><span class="">
</span><span class="">deployment </span><span class="s2">&#34;nginx&#34;</span><span class=""> created
</span><span class="">$ kubectl expose deployment nginx --type</span><span class="o">=</span><span class="">NodePort --name</span><span class="o">=</span><span class="">example-service
</span><span class="">service </span><span class="s2">&#34;example-service&#34;</span><span class=""> exposed
</span><span class="">$ kubectl describe svc example-service
</span><span class="">Name:			example-service
</span><span class="">Namespace:		default
</span><span class="">Labels:			</span><span class="nv">run</span><span class=""></span><span class="o">=</span><span class="">load-balancer-example
</span><span class="">Annotations:		&lt;none&gt;
</span><span class="">Selector:		</span><span class="nv">run</span><span class=""></span><span class="o">=</span><span class="">load-balancer-example
</span><span class="">Type:			NodePort
</span><span class="">IP:			</span><span class="m">10</span><span class="">.254.62.207
</span><span class="">Port:			&lt;unset&gt;	</span><span class="m">80</span><span class="">/TCP
</span><span class="">NodePort:		&lt;unset&gt;	</span><span class="m">32724</span><span class="">/TCP
</span><span class="">Endpoints:		</span><span class="m">172</span><span class="">.30.60.2:80,172.30.94.2:80
</span><span class="">Session Affinity:	None
</span><span class="">Events:			&lt;none&gt;
</span><span class="">$ curl </span><span class="s2">&#34;10.254.62.207:80&#34;</span><span class="">
</span><span class="">&lt;!DOCTYPE html&gt;
</span><span class="">&lt;html&gt;
</span><span class="">&lt;head&gt;
</span><span class="">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span><span class="">&lt;style&gt;
</span><span class="">    body </span><span class="o">{</span><span class="">
</span><span class="">        width: 35em</span><span class="p">;</span><span class="">
</span><span class="">        margin: </span><span class="m">0</span><span class=""> auto</span><span class="p">;</span><span class="">
</span><span class="">        font-family: Tahoma, Verdana, Arial, sans-serif</span><span class="p">;</span><span class="">
</span><span class="">    </span><span class="o">}</span><span class="">
</span><span class="">&lt;/style&gt;
</span><span class="">&lt;/head&gt;
</span><span class="">&lt;body&gt;
</span><span class="">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span><span class="">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span><span class="">working. Further configuration is required.&lt;/p&gt;
</span><span class="">
</span><span class="">&lt;p&gt;For online documentation and support please refer to
</span><span class="">&lt;a </span><span class="nv">href</span><span class=""></span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span><span class="">&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span><span class="">Commercial support is available at
</span><span class="">&lt;a </span><span class="nv">href</span><span class=""></span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span><span class="">&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span><span class="">
</span><span class="">&lt;p&gt;&lt;em&gt;Thank you </span><span class="k">for</span><span class=""> using nginx.&lt;/em&gt;&lt;/p&gt;
</span><span class="">&lt;/body&gt;
</span><span class="">&lt;/html&gt;</span></code></pre>
</div>
<p>访问<code>172.20.0.113:32724</code>或<code>172.20.0.114:32724</code>或者<code>172.20.0.115:32724</code>都可以得到nginx的页面。</p>

<p><img src="http://olz1di9xf.bkt.clouddn.com/kubernetes-installation-test-nginx.png" alt="welcome-nginx" /></p>

            </article>
             
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Tue Apr 11, 2017 </h4>
        <h5 id="wc"> 2100 Words </h5>
        <h5 id="readtime"> Read in about 4 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/kubernetes-kubedns-installation/"><i class="icon-arrow-left"></i> Kubernetes安装之kubedns配置</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/kubernetes-ha-master-installation/">Kubernetes高可用master节点安装 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="2002">
<meta itemprop="datePublished" content="2017-04-11">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubernetes-node-installation/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a> |
            Cloud Native Python comming soon...
    </div>
    <div>
        <p>

        </p>
        <p>Copyright &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name"><a href="https://jimmysong.io/about">Jimmy Song</a></span><span>
                Powered by <a href="https://gohugo.io">Hugo</a> ❤️  &nbsp; </span> <span> Theme <a href="https://themes.gohugo.io/nixon/">nixon</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
