<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="kubectl的用户认证授权 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/blogs/kubectl-user-authentication-authorization/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-08-31"/>
<meta property="article:modified_time" content="2017-08-31"/>



<meta property="article:tag" content="kubernetes">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="kubectl的用户认证授权 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> kubectl的用户认证授权 - jimmysong.io focus on Cloud Native & Big Data </title>
    <link rel="canonical" href="https://jimmysong.io/blogs/kubectl-user-authentication-authorization/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">




<link rel="stylesheet" href="/static/css/syntax.css">


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>





    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>


<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=kubectl%e7%9a%84%e7%94%a8%e6%88%b7%e8%ae%a4%e8%af%81%e6%8e%88%e6%9d%83-https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f&title=kubectl%e7%9a%84%e7%94%a8%e6%88%b7%e8%ae%a4%e8%af%81%e6%8e%88%e6%9d%83&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fblogs%2fkubectl-user-authentication-authorization%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/jimmysongio" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/jimmysongio" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/jimmysongio" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://jimmysongio.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>

    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">kubectl的用户认证授权</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p>当我们安装好集群后，如果想要把 kubectl 命令交给用户使用，就不得不对用户的身份进行认证和对其权限做出限制。</p>

<p>下面以创建一个 devuser 用户并将其绑定到 dev 和 test 两个 namespace 为例说明。</p>

<h2 id="创建-ca-证书和秘钥">创建 CA 证书和秘钥</h2>

<p><strong>创建 devuser-csr.json 文件</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="">
</span><span class="">  </span><span class="nt">&#34;CN&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;devuser&#34;</span><span class="p">,</span><span class="">
</span><span class="">  </span><span class="nt">&#34;hosts&#34;</span><span class="p">:</span><span class=""> </span><span class="p">[],</span><span class="">
</span><span class="">  </span><span class="nt">&#34;key&#34;</span><span class="p">:</span><span class=""> </span><span class="p">{</span><span class="">
</span><span class="">    </span><span class="nt">&#34;algo&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;rsa&#34;</span><span class="p">,</span><span class="">
</span><span class="">    </span><span class="nt">&#34;size&#34;</span><span class="p">:</span><span class=""> </span><span class="mi">2048</span><span class="">
</span><span class="">  </span><span class="p">},</span><span class="">
</span><span class="">  </span><span class="nt">&#34;names&#34;</span><span class="p">:</span><span class=""> </span><span class="p">[</span><span class="">
</span><span class="">    </span><span class="p">{</span><span class="">
</span><span class="">      </span><span class="nt">&#34;C&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;CN&#34;</span><span class="p">,</span><span class="">
</span><span class="">      </span><span class="nt">&#34;ST&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span><span class="">
</span><span class="">      </span><span class="nt">&#34;L&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span><span class="">
</span><span class="">      </span><span class="nt">&#34;O&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;k8s&#34;</span><span class="p">,</span><span class="">
</span><span class="">      </span><span class="nt">&#34;OU&#34;</span><span class="p">:</span><span class=""> </span><span class="s2">&#34;System&#34;</span><span class="">
</span><span class="">    </span><span class="p">}</span><span class="">
</span><span class="">  </span><span class="p">]</span><span class="">
</span><span class=""></span><span class="p">}</span></code></pre>
</div>
<p><strong>生成 CA 证书和私钥</strong></p>

<p>在 <a href="http://jimmysong.io/kubernetes-handbook/practice/create-tls-and-secret-key.html">创建 TLS 证书和秘钥</a> 一节中我们将生成的证书和秘钥放在了所有节点的 <code>/etc/kubernetes/ssl</code> 目录下，下面我们再在 master 节点上为 devuser 创建证书和秘钥，在 <code>/etc/kubernetes/ssl</code> 目录下执行以下命令：</p>

<p>执行该命令前请先确保该目录下已经包含如下文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">ca-key.pem  ca.pem ca-config.json  devuser-csr.json</span></code></pre>
</div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">$ cfssl gencert -ca</span><span class="o">=</span><span class="">ca.pem -ca-key</span><span class="o">=</span><span class="">ca-key.pem -config</span><span class="o">=</span><span class="">ca-config.json -profile</span><span class="o">=</span><span class="">kubernetes devuser-csr.json </span><span class="p">|</span><span class=""> cfssljson -bare devuser
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:54 </span><span class="o">[</span><span class="">INFO</span><span class="o">]</span><span class=""> generate received request
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:54 </span><span class="o">[</span><span class="">INFO</span><span class="o">]</span><span class=""> received CSR
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:54 </span><span class="o">[</span><span class="">INFO</span><span class="o">]</span><span class=""> generating key: rsa-2048
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:55 </span><span class="o">[</span><span class="">INFO</span><span class="o">]</span><span class=""> encoded CSR
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:55 </span><span class="o">[</span><span class="">INFO</span><span class="o">]</span><span class=""> signed certificate with serial number </span><span class="m">43372632012323103879829229080989286813242051309</span><span class="">
</span><span class=""></span><span class="m">2017</span><span class="">/08/31 </span><span class="m">13</span><span class="">:31:55 </span><span class="o">[</span><span class="">WARNING</span><span class="o">]</span><span class=""> This certificate lacks a </span><span class="s2">&#34;hosts&#34;</span><span class=""> field. This makes it unsuitable </span><span class="k">for</span><span class="">
</span><span class="">websites. For more information see the Baseline Requirements </span><span class="k">for</span><span class=""> the Issuance and Management
</span><span class="">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="o">(</span><span class="">https://cabforum.org</span><span class="o">)</span><span class="p">;</span><span class="">
</span><span class="">specifically, section </span><span class="m">10</span><span class="">.2.3 </span><span class="o">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="o">)</span><span class="">.</span></code></pre>
</div>
<p>这将生成如下文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">devuser.csr  devuser-key.pem  devuser.pem</span></code></pre>
</div>
<h2 id="创建-kubeconfig-文件">创建 kubeconfig 文件</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 设置集群参数
</span><span class="c1"></span><span class="nb">export</span><span class=""> </span><span class="nv">KUBE_APISERVER</span><span class=""></span><span class="o">=</span><span class="s2">&#34;https://172.20.0.113:6443&#34;</span><span class="">
</span><span class="">kubectl config set-cluster kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">--certificate-authority</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/ca.pem </span><span class="se">\
</span><span class="se"></span><span class="">--embed-certs</span><span class="o">=</span><span class="nb">true</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">--server</span><span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">--kubeconfig</span><span class="o">=</span><span class="">devuser.kubeconfig
</span><span class="">
</span><span class=""></span><span class="c1"># 设置客户端认证参数
</span><span class="c1"></span><span class="">kubectl config set-credentials devuser </span><span class="se">\
</span><span class="se"></span><span class="">--client-certificate</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/devuser.pem </span><span class="se">\
</span><span class="se"></span><span class="">--client-key</span><span class="o">=</span><span class="">/etc/kubernetes/ssl/devuser-key.pem </span><span class="se">\
</span><span class="se"></span><span class="">--embed-certs</span><span class="o">=</span><span class="nb">true</span><span class=""> </span><span class="se">\
</span><span class="se"></span><span class="">--kubeconfig</span><span class="o">=</span><span class="">devuser.kubeconfig
</span><span class="">
</span><span class=""></span><span class="c1"># 设置上下文参数
</span><span class="c1"></span><span class="">kubectl config set-context kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">--cluster</span><span class="o">=</span><span class="">kubernetes </span><span class="se">\
</span><span class="se"></span><span class="">--user</span><span class="o">=</span><span class="">devuser </span><span class="se">\
</span><span class="se"></span><span class="">--namespace</span><span class="o">=</span><span class="">dev </span><span class="se">\
</span><span class="se"></span><span class="">--kubeconfig</span><span class="o">=</span><span class="">devuser.kubeconfig
</span><span class="">
</span><span class=""></span><span class="c1"># 设置默认上下文
</span><span class="c1"></span><span class="">kubectl config use-context kubernetes --kubeconfig</span><span class="o">=</span><span class="">devuser.kubeconfig</span></code></pre>
</div>
<p>我们现在查看 kubectl 的 context：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">kubectl config get-contexts
</span><span class="">CURRENT   NAME              CLUSTER           AUTHINFO        NAMESPACE
</span><span class="">*         kubernetes        kubernetes        admin
</span><span class="">          default-context   default-cluster   default-admin</span></code></pre>
</div>
<p>显示的用户仍然是 admin，这是因为 kubectl 使用了 <code>$HOME/.kube/config</code> 文件作为了默认的 context 配置，我们只需要将其用刚生成的 <code>devuser.kubeconfig</code> 文件替换即可。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">cp -f ./devuser.kubeconfig /root/.kube/config</span></code></pre>
</div>
<p>关于 kubeconfig 文件的更多信息请参考 <a href="http://jimmysong.io/kubernetes-handbook/guide/authenticate-across-clusters-kubeconfig.html">使用 kubeconfig 文件配置跨集群认证</a>。</p>

<h2 id="clusterrolebinding">ClusterRoleBinding</h2>

<p>如果我们想限制 devuser 用户的行为，需要使用 RBAC 将该用户的行为限制在某个或某几个 namespace 空间范围内，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="">kubectl create rolebinding devuser-admin-binding --clusterrole</span><span class="o">=</span><span class="">admin --user</span><span class="o">=</span><span class="">devuser --namespace</span><span class="o">=</span><span class="">dev
</span><span class="">kubectl create rolebinding devuser-admin-binding --clusterrole</span><span class="o">=</span><span class="">admin --user</span><span class="o">=</span><span class="">devuser --namespace</span><span class="o">=</span><span class="">test</span></code></pre>
</div>
<p>这样 devuser 用户对 dev 和 test 两个 namespace 具有完全访问权限。</p>

<p>让我们来验证以下，现在我们在执行：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 获取当前的 context
</span><span class="c1"></span><span class="">kubectl config get-contexts
</span><span class="">CURRENT   NAME         CLUSTER      AUTHINFO   NAMESPACE
</span><span class="">*         kubernetes   kubernetes   devuser    dev
</span><span class="">*         kubernetes   kubernetes   devuser    </span><span class="nb">test</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 无法访问 default namespace
</span><span class="c1"></span><span class="">kubectl get pods --namespace default
</span><span class="">Error from server </span><span class="o">(</span><span class="">Forbidden</span><span class="o">)</span><span class="">: User </span><span class="s2">&#34;devuser&#34;</span><span class=""> cannot list pods in the namespace </span><span class="s2">&#34;default&#34;</span><span class="">. </span><span class="o">(</span><span class="">get pods</span><span class="o">)</span><span class="">
</span><span class="">
</span><span class=""></span><span class="c1"># 默认访问的是 dev namespace，您也可以重新设置 context 让其默认访问 test namespace
</span><span class="c1"></span><span class="">kubectl get pods
</span><span class="">No resources found.</span></code></pre>
</div>
<p>现在 kubectl 命令默认使用的 context 就是 devuser 了，且该用户只能操作 dev 和 test 这两个 namespace，并拥有完全的访问权限。</p>

<p>关于角色绑定的更多信息请参考 <a href="http://jimmysong.io/kubernetes-handbook/guide/rbac.html">RBAC——基于角色的访问控制</a>。</p>

<p><strong>注意：</strong>本文已归档到 <a href="http://jimmysong.io/kubernetes-handbook">kubernetes-handbook</a>，所有更新请以 handbook 为准。</p>

            </article>
             
            <h2>See Also</h2>
            <ul>
                
                <li><a href="/blogs/migrating-hadoop-yarn-to-kubernetes/">迁移传统应用到Kubernetes步骤详解——以Hadoop YARN为例</a></li>
                
                <li><a href="/blogs/kubernetes-tls-bootstrapping/">Kubernetes TLS bootstrap引导程序</a></li>
                
                <li><a href="/blogs/linkerd-user-guide/">Linkerd 使用指南</a></li>
                
                <li><a href="/blogs/deploy-applications-in-kubernetes/">适用于kubernetes的应用开发与部署流程详解</a></li>
                
                <li><a href="/talks/book-kubernetes-management-design-patterns/">记一本关于kubernetes management design patterns的书</a></li>
                
            </ul>
            
        </div>
    </section>

    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Thu Aug 31, 2017 </h4>
        <h5 id="wc"> 800 Words </h5>
        <h5 id="readtime"> Read in about 2 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/talks/enable-github-pages-https-with-cloudflare/"><i class="icon-arrow-left"></i> 使用Cloudflare为Github Pages博客开启https支持</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/migrating-hadoop-yarn-to-kubernetes/">迁移传统应用到Kubernetes步骤详解——以Hadoop YARN为例 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="https://jimmysong.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://jimmysongio.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/jimmysongio>follow him on twitter</a>.
        </p>
    </section>

</div>

</aside>

<meta itemprop="wordCount" content="777">
<meta itemprop="datePublished" content="2017-08-31">
<meta itemprop="url" content="https://jimmysong.io/blogs/kubectl-user-authentication-authorization/">
 <aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    
    
    
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside> <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook中文指南/实践手册</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构手册</a> |
            <a href="https://istio.doczh.cn/">Istio Service Mesh中文文档</a> |
            <a href="https://jimmysong.io/spark-on-k8s">Spark on Kubernetes</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
</footer>


</body>

</html>

    
