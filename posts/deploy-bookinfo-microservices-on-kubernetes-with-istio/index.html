<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> 在kubernetes集群上安装istio并测试bookinfo示例微服务 - jimmysong.io</title>
  <meta name="description" content="jimmysong.io" />
  <meta property="og:title" content="在kubernetes集群上安装istio并测试bookinfo示例微服务" />
  <meta name="twitter:title" content="在kubernetes集群上安装istio并测试bookinfo示例微服务" />
  <meta name="description" content="本文翻译自istio官方文档">
  <meta property="og:description" content="本文翻译自istio官方文档">
  <meta name="twitter:description" content="本文翻译自istio官方文档">
  <meta name="author" content="{Description { .Site.Author.name }}"/>
  <link href='https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" />
  <meta name="twitter:image" content="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jimmysongio" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/posts/deploy-bookinfo-microservices-on-kubernetes-with-istio/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jimmy Song" />

  <meta name="generator" content="Hugo 0.31-DEV" />
  <link rel="canonical" href="https://jimmysong.io/posts/deploy-bookinfo-microservices-on-kubernetes-with-istio/" />
  <link rel="alternate" href="https://jimmysong.io/index.xml" type="application/rss+xml" title="Jimmy Song">
  <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://jimmysong.io/css/main.css" />
  <link rel="stylesheet" href="https://jimmysong.io/css/search.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  

<meta name="baidu-site-verification" content="g8IYR9SNLF" />
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>

<link rel="stylesheet" href="https://jimmysong.io/css/prism.css" />




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jimmysong.io/">Jimmy Song</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Categories</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/categories/kubernetes">kubernetes</a>
                
                
                  <a href="https://jimmysong.io/categories/cloud-native">Cloud Native</a>
                
                
                  <a href="https://jimmysong.io/categories/microservices">Microservices</a>
                
                
                  <a href="https://jimmysong.io/categories/devops">Devops</a>
                
                
                  <a href="https://jimmysong.io/categories/github">Github</a>
                
                
                  <a href="https://jimmysong.io/categories/docker">Docker</a>
                
                
                  <a href="https://jimmysong.io/categories/code">Code</a>
                
                
                  <a href="https://jimmysong.io/tags">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Books</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-python">Cloud Native Python</a>
                
                
                  <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes handbook</a>
                
                
                  <a href="https://jimmysong.io/hugo-handbook">Hugo Handbook</a>
                
                
                  <a href="http://istio.doczh.cn">Istio service mesh</a>
                
                
                  <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/spark-on-k8s">Spark on kubernetes</a>
                
                
                  <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a>
                
                
                  <a href="https://jimmysong.io/posts/cloudinary-go">Cloudinary go</a>
                
                
                  <a href="https://jimmysong.io/posts/yarn-on-docker">Magpie</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
              
              
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Jimmy Song" href="https://jimmysong.io/">
            <img class="avatar-img" src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" alt="Jimmy Song" />
          </a>
        
      </div>
    </div>

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search jimmysong.io</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>



<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>

<script>
var client = algoliasearch("X4YB3WOBNV", "d2134c5a8d250e6d3246594240c45201");
var index = client.initIndex('rootsongjc-hugo');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://res.cloudinary.com/jimmysong/image/upload/images/20160813015.jpg" data-img-desc-1="Shanghai Pudong Iternational Airport Aug 13,2016"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        
        <div class="container">
          <div class="row">
              <div class="col-lg-12 col-md-12 col-md-offset-0">
                
                <div class="post-heading">
                
                  
                     <h1>在kubernetes集群上安装istio并测试bookinfo示例微服务</h1>
                     
                     
                  
                  
                  
                    
                      <hr class="small">
                      <span class="post-subheading">本文翻译自istio官方文档</span>
                    
                  
                  
                    <span class="post-meta">
  
  Posted on November 6, 2017
  
  
</span>


                  
                
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">在kubernetes集群上安装istio并测试bookinfo示例微服务</h1>
                
                  
                    <h2 align="center" class="posts-subheading">本文翻译自istio官方文档</h2>
                  
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main" itemscope itemtype="http://schema.org/Article">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            
            
<div>
    <section id="datecount">
        <h4 id="date"> Mon Nov 6, 2017</h4>
    </section>
    <h5 id="wc">4500 Words|Read in about 9 Min</h5>
    <h5 id="tags">Tags: 
        
        <a href="https://jimmysong.io/tags/istio/">istio</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/kubernetes/">kubernetes</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/microservices/">microservices</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/cloud-native/">cloud-native</a> &nbsp;
    </h5>
</div>

            
            <article role="main" class="blog-post" itemprop="articleBody" id="content">
                

<p>今年来以 <a href="https://istio.io">Istio</a> 和 <a href="https://linkerd.io">Linkderd</a> 为代表的 Service Mesh 蓬勃发展，大有成为下一代语言异构微服务架构的王者之范，今天又碰巧看到了 Red Hat 的 <a href="https://twitter.com/burrsutter">Burr Sutter</a> 提出了<strong>8 Steps to Becoming Awesome with Kubernetes</strong>，整个PPT一共60多页，很有建设性，<a href="https://github.com/rootsongjc/cloud-native-slides-share/blob/master/kubernetes/8-Steps-to-Becoming-Awesome-with-Kubernetes-readhat-burrsutter.pdf">点此</a>跳转到我的GitHub上下载，我将其归档到<a href="https://github.com/rootsongjc/cloud-native-slides-share">cloud-native-slides-share</a>中了。</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/polyglot-microservices-serivce-mesh.png" alt="下一代异构微服务架构" /></p>

<p>自我6月份初接触Istio依赖就发觉service mesh很好的解决了异构语言中的很多问题，而且是kuberentes service 上层不可或缺的服务间代理。关于istio的更多内容请参考 <a href="http://istio.doczh.cn">istio中文文档</a>。</p>

<h1 id="快速开始">快速开始</h1>

<h2 id="前置条件">前置条件</h2>

<p>下面的操作说明需要您可以访问 kubernetes <strong>1.7.3 后更高版本</strong> 的集群，并且启用了 <a href="https://kubernetes.io/docs/admin/authorization/rbac/">RBAC (基于角色的访问控制)</a>。您需要安装了 <strong>1.7.3 或更高版本</strong> 的 <code>kubectl</code> 命令。如果您希望启用 <a href="http://istio.doczh.cn/docs/setup/kubernetes/sidecar-injection.html#自动注入-sidecar">自动注入 sidecar</a>，您需要启用 kubernetes 集群的 alpha 功能。</p>

<blockquote>
<p>注意：如果您安装了 Istio 0.1.x，在安装新版本前请先 <a href="http://istio.doczh.cn/docs/setup/kubernetes/quick-start.html#卸载">卸载</a> 它们（包括已启用 Istio 应用程序 Pod 中的 sidecar）。</p>
</blockquote>

<ul>
<li><p>取决于您的 kubernetes 提供商：</p>

<ul>
<li><p>本地安装 Istio，安装最新版本的 <a href="https://kubernetes.io/docs/getting-started-guides/minikube/">Minikube</a> (version 0.22.1 或者更高)。</p></li>

<li><p><a href="https://cloud.google.com/container-engine">Google Container Engine</a></p></li>

<li><p>使用 kubectl 获取证书 （使用您自己的集群的名字替换 <code>&lt;cluster-name&gt;</code> ，使用集群实际所在的位置替换 <code>&lt;zone&gt;</code> ）：</p></li>
</ul>

<pre><code class="language-bash">  gcloud container clusters get-credentials &lt;cluster-name&gt; --zone &lt;zone&gt; --project &lt;project-name&gt;
</code></pre>

<ul>
<li>将集群管理员权限授予当前用户（需要管理员权限才能为Istio创建必要的RBAC规则）：</li>
</ul>

<pre><code class="language-bash">  kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --user=$(gcloud config get-value core/account)
</code></pre>

<ul>
<li><p><a href="https://www.ibm.com/cloud-computing/bluemix/containers">IBM Bluemix Container Service</a></p></li>

<li><p>使用 kubectl 获取证书 （使用您自己的集群的名字替换）：</p></li>
</ul>

<pre><code class="language-bash">  &lt;cluster-name&gt;
</code></pre>

<pre><code class="language-bash">  $(bx cs cluster-config &lt;cluster-name&gt;|grep &quot;export KUBECONFIG&quot;)
</code></pre>

<ul>
<li><p><a href="https://www.openshift.org/">Openshift Origin</a> 3.7 或者以上版本：</p></li>

<li><p>默认情况下，Openshift 不允许以 UID 0运行容器。为 Istio 的入口（ingress）和出口（egress）service account 启用使用UID 0运行的容器：</p></li>
</ul>

<pre><code class="language-bash">  oc adm policy add-scc-to-user anyuid -z istio-ingress-service-account -n istio-system
  oc adm policy add-scc-to-user anyuid -z istio-egress-service-account -n istio-system
  oc adm policy add-sc-to-user anyuid -z default -n istio-system
</code></pre>

<ul>
<li>运行应用程序 Pod 的 service account 需要特权安全性上下文限制，以此作为 sidecar 注入的一部分:</li>
</ul>

<pre><code class="language-bash">  oc adm policy add-scc-to-user privileged -z default -n &lt;target-namespace&gt;
</code></pre></li>

<li><p>安装或升级 Kubernetes 命令行工具 <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> 以匹配您的集群版本（1.7或以上版本）。</p></li>
</ul>

<h2 id="安装步骤">安装步骤</h2>

<p>不论对于哪个 Istio 发行版，都安装到 <code>istio-system</code> namespace 下，即可以管理所有其它 namespace 下的微服务。</p>

<ol>
<li>到 <a href="https://github.com/istio/istio/releases">Istio release</a> 页面上，根据您的操作系统下载对应的发行版。如果您使用的是 MacOS 或者 Linux 系统，可以使用下面的额命令自动下载和解压最新的发行版：</li>
</ol>

<pre><code class="language-bash">   curl -L https://git.io/getLatestIstio | sh -
</code></pre>

<ol>
<li><p>解压安装文件，切换到文件所在目录。安装文件目录下包含：</p>

<ul>
<li><code>install/</code> 目录下是 kubernetes 使用的 <code>.yaml</code> 安装文件</li>
<li><code>samples/</code> 目录下是示例程序</li>
<li><code>istioctl</code> 客户端二进制文件在 <code>bin</code> 目录下。<code>istioctl</code> 文件用户手动注入 Envoy sidecar 代理、创建路由和策略等。</li>
<li><code>istio.VERSION</code> 配置文件</li>
</ul></li>

<li><p>切换到 istio 包的解压目录。例如 istio-0.2.7：</p></li>
</ol>

<pre><code class="language-bash">   cd istio-0.2.7
</code></pre>

<ol>
<li>将 <code>istioctl</code> 客户端二进制文件加到 PATH 中。</li>
</ol>

<p>例如，在 MacOS 或 Linux 系统上执行下面的命令：</p>

<pre><code class="language-bash">   export PATH=$PWD/bin:$PATH
</code></pre>

<ol>
<li>安装 Istio 的核心部分。选择面两个 <strong>互斥</strong> 选项中的之一：</li>
</ol>

<p>a) 安装 Istio 的时候不启用 sidecar 之间的 <a href="http://istio.doczh.cn/docs/concepts/security/mutual-tls.md">TLS 交互认证</a>：</p>

<p>为具有现在应用程序的集群选择该选项，使用 Istio sidecar 的服务需要能够与非 Istio Kubernetes 服务以及使用 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">liveliness 和 readiness 探针</a>、headless service 和 StatefulSet 的应用程序通信。</p>

<pre><code class="language-bash">   kubectl apply -f install/kubernetes/istio.yaml
</code></pre>

<p><strong>或者</strong></p>

<p>b) 安装 Istio 的时候启用 sidecar 之间的 <a href="http://istio.doczh.cn/docs/concepts/security/mutual-tls.md">TLS 交互认证</a>：</p>

<pre><code class="language-bash">   kubectl apply -f install/kubernetes/istio-auth.yaml
</code></pre>

<p>这两个选项都会创建 <code>istio-system</code> 命名空间以及所需的 RBAC 权限，并部署 Istio-Pilot、Istio-Mixer、Istio-Ingress、Istio-Egress 和 Istio-CA（证书颁发机构）。</p>

<ol>
<li>*可选的*：如果您的 kubernetes 集群开启了 alpha 功能，并想要启用 <a href="http://istio.doczh.cn/docs/setup/kubernetes/sidecar-injection.html#automatic-sidecar-injection">自动注入 sidecar</a>，需要安装 Istio-Initializer：</li>
</ol>

<pre><code class="language-bash">   kubectl apply -f install/kubernetes/istio-initializer.yaml
</code></pre>

<h2 id="验证安装">验证安装</h2>

<ol>
<li>确认系列 kubernetes 服务已经部署了： <code>istio-pilot</code>、 <code>istio-mixer</code>、<code>istio-ingress</code>、 <code>istio-egress</code>：</li>
</ol>

<pre><code class="language-bash">   kubectl get svc -n istio-system
</code></pre>

<pre><code class="language-bash">   NAME            CLUSTER-IP      EXTERNAL-IP       PORT(S)                       AGE
   istio-egress    10.83.247.89    &lt;none&gt;            80/TCP                        5h
   istio-ingress   10.83.245.171   35.184.245.62     80:32730/TCP,443:30574/TCP    5h
   istio-pilot     10.83.251.173   &lt;none&gt;            8080/TCP,8081/TCP             5h
   istio-mixer     10.83.244.253   &lt;none&gt;            9091/TCP,9094/TCP,42422/TCP   5h
</code></pre>

<p>注意：如果您运行的集群不支持外部负载均衡器（如 minikube）， <code>istio-ingress</code> 服务的 <code>EXTERNAL-IP</code> 显示<code>&lt;pending&gt;</code>。你必须改为使用 NodePort service 或者 端口转发方式来访问应用程序。</p>

<ol>
<li>确人对应的 Kubernetes pod 已部署并且所有的容器都启动并运行： <code>istio-pilot-*</code>、 <code>istio-mixer-*</code>、 <code>istio-ingress-*</code>、 <code>istio-egress-*</code>、<code>istio-ca-*</code>， <code>istio-initializer-*</code> 是可以选的。</li>
</ol>

<pre><code class="language-bash">   kubectl get pods -n istio-system
</code></pre>

<pre><code class="language-bash">   istio-ca-3657790228-j21b9           1/1       Running   0          5h
   istio-egress-1684034556-fhw89       1/1       Running   0          5h
   istio-ingress-1842462111-j3vcs      1/1       Running   0          5h
   istio-initializer-184129454-zdgf5   1/1       Running   0          5h
   istio-pilot-2275554717-93c43        1/1       Running   0          5h
   istio-mixer-2104784889-20rm8        2/2       Running   0          5h
</code></pre>

<h2 id="部署应用">部署应用</h2>

<p>您可以部署自己的应用或者示例应用程序如 <a href="http://istio.doczh.cn/docs/guides/bookinfo.html">BookInfo</a>。 注意：应用程序必须使用 HTTP/1.1 或 HTTP/2.0 协议来传递 HTTP 流量，因为 HTTP/1.0 已经不再支持。</p>

<p>如果您启动了 <a href="http://istio.doczh.cn/docs/setup/kubernetes/sidecar-injection.html">Istio-Initializer</a>，如上所示，您可以使用 <code>kubectl create</code> 直接部署应用。Istio-Initializer 会向应用程序的 pod 中自动注入 Envoy 容器：</p>

<pre><code class="language-bash">kubectl create -f &lt;your-app-spec&gt;.yaml
</code></pre>

<p>如果您没有安装 Istio-initializer 的话，您必须使用 <a href="http://istio.doczh.cn/docs/reference/commands/istioctl.md#istioctl-kube-inject">istioctl kube-inject</a> 命令在部署应用之前向应用程序的 pod 中手动注入 Envoy 容器：</p>

<pre><code class="language-bash">kubectl create -f &lt;(istioctl kube-inject -f &lt;your-app-spec&gt;.yaml)
</code></pre>

<h2 id="卸载">卸载</h2>

<ul>
<li>卸载 Istio initializer:</li>
</ul>

<p>如果您安装 Isto 的时候启用了 initializer，请卸载它：</p>

<pre><code class="language-bash">  kubectl delete -f install/kubernetes/istio-initializer.yaml
</code></pre>

<ul>
<li>卸载 Istio 核心组件。对于某一 Istio 版本，删除 RBAC 权限，<code>istio-system</code> namespace，和该命名空间的下的各层级资源。</li>
</ul>

<p>不必理会在层级删除过程中的各种报错，因为这些资源可能已经被删除的。</p>

<p>a) 如果您在安装 Istio 的时候关闭了 TLS 交互认证：</p>

<pre><code class="language-bash">   kubectl delete -f install/kubernetes/istio.yaml
</code></pre>

<p><strong>或者</strong></p>

<p>b) 如果您在安装 Istio 的时候启用到了 TLS 交互认证：</p>

<pre><code class="language-bash">   kubectl delete -f install/kubernetes/istio-auth.yaml
</code></pre>

<h1 id="安装-istio-sidecar">安装 Istio Sidecar</h1>

<h2 id="pod-spec-需满足的条件">Pod Spec 需满足的条件</h2>

<p>为了成为 Service Mesh 中的一部分，kubernetes 集群中的每个 Pod 都必须满足如下条件：</p>

<ol>
<li><strong>Service 注解</strong>：每个 pod 都必须只属于某<strong>一个</strong> <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes Service</a> （当前不支持一个 pod 同时属于多个 service）。</li>
<li><strong>命名的端口</strong>：Service 的端口必须命名。端口的名字必须遵循如下格式 <code>&lt;protocol&gt;[-&lt;suffix&gt;]</code>，可以是http、http2、 grpc、 mongo、 或者 redis 作为 <code>&lt;protocol&gt;</code> ，这样才能使用 Istio 的路由功能。例如<code>name: http2-foo</code> 和 <code>name: http</code> 都是有效的端口名称，而 <code>name: http2foo</code> 不是。如果端口的名称是不可识别的前缀或者未命名，那么该端口上的流量就会作为普通的 TCP 流量（除非使用 <code>Protocol: UDP</code> 明确声明使用 UDP 端口）。</li>
<li><strong>带有 app label 的 Deployment</strong>：我们建议 kubernetes 的<code>Deploymenet</code> 资源的配置文件中为 Pod 明确指定 <code>app</code> label。每个Deployment 的配置中都需要有个不同的有意义的 <code>app</code> 标签。<code>app</code> label 用于在分布式坠重中添加上下文信息。</li>
<li><strong>Mesh 中的每个 pod 里都有一个 Sidecar</strong>： 最后，Mesh 中的每个 pod 都必须运行与 Istio 兼容的sidecar。遗爱部分介绍了将 sidecar 注入到 pod 中的两种方法：使用<code>istioctl</code> 命令行工具手动注入，或者使用 istio initializer 自动注入。注意 sidecar 不涉及到容器间的流量，因为他们都在同一个 pod 中。</li>
</ol>

<p>TBD</p>

<hr />

<h2 id="部署-bookinfo-示例应用">部署 bookinfo 示例应用</h2>

<p>该示例部署由四个单独的微服务组成的简单应用程序，用于演示Istio服务网格的各种功能。</p>

<h2 id="概况">概况</h2>

<p>在本示例中，我们将部署一个简单的应用程序，显示书籍的信息，类似于网上书店的书籍条目。在页面上有书籍的描述、详细信息（ISBN、页数等）和书评。</p>

<p>BookInfo 应用程序包括四个独立的微服务：</p>

<ul>
<li>productpage：productpage(产品页面)微服务，调用 <em>details</em> 和 <em>reviews</em> 微服务来填充页面。</li>
<li>details：details 微服务包含书籍的详细信息。</li>
<li>reviews：reviews 微服务包含书籍的点评。它也调用 <em>ratings</em> 微服务。</li>
<li>ratings：ratings 微服务包含随书评一起出现的评分信息。</li>
</ul>

<p>有3个版本的 reviews 微服务：</p>

<ul>
<li>版本v1不调用 ratings 服务。</li>
<li>版本v2调用 ratings ，并将每个评级显示为1到5个黑色星。</li>
<li>版本v3调用 ratings ，并将每个评级显示为1到5个红色星。</li>
</ul>

<p>应用程序的端到端架构如下所示。</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/noistio.png" alt="BookInfo Application without Istio" /></p>

<p>该应用程序是多语言构建的，即这些微服务是用不同的语言编写的。值得注意的是，这些服务与 Istio 没有任何依赖关系，单这是个有趣的 Service Mesh 示例，特别是因为评论服务和众多的语言和版本。</p>

<h2 id="开始之前">开始之前</h2>

<p>如果您还没有这样做，请按照与您的平台 <a href="http://istio.doczh.cn/docs/setup/index.md">安装指南</a> 对应的说明安装Istio。</p>

<h2 id="部署应用程序">部署应用程序</h2>

<p>使用 Istio 运行应用程序示例不需要修改应用程序本身。相反，我们只需要在支持 Istio 的环境中配置和运行服务， Envoy sidecar 将会注入到每个服务中。所需的命令和配置根据运行时环境的不同而有所不同，但在所有情况下，生成的部署将如下所示：</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/noistio.png" alt="BookInfo Application without Istio" /></p>

<p>所有的微服务都将与一个 Envoy sidecar 一起打包，拦截这些服务的入站和出站的调用请求，提供通过 Istio 控制平面从外部控制整个应用的路由，遥测收集和策略执行所需的 hook。</p>

<p>要启动该应用程序，请按照以下对应于您的 Istio 运行时环境的说明进行操作。</p>

<h3 id="在-kubernetes-中运行">在 Kubernetes 中运行</h3>

<blockquote>
<p>注意：如果您使用 GKE，清确保您的集群至少有 4 个标准的 GKE 节点。如果您使用 Minikube，请确保您至少有 4GB 内存。</p>
</blockquote>

<ol>
<li><p>将目录更改为 Istio 安装目录的根目录。</p></li>

<li><p>构建应用程序容器：</p></li>
</ol>

<p>如果您使用 <strong>自动注入 sidecar</strong> 的方式部署的集群，那么只需要使用 <code>kubectl</code> 命令部署服务：</p>

<pre><code class="language-bash">   kubectl apply -f samples/bookinfo/kube/bookinfo.yaml
</code></pre>

<p>如果您使用 <strong>手动注入 sidecar</strong> 的方式部署的集群，清使用下面的命令：</p>

<pre><code class="language-bash">   kubectl apply -f &lt;(istioctl kube-inject -f samples/apps/bookinfo/bookinfo.yaml)
</code></pre>

<p>请注意，该 <code>istioctl kube-inject</code> 命令用于在创建部署之前修改 <code>bookinfo.yaml</code> 文件。这将把 Envoy 注入到 Kubernetes 资源。</p>

<p>上述命令启动四个微服务并创建网关入口资源，如下图所示。3 个版本的评论的服务 v1、v2、v3 都已启动。</p>

<blockquote>
<p>请注意在实际部署中，随着时间的推移部署新版本的微服务，而不是同时部署所有版本。</p>
</blockquote>

<ol>
<li>确认所有服务和 pod 已正确定义并运行：</li>
</ol>

<pre><code class="language-bash">   kubectl get services
</code></pre>

<p>这将产生以下输出：</p>

<pre><code class="language-bash">   NAME                       CLUSTER-IP   EXTERNAL-IP   PORT(S)              AGE
   details                    10.0.0.31    &lt;none&gt;        9080/TCP             6m
   istio-ingress              10.0.0.122   &lt;pending&gt;     80:31565/TCP         8m
   istio-pilot                10.0.0.189   &lt;none&gt;        8080/TCP             8m
   istio-mixer                10.0.0.132   &lt;none&gt;        9091/TCP,42422/TCP   8m
   kubernetes                 10.0.0.1     &lt;none&gt;        443/TCP              14d
   productpage                10.0.0.120   &lt;none&gt;        9080/TCP             6m
   ratings                    10.0.0.15    &lt;none&gt;        9080/TCP             6m
   reviews                    10.0.0.170   &lt;none&gt;        9080/TCP             6m
</code></pre>

<p>而且</p>

<pre><code class="language-bash">   kubectl get pods
</code></pre>

<p>将产生:</p>

<pre><code class="language-bash">   NAME                                        READY     STATUS    RESTARTS   AGE
   details-v1-1520924117-48z17                 2/2       Running   0          6m
   istio-ingress-3181829929-xrrk5              1/1       Running   0          8m
   istio-pilot-175173354-d6jm7                 2/2       Running   0          8m
   istio-mixer-3883863574-jt09j                2/2       Running   0          8m
   productpage-v1-560495357-jk1lz              2/2       Running   0          6m
   ratings-v1-734492171-rnr5l                  2/2       Running   0          6m
   reviews-v1-874083890-f0qf0                  2/2       Running   0          6m
   reviews-v2-1343845940-b34q5                 2/2       Running   0          6m
   reviews-v3-1813607990-8ch52                 2/2       Running   0          6m
</code></pre>

<h1 id="确定-ingress-ip-和端口">确定 ingress IP 和端口</h1>

<ol>
<li>如果您的 kubernetes 集群环境支持外部负载均衡器的话，可以使用下面的命令获取 ingress 的IP地址：</li>
</ol>

<pre><code class="language-bash">   kubectl get ingress -o wide
</code></pre>

<p>输出如下所示：</p>

<pre><code class="language-bash">   NAME      HOSTS     ADDRESS                 PORTS     AGE
   gateway   *         130.211.10.121          80        1d
</code></pre>

<p>Ingress 服务的地址是：</p>

<pre><code class="language-bash">   export GATEWAY_URL=130.211.10.121:80
</code></pre>

<ol>
<li>GKE：如果服务无法获取外部 IP，<code>kubectl get ingress -o wide</code> 会显示工作节点的列表。在这种情况下，您可以使用任何地址以及 NodePort 访问入口。但是，如果集群具有防火墙，则还需要创建防火墙规则以允许TCP流量到NodePort，您可以使用以下命令创建防火墙规则：</li>
</ol>

<pre><code class="language-bash">   export GATEWAY_URL=&lt;workerNodeAddress&gt;:$(kubectl get svc istio-ingress -n istio-system -o jsonpath='{.spec.ports[0].nodePort}')
   gcloud compute firewall-rules create allow-book --allow tcp:$(kubectl get svc istio-ingress -n istio-system -o jsonpath='{.spec.ports[0].nodePort}')
</code></pre>

<ol>
<li>IBM Bluemix Free Tier：在免费版的 Bluemix 的 kubernetes 集群中不支持外部负载均衡器。您可以使用工作节点的公共 IP，并通过 NodePort 来访问 ingress。工作节点的公共 IP可以通过如下命令获取：</li>
</ol>

<pre><code class="language-bash">   bx cs workers &lt;cluster-name or id&gt;
   export GATEWAY_URL=&lt;public IP of the worker node&gt;:$(kubectl get svc istio-ingress -n istio-system -o jsonpath='{.spec.ports[0].nodePort}')
</code></pre>

<ol>
<li>Minikube：Minikube 不支持外部负载均衡器。您可以使用 ingress 服务的主机 IP 和 NodePort 来访问 ingress：</li>
</ol>

<pre><code class="language-bash">   export GATEWAY_URL=$(kubectl get po -l istio=ingress -o 'jsonpath={.items[0].status.hostIP}'):$(kubectl get svc istio-ingress -o 'jsonpath={.spec.ports[0].nodePort}')
</code></pre>

<h3 id="在-consul-或-eureka-环境下使用-docker-运行">在 Consul 或 Eureka 环境下使用 Docker 运行</h3>

<ol>
<li><p>切换到 Istio 的安装根目录下。</p></li>

<li><p>启动应用程序容器。</p>

<ol>
<li>执行下面的命令测试 Consul：</li>
</ol>

<pre><code class="language-bash">   docker-compose -f samples/bookinfo/consul/bookinfo.yaml up -d
</code></pre>

<ol>
<li>执行下面的命令测试 Eureka：</li>
</ol>

<pre><code class="language-bash">   docker-compose -f samples/bookinfo/eureka/bookinfo.yaml up -d
</code></pre></li>

<li><p>确认所有容器都在运行：</p></li>
</ol>

<pre><code class="language-bash">   docker ps -a
</code></pre>

<blockquote>
<p>如果 Istio Pilot 容器终止了，重新执行上面的命令重新运行。</p>
</blockquote>

<ol>
<li>设置 <code>GATEWAY_URL</code>:</li>
</ol>

<pre><code class="language-bash">   export GATEWAY_URL=localhost:9081
</code></pre>

<h2 id="下一步">下一步</h2>

<p>使用以下 <code>curl</code> 命令确认 BookInfo 应用程序正在运行:</p>

<pre><code class="language-bash">curl -o /dev/null -s -w &quot;%{http_code}\n&quot; http://${GATEWAY_URL}/productpage
</code></pre>

<pre><code class="language-bash">200
</code></pre>

<p>你也可以通过在浏览器中打开 <code>http://$GATEWAY_URL/productpage</code> 页面访问 Bookinfo 网页。如果您多次刷新浏览器将在 productpage 中看到评论的不同的版本，它们会按照 round robin（红星、黑星、没有星星）的方式展现，因为我们还没有使用 Istio 来控制版本的路由。</p>

<p>现在，您可以使用此示例来尝试 Istio 的流量路由、故障注入、速率限制等功能。要继续的话，请参阅 <a href="http://istio.doczh.cn/docs/guides/index.md">Istio 指南</a>，具体取决于您的兴趣。<a href="http://istio.doczh.cn/docs/guides/intelligent-routing.md">智能路由</a> 是初学者入门的好方式。</p>

<h2 id="清理">清理</h2>

<p>在完成 BookInfo 示例后，您可以卸载它，如下所示：</p>

<h3 id="卸载-kubernetes-环境">卸载 Kubernetes 环境</h3>

<ol>
<li>删除路由规则，终止应用程序 pod</li>
</ol>

<pre><code class="language-bash">   samples/bookinfo/kube/cleanup.sh
</code></pre>

<ol>
<li>确认关闭</li>
</ol>

<pre><code class="language-bash">   istioctl get routerules   #-- there should be no more routing rules
   kubectl get pods          #-- the BookInfo pods should be deleted
</code></pre>

<h3 id="卸载-docker-环境">卸载 docker 环境</h3>

<ol>
<li><p>删除路由规则和应用程序容器</p>

<ol>
<li>若使用 Consul 环境安装，执行下面的命令：</li>
</ol>

<pre><code class="language-bash">  samples/bookinfo/consul/cleanup.sh
</code></pre>

<ol>
<li>若使用 Eureka 环境安装，执行下面的命令：</li>
</ol>

<pre><code class="language-bash">  samples/bookinfo/eureka/cleanup.sh
</code></pre></li>

<li><p>确认清理完成：</p></li>
</ol>

<pre><code class="language-bash">   istioctl get routerules   #-- there should be no more routing rules
   docker ps -a              #-- the BookInfo containers should be deleted
</code></pre>

            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://jimmysong.io/posts/kubectl-cheatsheet/" data-toggle="tooltip" data-placement="top" title="Kubectl Cheatsheet">&larr; Previous Post</a>
                </li>
                 
            </ul>
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li><a href="/posts/istio-installation/">微服务管理框架service mesh——Istio安装试用笔记</a></li>
                    
                    <li><a href="/posts/keuc-china-2017/">记Kubernetes中国用户大会KEUC2017</a></li>
                    
                    <li><a href="/posts/kubernetes-and-cloud-native-app-overview/">Kubernetes与云原生应用概览</a></li>
                    
                    <li><a href="/posts/istio-service-mesh-doc-zh/">Istio Service Mesh官方文档中文版</a></li>
                    
                    <li><a href="/posts/creating-cloud-native-app-with-kubernetes/">如何开发部署kubernetes native应用</a></li>
                    
                </ul>
                
            </div>
            
            
            
<div>
    <section id="datecount">
        <h4 id="date"> Mon Nov 6, 2017</h4>
    </section>
    <h5 id="wc">4500 Words|Read in about 9 Min</h5>
    <h5 id="tags">Tags: 
        
        <a href="https://jimmysong.io/tags/istio/">istio</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/kubernetes/">kubernetes</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/microservices/">microservices</a> &nbsp;
        
        <a href="https://jimmysong.io/tags/cloud-native/">cloud-native</a> &nbsp;
    </h5>
</div>

            
            </div>
            
            
                
                 <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<aside id=comments>
    <div>
        <h2> Comments </h2>
    </div>
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    
    <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rootsongjc', 
            repo: 'rootsongjc.github.io', 
            oauth: {
                client_id: '93a0df08e0f93ff0c8a3',
                client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
            },
        })
        gitment.render('container')
    </script>
</aside>
</div>

                
            
        </div>
    </div>
    </section>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:rootsongjc@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/jimmysongio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rootsongjc" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/jimmysongio" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/jimmysongio" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017
          
            
              Jimmy Song
                      
          
          
          
            &nbsp;&bull;&nbsp;
            <a href="https://jimmysong.io/">Jimmy Song</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.31-DEV</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>


<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/bootstrap.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe-ui-default.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/auto-render.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/main.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/prism.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/katex.min.js"></script>
<script> renderMathInElement(document.body); </script>







  </body>
</html>

