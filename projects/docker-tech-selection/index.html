<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="docker, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Docker技术选型 : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://jimmysong.io/projects/docker-tech-selection/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-08"/>
<meta property="article:modified_time" content="2017-03-08"/>



<meta property="article:tag" content="docker">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Docker技术选型 : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="https://jimmysong.io/">
    <title> Docker技术选型 - Jimmy Song </title>
    <link rel="canonical" href="https://jimmysong.io/projects/docker-tech-selection/"> <link rel="stylesheet" href="https://jimmysong.io/static/css/style.css">


<link href="https://jimmysong.io/static/css/prism.css" rel="stylesheet" />
<script type="text/javascript" src="https://jimmysong.io/static/js/prism.js"></script>


<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>




    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
    <ul id="mainnav">
    <li>
        <a href="/blogs/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blogs </span>
        </a>
    </li>
    <li>
        <a href="/projects/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> projects </span>
        </a>
    </li>
    <li>
        <a href="/talks/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://www.linkedin.com/in/rootsongjc">
            <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
            <span> me </span>
        </a>
    </li>
</ul>
    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Docker%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b-https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f&title=Docker%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=https%3a%2f%2fjimmysong.io%2fprojects%2fdocker-tech-selection%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="豆瓣" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="图虫" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Docker技术选型</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<h2 id="回顾历史">回顾历史</h2>

<blockquote>
<p><em>多少次我回过头看看走过的路，你还在小村旁。</em></p>
</blockquote>

<p>去年基于docker1.11对Hadoop yarn进行了docker化改造，详情请看<a href="https://rootsongjc.github.io/docker-practice/docs/td_yarn_on_docker.html">大数据集群虚拟化-Yarn on docker始末</a>，我将这个事件命名为<a href="https://github.com/rootsongjc/magpie">magpie</a>，因为它就像是喜鹊一样收集着各种各样的资源搭建自己的小窝。<strong>magpie</strong>还是有很多事情可以做的，大数据集群的虚拟化也不会止步，它仅仅是对其做了初步的探索，对于资源利用率和管理方面的优化还有很长的路要走，<strong>Yarn</strong>本身就是做为大数据集群的资源管理调度角色出现的，一开始是为调度<strong>MapReduce</strong>，后来的<code>spark</code>、<code>hive</code>、<code>tensrflow</code>、<code>HAWQ</code>、<code>slide</code>等等不一而足陆续出现。但是用它来管理docker似乎还是有点过重，还不如用kubernetes、marathon、nomad、swarm等。</p>

<p>但是在微服务方面docker1.11的很多弊端或者说缺点就暴露了出来，首先docker1.11原生并不带cluster管理，需要配合·<code>docker swarm</code>、<code>kubernetes</code>、<code>marathon</code>等才能管理docker集群。<u>之前的对于docker的使用方式基本就是按照虚拟机的方式使用的，固定IP有悖于微服务的原则。</u></p>

<p>我们基于docker1.11和<a href="github.com/talkingdata/shrike">shrike</a>二层网络模式，还有<a href="https://github.com/shipyard/shipyard">shipyard</a>来做集群管理，shipyard只是一个简单的docker集群管理的WebUI，基本都是调用docker API，唯一做了一点docker原生没有的功能就是<strong>scale</strong>容器，而且只支持到docker1.11，早已停止开发。我抛弃了<strong>shipyard</strong>，它的页面功能基本可有可无，我自己开发的<a href="https://github.com/rootsongjc/magpie">magpie</a>一样可以管理<code>yarn on docker</code>集群。</p>

<p><strong>Docker Swarm有如下几个缺点</strong></p>

<ol>
<li>对于大规模集群的管理效率太低，当管理上百个node的时候经常出现有节点状态不同步的问题，比如主机重启后容器已经<strong>Exited</strong>了，但是master让然认为是<strong>Running</strong>状态，必须重启所有master节点才行。</li>
<li>没有中心化Node管理功能，必须登录到每台node上手动启停<code>swarm-agent</code>。</li>
<li>集群管理功能实在<strong>太太太</strong>简陋，查看所有node状态只能用<code>docker info</code>而且那个格式就不提了，shipyard里有处理这个格式的代码，我copy到了magpie里，彻底抛弃shipyard了。</li>
<li>Docker swarm的集群管理概念缺失，因为docker一开始设计的时候就不是用来管理集群的，所以出现了swarm，但是只能使用<strong>docker-compose</strong>来编排服务，但是无法在swarm集群中使用我们自定义的<strong>mynet</strong>网络，<a href="https://github.com/docker/compose/issues/4233">compose issue-4233</a>，<strong>compose</strong>也已经被docker官方废弃（最近一年docker发展的太快了，原来用python写的compose已经被用go重构为<strong>libcompose</strong>直接集成到swarm mode里了），而且docker1.11里也没有像kubernetes那样<code>service</code>的单位，在docker1.11所有的管理都是基于docker容器的。</li>
</ol>

<p>Docker Swarm的问题也是shipyard的问题，谁让shipyard直接调用docker的API呢。当然，在后续版本的docker里以上问题都已经不是问题，docker已经越来越像kubernetes，不论是在设计理念上还是在功能上，甚至还发行了企业版，以后每个月发布一个版本。</p>

<h2 id="技术选型">技术选型</h2>

<p>主要对比<code>Docker1.11</code>和<code>Docker17.03-ce</code>版本。</p>

<p>首先有一点需要了解的是，docker1.12+带来的<a href="https://rootsongjc.github.io/docker-practice/docs/swarm_mode.html">swarm mode</a>，你可以使用一个命令直接启动一个复杂的<strong>stack</strong>，其中包括了服务编排和所有的服务配置，这是一个<a href="https://rootsongjc.github.io/docker-practice/docs/create_swarm_app.html">投票应用的例子</a>。</p>

<p>下表对比了docker1.11和docker17.03-ce</p>

<table>
<thead>
<tr>
<th>版本</th>
<th>docker1.11</th>
<th>docker17.03-ce</th>
</tr>
</thead>

<tbody>
<tr>
<td>基本单位</td>
<td>docker容器</td>
<td>docker容器、service、stack</td>
</tr>

<tr>
<td>服务编排</td>
<td>compose，不支持docker swarm的mynet网络</td>
<td>改造后的compose，支持stack中完整的服务编排</td>
</tr>

<tr>
<td>网络模型</td>
<td>Host、bridge、overlay、mynet</td>
<td>默认支持跨主机的overlay网络，创建单个容器时也可以attach到已有的overla网络中</td>
</tr>

<tr>
<td>插件</td>
<td>没有插件管理命令，但是可以手动创建和管理</td>
<td>有插件管理命令，可以手动创建和从docker hub中下载，上传插件到自己的私有镜像仓库</td>
</tr>

<tr>
<td>升级</td>
<td>不支持平滑升级，重启docker原来的容器也会停掉</td>
<td>可以停止docker engine但不影响已启动的容器</td>
</tr>

<tr>
<td>弹性伸缩</td>
<td>不支持</td>
<td>service内置功能</td>
</tr>

<tr>
<td>服务发现</td>
<td>监听docker event增删DNS</td>
<td>内置服务发现，根据DNS负载均衡</td>
</tr>

<tr>
<td>节点管理</td>
<td>手动启停</td>
<td>中心化管理node节点</td>
</tr>

<tr>
<td>服务升级</td>
<td>手动升级</td>
<td>service内置功能</td>
</tr>

<tr>
<td>负载均衡</td>
<td>本身不支持</td>
<td>Swarm mode内部DNS轮寻</td>
</tr>
</tbody>
</table>

<p>基于以上对比，使用docker17.03-ce不仅可以兼容以前的mynet网络模式，只需要重构以前的shrike为<strong>docker plugin</strong>，在创建service的时候指定为mynet即可。也可以同时使用docker mode的overlay网络，而且还可以安装其它docker plugin首先更高级网络和volume功能。</p>

<p>Docker17.03-ce借鉴了很多kubernetes的设计理念，docker发力企业级市场，相信新版的才符合微服务的方向，既能兼容以前的<strong>虚拟机式</strong>的使用模式，也能兼容<strong>微服务</strong>架构。</p>

<h2 id="下一步">下一步</h2>

<p>之前考虑过使用docker1.11 + compose + shipyard + eureka + nginx等做微服务架构，但是考虑到最新版docker的重大升级，从长远的眼光来看，不能一直限定于之前的那一套，我更倾向于新版本。</p>

<ul>
<li>调研Docker17.03-ce的新特性，尤其是服务治理方面</li>
<li>结合具体业务试用</li>
<li>重构shrike为docker plugin</li>
</ul>

<blockquote>
<p><em>Don&rsquo;t speak, I&rsquo;ll try to save us from ourselves</em></p>

<p><em>If were going down, we&rsquo;re going down in flames</em></p>
</blockquote>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Mar 8, 2017 </h4>
        <h5 id="wc"> 2400 Words </h5>
        <h5 id="readtime"> Read in about 5 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="https://jimmysong.io//tags/docker">docker</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="https://jimmysong.io/blogs/vagrant-intro/"><i class="icon-arrow-left"></i> Vagrant介绍-从使用到放弃完全指南</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="https://jimmysong.io/blogs/docker-dev-env/">Docker源码编译和开发环境搭建 <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(图虫)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="2369">
<meta itemprop="datePublished" content="2017-03-08">
<meta itemprop="url" content="https://jimmysong.io/projects/docker-tech-selection/">
 <footer>
    <div>
        <p>
            <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes Handbook</a> |
            <a href="https://jimmysong.io/cloud-native-go">Cloud Native Go</a> |
            <a href="https://jimmysong.io/awesome-cloud-native">Awesome Cloud Native</a> |
            <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">Migrating to Cloud Native Application Architectures</a>
    </div>
    <div>
        <p>

        </p>
        <p> &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span><span>
            Powered by <a href="https://gohugo.io">Hugo</a></span>
            </span>
    </div>
    <div>
        <a href="https://info.flagcounter.com/JENZ"><img src="https://s04.flagcounter.com/count2/JENZ/bg_FFFFFF/txt_000000/border_CCCCCC/columns_8/maxflags_8/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Free counters!" border="0"></a>
    </div>
</footer>
</body>

</html>
